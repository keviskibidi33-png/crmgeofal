# IMPLEMENTACI√ìN FASE 2 ‚Äì ESPECIFICACIONES DETALLADAS

## üéØ **OBJETIVO**
Construir un sistema de cotizaciones y aprobaciones con control diferenciado de roles, m√©tricas de tipo embudo basadas en aprobaciones reales, y un entorno seguro y usable en todos los dispositivos.

## üìã **SISTEMA DE APROBACIONES CON ROLES (FLUJO AISLADO)**

### **1. ROL: FACTURACI√ìN**
**Funcionalidades:**
- ‚úÖ **Recibe solicitudes de aprobaci√≥n** creadas por el vendedor
- ‚úÖ **Registra informaci√≥n del cliente**, monto total y servicios pagados
- ‚úÖ **Aprueba o rechaza cotizaciones** de forma individual
- ‚úÖ **Vistas y registros exclusivos** para este rol
- ‚úÖ **Aislamiento total** respecto a otros roles

**Estados que maneja:**
- `sent` ‚Üí `pending_approval` (Recibe de vendedor)
- `pending_approval` ‚Üí `approved` (Aprueba)
- `pending_approval` ‚Üí `rejected` (Rechaza)

**Interfaz espec√≠fica:**
```jsx
const FacturacionDashboard = () => {
  return (
    <div className="facturacion-dashboard">
      <h2>Panel de Facturaci√≥n</h2>
      <div className="pending-approvals">
        <h3>Cotizaciones Pendientes de Aprobaci√≥n</h3>
        <QuotationList 
          status="pending_approval"
          showActions={true}
          actions={['approve', 'reject', 'request_changes']}
        />
      </div>
      <div className="approval-history">
        <h3>Historial de Aprobaciones</h3>
        <QuotationList 
          status={['approved', 'rejected']}
          showActions={false}
        />
      </div>
    </div>
  );
};
```

### **2. ROL: JEFE COMERCIAL**
**Funcionalidades:**
- ‚úÖ **Accede √∫nicamente a reportes y dashboards** basados en cotizaciones aprobadas por facturaci√≥n
- ‚úÖ **No tiene visibilidad** de las solicitudes en tr√°mite ni de estados previos
- ‚úÖ **Aislamiento total** respecto a facturaci√≥n
- ‚úÖ **M√©tricas construidas solo** desde informaci√≥n ya validada por facturaci√≥n

**Estados que puede ver:**
- Solo `approved` (Cotizaciones ya aprobadas por facturaci√≥n)

**Interfaz espec√≠fica:**
```jsx
const JefeComercialDashboard = () => {
  return (
    <div className="jefe-comercial-dashboard">
      <h2>Panel de Jefe Comercial</h2>
      <div className="metrics-section">
        <h3>M√©tricas de Servicios Aprobados</h3>
        <MetricsGrid data={approvedQuotations} />
      </div>
      <div className="analytics-section">
        <h3>An√°lisis Embudo de Servicios</h3>
        <FunnelChart data={serviceFunnel} />
      </div>
    </div>
  );
};
```

## üìä **M√âTRICAS PARA JEFE COMERCIAL (EMBUDO DE SERVICIOS)**

### **1. Visi√≥n de Totales por Categor√≠a**
```javascript
const categoryMetrics = {
  laboratorio: {
    name: 'Laboratorio',
    source: 'm√≥dulo de Servicios',
    totalAmount: 0,
    totalQuotations: 0,
    services: []
  },
  ingenieria: {
    name: 'Ingenier√≠a',
    source: 'm√≥dulo de Ingenier√≠a',
    totalAmount: 0,
    totalQuotations: 0,
    services: []
  }
};
```

### **2. Reporte de Servicios Aprobados**
```javascript
const approvedServicesReport = {
  monthly: {
    totalQuotations: 0,
    totalAmount: 0,
    averageAmount: 0,
    topServices: [],
    conversionRate: 0
  },
  byCategory: {
    laboratorio: {
      totalAmount: 0,
      totalQuotations: 0,
      services: []
    },
    ingenieria: {
      totalAmount: 0,
      totalQuotations: 0,
      services: []
    }
  }
};
```

### **3. Desglose Embudo Anal√≠tico**
```javascript
const funnelAnalytics = {
  services: [
    {
      name: 'Ensayo Est√°ndar',
      totalQuotations: 0,
      totalAmount: 0,
      conversionRate: 0,
      rank: 1
    },
    {
      name: 'Ensayo Especial',
      totalQuotations: 0,
      totalAmount: 0,
      conversionRate: 0,
      rank: 2
    },
    {
      name: 'Ensayo de Campo',
      totalQuotations: 0,
      totalAmount: 0,
      conversionRate: 0,
      rank: 3
    }
  ],
  distribution: {
    mostUsed: [],
    leastUsed: [],
    businessImpact: [],
    requiresFollowUp: []
  }
};
```

## ‚öôÔ∏è **FUNCIONALIDADES DETALLADAS**

### **1. GESTI√ìN AVANZADA DE COTIZACIONES**

#### **1.1 Borradores Mejorados**
```javascript
const useDraftManagement = () => {
  const [draftVersions, setDraftVersions] = useState([]);
  const [currentVersion, setCurrentVersion] = useState(null);
  
  const saveDraftVersion = async (quotationData) => {
    const version = {
      id: generateId(),
      timestamp: new Date(),
      data: { ...quotationData },
      changes: calculateChanges(currentVersion?.data, quotationData)
    };
    
    setDraftVersions(prev => [version, ...prev]);
    await saveDraftVersionToDB(quotationData.id, version);
  };
  
  const restoreDraftVersion = (versionId) => {
    const version = draftVersions.find(v => v.id === versionId);
    if (version) {
      setCurrentVersion(version);
      return version.data;
    }
  };
  
  return { draftVersions, currentVersion, saveDraftVersion, restoreDraftVersion };
};
```

#### **1.2 Clonaci√≥n Inteligente**
```javascript
const useQuotationCloning = () => {
  const cloneQuotation = async (originalId, modifications = {}) => {
    try {
      const original = await getQuotation(originalId);
      const cloned = {
        ...original,
        id: null,
        status: 'draft',
        created_at: new Date(),
        reference: `${original.reference}-CLON-${Date.now()}`,
        parent_id: originalId,
        items: original.items.map(item => ({
          ...item,
          id: generateId()
        })),
        ...modifications
      };
      
      const newQuotation = await createQuotation(cloned);
      await logCloningAction(originalId, newQuotation.id);
      
      return newQuotation;
    } catch (error) {
      console.error('Error al clonar cotizaci√≥n:', error);
      throw error;
    }
  };
  
  return { cloneQuotation };
};
```

### **2. SISTEMA DE APROBACIONES Y FLUJOS**

#### **2.1 Estados Definidos**
```javascript
const quotationStates = {
  draft: {
    label: 'Borrador',
    color: 'gray',
    icon: 'edit',
    canEdit: true,
    canDelete: true
  },
  sent: {
    label: 'Enviada',
    color: 'blue',
    icon: 'send',
    canEdit: false,
    canDelete: false
  },
  pending_approval: {
    label: 'En Revisi√≥n',
    color: 'orange',
    icon: 'clock',
    canEdit: false,
    canDelete: false
  },
  approved: {
    label: 'Aprobada',
    color: 'green',
    icon: 'check',
    canEdit: false,
    canDelete: false
  },
  rejected: {
    label: 'Rechazada',
    color: 'red',
    icon: 'x',
    canEdit: true,
    canDelete: true
  }
};
```

#### **2.2 Roles Diferenciados y Aislados**
```javascript
const rolePermissions = {
  facturacion: {
    name: 'Facturaci√≥n',
    canView: ['sent', 'pending_approval', 'approved', 'rejected'],
    canApprove: ['pending_approval'],
    canReject: ['pending_approval'],
    canEdit: ['rejected'],
    canDelete: ['rejected'],
    isolationLevel: 'high'
  },
  jefe_comercial: {
    name: 'Jefe Comercial',
    canView: ['approved'],
    canApprove: [],
    canReject: [],
    canEdit: [],
    canDelete: [],
    isolationLevel: 'total',
    canViewMetrics: true
  },
  vendedor: {
    name: 'Vendedor',
    canView: ['draft', 'sent', 'pending_approval', 'approved', 'rejected'],
    canApprove: [],
    canReject: [],
    canEdit: ['draft', 'rejected'],
    canDelete: ['draft', 'rejected'],
    isolationLevel: 'none'
  }
};
```

#### **2.3 Notificaciones Multicanal**
```javascript
const NotificationSystem = {
  sendApprovalRequest: async (quotation, approver) => {
    const notification = {
      type: 'approval_request',
      quotation_id: quotation.id,
      approver_id: approver.id,
      message: `Cotizaci√≥n ${quotation.id} requiere aprobaci√≥n`,
      priority: 'high',
      channels: ['email', 'websocket', 'dashboard']
    };
    
    // Email
    await emailService.send({
      to: approver.email,
      subject: `Aprobaci√≥n requerida - Cotizaci√≥n ${quotation.id}`,
      template: 'approval_request',
      data: { quotation, approver }
    });
    
    // WebSocket
    await websocketService.notify(approver.id, notification);
    
    // Dashboard
    await notificationService.create(notification);
  },
  
  sendApprovalResult: async (quotation, result, approver) => {
    const notification = {
      type: 'approval_result',
      quotation_id: quotation.id,
      result,
      approver_id: approver.id,
      message: `Cotizaci√≥n ${quotation.id} ${result === 'approved' ? 'aprobada' : 'rechazada'}`,
      priority: 'medium',
      channels: ['email', 'websocket', 'dashboard']
    };
    
    await websocketService.notify(quotation.created_by, notification);
    await notificationService.create(notification);
  }
};
```

### **3. MEJORAS DE UX/UI**

#### **3.1 Responsive Full**
```css
/* Mobile First Design */
@media (max-width: 768px) {
  .quotation-form {
    padding: 10px;
    margin: 0;
  }
  
  .quotation-header {
    flex-direction: column;
    gap: 10px;
  }
  
  .items-table {
    overflow-x: auto;
    font-size: 14px;
  }
  
  .action-buttons {
    flex-direction: column;
    gap: 10px;
    position: sticky;
    bottom: 0;
    background: white;
    padding: 10px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }
  
  .metrics-dashboard {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .approval-flow {
    flex-direction: column;
    gap: 10px;
  }
}

@media (max-width: 480px) {
  .quotation-form {
    padding: 5px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .btn {
    width: 100%;
    margin-bottom: 10px;
  }
}
```

#### **3.2 Interfaz Optimizada**
```jsx
const ResponsiveQuotationForm = () => {
  const [isMobile, setIsMobile] = useState(false);
  
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth <= 768);
    };
    
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);
  
  return (
    <div className={`quotation-form ${isMobile ? 'mobile' : 'desktop'}`}>
      <div className="form-header">
        <h2>Cotizaci√≥n Inteligente</h2>
        {isMobile && <MobileMenu />}
      </div>
      
      <div className="form-content">
        <ClientSection />
        <ProjectSection />
        <QuotationSection />
        <ItemsSection />
      </div>
      
      <div className="form-actions">
        <ActionButtons isMobile={isMobile} />
      </div>
    </div>
  );
};
```

## üîí **SEGURIDAD Y AISLAMIENTO**

### **1. Control de Acceso por Roles**
```javascript
const RoleBasedAccess = {
  checkPermission: (user, action, resource) => {
    const userRole = rolePermissions[user.role];
    if (!userRole) return false;
    
    return userRole.canView.includes(resource.status) &&
           userRole[action]?.includes(resource.status);
  },
  
  filterDataByRole: (user, data) => {
    const userRole = rolePermissions[user.role];
    if (!userRole) return [];
    
    return data.filter(item => 
      userRole.canView.includes(item.status)
    );
  }
};
```

### **2. Auditor√≠a de Acciones**
```javascript
const AuditLogger = {
  logAction: (action, user, resource, details) => {
    const auditEntry = {
      id: generateId(),
      action,
      user_id: user.id,
      user_email: user.email,
      user_role: user.role,
      resource_type: resource.type,
      resource_id: resource.id,
      timestamp: new Date(),
      ip_address: getClientIP(),
      user_agent: getUserAgent(),
      details: JSON.stringify(details)
    };
    
    auditDatabase.insert(auditEntry);
  }
};
```

## üìä **DASHBOARD DE M√âTRICAS**

### **1. M√©tricas para Jefe Comercial**
```jsx
const JefeComercialMetrics = () => {
  const [metrics, setMetrics] = useState({
    totalQuotations: 0,
    totalAmount: 0,
    byCategory: {
      laboratorio: { amount: 0, count: 0 },
      ingenieria: { amount: 0, count: 0 }
    },
    topServices: [],
    conversionRate: 0
  });
  
  return (
    <div className="metrics-dashboard">
      <div className="metrics-header">
        <h2>M√©tricas de Servicios Aprobados</h2>
        <MonthSelector />
      </div>
      
      <div className="metrics-grid">
        <MetricCard 
          title="Total Cotizaciones Aprobadas" 
          value={metrics.totalQuotations}
          icon="üìä"
        />
        <MetricCard 
          title="Monto Total Aprobado" 
          value={`S/ ${formatCurrency(metrics.totalAmount)}`}
          icon="üí∞"
        />
        <MetricCard 
          title="Tasa de Conversi√≥n" 
          value={`${metrics.conversionRate}%`}
          icon="üìà"
        />
      </div>
      
      <div className="categories-section">
        <CategoryChart 
          title="Laboratorio" 
          data={metrics.byCategory.laboratorio} 
        />
        <CategoryChart 
          title="Ingenier√≠a" 
          data={metrics.byCategory.ingenieria} 
        />
      </div>
      
      <div className="funnel-section">
        <FunnelChart 
          title="Embudo de Servicios" 
          data={metrics.topServices} 
        />
      </div>
    </div>
  );
};
```

## üìÖ **CRONOGRAMA DE IMPLEMENTACI√ìN**

### **Sprint 1 (2 semanas): Sistema de Aprobaciones**
- ‚úÖ Roles diferenciados (Facturaci√≥n, Jefe Comercial)
- ‚úÖ Estados de cotizaci√≥n
- ‚úÖ Flujo de aprobaci√≥n
- ‚úÖ Aislamiento de datos por rol

### **Sprint 2 (2 semanas): M√©tricas y Dashboard**
- ‚úÖ Dashboard para Jefe Comercial
- ‚úÖ M√©tricas de embudo de servicios
- ‚úÖ Reportes por categor√≠a
- ‚úÖ An√°lisis de conversi√≥n

### **Sprint 3 (2 semanas): Borradores y Clonaci√≥n**
- ‚úÖ Sistema de borradores mejorado
- ‚úÖ Clonaci√≥n inteligente
- ‚úÖ Historial de versiones
- ‚úÖ Recuperaci√≥n de borradores

### **Sprint 4 (2 semanas): UX/UI y Seguridad**
- ‚úÖ Responsive design completo
- ‚úÖ Interfaz optimizada
- ‚úÖ Seguridad avanzada
- ‚úÖ Auditor√≠a completa

## üéØ **RESULTADO ESPERADO**

Al finalizar la implementaci√≥n:

- ‚úÖ **Sistema de aprobaciones** con roles completamente aislados
- ‚úÖ **M√©tricas de embudo** para Jefe Comercial basadas en aprobaciones reales
- ‚úÖ **Dashboard anal√≠tico** con totales por categor√≠a y servicio
- ‚úÖ **Borradores inteligentes** con versionado y recuperaci√≥n
- ‚úÖ **Clonaci√≥n eficiente** de cotizaciones
- ‚úÖ **Interfaz responsive** optimizada para todos los dispositivos
- ‚úÖ **Seguridad robusta** con auditor√≠a completa

## üìÖ **Fecha de inicio**
2025-01-20

## üë§ **Planificado por**
Asistente IA - Especificaciones Fase 2
