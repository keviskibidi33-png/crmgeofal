import{a as P,r as x,b as r,j as e,av as d,B as b,A as q,Z as D,l as $,f,$ as L,_ as y,h,aM as k,ao as K,aw as U,C as j,aN as _,O as V}from"./index-Dcu-y_Nk.js";import{C as v,R as t}from"./Row-WYeb25UG.js";import{A as S}from"./Alert-CXOKGb3T.js";import{S as H}from"./Spinner-B-FgOVHr.js";import{C as c}from"./Col-c57Xg6FM.js";import{T as I,a as p}from"./Tabs-D4nEbgrV.js";import"./ElementChildren-BevWbOM2.js";const Y=()=>{const{user:m}=P(),[a,z]=x.useState({servicesDistribution:[],categoryRanking:[],ensayosRanking:[],hierarchicalStructure:[],conversionByCategory:[],monthlyTrends:[],underutilizedServices:[],salespersonPerformance:[],executiveSummary:{},funnelByArea:[],approvalMetrics:{}}),[w,N]=x.useState(!0),[u,n]=x.useState(null);x.useEffect(()=>{g()},[]);const g=async()=>{try{if(N(!0),n(null),m.role==="admin"||m.role==="jefa_comercial"){const[s,i,l,C,R,A,M,E,F,T,B]=await Promise.all([r("/api/funnel/distribution"),r("/api/funnel/category-ranking"),r("/api/funnel/ensayos-ranking"),r("/api/funnel/hierarchical-structure"),r("/api/funnel/categories"),r("/api/funnel/trends"),r("/api/funnel/underutilized"),r("/api/funnel/performance"),r("/api/funnel/summary"),r("/api/funnel/by-area"),r("/api/funnel/approval-metrics")]);z({servicesDistribution:s||[],categoryRanking:i||[],ensayosRanking:l||[],hierarchicalStructure:C||[],conversionByCategory:R||[],monthlyTrends:A||[],underutilizedServices:M||[],salespersonPerformance:E||[],executiveSummary:F||{},funnelByArea:T||[],approvalMetrics:B||{}})}else n("No tienes permisos para acceder a esta sección")}catch(s){console.error("Error fetching metrics:",s),s.status===401?n("Sesión expirada. Por favor, inicia sesión nuevamente."):s.status===403?n("No tienes permisos para acceder a esta sección."):n("Error al cargar las métricas: "+(s.message||"Error desconocido"))}finally{N(!1)}};if(!m||!["admin","jefa_comercial"].includes(m.role))return e.jsx(v,{className:"mt-4",children:e.jsxs(S,{variant:"warning",children:[e.jsx("h4",{children:"Acceso Denegado"}),e.jsx("p",{children:"No tienes permisos para acceder a esta sección. Solo los administradores y jefes comerciales pueden ver las métricas de embudo."})]})});if(w)return e.jsxs(v,{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(H,{animation:"border"}),e.jsx("div",{className:"ms-3",children:e.jsx("p",{children:"Cargando métricas..."})})]});const o=s=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(s);return e.jsx("div",{className:"metricas-embudo",children:e.jsxs(v,{fluid:!0,children:[e.jsx("div",{className:"metricas-header",children:e.jsxs(t,{className:"align-items-center",children:[e.jsxs(c,{children:[e.jsxs("h1",{className:"metricas-title",children:[e.jsx(d,{className:"me-3"}),"Métricas de Embudo"]}),e.jsx("p",{className:"metricas-subtitle",children:"Dashboard inteligente para análisis de conversión y rendimiento comercial"})]}),e.jsx(c,{xs:"auto",children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(b,{className:"btn-metricas-outline",onClick:g,children:[e.jsx(q,{className:"me-2"}),"Actualizar"]}),e.jsxs(b,{className:"btn-metricas",children:[e.jsx(D,{className:"me-2"}),"Exportar"]})]})})]})}),u&&e.jsxs(S,{variant:"danger",dismissible:!0,onClose:()=>n(null),className:"metricas-card",children:[e.jsx($,{className:"me-2"}),u]}),e.jsxs(t,{className:"mb-4",children:[e.jsx(c,{lg:3,md:6,className:"mb-3",children:e.jsxs("div",{className:"kpi-card",children:[e.jsx(f,{className:"kpi-icon"}),e.jsx("div",{className:"kpi-value",children:a.executiveSummary.approved_quotes||0}),e.jsx("div",{className:"kpi-label",children:"Cotizaciones Aprobadas"})]})}),e.jsx(c,{lg:3,md:6,className:"mb-3",children:e.jsxs("div",{className:"kpi-card",children:[e.jsx(L,{className:"kpi-icon"}),e.jsx("div",{className:"kpi-value",children:o(a.executiveSummary.approved_amount||0)}),e.jsx("div",{className:"kpi-label",children:"Monto Total Aprobado"})]})}),e.jsx(c,{lg:3,md:6,className:"mb-3",children:e.jsxs("div",{className:"kpi-card",children:[e.jsx(y,{className:"kpi-icon"}),e.jsx("div",{className:"kpi-value",children:o(a.executiveSummary.average_approved_amount||0)}),e.jsx("div",{className:"kpi-label",children:"Promedio por Cotización"})]})}),e.jsx(c,{lg:3,md:6,className:"mb-3",children:e.jsxs("div",{className:"kpi-card",children:[e.jsx(h,{className:"kpi-icon"}),e.jsx("div",{className:"kpi-value",children:a.executiveSummary.active_salespeople||0}),e.jsx("div",{className:"kpi-label",children:"Vendedores Activos"})]})})]}),e.jsx("div",{className:"metricas-tabs",children:e.jsxs(I,{defaultActiveKey:"rankings",id:"metricas-tabs",className:"mb-4",children:[e.jsx(p,{eventKey:"rankings",title:e.jsxs("span",{children:[e.jsx(k,{className:"me-2"}),"Rankings"]}),children:e.jsxs(t,{children:[e.jsx(c,{lg:6,className:"mb-4",children:e.jsxs("div",{className:"metricas-card",children:[e.jsx("div",{className:"metricas-card-header",children:e.jsxs("h5",{className:"metricas-card-title",children:[e.jsx(k,{className:"me-2"}),"🏆 Top Categorías"]})}),e.jsx("div",{className:"metricas-card-body",children:a.categoryRanking.length===0?e.jsxs("div",{className:"text-center text-muted py-4",children:[e.jsx(d,{size:48,className:"mb-3 opacity-50"}),e.jsx("p",{children:"No hay datos disponibles"})]}):e.jsx("div",{children:a.categoryRanking.slice(0,8).map((s,i)=>{var l;return e.jsxs("div",{className:"ranking-item d-flex align-items-center",children:[e.jsx("div",{className:`ranking-position ${i===0?"first":i===1?"second":i===2?"third":""}`,children:i+1}),e.jsxs("div",{className:"ranking-content",children:[e.jsx("div",{className:"ranking-title text-capitalize",children:s.category_name}),e.jsxs("div",{className:"ranking-subtitle",children:[s.total_items," ítems • ",s.total_quotes," cotizaciones"]}),e.jsxs("div",{className:"ranking-stats",children:[e.jsxs("span",{className:"ranking-stat",children:[s.percentage_of_items,"% del total"]}),e.jsxs("span",{className:"ranking-stat",children:["Promedio: S/ ",s.average_money_per_quote?Number(s.average_money_per_quote).toFixed(2):"0.00"]})]})]}),e.jsxs("div",{className:"ranking-amount",children:["S/ ",((l=s.total_money)==null?void 0:l.toLocaleString())||"0"]})]},i)})})})]})}),e.jsx(c,{lg:6,className:"mb-4",children:e.jsxs("div",{className:"metricas-card",children:[e.jsx("div",{className:"metricas-card-header",children:e.jsxs("h5",{className:"metricas-card-title",children:[e.jsx(K,{className:"me-2"}),"🧪 Top Ensayos"]})}),e.jsx("div",{className:"metricas-card-body",children:a.ensayosRanking.length===0?e.jsxs("div",{className:"text-center text-muted py-4",children:[e.jsx(y,{size:48,className:"mb-3 opacity-50"}),e.jsx("p",{children:"No hay datos disponibles"})]}):e.jsx("div",{children:a.ensayosRanking.slice(0,8).map((s,i)=>{var l;return e.jsxs("div",{className:"ranking-item d-flex align-items-center",children:[e.jsx("div",{className:`ranking-position ${i===0?"first":i===1?"second":i===2?"third":""}`,children:i+1}),e.jsxs("div",{className:"ranking-content",children:[e.jsx("div",{className:"ranking-title text-capitalize",children:s.ensayo_name}),e.jsxs("div",{className:"ranking-subtitle",children:[s.total_hijos_cotizados," hijos cotizados • ",s.total_quotes," cotizaciones"]}),e.jsxs("div",{className:"ranking-stats",children:[e.jsx("span",{className:"ranking-stat",children:s.category_main}),e.jsxs("span",{className:"ranking-stat",children:[s.percentage_of_items,"% del total"]})]})]}),e.jsxs("div",{className:"ranking-amount",children:["S/ ",((l=s.total_money)==null?void 0:l.toLocaleString())||"0"]})]},i)})})})]})})]})}),e.jsx(p,{eventKey:"performance",title:e.jsxs("span",{children:[e.jsx(h,{className:"me-2"}),"Rendimiento"]}),children:e.jsxs(t,{children:[e.jsx(c,{lg:6,className:"mb-4",children:e.jsxs("div",{className:"metricas-card",children:[e.jsx("div",{className:"metricas-card-header",children:e.jsxs("h5",{className:"metricas-card-title",children:[e.jsx(f,{className:"me-2"}),"Conversión por Categoría"]})}),e.jsx("div",{className:"metricas-card-body",children:a.conversionByCategory.length===0?e.jsxs("div",{className:"text-center text-muted py-4",children:[e.jsx(U,{size:48,className:"mb-3 opacity-50"}),e.jsx("p",{children:"No hay datos disponibles"})]}):e.jsx("div",{children:a.conversionByCategory.map((s,i)=>e.jsxs("div",{className:"ranking-item",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("div",{className:"ranking-title",children:s.category_name}),e.jsxs(j,{bg:s.conversion_rate>50?"success":s.conversion_rate>25?"warning":"danger",children:[s.conversion_rate,"%"]})]}),e.jsx("div",{className:"progress-custom",children:e.jsx("div",{className:"progress-bar-custom",style:{width:`${s.conversion_rate}%`}})}),e.jsxs("div",{className:"d-flex justify-content-between mt-2",children:[e.jsxs("small",{className:"text-muted",children:["Borradores: ",s.draft_count]}),e.jsxs("small",{className:"text-muted",children:["Aprobadas: ",s.approved_count]})]})]},i))})})]})}),e.jsx(c,{lg:6,className:"mb-4",children:e.jsxs("div",{className:"metricas-card",children:[e.jsx("div",{className:"metricas-card-header",children:e.jsxs("h5",{className:"metricas-card-title",children:[e.jsx(h,{className:"me-2"}),"Rendimiento de Vendedores"]})}),e.jsx("div",{className:"metricas-card-body",children:a.salespersonPerformance.length===0?e.jsxs("div",{className:"text-center text-muted py-4",children:[e.jsx(h,{size:48,className:"mb-3 opacity-50"}),e.jsx("p",{children:"No hay datos disponibles"})]}):e.jsx("div",{children:a.salespersonPerformance.map((s,i)=>e.jsxs("div",{className:"ranking-item",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"ranking-title",children:[s.name," ",s.apellido]}),e.jsx(j,{bg:"info",className:"mt-1",children:s.area})]}),e.jsxs("div",{className:"text-end",children:[e.jsxs("div",{className:"ranking-amount",children:[s.approval_rate,"%"]}),e.jsx("small",{className:"text-muted",children:"Éxito"})]})]}),e.jsxs("div",{className:"row text-center",children:[e.jsxs("div",{className:"col-4",children:[e.jsx("div",{className:"fw-bold text-primary",children:s.total_quotes}),e.jsx("small",{className:"text-muted",children:"Total"})]}),e.jsxs("div",{className:"col-4",children:[e.jsx("div",{className:"fw-bold text-success",children:s.approved_quotes}),e.jsx("small",{className:"text-muted",children:"Aprobadas"})]}),e.jsxs("div",{className:"col-4",children:[e.jsx("div",{className:"fw-bold text-info",children:o(s.approved_amount)}),e.jsx("small",{className:"text-muted",children:"Monto"})]})]})]},i))})})]})})]})}),e.jsx(p,{eventKey:"structure",title:e.jsxs("span",{children:[e.jsx(d,{className:"me-2"}),"Estructura"]}),children:e.jsx(t,{children:e.jsx(c,{lg:12,className:"mb-4",children:e.jsxs("div",{className:"metricas-card",children:[e.jsx("div",{className:"metricas-card-header",children:e.jsxs("h5",{className:"metricas-card-title",children:[e.jsx(d,{className:"me-2"}),"🌳 Estructura Jerárquica del Embudo"]})}),e.jsx("div",{className:"metricas-card-body",children:a.hierarchicalStructure.length===0?e.jsxs("div",{className:"text-center text-muted py-4",children:[e.jsx(d,{size:48,className:"mb-3 opacity-50"}),e.jsx("p",{children:"No hay datos disponibles"})]}):e.jsx("div",{className:"hierarchical-structure",children:a.hierarchicalStructure.map((s,i)=>{var l;return e.jsx("div",{className:`hierarchy-item ${s.level}`,style:{marginLeft:s.level==="category"?"0px":s.level==="ensayo"?"20px":"40px",padding:"15px",border:"1px solid rgba(102, 126, 234, 0.2)",borderRadius:"12px",marginBottom:"10px",background:s.level==="category"?"linear-gradient(135deg, #f8f9fa, #e9ecef)":s.level==="ensayo"?"linear-gradient(135deg, #e3f2fd, #bbdefb)":"linear-gradient(135deg, #f3e5f5, #e1bee7)",transition:"all 0.3s ease"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[s.level==="category"&&e.jsx("span",{className:"me-2",children:"📁"}),s.level==="ensayo"&&e.jsx("span",{className:"me-2",children:"🧪"}),s.level==="subservicio"&&e.jsx("span",{className:"me-2",children:"📋"}),e.jsxs("div",{children:[e.jsx("strong",{className:"text-capitalize",children:s.name}),s.level==="category"&&e.jsxs("div",{className:"text-muted small",children:[s.total_items," ítems • ",s.total_quotes," cotizaciones"]}),s.level==="ensayo"&&e.jsxs("div",{className:"text-muted small",children:[s.total_items," hijos cotizados • ",s.total_quotes," cotizaciones"]}),s.level==="subservicio"&&e.jsxs("div",{className:"text-muted small",children:[s.veces_cotizado," veces cotizado • ",s.total_quotes," cotizaciones"]})]})]}),e.jsx("div",{className:"text-end",children:e.jsxs("div",{className:"ranking-amount",children:["S/ ",((l=s.total_money)==null?void 0:l.toLocaleString())||"0"]})})]})},i)})})})]})})})})]})}),e.jsxs(t,{children:[e.jsx(c,{lg:6,className:"mb-4",children:e.jsxs("div",{className:"metricas-card",children:[e.jsx("div",{className:"metricas-card-header",children:e.jsxs("h5",{className:"metricas-card-title",children:[e.jsx(_,{className:"me-2"}),"Servicios Subutilizados"]})}),e.jsx("div",{className:"metricas-card-body",children:a.underutilizedServices.length===0?e.jsxs("div",{className:"text-center text-muted py-4",children:[e.jsx(_,{size:48,className:"mb-3 opacity-50"}),e.jsx("p",{children:"No hay servicios subutilizados"})]}):e.jsx("div",{children:a.underutilizedServices.map((s,i)=>e.jsxs("div",{className:"ranking-item d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"ranking-title",children:s.service_name}),e.jsxs("div",{className:"ranking-subtitle",children:[s.category_name," • ",s.area]})]}),e.jsxs("div",{className:"text-end",children:[e.jsxs(j,{bg:"warning",className:"mb-1",children:[s.usage_count," usos"]}),e.jsx("div",{className:"ranking-amount",children:o(s.total_revenue)})]})]},i))})})]})}),e.jsx(c,{lg:6,className:"mb-4",children:e.jsxs("div",{className:"metricas-card",children:[e.jsx("div",{className:"metricas-card-header",children:e.jsxs("h5",{className:"metricas-card-title",children:[e.jsx(V,{className:"me-2"}),"Métricas de Tiempo"]})}),e.jsx("div",{className:"metricas-card-body",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"kpi-value text-primary",children:[Math.round(a.approvalMetrics.avg_approval_hours||0),"h"]}),e.jsx("div",{className:"kpi-label",children:"Tiempo Promedio de Aprobación"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{className:"fw-bold",children:"Rápido (<24h)"}),e.jsx("span",{className:"fw-bold text-success",children:a.approvalMetrics.fast_approvals||0})]}),e.jsx("div",{className:"progress-custom",children:e.jsx("div",{className:"progress-bar-custom",style:{width:`${a.approvalMetrics.total_approvals?(a.approvalMetrics.fast_approvals||0)/a.approvalMetrics.total_approvals*100:0}%`}})}),e.jsxs("small",{className:"text-muted mt-2 d-block",children:["Total de aprobaciones: ",a.approvalMetrics.total_approvals||0]})]})]})})]})})]})]})})};export{Y as default};
//# sourceMappingURL=MetricasEmbudo-DyIO_GOZ.js.map
