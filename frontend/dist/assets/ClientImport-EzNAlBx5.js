import{b as I,r as d,c as $,e as X,x as H,j as e,L as T,$ as Y,h as ee,A as f,J as P,B as u,Z as V,F as se,f as ae,C as A}from"./index-Bcrgukx7.js";import{P as re}from"./PageHeader-BXdzGOF9.js";import{g as te}from"./authHelper-BtdtwZok.js";import{C as Q,R as m}from"./Row-B5ljKXp5.js";import{A as x}from"./Alert-C1-1JEUj.js";import{C as i}from"./Col-C5Zwr_ej.js";import{C as n}from"./Card-C96hNOBG.js";import{F as o}from"./Form-DBWuP9iW.js";import{P as ie}from"./ProgressBar-C_ilElTL.js";import{T as ne}from"./Table-CY_xt81j.js";import{M as g}from"./Modal-CPMvw6Im.js";import"./ElementChildren-BWXp08bt.js";const L={async cleanData(){try{console.log("🧹 Iniciando limpieza de datos...");const a=await I("/api/client-import/clean",{method:"POST"});return console.log("✅ Limpieza completada:",a),a}catch(a){throw console.error("❌ Error en limpieza:",a),a}},async importClients(a){try{console.log("📥 Iniciando importación de clientes...");const l=await I("/api/client-import/import",{method:"POST",body:a});return console.log("✅ Importación completada:",l),l}catch(l){throw console.error("❌ Error en importación:",l),l}},async getStats(){try{console.log("📊 Obteniendo estadísticas...");const a=await I("/api/client-import/stats",{method:"GET"});return console.log("✅ Estadísticas obtenidas:",a),a}catch(a){throw console.error("❌ Error obteniendo estadísticas:",a),a}}};function be(){var D,z,B,O,k;const[a,l]=d.useState(null),[v,c]=d.useState(0),[r,E]=d.useState(null),[G,N]=d.useState(!1),[w,M]=d.useState(""),[b,y]=d.useState(!1),F=te(),C=$(),U=(F==null?void 0:F.role)==="admin",{data:h,isLoading:q,refetch:R}=X(["clientImportStats"],L.getStats,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4}),j=H(L.cleanData,{onSuccess:s=>{console.log("✅ Datos limpiados exitosamente:",s),N(!1),M(""),R(),C.invalidateQueries("clients"),C.invalidateQueries("clientStats")},onError:s=>{console.error("❌ Error limpiando datos:",s)}}),S=H(L.importClients,{onSuccess:s=>{console.log("✅ Importación completada:",s),E(s.data),l(null),c(0),R(),C.invalidateQueries("clients"),C.invalidateQueries("clientStats")},onError:s=>{console.error("❌ Error en importación:",s),c(0)}}),W=s=>{const t=s.target.files[0];if(t){if(!t.name.toLowerCase().endsWith(".csv")){alert("Por favor selecciona un archivo CSV válido");return}if(t.size>10*1024*1024){alert("El archivo es demasiado grande. Máximo 10MB");return}l(t),E(null)}},_=()=>{w==="CONFIRMAR"?(y(!0),j.mutate()):alert('Por favor escribe "CONFIRMAR" para proceder con la limpieza')},J=()=>{if(!a){alert("Por favor selecciona un archivo CSV");return}y(!0),c(0);const s=setInterval(()=>{c(p=>p>=90?(clearInterval(s),90):p+10)},200),t=new FormData;t.append("file",a),S.mutate(t,{onSettled:()=>{clearInterval(s),c(100),y(!1),setTimeout(()=>c(0),2e3)}})},K=s=>{const p={prospeccion:{bg:"secondary",text:"Prospección"},interesado:{bg:"info",text:"Interesado"},pendiente_cotizacion:{bg:"warning",text:"Pendiente Cotización"},cotizacion_enviada:{bg:"primary",text:"Cotización Enviada"},negociacion:{bg:"warning",text:"Negociación"},ganado:{bg:"success",text:"Ganado"},perdido:{bg:"danger",text:"Perdido"}}[s]||{bg:"secondary",text:s};return e.jsx(A,{bg:p.bg,children:p.text})},Z=s=>e.jsx(A,{bg:s==="empresa"?"primary":"info",children:s==="empresa"?"Empresa":"Persona"});return U?e.jsx("div",{className:"client-import-page",children:e.jsxs(Q,{fluid:!0,children:[e.jsx(re,{title:"Importación de Clientes",subtitle:"Importar datos de clientes desde archivo CSV de seguimiento",icon:Y}),e.jsx(m,{className:"mb-4",children:e.jsx(i,{md:12,children:e.jsxs(n,{className:"shadow-sm",children:[e.jsx(n.Header,{className:"bg-primary text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(ee,{className:"me-2"}),"Estadísticas Actuales"]})}),e.jsx(n.Body,{children:q?e.jsxs("div",{className:"text-center py-3",children:[e.jsx(f,{className:"spinning"}),e.jsx("span",{className:"ms-2",children:"Cargando estadísticas..."})]}):h?e.jsxs(m,{children:[e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-primary mb-1",children:((D=h.data)==null?void 0:D.total)||0}),e.jsx("small",{className:"text-muted",children:"Total Clientes"})]})}),e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-success mb-1",children:((z=h.data)==null?void 0:z.empresas)||0}),e.jsx("small",{className:"text-muted",children:"Empresas"})]})}),e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-info mb-1",children:((B=h.data)==null?void 0:B.personas)||0}),e.jsx("small",{className:"text-muted",children:"Personas"})]})}),e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-warning mb-1",children:((O=h.data)==null?void 0:O.conEmail)||0}),e.jsx("small",{className:"text-muted",children:"Con Email"})]})})]}):e.jsx(x,{variant:"warning",children:"No se pudieron cargar las estadísticas"})})]})})}),e.jsx(m,{className:"mb-4",children:e.jsx(i,{md:12,children:e.jsxs(n,{className:"shadow-sm border-warning",children:[e.jsx(n.Header,{className:"bg-warning text-dark",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(P,{className:"me-2"}),"Limpieza de Datos Existentes"]})}),e.jsxs(n.Body,{children:[e.jsxs(x,{variant:"warning",className:"mb-3",children:[e.jsx(T,{className:"me-2"}),e.jsx("strong",{children:"Advertencia:"})," Esta acción eliminará TODOS los datos existentes (usuarios, proyectos, clientes) excepto los usuarios administradores. Esta acción no se puede deshacer."]}),e.jsx(u,{variant:"outline-warning",onClick:()=>N(!0),disabled:j.isLoading||b,children:j.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"spinning me-2"}),"Limpiando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"me-2"}),"Limpiar Datos Existentes"]})})]})]})})}),e.jsx(m,{className:"mb-4",children:e.jsx(i,{md:12,children:e.jsxs(n,{className:"shadow-sm",children:[e.jsx(n.Header,{className:"bg-success text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(V,{className:"me-2"}),"Importar Clientes desde CSV"]})}),e.jsxs(n.Body,{children:[e.jsxs(o.Group,{className:"mb-3",children:[e.jsx(o.Label,{children:"Seleccionar archivo CSV"}),e.jsx(o.Control,{type:"file",accept:".csv",onChange:W,disabled:b}),e.jsx(o.Text,{className:"text-muted",children:"Archivo CSV con formato de seguimiento de clientes (máximo 10MB)"})]}),a&&e.jsxs(x,{variant:"info",className:"mb-3",children:[e.jsx(se,{className:"me-2"}),e.jsx("strong",{children:"Archivo seleccionado:"})," ",a.name,"(",(a.size/1024).toFixed(1)," KB)"]}),v>0&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"d-flex justify-content-between mb-1",children:[e.jsx("small",{children:"Procesando archivo..."}),e.jsxs("small",{children:[v,"%"]})]}),e.jsx(ie,{now:v,animated:!0})]}),e.jsx(u,{variant:"success",onClick:J,disabled:!a||b||S.isLoading,className:"me-2",children:S.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"spinning me-2"}),"Importando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"me-2"}),"Importar Clientes"]})}),e.jsx(u,{variant:"outline-secondary",onClick:()=>{l(null),E(null),c(0)},disabled:b,children:"Limpiar"})]})]})})}),r&&e.jsx(m,{className:"mb-4",children:e.jsx(i,{md:12,children:e.jsxs(n,{className:"shadow-sm",children:[e.jsx(n.Header,{className:"bg-info text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(ae,{className:"me-2"}),"Resultados de Importación"]})}),e.jsxs(n.Body,{children:[e.jsxs(m,{className:"mb-3",children:[e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-success mb-1",children:r.successful}),e.jsx("small",{className:"text-muted",children:"Importados"})]})}),e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-danger mb-1",children:r.failed}),e.jsx("small",{className:"text-muted",children:"Fallaron"})]})}),e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-primary mb-1",children:r.totalProcessed}),e.jsx("small",{className:"text-muted",children:"Procesados"})]})}),e.jsx(i,{md:3,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-warning mb-1",children:((k=r.errors)==null?void 0:k.length)||0}),e.jsx("small",{className:"text-muted",children:"Errores"})]})})]}),r.errors&&r.errors.length>0&&e.jsxs(x,{variant:"warning",className:"mb-3",children:[e.jsx("h6",{children:"Errores encontrados:"}),e.jsxs("ul",{className:"mb-0",children:[r.errors.slice(0,5).map((s,t)=>e.jsx("li",{children:s},t)),r.errors.length>5&&e.jsxs("li",{children:["... y ",r.errors.length-5," errores más"]})]})]}),r.importedClients&&r.importedClients.length>0&&e.jsxs("div",{children:[e.jsx("h6",{children:"Clientes importados:"}),e.jsxs(ne,{striped:!0,bordered:!0,hover:!0,size:"sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Acción"})]})}),e.jsx("tbody",{children:r.importedClients.slice(0,10).map((s,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:s.name}),e.jsx("td",{children:Z(s.type)}),e.jsx("td",{children:K(s.status)}),e.jsx("td",{children:e.jsx(A,{bg:s.action==="created"?"success":"info",children:s.action==="created"?"Creado":"Actualizado"})})]},t))})]}),r.importedClients.length>10&&e.jsxs("small",{className:"text-muted",children:["Mostrando los primeros 10 de ",r.importedClients.length," clientes"]})]})]})]})})}),e.jsxs(g,{show:G,onHide:()=>N(!1),centered:!0,children:[e.jsx(g.Header,{closeButton:!0,className:"bg-warning text-dark",children:e.jsxs(g.Title,{children:[e.jsx(T,{className:"me-2"}),"Confirmar Limpieza de Datos"]})}),e.jsxs(g.Body,{children:[e.jsxs(x,{variant:"danger",children:[e.jsx("strong",{children:"¡ADVERTENCIA!"}),e.jsx("br",{}),"Esta acción eliminará PERMANENTEMENTE:",e.jsxs("ul",{className:"mt-2 mb-0",children:[e.jsx("li",{children:"Todos los clientes/empresas"}),e.jsx("li",{children:"Todos los proyectos"}),e.jsx("li",{children:"Todas las cotizaciones"}),e.jsx("li",{children:"Todos los usuarios (excepto administradores)"})]})]}),e.jsx("p",{children:"Esta acción NO se puede deshacer."}),e.jsxs(o.Group,{children:[e.jsxs(o.Label,{children:["Para confirmar, escribe ",e.jsx("strong",{children:"CONFIRMAR"})," en el campo de abajo:"]}),e.jsx(o.Control,{type:"text",value:w,onChange:s=>M(s.target.value),placeholder:"Escribe CONFIRMAR aquí"})]})]}),e.jsxs(g.Footer,{children:[e.jsx(u,{variant:"secondary",onClick:()=>N(!1),children:"Cancelar"}),e.jsx(u,{variant:"danger",onClick:_,disabled:w!=="CONFIRMAR"||j.isLoading,children:j.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"spinning me-2"}),"Limpiando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"me-2"}),"Limpiar Datos"]})})]})]})]})}):e.jsx(Q,{className:"mt-4",children:e.jsxs(x,{variant:"danger",children:[e.jsx(T,{className:"me-2"}),e.jsx("strong",{children:"Acceso Denegado"}),e.jsx("br",{}),"Solo los administradores pueden acceder al módulo de importación de clientes."]})})}export{be as default};
//# sourceMappingURL=ClientImport-EzNAlBx5.js.map
