import{r as l,j as e,az as G}from"./index-D5j7Etbr.js";import{l as U}from"./companies-BQpw0ewS.js";import{l as O,c as E,u as T}from"./projects-C9osJ5rC.js";function D({value:b,onChange:r}){const[g,M]=l.useState([]),[N,y]=l.useState([]),[f,m]=l.useState(!1),[t,j]=l.useState({company_id:"",project_id:"",project_name:"",location:""}),[C,u]=l.useState(""),[v,P]=l.useState(!1),[h,_]=l.useState(null),[S,L]=l.useState(!1);l.useEffect(()=>{if(v){document.body.style.overflow="hidden";const a=o=>{o.key==="Escape"&&p()};return document.addEventListener("keydown",a),()=>{document.removeEventListener("keydown",a)}}else document.body.style.overflow="unset";return()=>{document.body.style.overflow="unset"}},[v]);const[n,c]=l.useState({name:"",location:"",sector:"",status:"activo",description:"",start_date:"",end_date:"",priority:"media"});l.useEffect(()=>{(async()=>{try{m(!0);const a=await U({page:1,limit:50}),o=Array.isArray(a==null?void 0:a.data)?a.data:a;M(o||[])}catch{u("No se pudo cargar empresas")}finally{m(!1)}})()},[]),l.useEffect(()=>{if(!t.company_id){y([]);return}const a=setTimeout(async()=>{try{m(!0),u(""),console.log("üîç Cargando proyectos para company_id:",t.company_id);const o=await O({page:1,limit:50,company_id:t.company_id}),s=Array.isArray(o==null?void 0:o.data)?o.data:o;y(s||[]),console.log("‚úÖ Proyectos cargados:",(s==null?void 0:s.length)||0)}catch(o){console.error("‚ùå Error cargando proyectos:",o),u("No se pudo cargar proyectos del cliente"),y([])}finally{m(!1)}},300);return()=>clearTimeout(a)},[t.company_id]);const d=l.useMemo(()=>g.find(a=>String(a.id)===String(t.company_id)),[g,t.company_id]),i=l.useMemo(()=>N.find(a=>String(a.id)===String(t.project_id)),[N,t.project_id]),w=l.useMemo(()=>t.company_id?N.filter(a=>String(a.company_id)===String(t.company_id)):[],[N,t.company_id]);l.useEffect(()=>{if(typeof r=="function"){const a={company_id:t.company_id?Number(t.company_id):null,company:d||null,project_id:t.project_id?Number(t.project_id):null,project:i||null,project_name:t.project_name,location:t.location},o=JSON.stringify(b),s=JSON.stringify(a);o!==s&&(console.log("üîÑ CompanyProjectPicker - onChange:",a),r(a))}},[t.company_id,t.project_id,t.project_name,t.location,d,i,r,b]);const A=async()=>{if(!(!t.company_id||!t.project_name||!t.location))try{m(!0);const a={company_id:Number(t.company_id),name:t.project_name,location:t.location},o=await E(a);y(s=>[...s,o]),typeof r=="function"&&r({...b,project_id:o.id,project:o,project_name:o.name,location:o.location}),j(s=>({...s,project_id:o.id,project_name:"",location:""})),u("")}catch(a){u(a.message||"No se pudo crear proyecto")}finally{m(!1)}},x=(a=null)=>{if(console.log("üîç openProjectModal llamado con:",a),console.log("üîç showProjectModal actual:",v),console.log("üîç modalLoading actual:",S),S){console.log("‚ö†Ô∏è Modal est√° cargando, esperando...");return}v?console.log("üîÑ Modal ya abierto, cambiando modo..."):(console.log("üîç Abriendo modal para proyecto:",(a==null?void 0:a.name)||"nuevo"),P(!0)),a?(console.log("üîç Configurando modo edici√≥n para:",a.name),_(a),c({name:a.name||"",location:a.location||"",sector:a.sector||"",status:a.status||"activo",description:a.description||"",start_date:a.start_date||"",end_date:a.end_date||"",priority:a.priority||"media"})):(console.log("üîç Configurando modo creaci√≥n"),_(null),c({name:"",location:"",sector:"",status:"activo",description:"",start_date:"",end_date:"",priority:"media"})),console.log("‚úÖ Modal configurado correctamente")},p=()=>{console.log("üîç Cerrando modal de proyectos"),P(!1),_(null),L(!1),c({name:"",location:"",sector:"",status:"activo",description:"",start_date:"",end_date:"",priority:"media"})},F=async()=>{if(!t.company_id||!n.name||!n.location){u("Nombre y ubicaci√≥n son requeridos");return}try{m(!0);const a={company_id:Number(t.company_id),...n};let o;h?(o=await T(h.id,a),y(s=>s.map(k=>k.id===h.id?o:k))):(o=await E(a),y(s=>[...s,o])),j(s=>({...s,project_id:o.id})),typeof r=="function"&&r({...b,project_id:o.id,project:o,project_name:o.name,location:o.location}),p(),u("")}catch(a){u(a.message||"No se pudo guardar el proyecto")}finally{m(!1)}};return e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("h6",{children:"Cliente y Proyecto"}),C&&e.jsx("div",{className:"alert alert-warning py-1 my-2",children:C}),e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsxs("select",{className:"form-select",value:t.company_id,disabled:f,onChange:a=>j({...t,company_id:a.target.value,project_id:""}),children:[e.jsx("option",{value:"",children:"Seleccione..."}),g.map(a=>e.jsxs("option",{value:a.id,children:[a.name," ",a.ruc?`(RUC ${a.ruc})`:""]},a.id))]})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Proyecto"}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("input",{className:"form-control",value:i?`${i.name} | ${i.location}`:"Seleccionar proyecto...",readOnly:!0,style:{backgroundColor:"#f8f9fa",cursor:"pointer"},onClick:()=>t.company_id&&x()}),e.jsx("button",{type:"button",className:"btn btn-outline-primary",onClick:()=>t.company_id&&x(),disabled:!t.company_id||f,title:"Gestionar proyectos",children:"üìã"})]}),i&&e.jsxs("div",{className:"small text-muted mt-1",children:["Sector: ",i.sector||"Sin sector"," | Estado: ",i.status||"Sin estado"]})]}),t.project_id==="new"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx("label",{className:"form-label",children:"Nombre del proyecto"}),e.jsx("input",{className:"form-control",value:t.project_name,onChange:a=>j({...t,project_name:a.target.value}),placeholder:"Ej. Control de calidad de mezclas"})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx("label",{className:"form-label",children:"Ubicaci√≥n"}),e.jsx("input",{className:"form-control",value:t.location,onChange:a=>j({...t,location:a.target.value}),placeholder:"Ej. Lima, Per√∫"})]}),e.jsx("div",{className:"col-md-2 d-grid",children:e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:A,disabled:!t.company_id||!t.project_name||!t.location,children:"Crear"})})]}),t.project_id&&t.project_id!=="new"&&e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Ubicaci√≥n"}),e.jsx("input",{className:"form-control",value:(i==null?void 0:i.location)||"",readOnly:!0})]}),d&&e.jsxs("div",{className:"small text-muted mt-2",children:["Contacto: ",d.contact_name," ¬∑ Tel: ",d.phone," ¬∑ Email: ",d.email]})]}),v&&G.createPortal(e.jsx("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)",position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:9999},onClick:a=>{a.target===a.currentTarget&&p()},children:e.jsx("div",{className:"modal-dialog modal-lg",style:{margin:"2rem auto"},children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:h?"Editar Proyecto":"Gestionar Proyectos"}),e.jsx("button",{type:"button",className:"btn-close",onClick:p})]}),e.jsx("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"},children:h?e.jsx("div",{children:e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Nombre del Proyecto *"}),e.jsx("input",{type:"text",className:"form-control",value:n.name,onChange:a=>c(o=>({...o,name:a.target.value})),required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Ubicaci√≥n *"}),e.jsx("input",{type:"text",className:"form-control",value:n.location,onChange:a=>c(o=>({...o,location:a.target.value})),required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Sector"}),e.jsxs("select",{className:"form-select",value:n.sector,onChange:a=>c(o=>({...o,sector:a.target.value})),children:[e.jsx("option",{value:"",children:"Seleccionar sector..."}),e.jsx("option",{value:"Construcci√≥n",children:"Construcci√≥n"}),e.jsx("option",{value:"Geot√©cnico",children:"Geot√©cnico"}),e.jsx("option",{value:"Laboratorio",children:"Laboratorio"}),e.jsx("option",{value:"Consultor√≠a",children:"Consultor√≠a"}),e.jsx("option",{value:"Capacitaci√≥n",children:"Capacitaci√≥n"}),e.jsx("option",{value:"Auditor√≠a",children:"Auditor√≠a"})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Estado"}),e.jsxs("select",{className:"form-select",value:n.status,onChange:a=>c(o=>({...o,status:a.target.value})),children:[e.jsx("option",{value:"activo",children:"Activo"}),e.jsx("option",{value:"en_proceso",children:"En Proceso"}),e.jsx("option",{value:"completado",children:"Completado"}),e.jsx("option",{value:"pausado",children:"Pausado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Fecha de Inicio"}),e.jsx("input",{type:"date",className:"form-control",value:n.start_date,onChange:a=>c(o=>({...o,start_date:a.target.value}))})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Fecha de Fin"}),e.jsx("input",{type:"date",className:"form-control",value:n.end_date,onChange:a=>c(o=>({...o,end_date:a.target.value}))})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Prioridad"}),e.jsxs("select",{className:"form-select",value:n.priority,onChange:a=>c(o=>({...o,priority:a.target.value})),children:[e.jsx("option",{value:"baja",children:"Baja"}),e.jsx("option",{value:"media",children:"Media"}),e.jsx("option",{value:"alta",children:"Alta"}),e.jsx("option",{value:"urgente",children:"Urgente"})]})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label",children:"Descripci√≥n"}),e.jsx("textarea",{className:"form-control",rows:"3",value:n.description,onChange:a=>c(o=>({...o,description:a.target.value})),placeholder:"Descripci√≥n detallada del proyecto..."})]})]})}):e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h6",{children:["Proyectos de ",d==null?void 0:d.name]}),e.jsx("button",{type:"button",className:"btn btn-primary btn-sm",onClick:()=>x(),children:"+ Nuevo Proyecto"})]}),f?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})}),e.jsx("p",{className:"mt-2 text-muted",children:"Cargando proyectos..."})]}):w.length>0?e.jsx("div",{className:"list-group",children:w.map(a=>e.jsx("div",{className:"list-group-item",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:a.name}),e.jsxs("p",{className:"mb-1 text-muted",children:["üìç ",a.location," | üè¢ ",a.sector||"Sin sector"," | üìä ",a.status||"Sin estado"]}),a.description&&e.jsx("small",{className:"text-muted",children:a.description})]}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>{j(o=>({...o,project_id:a.id})),typeof r=="function"&&r({...b,project_id:a.id,project:a,project_name:a.name,location:a.location}),p()},children:"Seleccionar"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{console.log("üîç Bot√≥n editar clickeado para proyecto:",a),x(a)},title:"Editar proyecto",children:"‚úèÔ∏è"})]})]})},a.id))}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-muted",children:"No hay proyectos para este cliente"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>x(),children:"Crear Primer Proyecto"})]})]})}),e.jsx("div",{className:"modal-footer",children:h?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>x(),children:"‚Üê Volver a Lista"}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:p,children:"Cancelar"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:F,disabled:f||!n.name||!n.location,children:f?"Guardando...":"Guardar Cambios"})]}):e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:p,children:"Cerrar"})})]})})}),document.body)]})}export{D as C};
//# sourceMappingURL=CompanyProjectPicker-BsZ_ZGoi.js.map
