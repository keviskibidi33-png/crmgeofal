{"version":3,"file":"Exportaciones-CkhC4nDM.js","sources":["../../src/services/exports.js","../../src/services/exportsHistory.js","../../src/pages/Exportaciones.jsx"],"sourcesContent":["// File download helpers for export endpoints\r\nexport async function exportExcel({ type = 'leads' } = {}) {\r\n  const base = (import.meta.env?.VITE_API_URL || '').replace(/\\/$/, '');\r\n  const path = '/api/export/excel?type=' + encodeURIComponent(type);\r\n  const url = base ? base + path : path;\r\n  const token = localStorage.getItem('token');\r\n  const res = await fetch(url, {\r\n    method: 'GET',\r\n    headers: token ? { Authorization: `Bearer ${token}` } : {},\r\n  });\r\n  if (!res.ok) throw new Error('No se pudo exportar Excel');\r\n  const blob = await res.blob();\r\n  const a = document.createElement('a');\r\n  a.href = URL.createObjectURL(blob);\r\n  a.download = `reporte_${type}.xlsx`;\r\n  document.body.appendChild(a);\r\n  a.click();\r\n  a.remove();\r\n}\r\n\r\nexport async function exportPDF({ type = 'leads' } = {}) {\r\n  const base = (import.meta.env?.VITE_API_URL || '').replace(/\\/$/, '');\r\n  const path = '/api/export/pdf?type=' + encodeURIComponent(type);\r\n  const url = base ? base + path : path;\r\n  const token = localStorage.getItem('token');\r\n  const res = await fetch(url, {\r\n    method: 'GET',\r\n    headers: token ? { Authorization: `Bearer ${token}` } : {},\r\n  });\r\n  if (!res.ok) throw new Error('No se pudo exportar PDF');\r\n  const blob = await res.blob();\r\n  const a = document.createElement('a');\r\n  a.href = URL.createObjectURL(blob);\r\n  a.download = `reporte_${type}.pdf`;\r\n  document.body.appendChild(a);\r\n  a.click();\r\n  a.remove();\r\n}\r\n\r\nexport default { exportExcel, exportPDF };\r\n","import { apiFetch } from './api';\r\n\r\nexport const listExportHistory = (params = {}) => {\r\n  const sp = new URLSearchParams();\r\n  if (params.page) sp.set('page', params.page);\r\n  if (params.limit) sp.set('limit', params.limit);\r\n  if (params.q) sp.set('q', params.q);\r\n  if (params.type) sp.set('type', params.type);\r\n  if (params.range) sp.set('range', params.range);\r\n  const qs = sp.toString();\r\n  return apiFetch('/api/export/history' + (qs ? `?${qs}` : ''));\r\n};\r\n\r\nexport default { listExportHistory };\r\n","import React from 'react';\r\nimport ModuloBase from '../components/ModuloBase';\r\nimport DataTable from '../components/DataTable';\r\nimport Toolbar from '../components/Toolbar';\r\nimport { exportExcel, exportPDF } from '../services/exports';\r\nimport { useQuery } from 'react-query';\r\nimport { listExportHistory } from '../services/exportsHistory';\r\n\r\nexport default function Exportaciones() {\r\n  const [q, setQ] = React.useState('');\r\n  const [type, setType] = React.useState('');\r\n  const [range, setRange] = React.useState('30');\r\n  const [downloading, setDownloading] = React.useState(false);\r\n  const [page, setPage] = React.useState(1);\r\n  const [limit] = React.useState(10);\r\n  const { data, isLoading } = useQuery(['export-history', { page, limit, q, type, range }], async () => {\r\n    const resp = await listExportHistory({ page, limit, q, type, range });\r\n    const rows = Array.isArray(resp?.data) ? resp.data : (resp?.rows || resp || []);\r\n    const total = Number(resp?.total || rows.length || 0);\r\n    return { rows, total };\r\n  }, { keepPreviousData: true });\r\n  const rows = data?.rows || [];\r\n  const total = data?.total || 0;\r\n  const totalPages = Math.max(1, Math.ceil(total / limit));\r\n  const onClear = () => { setQ(''); setType(''); setRange('30'); setPage(1); };\r\n\r\n  return (\r\n    <ModuloBase titulo=\"Exportaciones\" descripcion=\"Historial de exportaciones realizadas (PDF/Excel/CSV).\">\r\n      <Toolbar\r\n        compact\r\n        left={(\r\n          <>\r\n            <input\r\n              className=\"form-control\"\r\n              style={{ minWidth: 220 }}\r\n              placeholder=\"Buscar por recurso o usuario\"\r\n              value={q}\r\n              onChange={e => setQ(e.target.value)}\r\n            />\r\n            <select className=\"form-select\" value={type} onChange={e => setType(e.target.value)}>\r\n              <option value=\"\">Todos los tipos</option>\r\n              <option value=\"pdf\">PDF</option>\r\n              <option value=\"xlsx\">Excel</option>\r\n              <option value=\"csv\">CSV</option>\r\n            </select>\r\n            <select className=\"form-select\" value={range} onChange={e => setRange(e.target.value)}>\r\n              <option value=\"7\">Últimos 7 días</option>\r\n              <option value=\"30\">Últimos 30 días</option>\r\n              <option value=\"90\">Últimos 90 días</option>\r\n              <option value=\"all\">Todo</option>\r\n            </select>\r\n          </>\r\n        )}\r\n        right={(\r\n          <>\r\n            <button className=\"btn btn-outline-secondary\" onClick={onClear}>Limpiar</button>\r\n            <div className=\"vr mx-2\" />\r\n            <button className=\"btn btn-success\" disabled={!type || downloading}\r\n                    onClick={async ()=>{ try { setDownloading(true); await exportExcel({ type }); } finally { setDownloading(false); } }}>\r\n              {downloading ? 'Descargando...' : 'Exportar Excel'}\r\n            </button>\r\n            <button className=\"btn btn-danger\" disabled={!type || downloading}\r\n                    onClick={async ()=>{ try { setDownloading(true); await exportPDF({ type }); } finally { setDownloading(false); } }}>\r\n              {downloading ? 'Descargando...' : 'Exportar PDF'}\r\n            </button>\r\n          </>\r\n        )}\r\n      />\r\n      <DataTable\r\n        columns={[\r\n          { header: 'ID', key: 'id', width: 80 },\r\n          { header: 'Tipo', key: 'type' },\r\n          { header: 'Recurso', key: 'resource' },\r\n          { header: 'Fecha', key: 'created_at', render: r => (r.created_at ? String(r.created_at).slice(0,19).replace('T',' ') : '—'), width: 160 },\r\n          { header: 'Usuario', key: 'user_name' },\r\n        ]}\r\n        rows={rows}\r\n        loading={isLoading}\r\n      />\r\n      <div className=\"d-flex justify-content-between align-items-center mt-2\">\r\n        <div className=\"text-muted small\">Total: {total}</div>\r\n        <div className=\"btn-group\">\r\n          <button className=\"btn btn-outline-secondary\" disabled={page<=1 || isLoading} onClick={()=>setPage(p=>Math.max(1,p-1))}>Anterior</button>\r\n          <span className=\"btn btn-outline-secondary disabled\">{page}/{totalPages}</span>\r\n          <button className=\"btn btn-outline-secondary\" disabled={page>=totalPages || isLoading} onClick={()=>setPage(p=>Math.min(totalPages,p+1))}>Siguiente</button>\r\n        </div>\r\n      </div>\r\n    </ModuloBase>\r\n  );\r\n}\r\n"],"names":["exportExcel","type","base","path","url","token","res","blob","a","exportPDF","listExportHistory","params","sp","qs","apiFetch","Exportaciones","q","setQ","React","setType","range","setRange","downloading","setDownloading","page","setPage","limit","data","isLoading","useQuery","resp","rows","total","totalPages","onClear","jsxs","ModuloBase","jsx","Toolbar","Fragment","e","DataTable","r","p"],"mappings":"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"}