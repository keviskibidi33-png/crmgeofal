import{a as V,r as c,b as w,j as e,B as h,A as q,F as M,$ as H,a0 as $,n as J,m as K,V as I,C as W}from"./index-_ax5caxz.js";import{C as A,R as m}from"./Row-DUT7dzcT.js";import{S as Q}from"./Spinner-CWz_2665.js";import{A as X}from"./Alert-e0x4JDT9.js";import{C as r}from"./Col-DhWa0-63.js";import{F as n}from"./Form-Bfp_I-3p.js";import{C as i}from"./Card-DX68ND5N.js";import{T as Y}from"./Table-D6NZfay2.js";import{M as j}from"./Modal-CGO4qTye.js";import"./ElementChildren-B77MQmQf.js";const de=()=>{const{user:Z}=V(),[u,k]=c.useState([]),[y,G]=c.useState([]),[C,p]=c.useState(!0),[z,v]=c.useState(null),[o,g]=c.useState({status:"",vendedor:"",cliente:""}),[O,f]=c.useState(!1),[N,D]=c.useState(null),[P,B]=c.useState(null),[l,x]=c.useState({invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],invoice_amount:"",notes:""});c.useEffect(()=>{_()},[]);const _=async()=>{try{p(!0),v(null);const s=await w("/api/projects/for-invoicing");k(s||[]);const t=await w("/api/quotes/with-projects");G(t||[])}catch(s){console.error("Error fetching data:",s),v("Error al cargar los datos: "+(s.message||"Error desconocido"))}finally{p(!1)}},E=s=>{const a={borrador:{variant:"warning",text:"Borrador"},aprobada:{variant:"success",text:"Aprobada"},facturada:{variant:"info",text:"Facturada"},activo:{variant:"primary",text:"Activo"},completado:{variant:"success",text:"Completado"}}[s]||{variant:"secondary",text:s};return e.jsx(W,{bg:a.variant,children:a.text})},F=s=>{const t=y.filter(a=>a.project_id===s.id);return t.length===0?"sin_cotizaciones":t.some(a=>a.status==="facturada")?"completado":t.some(a=>a.status==="aprobada")?"en_proceso":t.some(a=>a.status==="borrador")?"pendiente":"activo"},S=s=>{const t=y.filter(a=>a.project_id===s.id);return{totalQuotes:t.length,approvedQuotes:t.filter(a=>a.status==="aprobada").length,invoicedQuotes:t.filter(a=>a.status==="facturada").length,totalAmount:t.reduce((a,b)=>a+(b.total||0),0),lastActivity:t.length>0?new Date(Math.max(...t.map(a=>new Date(a.updated_at)))):new Date(s.updated_at)}},T=u.filter(s=>{var t,a;return!(o.status&&F(s)!==o.status||o.vendedor&&!((t=s.created_by_name)!=null&&t.toLowerCase().includes(o.vendedor.toLowerCase()))||o.cliente&&!((a=s.company_name)!=null&&a.toLowerCase().includes(o.cliente.toLowerCase())))}),U=async()=>{try{p(!0),v(null);const s=new FormData;s.append("project_id",N.id),s.append("invoice_number",l.invoice_number),s.append("invoice_date",l.invoice_date),s.append("invoice_amount",l.invoice_amount),s.append("notes",l.notes),P&&s.append("invoice_file",P),await w("/api/projects/upload-invoice",{method:"POST",body:s}),f(!1),D(null),B(null),x({invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],invoice_amount:"",notes:""}),await _()}catch(s){v("Error al subir factura: "+(s.message||"Error desconocido"))}finally{p(!1)}},R=s=>{D(s);const t=S(s);x(a=>({...a,invoice_amount:t.totalAmount.toString()})),f(!0)};return C?e.jsx(A,{className:"py-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Q,{animation:"border"}),e.jsx("p",{className:"mt-2",children:"Cargando proyectos para facturación..."})]})}):z?e.jsx(A,{className:"py-4",children:e.jsx(X,{variant:"danger",children:z})}):e.jsxs(A,{className:"py-4",children:[e.jsxs(m,{className:"mb-4",children:[e.jsxs(r,{children:[e.jsx("h2",{children:"💰 Facturación de Proyectos"}),e.jsx("p",{className:"text-muted",children:"Proyectos listos para facturar"})]}),e.jsx(r,{md:"auto",children:e.jsxs(h,{variant:"outline-secondary",onClick:_,children:[e.jsx(q,{className:"me-2"}),"Actualizar"]})})]}),e.jsxs(m,{className:"mb-4",children:[e.jsx(r,{md:3,children:e.jsxs(n.Select,{value:o.status,onChange:s=>g(t=>({...t,status:s.target.value})),children:[e.jsx("option",{value:"",children:"Todos los estados"}),e.jsx("option",{value:"pendiente",children:"Pendiente"}),e.jsx("option",{value:"en_proceso",children:"En Proceso"}),e.jsx("option",{value:"completado",children:"Completado"}),e.jsx("option",{value:"sin_cotizaciones",children:"Sin Cotizaciones"})]})}),e.jsx(r,{md:3,children:e.jsx(n.Control,{type:"text",placeholder:"Filtrar por vendedor...",value:o.vendedor,onChange:s=>g(t=>({...t,vendedor:s.target.value}))})}),e.jsx(r,{md:3,children:e.jsx(n.Control,{type:"text",placeholder:"Filtrar por cliente...",value:o.cliente,onChange:s=>g(t=>({...t,cliente:s.target.value}))})}),e.jsx(r,{md:3,children:e.jsx("div",{className:"d-flex gap-2",children:e.jsx(h,{variant:"outline-secondary",onClick:()=>g({status:"",vendedor:"",cliente:""}),children:"Limpiar"})})})]}),e.jsxs(m,{className:"mb-4",children:[e.jsx(r,{md:3,children:e.jsx(i,{className:"text-center",children:e.jsxs(i.Body,{children:[e.jsx(M,{size:24,className:"text-primary mb-2"}),e.jsx("h4",{children:u.length}),e.jsx("small",{className:"text-muted",children:"Total Proyectos"})]})})}),e.jsx(r,{md:3,children:e.jsx(i,{className:"text-center",children:e.jsxs(i.Body,{children:[e.jsx(H,{size:24,className:"text-success mb-2"}),e.jsx("h4",{children:u.filter(s=>F(s)==="en_proceso").length}),e.jsx("small",{className:"text-muted",children:"En Proceso"})]})})}),e.jsx(r,{md:3,children:e.jsx(i,{className:"text-center",children:e.jsxs(i.Body,{children:[e.jsx($,{size:24,className:"text-info mb-2"}),e.jsxs("h4",{children:["S/ ",u.reduce((s,t)=>{const a=S(t);return s+a.totalAmount},0).toFixed(2)]}),e.jsx("small",{className:"text-muted",children:"Monto Total"})]})})}),e.jsx(r,{md:3,children:e.jsx(i,{className:"text-center",children:e.jsxs(i.Body,{children:[e.jsx(J,{size:24,className:"text-warning mb-2"}),e.jsx("h4",{children:new Set(u.map(s=>s.created_by_name)).size}),e.jsx("small",{className:"text-muted",children:"Vendedores Asignados"})]})})})]}),e.jsx(m,{children:T.length===0?e.jsx(r,{children:e.jsx(i,{children:e.jsxs(i.Body,{className:"text-center py-5",children:[e.jsx(M,{size:48,className:"text-muted mb-3"}),e.jsx("h5",{children:"No hay proyectos"}),e.jsx("p",{className:"text-muted",children:Object.values(o).some(s=>s)?"No se encontraron proyectos con los filtros aplicados":"No hay proyectos listos para facturar"})]})})}):T.map(s=>{const t=S(s),a=F(s),b=y.filter(d=>d.project_id===s.id);return e.jsx(r,{md:6,lg:4,className:"mb-3",children:e.jsxs(i,{children:[e.jsxs(i.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:s.name}),E(a)]}),e.jsxs(i.Body,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Cliente:"})," ",s.company_name||"N/A"]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Vendedor:"})," ",s.created_by_name||"N/A"]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Ubicación:"})," ",s.location||"N/A"]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Descripción:"})," ",s.description||"Sin descripción"]}),e.jsx("hr",{}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Cotizaciones:"})," ",t.totalQuotes]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Monto Total:"})," S/ ",t.totalAmount.toFixed(2)]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Última Actividad:"})," ",t.lastActivity.toLocaleDateString()]}),b.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h6",{children:"Cotizaciones del Proyecto:"}),e.jsxs(Y,{size:"sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Número"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Monto"})]})}),e.jsx("tbody",{children:b.map(d=>{var L;return e.jsxs("tr",{children:[e.jsx("td",{children:d.quote_number||`COT-${d.id}`}),e.jsx("td",{children:E(d.status)}),e.jsxs("td",{children:["S/ ",((L=d.total)==null?void 0:L.toFixed(2))||"0.00"]})]},d.id)})})]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-3",children:[e.jsxs(h,{variant:"outline-primary",size:"sm",onClick:()=>{window.location.href=`/proyectos/${s.id}`},children:[e.jsx(K,{className:"me-1"}),"Ver Detalles"]}),a==="en_proceso"&&e.jsxs(h,{variant:"success",size:"sm",onClick:()=>R(s),children:[e.jsx(I,{className:"me-1"}),"Adjuntar Factura"]})]})]})]})},s.id)})}),e.jsxs(j,{show:O,onHide:()=>f(!1),size:"lg",children:[e.jsx(j.Header,{closeButton:!0,children:e.jsx(j.Title,{children:"Adjuntar Factura"})}),e.jsxs(j.Body,{children:[N&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("h6",{children:["Proyecto: ",N.name]}),e.jsxs("p",{className:"text-muted",children:["Cliente: ",N.company_name]})]}),e.jsxs(m,{children:[e.jsx(r,{md:6,children:e.jsxs(n.Group,{className:"mb-3",children:[e.jsx(n.Label,{children:"Número de Factura *"}),e.jsx(n.Control,{type:"text",value:l.invoice_number,onChange:s=>x(t=>({...t,invoice_number:s.target.value})),required:!0})]})}),e.jsx(r,{md:6,children:e.jsxs(n.Group,{className:"mb-3",children:[e.jsx(n.Label,{children:"Fecha de Factura *"}),e.jsx(n.Control,{type:"date",value:l.invoice_date,onChange:s=>x(t=>({...t,invoice_date:s.target.value})),required:!0})]})})]}),e.jsxs(m,{children:[e.jsx(r,{md:6,children:e.jsxs(n.Group,{className:"mb-3",children:[e.jsx(n.Label,{children:"Monto de Factura (S/) *"}),e.jsx(n.Control,{type:"number",step:"0.01",value:l.invoice_amount,onChange:s=>x(t=>({...t,invoice_amount:s.target.value})),required:!0})]})}),e.jsx(r,{md:6,children:e.jsxs(n.Group,{className:"mb-3",children:[e.jsx(n.Label,{children:"Archivo de Factura"}),e.jsx(n.Control,{type:"file",accept:".pdf,.jpg,.jpeg,.png",onChange:s=>B(s.target.files[0])})]})})]}),e.jsx(m,{children:e.jsx(r,{children:e.jsxs(n.Group,{className:"mb-3",children:[e.jsx(n.Label,{children:"Notas"}),e.jsx(n.Control,{as:"textarea",rows:3,value:l.notes,onChange:s=>x(t=>({...t,notes:s.target.value}))})]})})})]}),e.jsxs(j.Footer,{children:[e.jsx(h,{variant:"secondary",onClick:()=>f(!1),children:"Cancelar"}),e.jsx(h,{variant:"success",onClick:U,disabled:C,children:C?e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:"sm",className:"me-2"}),"Subiendo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"me-2"}),"Adjuntar Factura"]})})]})]})]})};export{de as default};
//# sourceMappingURL=FacturacionProyectos-odLE57nq.js.map
