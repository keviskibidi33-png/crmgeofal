import{r as o,R as Q,j as e,n as q,o as J,k as T,E as K,p as X,q as Fe,K as de,w as Xe,s as we,B as P,L as Ye,c as Re,M as Ue,f as Ze,g as es,N as ss,O as De,P as as,Q as ts,S as is,T as ls,U as ns,V as os,u as rs,e as ne,x as oe,W as cs,y as ds,h as Ee,C as _,I as ms,X as us,J as ze}from"./index-BlIitoHL.js";import{D as ps}from"./DataTable-2PUODnU_.js";/* empty css                     */import{S as V}from"./StatsCard-WhbJamxe.js";import{C as hs}from"./ConfirmModal-D99OSnvZ.js";import{M as $}from"./Modal-dJieHQcT.js";import{u as xs,c as fs,a as gs,d as js,l as bs,g as vs,b as Ns}from"./companies-DFLu3Col.js";import{A as Cs}from"./Alert-jxPGzPb8.js";import{S as ys}from"./Spinner-mZzrAUCv.js";import{C as Ss,a as ws}from"./ClientSuccessModal-COOAwdU7.js";import{g as Es,c as zs,a as ks,b as Fs,d as Rs,e as Ds,l as Ts}from"./authHelper-BtdtwZok.js";import{C as Ps,R as Is}from"./Row-AGWrTK1L.js";import{C as W}from"./Col-EOfTAxlS.js";import{C as re}from"./Card-DEKILsJ8.js";/* empty css                  */import"./InputGroup-DhbmGhYe.js";import"./Form-GUezvg6j.js";import"./ElementChildren-D0KhXBLv.js";import"./Table-D_RrkMYP.js";import"./Tabs-CwsjqVR5.js";const Ms=[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}],Os=[{value:"construccion",label:"Construcción"},{value:"mineria",label:"Minería"},{value:"servicios",label:"Servicios"},{value:"comercio",label:"Comercio"},{value:"industria",label:"Industria"},{value:"gobierno",label:"Gobierno"},{value:"otro",label:"Otro"}],qs=[{value:"lima",label:"Lima"},{value:"arequipa",label:"Arequipa"},{value:"trujillo",label:"Trujillo"},{value:"chiclayo",label:"Chiclayo"},{value:"piura",label:"Piura"},{value:"cusco",label:"Cusco"},{value:"otro",label:"Otra"}],Ls=[{value:"urgent",label:"URGENTE"},{value:"high",label:"ALTA"},{value:"normal",label:"NORMAL"},{value:"low",label:"BAJA"}],As=({show:E,onHide:p,data:i={},onSubmit:R,loading:b=!1,isEditing:N=!1})=>{const[l,I]=o.useState({type:i.type||"empresa",name:i.name||"",ruc:i.ruc||"",dni:i.dni||"",contact_name:i.contact_name||"",email:i.email||"",phone:i.phone||"",address:i.address||"",city:i.city||"lima",sector:i.sector||"servicios",priority:i.priority||"normal",actividad:i.actividad||"",servicios:i.servicios||""}),[c,g]=o.useState({});Q.useEffect(()=>{if(E){const s=!i.id;I({type:i.type||"empresa",name:s?"":i.name||"",ruc:s?"":i.ruc||"",dni:s?"":i.dni||"",contact_name:s?"":i.contact_name||"",email:s?"":i.email||"",phone:s?"":i.phone||"",address:s?"":i.address||"",city:i.city||"lima",sector:i.sector||"servicios",priority:i.priority||"normal",actividad:s?"":i.actividad||"",servicios:s?"":i.servicios||""}),g({})}},[E,i,N]);const m=(s,h)=>{I(u=>({...u,[s]:h})),s==="ruc"&&l.type==="empresa"&&(h&&!j(h)?g(u=>({...u,ruc:"El RUC debe empezar con 20 o 209999999 y tener 11 dígitos"})):g(u=>({...u,ruc:""}))),s==="dni"&&l.type==="persona"&&(h&&!z(h)?g(u=>({...u,dni:"El DNI debe tener exactamente 8 dígitos"})):g(u=>({...u,dni:""}))),s==="phone"&&(h&&!C(h)?g(u=>({...u,phone:"El teléfono debe tener 9 dígitos"})):g(u=>({...u,phone:""}))),c[s]&&s!=="ruc"&&s!=="dni"&&g(u=>({...u,[s]:""}))},j=s=>s?/^(20|209999999)\d{9}$/.test(s):!1,z=s=>s?/^\d{8}$/.test(s):!1,C=s=>s?/^\d{9}$/.test(s):!0,D=()=>{const s={};return l.name.trim()||(s.name="El nombre/razón social es requerido"),l.type==="empresa"&&(l.ruc.trim()?j(l.ruc)||(s.ruc="El RUC debe empezar con 20 o 209999999 y tener 11 dígitos"):s.ruc="El RUC es requerido para empresas"),l.type==="persona"&&(l.dni.trim()?z(l.dni)||(s.dni="El DNI debe tener exactamente 8 dígitos"):s.dni="El DNI es requerido para personas naturales"),l.email&&!/\S+@\S+\.\S+/.test(l.email)&&(s.email="El email no es válido"),l.phone&&!C(l.phone)&&(s.phone="El teléfono debe tener 9 dígitos"),g(s),Object.keys(s).length===0},k=s=>{if(s.preventDefault(),D()){const h={...l};h.type==="empresa"?delete h.dni:delete h.ruc,R(h)}};return Q.useEffect(()=>{i.error&&(i.error.includes("email")||i.error.includes("Email"))&&g(s=>({...s,email:"Este email ya está registrado"}))},[i.error]),E?e.jsx("div",{className:"client-form-backdrop",onClick:p,children:e.jsxs("div",{className:"client-form-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"client-form-header",children:[e.jsxs("h4",{children:[e.jsx(q,{className:"client-form-icon"}),N?"Editar Cliente":"Nuevo Cliente"]}),e.jsx("button",{className:"close-btn",onClick:p,children:e.jsx(J,{})})]}),e.jsxs("form",{onSubmit:k,className:"client-form-body",children:[e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(q,{className:"client-form-icon"}),"Información Básica"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(T,{className:"client-form-icon"}),"Tipo de Cliente ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("select",{className:"client-form-select",value:l.type,onChange:s=>m("type",s.target.value),children:Ms.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(K,{className:"client-form-icon"}),"Nombre/Razón Social ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${c.name?"error":""}`,value:l.name,onChange:s=>m("name",s.target.value),placeholder:"Ingresa el nombre o razón social"}),c.name&&e.jsx("div",{className:"client-form-error",children:c.name})]})]}),e.jsxs("div",{className:"client-form-row",children:[l.type==="empresa"?e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(T,{className:"client-form-icon"}),"RUC ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${c.ruc?"error":l.ruc&&j(l.ruc)?"valid":""}`,value:l.ruc,onChange:s=>m("ruc",s.target.value),placeholder:"20123456789",maxLength:"11"}),c.ruc&&e.jsx("div",{className:"client-form-error",children:c.ruc}),e.jsx("div",{className:"client-form-help",children:"Solo para empresas - Debe empezar con 20 y tener 11 dígitos"})]}):e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(q,{className:"client-form-icon"}),"DNI ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${c.dni?"error":l.dni&&z(l.dni)?"valid":""}`,value:l.dni,onChange:s=>m("dni",s.target.value),placeholder:"12345678",maxLength:"8"}),c.dni&&e.jsx("div",{className:"client-form-error",children:c.dni}),e.jsx("div",{className:"client-form-help",children:"Solo para personas naturales - Debe tener exactamente 8 dígitos"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(q,{className:"client-form-icon"}),"Nombre de Contacto"]}),e.jsx("input",{type:"text",className:"client-form-input",value:l.contact_name,onChange:s=>m("contact_name",s.target.value),placeholder:"Ingresa el nombre del contacto"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(X,{className:"client-form-icon"}),"Información de Contacto"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(X,{className:"client-form-icon"}),"Email"]}),e.jsx("input",{type:"email",className:`client-form-input ${c.email?"error":""}`,value:l.email,onChange:s=>m("email",s.target.value),placeholder:"contacto@empresa.com"}),c.email&&e.jsx("div",{className:"client-form-error",children:c.email})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(Fe,{className:"client-form-icon"}),"Teléfono"]}),e.jsx("input",{type:"tel",className:`client-form-input ${c.phone?"error":l.phone&&C(l.phone)?"valid":""}`,value:l.phone,onChange:s=>m("phone",s.target.value),placeholder:"930238631",maxLength:"9"}),c.phone&&e.jsx("div",{className:"client-form-error",children:c.phone}),e.jsx("div",{className:"client-form-help",children:"Debe tener 9 dígitos"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(de,{className:"client-form-icon"}),"Información de Ubicación"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(de,{className:"client-form-icon"}),"Dirección"]}),e.jsx("input",{type:"text",className:"client-form-input",value:l.address,onChange:s=>m("address",s.target.value),placeholder:"Ingresa la dirección"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(T,{className:"client-form-icon"}),"Ciudad"]}),e.jsx("select",{className:"client-form-select",value:l.city,onChange:s=>m("city",s.target.value),children:qs.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(T,{className:"client-form-icon"}),"Sector"]}),e.jsx("select",{className:"client-form-select",value:l.sector,onChange:s=>m("sector",s.target.value),children:Os.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(K,{className:"client-form-icon"}),"Prioridad"]}),e.jsx("select",{className:"client-form-select",value:l.priority,onChange:s=>m("priority",s.target.value),children:Ls.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(T,{className:"client-form-icon"}),"Actividad y Servicios"]}),e.jsx("div",{className:"client-form-row single",children:e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(T,{className:"client-form-icon"}),"Actividad Principal"]}),e.jsx("textarea",{className:"client-form-input",value:l.actividad,onChange:s=>m("actividad",s.target.value),placeholder:"Describe la actividad principal de la empresa",rows:"3"}),e.jsx("div",{className:"client-form-help",children:"Describe brevemente a qué se dedica la empresa"})]})}),e.jsx("div",{className:"client-form-row single",children:e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(T,{className:"client-form-icon"}),"Servicios"]}),e.jsx("textarea",{className:"client-form-input",value:l.servicios,onChange:s=>m("servicios",s.target.value),placeholder:"Describe los servicios que ofrece o requiere la empresa",rows:"3"}),e.jsx("div",{className:"client-form-help",children:"Lista los servicios que ofrece o que necesita la empresa"})]})})]})]}),e.jsxs("div",{className:"client-form-actions",children:[e.jsxs("button",{type:"button",className:"client-form-btn client-form-btn-cancel",onClick:p,disabled:b,children:[e.jsx(J,{}),"Cancelar"]}),e.jsx("button",{type:"submit",className:"client-form-btn client-form-btn-create",onClick:k,disabled:b,children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})}),N?"Actualizando...":"Creando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Xe,{}),N?"Actualizar":"Crear"]})})]})]})}):null},_s=({show:E,onHide:p,action:i="realizar esta acción",requiredRole:R="administrador",currentRole:b="usuario"})=>e.jsxs($,{show:E,onHide:p,centered:!0,backdrop:"static",children:[e.jsxs($.Header,{className:"bg-danger text-white border-0",children:[e.jsxs($.Title,{className:"d-flex align-items-center",children:[e.jsx(we,{className:"me-2",size:20}),"Acceso Denegado"]}),e.jsx(P,{variant:"link",className:"text-white p-0 border-0",onClick:p,style:{fontSize:"1.5rem",lineHeight:1},children:e.jsx(J,{})})]}),e.jsx($.Body,{className:"py-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-3",children:e.jsx(Ye,{size:48,className:"text-warning"})}),e.jsxs("h5",{className:"text-danger mb-3",children:["No tienes permisos para ",i]}),e.jsx("div",{className:"alert alert-warning border-0 mb-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(we,{className:"me-2 text-warning",size:16}),e.jsxs("div",{children:[e.jsx("strong",{children:"Rol requerido:"})," ",R,e.jsx("br",{}),e.jsx("strong",{children:"Tu rol actual:"})," ",b]})]})}),e.jsx("p",{className:"text-muted mb-0",children:"Contacta al administrador del sistema si necesitas acceso a esta funcionalidad."})]})}),e.jsx($.Footer,{className:"border-0 justify-content-center",children:e.jsx(P,{variant:"secondary",onClick:p,className:"px-4",children:"Entendido"})})]}),ce={prospeccion:{label:"Prospección",icon:is,color:"secondary",bgColor:"#6c757d"},contactado:{label:"Contactado",icon:K,color:"primary",bgColor:"#007bff"},no_contesto:{label:"No contestó",icon:ts,color:"warning",bgColor:"#ffc107"},interesado:{label:"Interesado",icon:as,color:"info",bgColor:"#17a2b8"},pendiente_cotizacion:{label:"Pendiente de Cotización",icon:De,color:"warning",bgColor:"#ffc107"},cotizacion_enviada:{label:"Cotización Enviada",icon:ss,color:"info",bgColor:"#17a2b8"},negociacion:{label:"Negociación",icon:es,color:"secondary",bgColor:"#6c757d"},ganado:{label:"Ganado",icon:Ze,color:"success",bgColor:"#28a745"},perdido:{label:"Perdido",icon:J,color:"danger",bgColor:"#dc3545"},otro:{label:"Otro",icon:Ue,color:"light",bgColor:"#f8f9fa"}},$s=({clientId:E,currentStatus:p,onStatusChange:i,disabled:R=!1,size:b="sm",showLabel:N=!0})=>{const[l,I]=o.useState(!1),[c,g]=o.useState(""),[m,j]=o.useState(!1),[z,C]=o.useState({top:0,left:0}),D=o.useRef(null),k=o.useRef(null),s=Re(),h=()=>{if(D.current){const x=D.current.getBoundingClientRect();C({top:x.bottom+5,left:x.left})}j(!m)},u=x=>{m&&k.current&&!k.current.contains(x.target)&&D.current&&!D.current.contains(x.target)&&j(!1)};o.useEffect(()=>{if(m)return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[m]);const Y=async x=>{if(x!==p){console.log(`🔄 ClientStatusDropdown - Iniciando cambio de estado del cliente ${E} de '${p}' a '${x}'`),i==null||i(x),j(!1),I(!0),g("");try{console.log("🔄 ClientStatusDropdown - Llamando a updateClientStatus...");const F=await xs(E,x);console.log("✅ ClientStatusDropdown - Estado actualizado exitosamente:",F),s.invalidateQueries(["clients"]),s.invalidateQueries(["commercial-clients"]),s.invalidateQueries(["commercial-clients-with-totals"]),s.invalidateQueries("companiesList"),s.invalidateQueries("clientStats"),s.invalidateQueries("companyStats"),s.invalidateQueries("clientFilterOptions"),s.refetchQueries(["commercial-clients-with-totals"]),s.refetchQueries(["clients"])}catch(F){console.error("❌ ClientStatusDropdown - Error al actualizar estado:",F),g(F.message||"Error al actualizar estado"),console.log(`🔄 ClientStatusDropdown - Revirtiendo estado a '${p}'`),i==null||i(p)}finally{I(!1)}}},O=ce[p]||ce.prospeccion,L=O.icon,U=m&&ls.createPortal(e.jsx("div",{ref:k,className:"dropdown-menu show",style:{position:"fixed",top:z.top,left:z.left,zIndex:99999,minWidth:"200px",maxHeight:"300px",overflowY:"auto",boxShadow:"0 0.5rem 1rem rgba(0, 0, 0, 0.15)",border:"1px solid rgba(0, 0, 0, 0.15)",borderRadius:"0.375rem",backgroundColor:"white"},children:Object.entries(ce).map(([x,F])=>{const B=F.icon,n=x===p;return e.jsxs("button",{className:`dropdown-item d-flex align-items-center gap-2 ${n?"active":""}`,onClick:()=>Y(x),disabled:n,style:{border:"none",background:n?F.bgColor:"transparent",color:n?"white":"#212529",width:"100%",textAlign:"left",padding:"0.5rem 1rem",cursor:"pointer"},onMouseEnter:M=>{n||(M.target.style.backgroundColor="#f8f9fa")},onMouseLeave:M=>{n||(M.target.style.backgroundColor="transparent")},children:[e.jsx(B,{size:14}),e.jsx("span",{children:F.label}),n&&e.jsx(ns,{size:14,className:"ms-auto"})]},x)})}),document.body);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-status-dropdown",children:[c&&e.jsx(Cs,{variant:"danger",className:"mb-2",style:{fontSize:"0.8rem"},children:c}),e.jsxs("button",{ref:D,className:`btn btn-${O.color} btn-${b} d-flex align-items-center gap-1`,onClick:h,disabled:R||l,style:{backgroundColor:O.bgColor,borderColor:O.bgColor,minWidth:"140px"},children:[l?e.jsx(ys,{animation:"border",size:"sm"}):e.jsxs(e.Fragment,{children:[e.jsx(L,{size:14}),N&&e.jsx("span",{children:O.label})]}),e.jsx(os,{size:12})]})]}),U]})},ke={id:null,type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:"",city:"",sector:"",priority:"normal",actividad:"",servicios:""};function da(){var ye,Se;const[E,p]=o.useState(!1),[i,R]=o.useState(null),[b,N]=o.useState(null),[l,I]=o.useState(!1),[c,g]=o.useState(null),[m,j]=o.useState(!1),[z,C]=o.useState({}),[D,k]=o.useState(!1),[s,h]=o.useState(""),[u,Y]=o.useState("success"),[O,L]=o.useState(!1),[U,x]=o.useState(null),[F,B]=o.useState(!1),n=Es(),M=zs(),me=ks(),H=Fs(),ue=Rs(),pe=Ds();Q.useEffect(()=>{Ts()},[]);const[Z,ee]=o.useState(1),[he,xe]=o.useState(""),[se,Te]=o.useState(""),[ae,Pe]=o.useState(""),[te,Ie]=o.useState(""),[Me,fe]=o.useState(!1),ie=Re(),ge=rs(),{data:v,isLoading:Oe,refetch:qe}=ne(["clients",Z,he,se,ae,te],()=>bs({page:Z,limit:20,search:he,type:se,city:ae,sector:te}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:f,isLoading:G,error:Qs}=ne(["clientStats"],vs,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4});Q.useEffect(()=>{f&&f.data&&console.log("✅ Estadísticas cargadas correctamente:",{total:f.data.total,empresas:f.data.empresas,personas:f.data.personas})},[f]);const{data:y,isLoading:Bs}=ne(["clientFilterOptions"],Ns,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:6e4,cacheTime:3e5});Q.useEffect(()=>{y&&y.data&&console.log("✅ Opciones de filtros cargadas correctamente:",{types:y.data.types,sectors:y.data.sectors,cities:y.data.cities})},[y]);const Le=(a,t="success")=>{h(a),Y(t),k(!0),setTimeout(()=>{k(!1)},5e3)},le=a=>{ie.invalidateQueries("clients"),ie.invalidateQueries("clientStats"),ie.invalidateQueries("clientFilterOptions"),p(!1),R(null),N(null),Le(a,"success")},Ae=a=>{console.log("🔍 handleSearch - Búsqueda:",a),xe(a),ee(1),fe(!0),setTimeout(()=>fe(!1),1e3)},_e=a=>{console.log("🔍 handleFilter - Filtros recibidos:",a),console.log("🔍 handleFilter - Estado actual:",{selectedType:se,selectedCity:ae,selectedSector:te});const t=a.type||"",r=a.city||"",d=a.sector||"";Object.keys(a).length===0&&(console.log("🔍 handleFilter - Limpiando todos los filtros y búsqueda"),xe("")),Te(t),Pe(r),Ie(d),ee(1),console.log("🔍 handleFilter - Nuevos valores aplicados:",{type:t,city:r,sector:d}),setTimeout(()=>{qe()},100)},$e=o.useMemo(()=>{var r,d,S;if(console.log("🔍 clientFilterOptions - filterOptionsData:",y),!y||!y.data)return console.log("🔍 clientFilterOptions - Usando opciones por defecto"),[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona_natural"}}]}];const a=y.data,t=[{title:"Por Tipo de Cliente",options:((r=a.types)==null?void 0:r.map(w=>({label:`${w.label} (${w.count})`,filter:{type:w.value}})))||[]},{title:"Por Sector",options:((d=a.sectors)==null?void 0:d.map(w=>({label:`${w.label} (${w.count})`,filter:{sector:w.value}})))||[]},{title:"Por Ciudad",options:((S=a.cities)==null?void 0:S.map(w=>({label:`${w.label} (${w.count})`,filter:{city:w.value}})))||[]}];return console.log("🔍 clientFilterOptions - Opciones generadas:",t),t},[y]),je=oe(fs,{onSuccess:a=>{x(a),B(!1),L(!0),le("Cliente creado exitosamente")},onError:a=>{console.error("Error creating client:",a),console.error("Error details:",{message:a.message,status:a.status,body:a.body})}}),be=oe(gs,{onSuccess:a=>{x(a),B(!0),L(!0),le("Cliente actualizado exitosamente")},onError:a=>console.error("Error updating client:",a)}),ve=oe(js,{onSuccess:()=>le("Cliente eliminado exitosamente"),onError:a=>console.error("Error deleting client:",a)}),Qe=()=>{if(!M){C({action:"crear clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(n==null?void 0:n.role)||"no autenticado"}),j(!0);return}R(ke),p(!0)},Ne=a=>{if(!me){C({action:"editar clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(n==null?void 0:n.role)||"no autenticado"}),j(!0);return}R(a),p(!0)},Ce=a=>{if(console.log("🔍 handleDelete - Verificando permisos:",{userCanDeleteClient:H,currentUserRole:n==null?void 0:n.role,currentUser:n}),!H){console.log("🚫 handleDelete - Permisos insuficientes, mostrando modal"),C({action:"eliminar clientes",requiredRole:"administrador",currentRole:(n==null?void 0:n.role)||"no autenticado"}),j(!0);return}console.log("✅ handleDelete - Permisos OK, procediendo con eliminación"),N(a)},Be=async()=>{try{await ve.mutateAsync(b.id),N(null)}catch(a){console.error("Error eliminando cliente:",a),N(null)}},He=a=>{if(!pe){C({action:"crear cotizaciones",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(n==null?void 0:n.role)||"no autenticado"}),j(!0);return}ge("/cotizaciones/inteligente",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city,ruc:a.ruc,dni:a.dni,email:a.email,phone:a.phone,contact_name:a.contact_name,address:a.address}}})},Ge=a=>{if(!ue){C({action:"ver historial de clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(n==null?void 0:n.role)||"no autenticado"}),j(!0);return}g(a),I(!0)},Ve=(a,t)=>{console.log(`Estado del cliente ${a} cambiado a: ${t}`)},We=async a=>{i.id?await be.mutateAsync({id:i.id,...a}):await je.mutateAsync(a)},Je=a=>{const r={empresa:{bg:"primary",text:"Empresa",icon:T},persona:{bg:"info",text:"Persona Natural",icon:q}}[a]||{bg:"secondary",text:a,icon:q},d=r.icon;return e.jsxs(_,{bg:r.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(d,{size:12,className:"me-1"}),r.text]})},Ke=[{header:"ID",accessor:"id",width:"50px"},{header:"Cliente",accessor:"name",width:"180px",render:(a,t)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:t.name}),e.jsxs("div",{className:"d-flex align-items-center gap-1 mt-1",children:[Je(t.type),t.ruc&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["RUC: ",t.ruc]}),t.dni&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["DNI: ",t.dni]})]})]})},{header:"Contacto",accessor:"contact",width:"150px",render:(a,t)=>e.jsxs("div",{children:[t.contact_name&&e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:t.contact_name}),t.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(X,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:t.email})]}),t.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(Fe,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:t.phone})]})]})},{header:"Ciudad",accessor:"city",width:"80px",render:a=>{const t=a||"No especificada";let r="secondary";switch(t){case"Lima":r="primary";break;case"Arequipa":r="info";break;case"Cusco":r="success";break;case"Trujillo":r="warning";break;case"Piura":r="danger";break;case"Chiclayo":r="info";break;case"Iquitos":r="success";break;case"Huancayo":r="warning";break;default:r="secondary"}return e.jsx(_,{bg:r,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:t})}},{header:"Sector",accessor:"sector",width:"80px",render:a=>{const r=(S=>S&&S.replace(/\s*\[PRIORIDAD:\s*\w+\]/g,"").trim()||"General")(a);let d="secondary";switch(r){case"Construcción":d="warning";break;case"Minería":d="dark";break;case"Ingeniería":d="primary";break;case"Laboratorio":d="info";break;case"Consultoría":d="success";break;case"Tecnología":d="primary";break;case"Ambiental":d="success";break;case"Geología":d="info";break;default:d="secondary"}return e.jsx(_,{bg:d,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:r})}},{header:"Estado",accessor:"status",width:"120px",render:(a,t)=>e.jsx($s,{clientId:t.id,currentStatus:t.status||"prospeccion",onStatusChange:r=>Ve(t.id,r),size:"sm",showLabel:!0})},{header:"Prioridad",accessor:"priority",width:"100px",render:(a,t)=>{const r=t.priority||"normal";let d="secondary",S="Normal";switch(r){case"urgent":d="danger",S="URGENTE";break;case"high":d="warning",S="ALTA";break;case"normal":d="info",S="NORMAL";break;case"low":d="secondary",S="BAJA";break}return e.jsx(_,{bg:d,className:"px-2 py-1",style:{fontSize:"0.7rem"},children:S})}},{header:"Gestor",accessor:"managed_by",width:"100px",render:(a,t)=>e.jsx("div",{className:"d-flex align-items-center",children:t.managed_by_name?e.jsxs(e.Fragment,{children:[e.jsx(K,{size:12,className:"me-1 text-success"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:t.managed_by_name}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:t.managed_by_role})]})]}):e.jsx("span",{className:"text-muted",style:{fontSize:"0.8rem"},children:"Sin asignar"})})},{header:"Dirección",accessor:"address",width:"120px",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(de,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin dirección"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,t)=>e.jsxs("div",{className:"d-flex gap-1",children:[me&&e.jsx(P,{variant:"outline-primary",size:"sm",onClick:()=>Ne(t),title:"Editar cliente",children:e.jsx(ms,{size:14})}),ue&&e.jsx(P,{variant:"outline-info",size:"sm",onClick:()=>Ge(t),title:"Ver historial de cotizaciones y proyectos",children:e.jsx(De,{size:14})}),pe&&e.jsx(P,{variant:"outline-success",size:"sm",onClick:()=>He(t),title:"Crear cotización para este cliente",children:e.jsx(us,{size:14})}),H&&e.jsx(P,{variant:"outline-danger",size:"sm",onClick:()=>Ce(t),title:"Eliminar cliente",children:e.jsx(ze,{size:14})}),!H&&e.jsx(P,{variant:"outline-secondary",size:"sm",onClick:()=>{console.log("🚫 Botón eliminar clickeado sin permisos"),C({action:"eliminar clientes",requiredRole:"administrador",currentRole:(n==null?void 0:n.role)||"no autenticado"}),j(!0)},title:"No tienes permisos para eliminar clientes",children:e.jsx(ze,{size:14})})]})}],A=o.useMemo(()=>{if(f&&f.data)return console.log("📊 Stats - Usando estadísticas reales del backend:",f),console.log("📊 Stats - Datos extraídos:",f.data),{total:f.data.total||0,empresas:f.data.empresas||0,personas:f.data.personas||0,conEmail:f.data.withEmail||0,conTelefono:f.data.withPhone||0};const a=(v==null?void 0:v.data)||[];return console.log("📊 Stats - Fallback: calculando desde página actual:",a),{total:a.length,empresas:a.filter(t=>t.type==="empresa").length,personas:a.filter(t=>t.type==="persona").length,conEmail:a.filter(t=>t.email).length,conTelefono:a.filter(t=>t.phone).length}},[f,v]);return e.jsx("div",{className:"clientes-page",children:e.jsxs(Ps,{fluid:!0,className:"h-100 d-flex flex-column p-0",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"mb-0 fw-bold",children:"Gestión de Clientes"}),e.jsx("small",{className:"text-muted",children:"Crear, editar y gestionar clientes del sistema"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[(n==null?void 0:n.role)==="admin"&&e.jsxs(P,{variant:"outline-success",size:"sm",onClick:()=>ge("/clientes/importar"),title:"Importar clientes desde archivo CSV",children:[e.jsx(cs,{className:"me-1"}),"Importar Clientes"]}),e.jsxs(P,{variant:"primary",size:"sm",onClick:Qe,disabled:!M,title:M?"Crear nuevo cliente":`No tienes permisos para crear clientes. Rol actual: ${(n==null?void 0:n.role)||"No autenticado"}`,children:[e.jsx(ds,{className:"me-1"}),"Nuevo Cliente"]})]})]}),!M&&e.jsx("div",{className:"alert alert-warning py-1 mb-1",role:"alert",children:e.jsxs("small",{children:[e.jsx("strong",{children:"⚠️ Permisos insuficientes:"})," Tu rol actual (",(n==null?void 0:n.role)||"No autenticado",") no tiene permisos para crear clientes."]})}),e.jsxs(Is,{className:"g-2 mb-3",children:[e.jsx(W,{md:6,lg:3,children:e.jsx(V,{title:"Total",value:A.total,icon:Ee,color:"primary",loading:G,size:"compact"})}),e.jsx(W,{md:6,lg:3,children:e.jsx(V,{title:"Empresas",value:A.empresas,icon:T,color:"success",loading:G,size:"compact"})}),e.jsx(W,{md:6,lg:3,children:e.jsx(V,{title:"Personas",value:A.personas,icon:q,color:"info",loading:G,size:"compact"})}),e.jsx(W,{md:6,lg:3,children:e.jsx(V,{title:"Con Email",value:A.conEmail,icon:X,color:"warning",loading:G,size:"compact"})})]}),e.jsxs(re,{className:"shadow-sm border-0 flex-grow-1 d-flex flex-column",children:[e.jsx(re.Header,{className:"bg-white border-bottom flex-shrink-0 py-2",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx(Ee,{className:"me-1 text-primary",size:16}),"Lista de Clientes"]}),e.jsxs(_,{bg:"light",text:"dark",className:"px-2 py-1",children:[A.total," clientes"]})]})}),e.jsx(re.Body,{className:"p-0 flex-grow-1 d-flex flex-column",children:e.jsx("div",{className:"client-table flex-grow-1 d-flex flex-column",children:e.jsx(ps,{data:(v==null?void 0:v.data)||[],columns:Ke,loading:Oe||Me,onEdit:Ne,onDelete:Ce,emptyMessage:"No hay clientes registrados",totalItems:((ye=v==null?void 0:v.pagination)==null?void 0:ye.total)||0,itemsPerPage:((Se=v==null?void 0:v.pagination)==null?void 0:Se.limit)||20,currentPage:Z,onPageChange:ee,onSearch:Ae,onFilter:_e,filterOptions:$e,sortable:!1,useFlexbox:!0})})})]}),e.jsx(As,{show:E,onHide:()=>p(!1),data:i||ke,onSubmit:We,loading:je.isLoading||be.isLoading,isEditing:!!(i!=null&&i.id)}),e.jsx(hs,{show:!!b,onHide:()=>N(null),onConfirm:Be,title:"Eliminar Cliente",message:`¿Estás seguro de que quieres eliminar el cliente "${b==null?void 0:b.name}"?`,confirmText:"Eliminar",variant:"danger",isLoading:ve.isLoading,alertMessage:"Esta acción eliminará permanentemente el cliente y todos sus datos asociados (proyectos, cotizaciones, etc.).",alertVariant:"danger"}),e.jsx(Ss,{show:l,onHide:()=>I(!1),clientId:c==null?void 0:c.id,clientName:c==null?void 0:c.name}),e.jsx(_s,{show:m,onHide:()=>j(!1),action:z.action,requiredRole:z.requiredRole,currentRole:z.currentRole}),e.jsx(ws,{show:O,onHide:()=>L(!1),clientData:U,isEdit:F}),D&&e.jsxs("div",{style:{position:"fixed",top:"20px",right:"20px",zIndex:99999,backgroundColor:u==="success"?"#28a745":"#dc3545",color:"white",padding:"15px 20px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",minWidth:"300px",border:"none"},onClick:()=>k(!1),children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:"5px"},children:u==="success"?"✅ Éxito":"❌ Error"}),e.jsx("div",{children:s})]})]})})}export{da as default};
//# sourceMappingURL=Clientes-DzYEvZBn.js.map
