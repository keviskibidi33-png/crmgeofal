import{r as x,R as U,j as e,n as R,o as M,k as D,E as Ce,p as X,q as Se,K as ie,w as We,s as fe,B as _,L as Ke,c as Ee,M as Ve,f as Y,g as ze,N as we,O as B,P as Ye,Q as Je,S as Ue,T as Xe,U as Ze,e as J,l as es,V as ss,W as V,F as ae,X as as,C as A,u as ts,x as te,y as ns,h as ge,I as is,Y as rs,J as be}from"./index-Cuktr-pt.js";import{D as ls}from"./DataTable-C6u_tpkV.js";/* empty css                     *//* empty css                  */import{C as cs}from"./ConfirmModal-BG0s3nBn.js";import{M as j}from"./Modal-DX3fBC5J.js";import{u as os,g as ds,c as ms,a as us,d as xs,l as hs,b as ps,e as js}from"./companies-CyyHtdeS.js";import{A as fs}from"./Alert-D03HJGca.js";import{S as gs}from"./Spinner-B39M6lL3.js";import{C as H}from"./Card-B0ZWfcwD.js";import{R as re,C as bs}from"./Row-DXxIMG7u.js";import{C as I}from"./Col-nNxAn9NL.js";import{T as Ns,a as Ne}from"./Tabs-HFhgAc8J.js";import{T as ve}from"./Table-BqADrEzs.js";/* empty css                  */import"./InputGroup-aBcikS0_.js";import"./Form-luTHskiS.js";import"./ElementChildren-CA6H3NXv.js";const vs=[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}],ys=[{value:"construccion",label:"Construcción"},{value:"mineria",label:"Minería"},{value:"servicios",label:"Servicios"},{value:"comercio",label:"Comercio"},{value:"industria",label:"Industria"},{value:"gobierno",label:"Gobierno"},{value:"otro",label:"Otro"}],Cs=[{value:"lima",label:"Lima"},{value:"arequipa",label:"Arequipa"},{value:"trujillo",label:"Trujillo"},{value:"chiclayo",label:"Chiclayo"},{value:"piura",label:"Piura"},{value:"cusco",label:"Cusco"},{value:"otro",label:"Otra"}],Ss=({show:o,onHide:c,data:t={},onSubmit:C,loading:f=!1,isEditing:y=!1})=>{const[r,z]=x.useState({type:t.type||"empresa",name:t.name||"",ruc:t.ruc||"",dni:t.dni||"",contact_name:t.contact_name||"",email:t.email||"",phone:t.phone||"",address:t.address||"",city:t.city||"lima",sector:t.sector||"servicios"}),[d,g]=x.useState({});U.useEffect(()=>{if(o){const s=!t.id;z({type:t.type||"empresa",name:s?"":t.name||"",ruc:s?"":t.ruc||"",dni:s?"":t.dni||"",contact_name:s?"":t.contact_name||"",email:s?"":t.email||"",phone:s?"":t.phone||"",address:s?"":t.address||"",city:t.city||"lima",sector:t.sector||"servicios"}),g({})}},[o,t,y]);const m=(s,h)=>{z(p=>({...p,[s]:h})),s==="ruc"&&r.type==="empresa"&&(h&&!i(h)?g(p=>({...p,ruc:"El RUC debe empezar con 20 y tener 11 dígitos"})):g(p=>({...p,ruc:""}))),s==="dni"&&r.type==="persona"&&(h&&!w(h)?g(p=>({...p,dni:"El DNI debe tener exactamente 8 dígitos"})):g(p=>({...p,dni:""}))),s==="phone"&&(h&&!b(h)?g(p=>({...p,phone:"El teléfono debe tener 9 dígitos"})):g(p=>({...p,phone:""}))),d[s]&&s!=="ruc"&&s!=="dni"&&g(p=>({...p,[s]:""}))},i=s=>s?/^20\d{9}$/.test(s):!1,w=s=>s?/^\d{8}$/.test(s):!1,b=s=>s?/^\d{9}$/.test(s):!0,l=()=>{const s={};return r.name.trim()||(s.name="El nombre/razón social es requerido"),r.type==="empresa"&&(r.ruc.trim()?i(r.ruc)||(s.ruc="El RUC debe empezar con 20 y tener 11 dígitos"):s.ruc="El RUC es requerido para empresas"),r.type==="persona"&&(r.dni.trim()?w(r.dni)||(s.dni="El DNI debe tener exactamente 8 dígitos"):s.dni="El DNI es requerido para personas naturales"),r.email&&!/\S+@\S+\.\S+/.test(r.email)&&(s.email="El email no es válido"),r.phone&&!b(r.phone)&&(s.phone="El teléfono debe tener 9 dígitos"),g(s),Object.keys(s).length===0},F=s=>{if(s.preventDefault(),l()){const h={...r};h.type==="empresa"?delete h.dni:delete h.ruc,C(h)}};return U.useEffect(()=>{t.error&&(t.error.includes("email")||t.error.includes("Email"))&&g(s=>({...s,email:"Este email ya está registrado"}))},[t.error]),o?e.jsx("div",{className:"client-form-backdrop",onClick:c,children:e.jsxs("div",{className:"client-form-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"client-form-header",children:[e.jsxs("h4",{children:[e.jsx(R,{className:"client-form-icon"}),y?"Editar Cliente":"Nuevo Cliente"]}),e.jsx("button",{className:"close-btn",onClick:c,children:e.jsx(M,{})})]}),e.jsxs("form",{onSubmit:F,className:"client-form-body",children:[e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(R,{className:"client-form-icon"}),"Información Básica"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Tipo de Cliente ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("select",{className:"client-form-select",value:r.type,onChange:s=>m("type",s.target.value),children:vs.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(Ce,{className:"client-form-icon"}),"Nombre/Razón Social ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${d.name?"error":""}`,value:r.name,onChange:s=>m("name",s.target.value),placeholder:"Ingresa el nombre o razón social"}),d.name&&e.jsx("div",{className:"client-form-error",children:d.name})]})]}),e.jsxs("div",{className:"client-form-row",children:[r.type==="empresa"?e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"RUC ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${d.ruc?"error":r.ruc&&i(r.ruc)?"valid":""}`,value:r.ruc,onChange:s=>m("ruc",s.target.value),placeholder:"20123456789",maxLength:"11"}),d.ruc&&e.jsx("div",{className:"client-form-error",children:d.ruc}),e.jsx("div",{className:"client-form-help",children:"Solo para empresas - Debe empezar con 20 y tener 11 dígitos"})]}):e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(R,{className:"client-form-icon"}),"DNI ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${d.dni?"error":r.dni&&w(r.dni)?"valid":""}`,value:r.dni,onChange:s=>m("dni",s.target.value),placeholder:"12345678",maxLength:"8"}),d.dni&&e.jsx("div",{className:"client-form-error",children:d.dni}),e.jsx("div",{className:"client-form-help",children:"Solo para personas naturales - Debe tener exactamente 8 dígitos"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(R,{className:"client-form-icon"}),"Nombre de Contacto"]}),e.jsx("input",{type:"text",className:"client-form-input",value:r.contact_name,onChange:s=>m("contact_name",s.target.value),placeholder:"Ingresa el nombre del contacto"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(X,{className:"client-form-icon"}),"Información de Contacto"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(X,{className:"client-form-icon"}),"Email"]}),e.jsx("input",{type:"email",className:`client-form-input ${d.email?"error":""}`,value:r.email,onChange:s=>m("email",s.target.value),placeholder:"contacto@empresa.com"}),d.email&&e.jsx("div",{className:"client-form-error",children:d.email})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(Se,{className:"client-form-icon"}),"Teléfono"]}),e.jsx("input",{type:"tel",className:`client-form-input ${d.phone?"error":r.phone&&b(r.phone)?"valid":""}`,value:r.phone,onChange:s=>m("phone",s.target.value),placeholder:"930238631",maxLength:"9"}),d.phone&&e.jsx("div",{className:"client-form-error",children:d.phone}),e.jsx("div",{className:"client-form-help",children:"Debe tener 9 dígitos"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(ie,{className:"client-form-icon"}),"Información de Ubicación"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(ie,{className:"client-form-icon"}),"Dirección"]}),e.jsx("input",{type:"text",className:"client-form-input",value:r.address,onChange:s=>m("address",s.target.value),placeholder:"Ingresa la dirección"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Ciudad"]}),e.jsx("select",{className:"client-form-select",value:r.city,onChange:s=>m("city",s.target.value),children:Cs.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsx("div",{className:"client-form-row single",children:e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Sector"]}),e.jsx("select",{className:"client-form-select",value:r.sector,onChange:s=>m("sector",s.target.value),children:ys.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})})]})]}),e.jsxs("div",{className:"client-form-actions",children:[e.jsxs("button",{type:"button",className:"client-form-btn client-form-btn-cancel",onClick:c,disabled:f,children:[e.jsx(M,{}),"Cancelar"]}),e.jsx("button",{type:"submit",className:"client-form-btn client-form-btn-create",onClick:F,disabled:f,children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})}),y?"Actualizando...":"Creando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(We,{}),y?"Actualizar":"Crear"]})})]})]})}):null},Es=({show:o,onHide:c,action:t="realizar esta acción",requiredRole:C="administrador",currentRole:f="usuario"})=>e.jsxs(j,{show:o,onHide:c,centered:!0,backdrop:"static",children:[e.jsxs(j.Header,{className:"bg-danger text-white border-0",children:[e.jsxs(j.Title,{className:"d-flex align-items-center",children:[e.jsx(fe,{className:"me-2",size:20}),"Acceso Denegado"]}),e.jsx(_,{variant:"link",className:"text-white p-0 border-0",onClick:c,style:{fontSize:"1.5rem",lineHeight:1},children:e.jsx(M,{})})]}),e.jsx(j.Body,{className:"py-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-3",children:e.jsx(Ke,{size:48,className:"text-warning"})}),e.jsxs("h5",{className:"text-danger mb-3",children:["No tienes permisos para ",t]}),e.jsx("div",{className:"alert alert-warning border-0 mb-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(fe,{className:"me-2 text-warning",size:16}),e.jsxs("div",{children:[e.jsx("strong",{children:"Rol requerido:"})," ",C,e.jsx("br",{}),e.jsx("strong",{children:"Tu rol actual:"})," ",f]})]})}),e.jsx("p",{className:"text-muted mb-0",children:"Contacta al administrador del sistema si necesitas acceso a esta funcionalidad."})]})}),e.jsx(j.Footer,{className:"border-0 justify-content-center",children:e.jsx(_,{variant:"secondary",onClick:c,className:"px-4",children:"Entendido"})})]}),ne={prospeccion:{label:"Prospección",icon:Je,color:"secondary",bgColor:"#6c757d"},interesado:{label:"Interesado",icon:Ye,color:"info",bgColor:"#17a2b8"},pendiente_cotizacion:{label:"Pendiente de Cotización",icon:B,color:"warning",bgColor:"#ffc107"},cotizacion_enviada:{label:"Cotización Enviada",icon:we,color:"info",bgColor:"#17a2b8"},negociacion:{label:"Negociación",icon:ze,color:"secondary",bgColor:"#6c757d"},ganado:{label:"Ganado",icon:Y,color:"success",bgColor:"#28a745"},perdido:{label:"Perdido",icon:M,color:"danger",bgColor:"#dc3545"},otro:{label:"Otro",icon:Ve,color:"light",bgColor:"#f8f9fa"}},zs=({clientId:o,currentStatus:c,onStatusChange:t,disabled:C=!1,size:f="sm",showLabel:y=!0})=>{const[r,z]=x.useState(!1),[d,g]=x.useState(""),[m,i]=x.useState(!1),[w,b]=x.useState({top:0,left:0}),l=x.useRef(null),F=x.useRef(null),s=Ee(),h=()=>{if(l.current){const N=l.current.getBoundingClientRect();b({top:N.bottom+5,left:N.left})}i(!m)},p=N=>{m&&F.current&&!F.current.contains(N.target)&&l.current&&!l.current.contains(N.target)&&i(!1)};x.useEffect(()=>{if(m)return document.addEventListener("mousedown",p),()=>document.removeEventListener("mousedown",p)},[m]);const G=async N=>{if(N!==c){console.log(`🔄 ClientStatusDropdown - Iniciando cambio de estado del cliente ${o} de '${c}' a '${N}'`),t==null||t(N),i(!1),z(!0),g("");try{console.log("🔄 ClientStatusDropdown - Llamando a updateClientStatus...");const k=await os(o,N);console.log("✅ ClientStatusDropdown - Estado actualizado exitosamente:",k),s.invalidateQueries(["clients"]),s.invalidateQueries("companiesList"),s.invalidateQueries("clientStats"),s.invalidateQueries("companyStats")}catch(k){console.error("❌ ClientStatusDropdown - Error al actualizar estado:",k),g(k.message||"Error al actualizar estado"),console.log(`🔄 ClientStatusDropdown - Revirtiendo estado a '${c}'`),t==null||t(c)}finally{z(!1)}}},P=ne[c]||ne.prospeccion,L=P.icon,W=m&&Ue.createPortal(e.jsx("div",{ref:F,className:"dropdown-menu show",style:{position:"fixed",top:w.top,left:w.left,zIndex:99999,minWidth:"200px",maxHeight:"300px",overflowY:"auto",boxShadow:"0 0.5rem 1rem rgba(0, 0, 0, 0.15)",border:"1px solid rgba(0, 0, 0, 0.15)",borderRadius:"0.375rem",backgroundColor:"white"},children:Object.entries(ne).map(([N,k])=>{const Z=k.icon,T=N===c;return e.jsxs("button",{className:`dropdown-item d-flex align-items-center gap-2 ${T?"active":""}`,onClick:()=>G(N),disabled:T,style:{border:"none",background:T?k.bgColor:"transparent",color:T?"white":"#212529",width:"100%",textAlign:"left",padding:"0.5rem 1rem",cursor:"pointer"},onMouseEnter:q=>{T||(q.target.style.backgroundColor="#f8f9fa")},onMouseLeave:q=>{T||(q.target.style.backgroundColor="transparent")},children:[e.jsx(Z,{size:14}),e.jsx("span",{children:k.label}),T&&e.jsx(Xe,{size:14,className:"ms-auto"})]},N)})}),document.body);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-status-dropdown",children:[d&&e.jsx(fs,{variant:"danger",className:"mb-2",style:{fontSize:"0.8rem"},children:d}),e.jsxs("button",{ref:l,className:`btn btn-${P.color} btn-${f} d-flex align-items-center gap-1`,onClick:h,disabled:C||r,style:{backgroundColor:P.bgColor,borderColor:P.bgColor,minWidth:"140px"},children:[r?e.jsx(gs,{animation:"border",size:"sm"}):e.jsxs(e.Fragment,{children:[e.jsx(L,{size:14}),y&&e.jsx("span",{children:P.label})]}),e.jsx(Ze,{size:12})]})]}),W]})},ws={nuevo:{label:"Nuevo",variant:"primary",icon:B},cotizacion_enviada:{label:"Cotización Enviada",variant:"info",icon:we},pendiente_cotizacion:{label:"Pendiente de Cotización",variant:"warning",icon:B},en_negociacion:{label:"En Negociación",variant:"secondary",icon:ze},seguimiento:{label:"Seguimiento",variant:"info",icon:as},ganado:{label:"Ganado",variant:"success",icon:Y},perdido:{label:"Perdido",variant:"danger",icon:M},activo:{label:"Activo",variant:"success",icon:Y},completado:{label:"Completado",variant:"primary",icon:Y},pausado:{label:"Pausado",variant:"warning",icon:B},cancelado:{label:"Cancelado",variant:"danger",icon:M}},Fs=({show:o,onHide:c,clientId:t,clientName:C})=>{const{data:f,isLoading:y,error:r}=J(["clientHistory",t],()=>ds(t),{enabled:o&&!!t,staleTime:3e5}),z=(i,w="quote")=>{const b=ws[i]||{label:i,variant:"secondary",icon:ae},l=b.icon;return e.jsxs(A,{bg:b.variant,className:"d-flex align-items-center gap-1",children:[e.jsx(l,{size:12}),b.label]})},d=i=>new Date(i).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"}),g=i=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(i);if(y)return e.jsxs(j,{show:o,onHide:c,size:"xl",children:[e.jsx(j.Header,{closeButton:!0,children:e.jsxs(j.Title,{children:["Historial de ",C]})}),e.jsx(j.Body,{className:"text-center",children:e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})})})]});if(r)return e.jsxs(j,{show:o,onHide:c,size:"xl",children:[e.jsx(j.Header,{closeButton:!0,children:e.jsxs(j.Title,{children:["Historial de ",C]})}),e.jsx(j.Body,{children:e.jsxs("div",{className:"alert alert-danger",children:["Error al cargar el historial: ",r.message]})})]});const m=(f==null?void 0:f.data)||{quotes:[],projects:[],manager:null,stats:{}};return e.jsxs(j,{show:o,onHide:c,size:"xl",children:[e.jsx(j.Header,{closeButton:!0,children:e.jsxs(j.Title,{children:[e.jsx(es,{className:"me-2"}),"Historial de ",C]})}),e.jsxs(j.Body,{children:[m.manager&&e.jsx(H,{className:"mb-4",children:e.jsx(H.Body,{children:e.jsxs(re,{children:[e.jsxs(I,{md:6,children:[e.jsxs("h6",{children:[e.jsx(R,{className:"me-2"}),"Gestor Actual"]}),e.jsx("p",{className:"mb-1",children:e.jsx("strong",{children:m.manager.name})}),e.jsx("p",{className:"mb-1 text-muted",children:m.manager.role}),e.jsx("p",{className:"mb-0 text-muted",children:m.manager.email})]}),e.jsxs(I,{md:6,children:[e.jsx("h6",{children:"Estadísticas"}),e.jsxs(re,{children:[e.jsx(I,{xs:6,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-primary mb-0",children:m.stats.totalQuotes}),e.jsx("small",{className:"text-muted",children:"Cotizaciones"})]})}),e.jsx(I,{xs:6,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-success mb-0",children:m.stats.totalProjects}),e.jsx("small",{className:"text-muted",children:"Proyectos"})]})})]})]})]})})}),e.jsxs(Ns,{defaultActiveKey:"quotes",className:"mb-3",children:[e.jsx(Ne,{eventKey:"quotes",title:e.jsxs("span",{children:[e.jsx(ae,{className:"me-1"}),"Cotizaciones (",m.quotes.length,")"]}),children:m.quotes.length>0?e.jsxs(ve,{responsive:!0,striped:!0,hover:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Creado por"}),e.jsx("th",{children:"Fecha Creación"}),e.jsx("th",{children:"Última Actualización"})]})}),e.jsx("tbody",{children:m.quotes.map(i=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:["#",i.id]})}),e.jsxs("td",{children:[e.jsx(ss,{className:"me-1"}),g(i.total)]}),e.jsx("td",{children:z(i.status,"quote")}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{children:i.created_by_name}),e.jsx("small",{className:"text-muted",children:i.created_by_role})]})}),e.jsxs("td",{children:[e.jsx(V,{className:"me-1"}),d(i.created_at)]}),e.jsxs("td",{children:[e.jsx(V,{className:"me-1"}),d(i.updated_at)]})]},i.id))})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(ae,{size:48,className:"text-muted mb-3"}),e.jsx("p",{className:"text-muted",children:"No hay cotizaciones registradas para este cliente"})]})}),e.jsx(Ne,{eventKey:"projects",title:e.jsxs("span",{children:[e.jsx(D,{className:"me-1"}),"Proyectos (",m.projects.length,")"]}),children:m.projects.length>0?e.jsxs(ve,{responsive:!0,striped:!0,hover:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Creado por"}),e.jsx("th",{children:"Fecha Creación"}),e.jsx("th",{children:"Última Actualización"})]})}),e.jsx("tbody",{children:m.projects.map(i=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:["#",i.id]})}),e.jsxs("td",{children:[e.jsx(D,{className:"me-1"}),i.name]}),e.jsx("td",{children:z(i.status,"project")}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{children:i.created_by_name}),e.jsx("small",{className:"text-muted",children:i.created_by_role})]})}),e.jsxs("td",{children:[e.jsx(V,{className:"me-1"}),d(i.created_at)]}),e.jsxs("td",{children:[e.jsx(V,{className:"me-1"}),d(i.updated_at)]})]},i.id))})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(D,{size:48,className:"text-muted mb-3"}),e.jsx("p",{className:"text-muted",children:"No hay proyectos registrados para este cliente"})]})})]})]}),e.jsx(j.Footer,{children:e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:c,children:"Cerrar"})})]})},le=()=>{try{const o=localStorage.getItem("token");if(!o)return null;const c=JSON.parse(atob(o.split(".")[1]));return{id:c.id,name:c.name,role:c.role,email:c.email}}catch(o){return console.error("Error decodificando token:",o),null}},Q=o=>{const c=le();return c?(typeof o=="string"&&(o=[o]),o.includes(c.role)):!1},Fe=()=>Q(["admin","jefa_comercial","vendedor_comercial"]),ke=()=>Q(["admin","jefa_comercial","vendedor_comercial"]),Te=()=>Q(["admin"]),ks=()=>Q(["admin","jefa_comercial","vendedor_comercial"]),Ts=()=>Q(["admin","jefa_comercial","vendedor_comercial"]),Ps=()=>{const o=le();o?(console.log("👤 Usuario actual:",{id:o.id,name:o.name,role:o.role,email:o.email}),console.log("🔐 Permisos:",{canCreateClient:Fe(),canEditClient:ke(),canDeleteClient:Te()})):console.log("❌ No hay usuario autenticado")},ye={id:null,type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:"",city:"",sector:""};function Zs(){var pe,je;const[o,c]=x.useState(!1),[t,C]=x.useState(null),[f,y]=x.useState(null),[r,z]=x.useState(!1),[d,g]=x.useState(null),[m,i]=x.useState(!1),[w,b]=x.useState({}),l=le(),F=Fe(),s=ke(),h=Te(),p=ks(),G=Ts();U.useEffect(()=>{Ps()},[]);const[P,L]=x.useState(1),[W,N]=x.useState(""),[k,Z]=x.useState(""),[T,q]=x.useState(""),[ce,Pe]=x.useState(""),[De,oe]=x.useState(!1),ee=Ee(),_e=ts(),{data:S,isLoading:Re,refetch:Ds}=J(["clients",P,W,k,T,ce],()=>hs({page:P,limit:20,search:W,type:k,city:T,sector:ce}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:v,isLoading:K,error:_s}=J(["clientStats"],ps,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4});U.useEffect(()=>{v&&v.data&&console.log("✅ Estadísticas cargadas correctamente:",{total:v.data.total,empresas:v.data.empresas,personas:v.data.personas})},[v]);const{data:$,isLoading:Rs}=J(["clientFilterOptions"],js,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:6e4,cacheTime:3e5}),se=a=>{ee.invalidateQueries("clients"),ee.invalidateQueries("clientStats"),ee.invalidateQueries("clientFilterOptions"),c(!1),C(null),y(null)},Ie=a=>{console.log("🔍 handleSearch - Búsqueda:",a),N(a),L(1),oe(!0),setTimeout(()=>oe(!1),1e3)},Me=a=>{console.log("🔍 handleFilter - Filtros:",a),Z(a.type||""),q(a.city||""),Pe(a.sector||""),L(1)},Le=x.useMemo(()=>{var a,n,u;return $?[{title:"Por Tipo de Cliente",options:((a=$.types)==null?void 0:a.map(E=>({label:`${E.label} (${E.count})`,filter:{type:E.value}})))||[]},{title:"Por Sector",options:((n=$.sectors)==null?void 0:n.map(E=>({label:`${E.label} (${E.count})`,filter:{sector:E.value}})))||[]},{title:"Por Ciudad",options:((u=$.cities)==null?void 0:u.map(E=>({label:`${E.label} (${E.count})`,filter:{city:E.value}})))||[]}]:[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona"}}]}]},[$]),de=te(ms,{onSuccess:()=>se(),onError:a=>{console.error("Error creating client:",a),console.error("Error details:",{message:a.message,status:a.status,body:a.body})}}),me=te(us,{onSuccess:()=>se(),onError:a=>console.error("Error updating client:",a)}),ue=te(xs,{onSuccess:()=>se(),onError:a=>console.error("Error deleting client:",a)}),qe=()=>{if(!F){b({action:"crear clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(l==null?void 0:l.role)||"no autenticado"}),i(!0);return}C(ye),c(!0)},xe=a=>{if(!s){b({action:"editar clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(l==null?void 0:l.role)||"no autenticado"}),i(!0);return}C(a),c(!0)},he=a=>{if(console.log("🔍 handleDelete - Verificando permisos:",{userCanDeleteClient:h,currentUserRole:l==null?void 0:l.role,currentUser:l}),!h){console.log("🚫 handleDelete - Permisos insuficientes, mostrando modal"),b({action:"eliminar clientes",requiredRole:"administrador",currentRole:(l==null?void 0:l.role)||"no autenticado"}),i(!0);return}console.log("✅ handleDelete - Permisos OK, procediendo con eliminación"),y(a)},$e=async()=>{try{await ue.mutateAsync(f.id),y(null)}catch(a){console.error("Error eliminando cliente:",a),y(null)}},Oe=a=>{if(!G){b({action:"crear cotizaciones",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(l==null?void 0:l.role)||"no autenticado"}),i(!0);return}_e("/cotizaciones/inteligente",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city,ruc:a.ruc,dni:a.dni,email:a.email,phone:a.phone,contact_name:a.contact_name,address:a.address}}})},Ae=a=>{if(!p){b({action:"ver historial de clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(l==null?void 0:l.role)||"no autenticado"}),i(!0);return}g(a),z(!0)},Be=(a,n)=>{console.log(`Estado del cliente ${a} cambiado a: ${n}`)},He=async a=>{t.id?await me.mutateAsync({id:t.id,...a}):await de.mutateAsync(a)},Qe=a=>{const u={empresa:{bg:"primary",text:"Empresa",icon:D},persona:{bg:"info",text:"Persona Natural",icon:R}}[a]||{bg:"secondary",text:a,icon:R},E=u.icon;return e.jsxs(A,{bg:u.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(E,{size:12,className:"me-1"}),u.text]})},Ge=[{header:"ID",accessor:"id",width:"50px"},{header:"Cliente",accessor:"name",width:"180px",render:(a,n)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:n.name}),e.jsxs("div",{className:"d-flex align-items-center gap-1 mt-1",children:[Qe(n.type),n.ruc&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["RUC: ",n.ruc]}),n.dni&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["DNI: ",n.dni]})]})]})},{header:"Contacto",accessor:"contact",width:"150px",render:(a,n)=>e.jsxs("div",{children:[n.contact_name&&e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:n.contact_name}),n.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(X,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:n.email})]}),n.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(Se,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:n.phone})]})]})},{header:"Ciudad",accessor:"city",width:"80px",render:a=>{const n=a||"No especificada";let u="secondary";switch(n){case"Lima":u="primary";break;case"Arequipa":u="info";break;case"Cusco":u="success";break;case"Trujillo":u="warning";break;case"Piura":u="danger";break;case"Chiclayo":u="info";break;case"Iquitos":u="success";break;case"Huancayo":u="warning";break;default:u="secondary"}return e.jsx(A,{bg:u,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:n})}},{header:"Sector",accessor:"sector",width:"80px",render:a=>{const n=a||"General";let u="secondary";switch(n){case"Construcción":u="warning";break;case"Minería":u="dark";break;case"Ingeniería":u="primary";break;case"Laboratorio":u="info";break;case"Consultoría":u="success";break;case"Tecnología":u="primary";break;case"Ambiental":u="success";break;case"Geología":u="info";break;default:u="secondary"}return e.jsx(A,{bg:u,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:n})}},{header:"Estado",accessor:"status",width:"120px",render:(a,n)=>e.jsx(zs,{clientId:n.id,currentStatus:n.status||"prospeccion",onStatusChange:u=>Be(n.id,u),size:"sm",showLabel:!0})},{header:"Gestor",accessor:"managed_by",width:"100px",render:(a,n)=>e.jsx("div",{className:"d-flex align-items-center",children:n.managed_by_name?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{size:12,className:"me-1 text-success"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:n.managed_by_name}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:n.managed_by_role})]})]}):e.jsx("span",{className:"text-muted",style:{fontSize:"0.8rem"},children:"Sin asignar"})})},{header:"Dirección",accessor:"address",width:"120px",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(ie,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin dirección"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,n)=>e.jsxs("div",{className:"d-flex gap-1",children:[s&&e.jsx(_,{variant:"outline-primary",size:"sm",onClick:()=>xe(n),title:"Editar cliente",children:e.jsx(is,{size:14})}),p&&e.jsx(_,{variant:"outline-info",size:"sm",onClick:()=>Ae(n),title:"Ver historial de cotizaciones y proyectos",children:e.jsx(B,{size:14})}),G&&e.jsx(_,{variant:"outline-success",size:"sm",onClick:()=>Oe(n),title:"Crear cotización para este cliente",children:e.jsx(rs,{size:14})}),h&&e.jsx(_,{variant:"outline-danger",size:"sm",onClick:()=>he(n),title:"Eliminar cliente",children:e.jsx(be,{size:14})}),!h&&e.jsx(_,{variant:"outline-secondary",size:"sm",onClick:()=>{console.log("🚫 Botón eliminar clickeado sin permisos"),b({action:"eliminar clientes",requiredRole:"administrador",currentRole:(l==null?void 0:l.role)||"no autenticado"}),i(!0)},title:"No tienes permisos para eliminar clientes",children:e.jsx(be,{size:14})})]})}],O=x.useMemo(()=>{if(v&&v.data)return console.log("📊 Stats - Usando estadísticas reales del backend:",v),console.log("📊 Stats - Datos extraídos:",v.data),{total:v.data.total||0,empresas:v.data.empresas||0,personas:v.data.personas||0,conEmail:v.data.withEmail||0,conTelefono:v.data.withPhone||0};const a=(S==null?void 0:S.data)||[];return console.log("📊 Stats - Fallback: calculando desde página actual:",a),{total:a.length,empresas:a.filter(n=>n.type==="empresa").length,personas:a.filter(n=>n.type==="persona").length,conEmail:a.filter(n=>n.email).length,conTelefono:a.filter(n=>n.phone).length}},[v,S]);return e.jsx("div",{className:"clientes-page",children:e.jsxs(bs,{fluid:!0,className:"h-100 d-flex flex-column p-0",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"mb-0 fw-bold",children:"Gestión de Clientes"}),e.jsx("small",{className:"text-muted",children:"Crear, editar y gestionar clientes del sistema"})]}),e.jsxs(_,{variant:"primary",size:"sm",onClick:qe,disabled:!F,title:F?"Crear nuevo cliente":`No tienes permisos para crear clientes. Rol actual: ${(l==null?void 0:l.role)||"No autenticado"}`,children:[e.jsx(ns,{className:"me-1"}),"Nuevo Cliente"]})]}),!F&&e.jsx("div",{className:"alert alert-warning py-1 mb-1",role:"alert",children:e.jsxs("small",{children:[e.jsx("strong",{children:"⚠️ Permisos insuficientes:"})," Tu rol actual (",(l==null?void 0:l.role)||"No autenticado",") no tiene permisos para crear clientes."]})}),e.jsxs(re,{className:"g-0 mb-3",children:[e.jsx(I,{md:6,lg:3,children:e.jsx("div",{className:"bg-primary bg-opacity-10 rounded p-2 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx(ge,{className:"text-primary me-2",size:16}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-bold text-primary",children:K?"...":O.total}),e.jsx("small",{className:"text-muted",children:"Total"})]})]})})}),e.jsx(I,{md:6,lg:3,children:e.jsx("div",{className:"bg-success bg-opacity-10 rounded p-2 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx(D,{className:"text-success me-2",size:16}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-bold text-success",children:K?"...":O.empresas}),e.jsx("small",{className:"text-muted",children:"Empresas"})]})]})})}),e.jsx(I,{md:6,lg:3,children:e.jsx("div",{className:"bg-info bg-opacity-10 rounded p-2 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx(R,{className:"text-info me-2",size:16}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-bold text-info",children:K?"...":O.personas}),e.jsx("small",{className:"text-muted",children:"Personas"})]})]})})}),e.jsx(I,{md:6,lg:3,children:e.jsx("div",{className:"bg-warning bg-opacity-10 rounded p-2 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx(X,{className:"text-warning me-2",size:16}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-bold text-warning",children:K?"...":O.conEmail}),e.jsx("small",{className:"text-muted",children:"Con Email"})]})]})})})]}),e.jsxs(H,{className:"shadow-sm border-0 flex-grow-1 d-flex flex-column",children:[e.jsx(H.Header,{className:"bg-white border-bottom flex-shrink-0 py-2",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx(ge,{className:"me-1 text-primary",size:16}),"Lista de Clientes"]}),e.jsxs(A,{bg:"light",text:"dark",className:"px-2 py-1",children:[O.total," clientes"]})]})}),e.jsx(H.Body,{className:"p-0 flex-grow-1 d-flex flex-column",children:e.jsx("div",{className:"client-table flex-grow-1 d-flex flex-column",children:e.jsx(ls,{data:(S==null?void 0:S.data)||[],columns:Ge,loading:Re||De,onEdit:xe,onDelete:he,emptyMessage:"No hay clientes registrados",totalItems:((pe=S==null?void 0:S.pagination)==null?void 0:pe.total)||0,itemsPerPage:((je=S==null?void 0:S.pagination)==null?void 0:je.limit)||20,currentPage:P,onPageChange:L,onSearch:Ie,onFilter:Me,filterOptions:Le,sortable:!1,useFlexbox:!0})})})]}),e.jsx(Ss,{show:o,onHide:()=>c(!1),data:t||ye,onSubmit:He,loading:de.isLoading||me.isLoading,isEditing:!!(t!=null&&t.id)}),e.jsx(cs,{show:!!f,onHide:()=>y(null),onConfirm:$e,title:"Eliminar Cliente",message:`¿Estás seguro de que quieres eliminar el cliente "${f==null?void 0:f.name}"?`,confirmText:"Eliminar",variant:"danger",isLoading:ue.isLoading,alertMessage:"Esta acción eliminará permanentemente el cliente y todos sus datos asociados (proyectos, cotizaciones, etc.).",alertVariant:"danger"}),e.jsx(Fs,{show:r,onHide:()=>z(!1),clientId:d==null?void 0:d.id,clientName:d==null?void 0:d.name}),e.jsx(Es,{show:m,onHide:()=>i(!1),action:w.action,requiredRole:w.requiredRole,currentRole:w.currentRole})]})})}export{Zs as default};
//# sourceMappingURL=Clientes-1woNQNjB.js.map
