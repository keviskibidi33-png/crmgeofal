import{r as s,P as U,E as Q,c as k,G as M,j as t}from"./index-DEOVmouH.js";import{M as B}from"./ModuloBase-D7hsd1iJ.js";import{D as G}from"./DataTable-kZ-b6eAL.js";import{T as I}from"./Toolbar-DzDpkaTp.js";import{M as w}from"./Modal-Drn6X6DL.js";import{T as z}from"./Toast-BeFpd6uA.js";import{u as O,a as R,l as W}from"./attachments-CK8Tvz6R.js";import{l as H}from"./projects-CIJM5hiT.js";const E={project_id:"",description:"",file:null};function te(){const[r,h]=s.useState(1),[j]=s.useState(10),[f,x]=s.useState({q:""}),[y,l]=s.useState({message:"",type:"success",show:!1}),p=U(),[g,c]=s.useState(!1),[o,d]=s.useState(E),[i,u]=s.useState(null),_=Q();s.useEffect(()=>{var e;(e=p.state)!=null&&e.search&&x(a=>({...a,q:p.state.search}))},[p.state]);const{data:n,isLoading:q}=k(["attachments",{page:r,limit:j,q:f.q}],()=>W(1),{keepPreviousData:!0}),{data:m}=k("projectsList",()=>H({page:1,limit:500}),{staleTime:1/0}),D=s.useMemo(()=>(m==null?void 0:m.data)||[],[m]),v=e=>{l({message:e,type:"success",show:!0}),_.invalidateQueries("attachments"),c(!1),d(E),u(null)},N=(e,a)=>{l({message:(e==null?void 0:e.message)||a,type:"error",show:!0})},b=M(O,{onSuccess:()=>v("Archivo subido correctamente."),onError:e=>N(e,"Error al subir archivo.")}),S=M(R,{onSuccess:()=>v("Adjunto eliminado correctamente."),onError:e=>N(e,"Error al eliminar adjunto.")}),P=e=>{if(e.preventDefault(),!o.file||!o.project_id){l({message:"Debe seleccionar un proyecto y un archivo.",type:"error",show:!0});return}b.mutate(o)},T=()=>{i&&S.mutate(i.id)},L=s.useMemo(()=>[{header:"ID",key:"id",width:60},{header:"Proyecto",key:"project_name"},{header:"Archivo",key:"file_url",render:e=>t.jsx("a",{href:e.file_url,target:"_blank",rel:"noreferrer noopener",children:e.file_url.split("/").pop()})},{header:"Descripción",key:"description"},{header:"Subido por",key:"uploaded_by_name"},{header:"Fecha",key:"created_at",render:e=>new Date(e.created_at).toLocaleString(),width:200},{header:"Acciones",key:"actions",width:120,render:e=>t.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>u(e),children:"Eliminar"})}],[]),F=(n==null?void 0:n.data)||[],C=(n==null?void 0:n.total)||0,A=Math.max(1,Math.ceil(C/j));return t.jsxs(B,{titulo:"Gestión de Adjuntos",descripcion:"Archivos relacionados a proyectos y cotizaciones.",children:[t.jsx(I,{left:t.jsx("input",{className:"form-control",style:{maxWidth:"300px"},placeholder:"Buscar por archivo, proyecto...",value:f.q,onChange:e=>{h(1),x({q:e.target.value})}}),right:t.jsx("button",{className:"btn btn-primary",onClick:()=>c(!0),children:"+ Subir Archivo"})}),t.jsx(G,{columns:L,rows:F,loading:q}),t.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[t.jsxs("span",{className:"text-muted",children:["Total: ",C]}),t.jsxs("div",{className:"btn-group",children:[t.jsx("button",{className:"btn btn-outline-secondary",disabled:r<=1,onClick:()=>h(e=>e-1),children:"Anterior"}),t.jsxs("span",{className:"btn btn-outline-secondary disabled",children:[r," / ",A]}),t.jsx("button",{className:"btn btn-outline-secondary",disabled:r>=A,onClick:()=>h(e=>e+1),children:"Siguiente"})]})]}),g&&t.jsx(w,{open:g,onClose:()=>c(!1),children:t.jsxs("form",{onSubmit:P,children:[t.jsx("h4",{children:"Subir Archivo Adjunto"}),t.jsxs("div",{className:"row g-3 mt-2",children:[t.jsxs("div",{className:"col-12",children:[t.jsx("label",{className:"form-label",children:"Proyecto"}),t.jsxs("select",{className:"form-select",value:o.project_id,onChange:e=>d(a=>({...a,project_id:e.target.value})),required:!0,children:[t.jsx("option",{value:"",children:"Seleccione un proyecto..."}),D.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsxs("div",{className:"col-12",children:[t.jsx("label",{className:"form-label",children:"Descripción (Opcional)"}),t.jsx("input",{className:"form-control",value:o.description,onChange:e=>d(a=>({...a,description:e.target.value}))})]}),t.jsxs("div",{className:"col-12",children:[t.jsx("label",{className:"form-label",children:"Archivo"}),t.jsx("input",{type:"file",className:"form-control",onChange:e=>d(a=>({...a,file:e.target.files[0]})),required:!0})]})]}),t.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-4",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>c(!1),children:"Cancelar"}),t.jsx("button",{type:"submit",className:"btn btn-primary",disabled:b.isLoading,children:b.isLoading?"Subiendo...":"Subir"})]})]})}),i&&t.jsxs(w,{open:!!i,onClose:()=>u(null),children:[t.jsx("h4",{children:"Confirmar Eliminación"}),t.jsxs("p",{children:["¿Estás seguro de que quieres eliminar el archivo ",t.jsx("strong",{children:i.file_url.split("/").pop()}),"? Esta acción no se puede deshacer."]}),t.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-4",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>u(null),children:"Cancelar"}),t.jsx("button",{type:"button",className:"btn btn-danger",onClick:T,disabled:S.isLoading,children:"Eliminar"})]})]}),t.jsx(z,{message:y.message,type:y.type,onClose:()=>l(e=>({...e,show:!1}))})]})}export{te as default};
//# sourceMappingURL=Adjuntos-BLULbHLP.js.map
