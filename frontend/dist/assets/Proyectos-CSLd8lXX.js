import{r as s,u as je,a1 as fe,Q as Ce,c as V,R as y,j as a,U as _e,h as p,y as d,x as k,B as W,V as Se,d as X,a2 as Pe,X as Ne,G as Ee,w as ke,a3 as Me,a4 as Ae,E as Fe,a0 as qe,Z as Te}from"./index-o7c7tdkB.js";import{P as we,R as Ie,C as x}from"./PageHeader-C0hqpNJa.js";import{D as Le}from"./DataTable-BnIKqI-b.js";import{M as v}from"./ModalForm-BYW2MbvZ.js";import{S as j}from"./StatsCard-Sqt5gmwc.js";import{d as $e,c as ze,u as Re,a as Qe,l as De,g as Ge}from"./projects-BMxbiY1g.js";import{C as M}from"./Card-B7TGPdeB.js";import"./InputGroup-CsBCMGWc.js";import"./Form-CNH_JlrK.js";import"./Spinner-H_v7OS2w.js";const A={company_id:"",name:"",location:"",vendedor_id:"",laboratorio_id:"",requiere_laboratorio:!1,requiere_ingenieria:!1,contact_name:"",contact_phone:"",contact_email:""};function aa(){var H,U,B,O;const[Z,b]=s.useState(!1),[r,f]=s.useState(null),[He,J]=s.useState(null),[K,C]=s.useState(!1),[Y,_]=s.useState(!1),[ee,S]=s.useState(!1),[l,P]=s.useState(null),[N,E]=s.useState(1),[F,ae]=s.useState(""),[q,te]=s.useState(""),[T,oe]=s.useState(""),[w,se]=s.useState(""),[le,I]=s.useState(!1);je();const i=(H=fe().state)==null?void 0:H.selectedClient,L=Ce(),{data:o,isLoading:$,refetch:ie}=V(["projects",N,F,q,T,w],()=>De({page:N,limit:20,search:F,status:q,company_id:T,project_type:w}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:c,isLoading:g}=V(["projectStats"],Ge,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4}),h=e=>{L.invalidateQueries("projects"),L.invalidateQueries("projectStats"),b(!1),f(null),J(null)},ne=e=>{console.log("üîç handleSearch - B√∫squeda:",e),ae(e),E(1),I(!0),setTimeout(()=>I(!1),1e3)},re=e=>{console.log("üîç handleFilter - Filtros:",e),te(e.status||""),oe(e.company_id||""),se(e.project_type||""),E(1)},ce=[{title:"Por Estado",options:[{label:"Pendientes",filter:{status:"pendiente"}},{label:"Activos",filter:{status:"activo"}},{label:"Completados",filter:{status:"completado"}},{label:"Cancelados",filter:{status:"cancelado"}}]},{title:"Por Tipo de Proyecto",options:[{label:"An√°lisis de Suelos",filter:{project_type:"An√°lisis de Suelos"}},{label:"Estudio Geot√©cnico",filter:{project_type:"Estudio Geot√©cnico"}},{label:"Evaluaci√≥n Ambiental",filter:{project_type:"Evaluaci√≥n Ambiental"}},{label:"Control de Calidad",filter:{project_type:"Control de Calidad"}},{label:"An√°lisis de Agua",filter:{project_type:"An√°lisis de Agua"}},{label:"Estudio de Impacto",filter:{project_type:"Estudio de Impacto"}},{label:"An√°lisis Qu√≠mico",filter:{project_type:"An√°lisis Qu√≠mico"}},{label:"Pruebas de Laboratorio",filter:{project_type:"Pruebas de Laboratorio"}},{label:"Inspecci√≥n T√©cnica",filter:{project_type:"Inspecci√≥n T√©cnica"}},{label:"Certificaci√≥n de Materiales",filter:{project_type:"Certificaci√≥n de Materiales"}}]}],z=y(ze,{onSuccess:()=>h(),onError:e=>console.error("Error creating project:",e)}),R=y(Re,{onSuccess:()=>h(),onError:e=>console.error("Error updating project:",e)}),de=y($e,{onSuccess:()=>h(),onError:e=>console.error("Error deleting project:",e)}),Q=y(({id:e,...t})=>Qe(e,t),{onSuccess:()=>h(),onError:e=>console.error("Error updating project status:",e)}),ue=()=>{const e=i?{...A,company_id:i.id,name:`${i.sector||"Proyecto"} - ${i.name}`,location:i.city||"",contact_name:i.contact_name||"",contact_phone:i.phone||"",contact_email:i.email||""}:A;f(e),b(!0)},D=e=>{f(e),b(!0)},G=e=>{window.confirm(`¬øEst√°s seguro de que quieres eliminar el proyecto "${e.name}"?`)&&de.mutate(e.id)},me=e=>{P(e),C(!0)},pe=e=>{P(e),_(!0)},be=async e=>{try{console.log("Marcar/desmarcar proyecto:",e),alert(`Proyecto ${e.marked?"desmarcado":"marcado"}: ${e.name}`)}catch(t){console.error("Error al marcar proyecto:",t)}},ge=e=>{P(e),S(!0)},he=async e=>{r.id?await R.mutateAsync({id:r.id,...e}):await z.mutateAsync(e)},ye=e=>{const m={activo:{bg:"success",text:"Activo"},pendiente:{bg:"warning",text:"Pendiente"},completado:{bg:"primary",text:"Completado"},cancelado:{bg:"danger",text:"Cancelado"}}[e]||{bg:"secondary",text:e};return a.jsx(d,{bg:m.bg,className:"status-badge",children:m.text})},xe=[{header:"ID",accessor:"id",width:"80px"},{header:"Proyecto",accessor:"name",render:(e,t)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:t.name}),t.location&&a.jsxs("small",{className:"text-muted",children:[a.jsx(Te,{size:12,className:"me-1"}),t.location]})]})},{header:"Tipo de Proyecto",accessor:"project_type",render:(e,t)=>{const m=t.project_type||"General";let n="secondary";switch(m){case"An√°lisis de Suelos":n="success";break;case"Estudio Geot√©cnico":n="primary";break;case"Evaluaci√≥n Ambiental":n="info";break;case"Control de Calidad":n="warning";break;case"An√°lisis de Agua":n="info";break;case"Estudio de Impacto":n="danger";break;case"An√°lisis Qu√≠mico":n="primary";break;case"Pruebas de Laboratorio":n="success";break;case"Inspecci√≥n T√©cnica":n="warning";break;case"Certificaci√≥n de Materiales":n="info";break;default:n="secondary"}return a.jsx(d,{bg:n,className:"px-2 py-1",children:m})}},{header:"Empresa",accessor:"company_name",render:(e,t)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:t.company_name||"Sin empresa"}),t.company_ruc&&a.jsxs("small",{className:"text-muted",children:["RUC: ",t.company_ruc]})]})},{header:"Estado",accessor:"status",render:e=>ye(e||"activo")},{header:"Servicios Requeridos",accessor:"services",render:(e,t)=>a.jsxs("div",{className:"d-flex flex-wrap gap-1",children:[t.requiere_laboratorio&&a.jsxs(d,{bg:"info",className:"px-2 py-1",children:[a.jsx(p,{size:12,className:"me-1"}),"Laboratorio"]}),t.requiere_ingenieria&&a.jsxs(d,{bg:"primary",className:"px-2 py-1",children:[a.jsx(k,{size:12,className:"me-1"}),"Ingenier√≠a"]}),!t.requiere_laboratorio&&!t.requiere_ingenieria&&a.jsx(d,{bg:"secondary",className:"px-2 py-1",children:"Sin servicios"})]})},{header:"Contacto",accessor:"contacto",render:(e,t)=>a.jsxs("div",{className:"small",children:[t.contact_name&&a.jsx("div",{children:a.jsx("strong",{children:t.contact_name})}),t.contact_phone&&a.jsx("div",{className:"text-muted",children:t.contact_phone}),t.contact_email&&a.jsx("div",{className:"text-muted",children:t.contact_email}),!t.contact_name&&!t.contact_phone&&!t.contact_email&&a.jsx("span",{className:"text-muted",children:"Sin contacto"})]})},{header:"Asignado a",accessor:"vendedor_name",render:(e,t)=>a.jsxs("div",{children:[t.vendedor_name&&a.jsxs("div",{className:"d-flex align-items-center",children:[a.jsx(k,{size:14,className:"me-1 text-muted"}),a.jsx("span",{children:t.vendedor_name})]}),t.laboratorio_name&&a.jsxs("div",{className:"d-flex align-items-center mt-1",children:[a.jsx(p,{size:14,className:"me-1 text-muted"}),a.jsx("span",{className:"small text-muted",children:t.laboratorio_name})]})]})},{header:"Fecha Creaci√≥n",accessor:"created_at",type:"date"}],ve=[{name:"company_id",label:"Empresa/Cliente",type:"select",required:!0,options:((U=o==null?void 0:o.companies)==null?void 0:U.map(e=>({value:e.id,label:`${e.name} (${e.ruc||e.dni||"Sin RUC/DNI"})`})))||[],description:"Selecciona un cliente existente o crea uno nuevo desde el m√≥dulo de clientes"},{name:"name",label:"Nombre del Proyecto",type:"text",required:!0,placeholder:"Ingresa el nombre del proyecto"},{name:"location",label:"Ubicaci√≥n del Proyecto",type:"text",placeholder:"Ingresa la ubicaci√≥n del proyecto",required:!0},{name:"contact_name",label:"Persona de Contacto",type:"text",placeholder:"Nombre de la persona con quien negociar",description:"Persona responsable del proyecto en el cliente"},{name:"contact_phone",label:"Tel√©fono de Contacto",type:"text",placeholder:"Tel√©fono para comunicaci√≥n directa",description:"N√∫mero para llamadas urgentes o seguimiento"},{name:"contact_email",label:"Email de Contacto",type:"email",placeholder:"Email para comunicaci√≥n",description:"Email para env√≠o de reportes y documentos"},{name:"vendedor_id",label:"Vendedor Asignado",type:"select",options:((B=o==null?void 0:o.users)==null?void 0:B.filter(e=>["vendedor_comercial","jefa_comercial"].includes(e.role)).map(e=>({value:e.id,label:`${e.name} ${e.apellido}`})))||[]},{name:"laboratorio_id",label:"Responsable de Laboratorio",type:"select",options:((O=o==null?void 0:o.users)==null?void 0:O.filter(e=>["jefe_laboratorio","usuario_laboratorio","laboratorio"].includes(e.role)).map(e=>({value:e.id,label:`${e.name} ${e.apellido}`})))||[]},{name:"requiere_laboratorio",label:"Requiere Servicios de Laboratorio",type:"checkbox",description:"Marcar si el proyecto necesita an√°lisis o pruebas de laboratorio"},{name:"requiere_ingenieria",label:"Requiere Servicios de Ingenier√≠a",type:"checkbox",description:"Marcar si el proyecto necesita estudios o consultor√≠a de ingenier√≠a"}],u=s.useMemo(()=>{if(c)return console.log("üìä Stats - Usando estad√≠sticas reales del backend:",c),{total:c.total||0,activos:c.activos||0,completados:c.completados||0,pendientes:c.pendientes||0,cancelados:c.cancelados||0};const e=(o==null?void 0:o.data)||[];return console.log("üìä Stats - Fallback: calculando desde p√°gina actual:",e),{total:e.length,activos:e.filter(t=>t.status==="activo").length,completados:e.filter(t=>t.status==="completado").length,pendientes:e.filter(t=>t.status==="pendiente").length,cancelados:e.filter(t=>t.status==="cancelado").length}},[c,o]);return a.jsx(_e,{fluid:!0,className:"py-4",children:a.jsxs("div",{className:"fade-in",children:[a.jsx(we,{title:"Gesti√≥n de Proyectos",subtitle:i?`Crear proyecto para: ${i.name}`:"Crear, editar y gestionar proyectos del sistema",icon:p,actions:a.jsxs("div",{className:"d-flex gap-2",children:[i&&a.jsxs(d,{bg:"info",className:"px-3 py-2 d-flex align-items-center",children:[a.jsx(k,{className:"me-1"}),"Cliente: ",i.name]}),a.jsxs(W,{variant:"primary",onClick:ue,children:[a.jsx(Se,{className:"me-2"}),i?"Crear Proyecto":"Nuevo Proyecto"]})]})}),a.jsxs(Ie,{className:"g-4 mb-4",children:[a.jsx(x,{md:6,lg:3,children:a.jsx(j,{title:"Total Proyectos",value:u.total,icon:p,color:"primary",subtitle:"Proyectos registrados",loading:g})}),a.jsx(x,{md:6,lg:3,children:a.jsx(j,{title:"Proyectos Activos",value:u.activos,icon:X,color:"success",subtitle:"En desarrollo",loading:g})}),a.jsx(x,{md:6,lg:3,children:a.jsx(j,{title:"Completados",value:u.completados,icon:X,color:"info",subtitle:"Finalizados",loading:g})}),a.jsx(x,{md:6,lg:3,children:a.jsx(j,{title:"Pendientes",value:u.pendientes,icon:Pe,color:"warning",subtitle:"Por iniciar",loading:g})})]}),a.jsxs(M,{className:"shadow-sm border-0",children:[a.jsx(M.Header,{className:"bg-white border-bottom",children:a.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[a.jsxs("h5",{className:"mb-0",children:[a.jsx(p,{className:"me-2 text-primary"}),"Lista de Proyectos"]}),a.jsxs("div",{className:"d-flex align-items-center gap-2",children:[a.jsx(W,{variant:"outline-secondary",size:"sm",onClick:()=>ie(),className:"d-flex align-items-center",title:"Actualizar datos",children:a.jsx(Ne,{className:`${$?"spinning":""}`})}),a.jsxs(d,{bg:"light",text:"dark",className:"px-3 py-2",children:[u.total," proyectos"]})]})]})}),a.jsx(M.Body,{className:"p-0",children:a.jsx(Le,{data:(o==null?void 0:o.data)||[],columns:xe,loading:$||le,onEdit:D,onDelete:G,actions:[{label:"Editar",icon:Ee,onClick:D,variant:"outline-primary"},{label:"Estado",icon:ke,onClick:ge,variant:"outline-secondary"},{label:"Categor√≠as",icon:Me,onClick:me,variant:"outline-info"},{label:"Consultas",icon:Ae,onClick:pe,variant:"outline-warning"},{label:"Marcar",icon:Fe,onClick:be,variant:"outline-success"},{label:"Eliminar",icon:qe,onClick:G,variant:"outline-danger"}],emptyMessage:"No hay proyectos registrados",totalItems:(o==null?void 0:o.total)||0,itemsPerPage:20,currentPage:N,onPageChange:E,onSearch:ne,onFilter:re,filterOptions:ce})})]}),a.jsx(v,{show:Z,onHide:()=>b(!1),title:r!=null&&r.id?"Editar Proyecto":"Nuevo Proyecto",data:r||A,fields:ve,onSubmit:he,loading:z.isLoading||R.isLoading,submitText:r!=null&&r.id?"Actualizar":"Crear"}),a.jsx(v,{show:K,onHide:()=>C(!1),title:`Categor√≠as - ${(l==null?void 0:l.name)||""}`,data:l||{},fields:[{name:"categories",label:"Categor√≠as del Proyecto",type:"checkbox-group",options:[{value:"laboratorio",label:"Laboratorio"},{value:"ingenieria",label:"Ingenier√≠a"},{value:"consultoria",label:"Consultor√≠a"},{value:"capacitacion",label:"Capacitaci√≥n"},{value:"auditoria",label:"Auditor√≠a"}]}],onSubmit:e=>{console.log("Categor√≠as actualizadas:",e),C(!1)},submitText:"Guardar Categor√≠as"}),a.jsx(v,{show:Y,onHide:()=>_(!1),title:`Consultas - ${(l==null?void 0:l.name)||""}`,data:l||{},fields:[{name:"queries",label:"Consultas y Dudas",type:"textarea",placeholder:"Ingresa las consultas o dudas del cliente...",rows:5}],onSubmit:e=>{console.log("Consultas actualizadas:",e),_(!1)},submitText:"Guardar Consultas"}),a.jsx(v,{show:ee,onHide:()=>S(!1),title:`Actualizar Estado - ${(l==null?void 0:l.name)||""}`,data:l||{},fields:[{name:"status",label:"Estado del Proyecto",type:"select",required:!0,options:[{value:"pendiente",label:"Pendiente"},{value:"en_proceso",label:"En Proceso"},{value:"completado",label:"Completado"},{value:"pausado",label:"Pausado"},{value:"cancelado",label:"Cancelado"}]},{name:"laboratorio_status",label:"Estado del Servicio de Laboratorio",type:"select",options:[{value:"no_requerido",label:"No Requerido"},{value:"pendiente",label:"Pendiente"},{value:"en_proceso",label:"En Proceso"},{value:"completado",label:"Completado"},{value:"pausado",label:"Pausado"},{value:"cancelado",label:"Cancelado"}]},{name:"ingenieria_status",label:"Estado del Servicio de Ingenier√≠a",type:"select",options:[{value:"no_requerido",label:"No Requerido"},{value:"pendiente",label:"Pendiente"},{value:"en_proceso",label:"En Proceso"},{value:"completado",label:"Completado"},{value:"pausado",label:"Pausado"},{value:"cancelado",label:"Cancelado"}]},{name:"status_notes",label:"Notas del Estado",type:"textarea",placeholder:"Agrega comentarios sobre el cambio de estado...",rows:3}],onSubmit:e=>{Q.mutate({id:l.id,...e}),S(!1)},submitText:"Actualizar Estado",loading:Q.isLoading})]})})}export{aa as default};
//# sourceMappingURL=Proyectos-CSLd8lXX.js.map
