import{b as Q,c as $,d as H,e as D,u as B,a as O,r as E,F as b,f as j,g as f,h as T,j as e,i as x,k as C,B as A,l as P,m as L}from"./index-CJDD9_Aw.js";import{P as V}from"./PageHeader-Cfye0oPO.js";import{S as w}from"./StatsCard-DzydegCt.js";import{R as I,C as r}from"./Row-BGooJhRW.js";import{C as d}from"./Col-DkPevymr.js";import"./Spinner-BVQsrHFz.js";const G=()=>Q("/api/role-dashboard/stats"),X=(a={})=>{const s=new URLSearchParams(a).toString(),c=s?`/api/activities/recent?${s}`:"/api/activities/recent";return Q(c)},J=(a={})=>{var N,k,v,_;const s=$(),{limit:c=4,refetchInterval:n=3e5,staleTime:y=6e4,enabled:g=!0,userId:u=null,role:h=null}=a;H({onNewNotification:i=>{i.type&&(i.type.includes("quote")||i.type.includes("project")||i.type.includes("ticket")||i.type.includes("evidence")||i.type.includes("user")||i.type.includes("client"))&&s.invalidateQueries(["recentActivities"])},onUnreadCountUpdate:()=>{s.invalidateQueries(["recentActivities"])}});const l=D(["recentActivities",{limit:c,userId:u,role:h}],()=>X({limit:c,userId:u,role:h}),{enabled:g,refetchInterval:n,staleTime:y,refetchOnWindowFocus:!0,refetchOnMount:!0,retry:2,retryDelay:5e3,cacheTime:3e5,networkMode:"online",onError:i=>{console.warn("Error loading activities:",i)}});return{...l,refreshActivities:()=>{s.invalidateQueries(["recentActivities"])},getCachedActivities:()=>s.getQueryData(["recentActivities",{limit:c}]),hasActivities:((k=(N=l.data)==null?void 0:N.activities)==null?void 0:k.length)>0,activitiesCount:((_=(v=l.data)==null?void 0:v.activities)==null?void 0:_.length)||0,isOptimized:!0,lastFetch:l.dataUpdatedAt,nextFetch:l.dataUpdatedAt+n}},R=()=>{console.log("üîç DEBUG: Verificando autenticaci√≥n...");const a=localStorage.getItem("token");if(console.log("üîë Token en localStorage:",a?`${a.substring(0,50)}...`:"NO ENCONTRADO"),a)try{const c=JSON.parse(atob(a.split(".")[1]));console.log("üë§ Usuario del token:",c),console.log("‚è∞ Token expira en:",new Date(c.exp*1e3))}catch(c){console.error("‚ùå Error decodificando token:",c)}const s="http://localhost:4000/api";return console.log("üåê API URL configurada:",s),{hasToken:!!a,token:a,apiUrl:s}},W=async()=>{console.log("üß™ Probando conexi√≥n con backend...");try{const a=await fetch("/api/dashboard/stats",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(console.log("üì° Respuesta del backend:",a.status,a.statusText),a.ok){const s=await a.json();return console.log("üìä Datos del dashboard:",s),s}else{const s=await a.text();return console.error("‚ùå Error del backend:",s),null}}catch(a){return console.error("‚ùå Error de conexi√≥n:",a),null}},Y=()=>R().hasToken?(console.log("‚úÖ Token encontrado, verificando validez..."),!0):(console.log("üö® PROBLEMA: No hay token de autenticaci√≥n"),console.log("üí° SOLUCI√ìN: El usuario necesita iniciar sesi√≥n"),!1),oe=()=>{var i,F,q,z,S;const a=B(),{user:s}=O();E.useEffect(()=>{if(s!=null&&s.role)switch(s.role){case"vendedor_comercial":a("/dashboard-asesor",{replace:!0});break;case"jefa_comercial":a("/dashboards/jefa-comercial",{replace:!0});break;case"jefe_laboratorio":case"usuario_laboratorio":a("/dashboards/laboratorio",{replace:!0});break;case"facturacion":a("/dashboards/facturacion",{replace:!0});break;case"soporte":a("/dashboards/soporte",{replace:!0});break;case"gerencia":case"admin":a("/dashboards/gerencia",{replace:!0});break}},[s,a]),E.useEffect(()=>{console.log("üîç Dashboard: Verificando autenticaci√≥n..."),R(),Y(),W().then(t=>{console.log(t?"‚úÖ Dashboard: Conexi√≥n con backend exitosa":"‚ùå Dashboard: Error en conexi√≥n con backend")})},[]);const{data:c,isLoading:n,error:y}=D(["dashboardStats"],G,{refetchInterval:3e5,staleTime:6e4,onSuccess:t=>{console.log("‚úÖ Dashboard: Datos recibidos del backend:",t)},onError:t=>{console.error("‚ùå Dashboard: Error obteniendo datos:",t)}}),{data:g,isLoading:u,activitiesCount:h,refreshActivities:l}=J({limit:4,refetchInterval:3e5,staleTime:6e4,userId:s==null?void 0:s.id,role:s==null?void 0:s.role}),o=c?{totalUsers:parseInt(c.totalUsers)||0,totalProjects:parseInt(c.totalProjects)||0,totalQuotes:parseInt(c.totalQuotes)||0,totalTickets:parseInt(c.totalTickets)||0,activeProjects:parseInt(c.activeProjects)||0,pendingQuotes:parseInt(c.pendingQuotes)||0,openTickets:parseInt(c.openTickets)||0,completedProjects:parseInt(c.completedProjects)||0,totalClients:parseInt(c.totalClients)||0,totalEvidences:parseInt(c.totalEvidences)||0,activeUsersThisMonth:parseInt(c.activeUsersThisMonth)||0,quotesThisMonth:parseInt(c.quotesThisMonth)||0,ticketsThisMonth:parseInt(c.ticketsThisMonth)||0,changePercentages:{users:0,projects:0,quotes:0,tickets:0}}:{totalUsers:0,totalProjects:0,totalQuotes:0,totalTickets:0,activeProjects:0,pendingQuotes:0,openTickets:0,completedProjects:0,totalClients:0,totalEvidences:0,activeUsersThisMonth:0,quotesThisMonth:0,ticketsThisMonth:0,changePercentages:{users:0,projects:0,quotes:0,tickets:0}};E.useEffect(()=>{console.log("üìä Dashboard: Estado de los datos:"),console.log("- isLoading:",n),console.log("- error:",y),console.log("- data:",c),console.log("- stats procesados:",o),console.log("- totalUsers:",o.totalUsers,typeof o.totalUsers),console.log("- totalProjects:",o.totalProjects,typeof o.totalProjects),console.log("- totalQuotes:",o.totalQuotes,typeof o.totalQuotes),console.log("- totalTickets:",o.totalTickets,typeof o.totalTickets)},[n,y,c,o]);const M=t=>{const m=new Date,U=new Date(t),p=Math.floor((m-U)/(1e3*60));return p<1?"Ahora":p<60?`Hace ${p} min`:p<1440?`Hace ${Math.floor(p/60)} h`:`Hace ${Math.floor(p/1440)} d√≠as`},N=t=>({quote_created:b,quote_assigned:b,quote_approved:j,quote_rejected:FiX,quote_completed:j,project_created:C,project_assigned:C,project_started:x,project_completed:j,project_delayed:FiClock,ticket_created:f,ticket_assigned:f,ticket_resolved:j,ticket_escalated:FiAlertTriangle,evidence_uploaded:FiPaperclip,evidence_approved:j,evidence_rejected:FiX,user_registered:T,user_assigned:T,user_role_changed:FiSettings,client_created:FiUser,client_updated:FiUser,system_maintenance:FiSettings,system_update:FiSettings})[t]||P,k=t=>({quote_created:"primary",quote_assigned:"primary",quote_approved:"success",quote_rejected:"danger",quote_completed:"success",project_created:"info",project_assigned:"info",project_started:"info",project_completed:"success",project_delayed:"warning",ticket_created:"warning",ticket_assigned:"warning",ticket_resolved:"success",ticket_escalated:"danger",evidence_uploaded:"secondary",evidence_approved:"success",evidence_rejected:"danger",user_registered:"info",user_assigned:"info",user_role_changed:"secondary",client_created:"primary",client_updated:"primary",system_maintenance:"secondary",system_update:"secondary"})[t]||"secondary",v=((i=g==null?void 0:g.activities)==null?void 0:i.map(t=>({id:t.id,type:t.type,title:t.title,description:t.description,time:M(t.created_at),icon:N(t.type),color:k(t.type),user:t.user_name})))||[{id:1,type:"quote_created",title:"Nueva cotizaci√≥n creada",description:"Cotizaci√≥n #2024-001 para Proyecto ABC",time:"Hace 2 horas",icon:b,color:"primary"},{id:2,type:"project_completed",title:"Proyecto completado",description:"Proyecto XYZ finalizado exitosamente",time:"Hace 4 horas",icon:j,color:"success"},{id:3,type:"ticket_created",title:"Nuevo ticket de soporte",description:"Solicitud de soporte t√©cnico",time:"Hace 6 horas",icon:f,color:"warning"},{id:4,type:"user_registered",title:"Usuario registrado",description:"Nuevo usuario agregado al sistema",time:"Hace 8 horas",icon:T,color:"info"}],_=[{title:"Nuevo Proyecto",description:"Crear un nuevo proyecto",icon:C,color:"primary",onClick:()=>a("/proyectos")},{title:"Nueva Cotizaci√≥n",description:"Generar cotizaci√≥n",icon:b,color:"success",onClick:()=>a("/cotizaciones/nueva/lem")},{title:"Nuevo Ticket",description:"Crear ticket de soporte",icon:f,color:"warning",onClick:()=>a("/tickets")},{title:"Ver Reportes",description:"Analizar datos del sistema",icon:x,color:"info",onClick:()=>a("/reportes")}];return e.jsxs("div",{className:"fade-in",children:[e.jsx(V,{title:"Dashboard",subtitle:"Resumen general del sistema CRM GeoFal",icon:x}),e.jsxs(I,{className:"mb-4",children:[e.jsx(d,{lg:3,md:6,className:"mb-3",children:e.jsx(w,{title:"Total Usuarios",value:o.totalUsers,icon:T,color:"primary",trend:((F=o.changePercentages)==null?void 0:F.users)||null,subtitle:`${o.activeUsersThisMonth||0} usuarios activos este mes`,loading:n})}),e.jsx(d,{lg:3,md:6,className:"mb-3",children:e.jsx(w,{title:"Proyectos Activos",value:o.activeProjects,icon:C,color:"success",trend:((q=o.changePercentages)==null?void 0:q.projects)||null,subtitle:`${o.totalProjects} proyectos totales`,loading:n})}),e.jsx(d,{lg:3,md:6,className:"mb-3",children:e.jsx(w,{title:"Cotizaciones Pendientes",value:o.pendingQuotes,icon:b,color:"warning",trend:((z=o.changePercentages)==null?void 0:z.quotes)||null,subtitle:`${o.quotesThisMonth||0} cotizaciones este mes`,loading:n})}),e.jsx(d,{lg:3,md:6,className:"mb-3",children:e.jsx(w,{title:"Tickets Abiertos",value:o.openTickets,icon:f,color:"danger",trend:((S=o.changePercentages)==null?void 0:S.tickets)||null,subtitle:`${o.ticketsThisMonth||0} tickets este mes`,loading:n})})]}),e.jsxs(I,{children:[e.jsx(d,{lg:8,className:"mb-4",children:e.jsxs(r,{className:"h-100",children:[e.jsxs(r.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"mb-0",children:"Actividades Recientes"}),h>0&&e.jsxs("small",{className:"text-muted",children:[h," actividad",h!==1?"es":""," ‚Ä¢ Actualizado autom√°ticamente"]}),(s==null?void 0:s.role)!=="admin"&&e.jsxs("small",{className:"text-info d-block",children:["Mostrando solo actividades relevantes a tu rol: ",s==null?void 0:s.role]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(A,{variant:"outline-secondary",size:"sm",onClick:l,disabled:u,title:"Actualizar actividades",className:"refresh-btn",children:e.jsx(P,{className:u?"spinning":""})}),(s==null?void 0:s.role)==="admin"&&e.jsxs(A,{variant:"outline-primary",size:"sm",onClick:()=>a("/actividades"),title:"Ver todas las actividades (Solo Admin)",children:[e.jsx(L,{className:"me-1"}),"Ver todas"]})]})]}),e.jsx(r.Body,{children:u?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando actividades..."})}),e.jsx("p",{className:"mt-2 text-muted",children:"Cargando actividades recientes..."})]}):v.length===0?e.jsxs("div",{className:"activity-empty-state text-center",children:[e.jsx("div",{className:"mb-3",children:e.jsx(P,{size:48,className:"text-muted icon"})}),e.jsx("h6",{className:"text-muted mb-2",children:"No hay actividades recientes"}),e.jsx("p",{className:"text-muted small mb-3",children:(s==null?void 0:s.role)==="admin"?"A√∫n no hay actividades registradas en el sistema.":"No hay actividades relevantes a tu rol en este momento."}),e.jsxs(A,{variant:"outline-primary",size:"sm",onClick:l,className:"mt-2",children:[e.jsx(P,{className:"me-1"}),"Actualizar"]})]}):e.jsx("div",{className:"activity-list",children:v.map(t=>{const m=t.icon;return e.jsxs("div",{className:"activity-item d-flex align-items-start mb-3",children:[e.jsx("div",{className:`activity-icon bg-${t.color} bg-opacity-10 rounded-circle p-2 me-3`,children:e.jsx(m,{size:20,className:`text-${t.color}`})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:t.title}),e.jsx("p",{className:"text-muted mb-1 small",children:t.description}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:t.time}),t.user&&e.jsxs("small",{className:"text-muted",children:["por ",t.user]})]})]})]},t.id)})})})]})}),e.jsx(d,{lg:4,className:"mb-4",children:e.jsxs(r,{className:"h-100",children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Acciones R√°pidas"})}),e.jsx(r.Body,{children:e.jsx("div",{className:"quick-actions",children:_.map((t,m)=>{const U=t.icon;return e.jsxs(A,{variant:`outline-${t.color}`,className:"w-100 mb-3 d-flex align-items-center justify-content-start",onClick:t.onClick,children:[e.jsx("div",{className:`me-3 bg-${t.color} bg-opacity-10 rounded-circle p-2`,children:e.jsx(U,{size:20,className:`text-${t.color}`})}),e.jsxs("div",{className:"text-start",children:[e.jsx("div",{className:"fw-medium",children:t.title}),e.jsx("small",{className:"text-muted",children:t.description})]})]},m)})})})]})})]}),e.jsxs(I,{children:[e.jsx(d,{lg:6,className:"mb-4",children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Resumen de Proyectos"})}),e.jsxs(r.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Completados"}),e.jsx("span",{className:"fw-bold text-success",children:o.completedProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Activos"}),e.jsx("span",{className:"fw-bold text-primary",children:o.activeProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Total Proyectos"}),e.jsx("span",{className:"fw-bold",children:o.totalProjects})]})]})]})}),e.jsx(d,{lg:6,className:"mb-4",children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Estado del Sistema"})}),e.jsxs(r.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Usuarios Online"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(x,{className:"me-1"}),Math.floor(o.totalUsers*.3)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Cotizaciones Este Mes"}),e.jsxs("span",{className:"fw-bold text-primary",children:[e.jsx(x,{className:"me-1"}),Math.floor(o.totalQuotes*.4)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Tickets Resueltos"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(x,{className:"me-1"}),Math.floor(o.totalTickets*.7)]})]})]})]})})]})]})};export{oe as default};
//# sourceMappingURL=Dashboard-D3tUtFNb.js.map
