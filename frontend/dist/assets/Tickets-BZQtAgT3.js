import{r,a as re,j as e,g as P,n as ge,O as Q,T as $,N as pe,am as Ne,an as X,C as k,I as oe,B as _,f as ie,o as ye,b as R,c as ve,e as B,x as J,L as Z,Q as be,A as fe,y as ee,W as Ce,ao as Se,ap as ke,m as we}from"./index-Cuktr-pt.js";import{P as Te}from"./PageHeader-BYHPV7CG.js";import{S as z}from"./StatsCard-BrhQkFRp.js";import{g as Ee,c as _e,T as Ae}from"./ticketComments-DpYzbGbL.js";import{M as L}from"./Modal-DX3fBC5J.js";import{T as Fe,a as se}from"./Tabs-HFhgAc8J.js";import{R as q,C as ae}from"./Row-DXxIMG7u.js";import{C as g}from"./Col-nNxAn9NL.js";import{C as n}from"./Card-B0ZWfcwD.js";import{F as A}from"./Form-luTHskiS.js";import{S as Be}from"./SuccessModal-Cpw2-i9u.js";import{u as Me,c as He,l as Le}from"./tickets-DWmA2ZZs.js";import{A as Pe}from"./Alert-D03HJGca.js";import{I as te}from"./InputGroup-aBcikS0_.js";import{S as Re}from"./Spinner-B39M6lL3.js";/* empty css                  */import"./ElementChildren-CA6H3NXv.js";const Ie=({ticketId:o})=>{const[m,t]=r.useState(""),[p,M]=r.useState([]),[N,y]=r.useState(!1),[v,b]=r.useState(!0),[f,x]=r.useState("idle"),w=r.useRef(null),{user:j}=re();r.useEffect(()=>{const a=async()=>{try{const h=await fetch("http://localhost:4000/api/health",{method:"HEAD",timeout:3e3});b(h.ok)}catch{b(!1)}};a();const c=setInterval(a,1e4);return()=>clearInterval(c)},[]),r.useEffect(()=>{C();const a=setInterval(()=>{v&&C()},5e3);return()=>clearInterval(a)},[o,v]);const C=async()=>{try{const a=await Ee(o);console.log("ðŸ” [HYBRID] Comentarios del backend:",a),a&&a.length>0?(M(a),console.log("âœ… [HYBRID] Comentarios cargados desde backend:",a.length)):(M([]),console.log("ðŸ“ [HYBRID] No hay comentarios en el backend"))}catch(a){console.error("âŒ [HYBRID] Error cargando comentarios del backend:",a),M([])}},H=()=>{var a;(a=w.current)==null||a.scrollIntoView({behavior:"smooth"})};r.useEffect(()=>{H()},[p]);const T=async a=>{if(a.preventDefault(),m.trim()&&!N){y(!0),x("syncing");const c=m.trim();t("");try{const h=await _e({ticket_id:o,comment:c});console.log("âœ… [HYBRID] Mensaje enviado al backend:",h),await C(),x("success"),console.log("âœ… [HYBRID] Mensaje sincronizado correctamente")}catch(h){console.error("âŒ [HYBRID] Error enviando mensaje al backend:",h),x("error")}y(!1),setTimeout(()=>x("idle"),3e3)}},i=a=>new Date(a).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),u=a=>a.is_system||a.user_name==="Sistema",I=a=>{const c=["#3b82f6","#ef4444"],h=a.split("").reduce((F,G)=>(F=(F<<5)-F+G.charCodeAt(0),F&F),0);return c[Math.abs(h)%c.length]},d=()=>{switch(f){case"syncing":return e.jsx("div",{className:"spinner-small"});case"success":return e.jsx($,{className:"text-success"});case"error":return e.jsx(X,{className:"text-warning"});default:return v?e.jsx(Ne,{className:"text-success"}):e.jsx(X,{className:"text-danger"})}};return e.jsxs("div",{className:"ticket-chat",children:[e.jsxs("div",{className:"ticket-chat-header",children:[e.jsx(P,{className:"chat-icon"}),e.jsx("h4",{children:"ConversaciÃ³n del Ticket"}),e.jsxs("div",{className:"header-info",children:[e.jsxs("span",{className:"comment-count",children:[p.length," comentarios"]}),e.jsxs("div",{className:"connection-status",children:[d(),e.jsx("span",{className:"status-text",children:v?"En lÃ­nea":"Offline"})]})]})]}),e.jsxs("div",{className:"ticket-chat-messages",children:[p.map(a=>{const c=u(a)?"#6c757d":I(a.user_name||"Usuario"),h=a.user_id===(j==null?void 0:j.id);return e.jsxs("div",{className:`message ${u(a)?"system":h?"own":"other"}`,children:[e.jsxs("div",{className:"message-header",children:[e.jsxs("div",{className:"message-user",children:[e.jsx("div",{className:"user-color-bar",style:{width:"4px",height:"20px",backgroundColor:c,borderRadius:"2px",marginRight:"8px"}}),e.jsx(ge,{className:"user-icon",style:{color:c}}),e.jsx("span",{className:"user-name",style:{color:c},children:u(a)?"Sistema":`${a.user_name} ${a.user_apellido||""}`}),a.user_role&&a.user_role!=="system"&&e.jsxs("span",{className:"user-role",children:["(",a.user_role,")"]})]}),e.jsxs("div",{className:"message-time",children:[e.jsx(Q,{className:"time-icon"}),i(a.created_at)]})]}),e.jsx("div",{className:"message-content",children:a.comment}),a.is_read&&e.jsxs("div",{className:"message-status",children:[e.jsx($,{className:"read-icon"}),"LeÃ­do"]})]},a.id)}),e.jsx("div",{ref:w})]}),e.jsxs("form",{className:"ticket-chat-input",onSubmit:T,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("textarea",{value:m,onChange:a=>t(a.target.value),placeholder:v?"Escribe tu comentario aquÃ­...":"Escribe tu comentario (se guardarÃ¡ offline)...",className:"comment-input",rows:3,disabled:N}),e.jsx("button",{type:"submit",className:"send-button",disabled:!m.trim()||N,children:N?e.jsx("div",{className:"spinner-small"}):e.jsx(pe,{className:"send-icon"})})]}),e.jsxs("div",{className:"sync-status",children:[f==="syncing"&&e.jsx("span",{children:"Sincronizando..."}),f==="success"&&e.jsx("span",{className:"text-success",children:"âœ… Sincronizado"}),f==="error"&&e.jsx("span",{className:"text-warning",children:"âš ï¸ Guardado offline"})]})]})]})},De=({show:o,onHide:m,ticket:t,onUpdateStatus:p})=>{const[M,N]=r.useState(""),[y,v]=r.useState((t==null?void 0:t.status)||"abierto"),[b,f]=r.useState("details"),{user:x}=re(),w=i=>({abierto:"warning",en_progreso:"info",resuelto:"success",cerrado:"secondary",cancelado:"danger"})[i]||"secondary",j=i=>({abierto:"Abierto",en_progreso:"En Progreso",resuelto:"Resuelto",cerrado:"Cerrado",cancelado:"Cancelado"})[i]||i,C=i=>({baja:"success",media:"warning",alta:"danger",urgente:"danger"})[i]||"secondary",H=i=>({baja:"Baja",media:"Media",alta:"Alta",urgente:"Urgente"})[i]||i,T=()=>{p&&y!==t.status&&p(t.id,y)};return t?e.jsxs(L,{show:o,onHide:m,size:"xl",className:"ticket-history-modal",children:[e.jsx(L.Header,{closeButton:!0,className:"ticket-history-header",children:e.jsxs("div",{className:"ticket-header-content",children:[e.jsxs(L.Title,{className:"mb-0",children:["Historial del Ticket #",t.id]}),e.jsx("small",{className:"text-muted",children:t.title})]})}),e.jsx(L.Body,{className:"ticket-history-body",children:e.jsxs(Fe,{activeKey:b,onSelect:i=>f(i),className:"ticket-tabs",children:[e.jsx(se,{eventKey:"details",title:"Detalles",children:e.jsxs(q,{children:[e.jsx(g,{md:8,children:e.jsxs(n,{className:"ticket-info-card",children:[e.jsx(n.Header,{className:"ticket-info-header",children:e.jsxs("h5",{className:"mb-0",children:[e.jsx(P,{className:"me-2"}),"InformaciÃ³n del Ticket"]})}),e.jsx(n.Body,{children:e.jsxs("div",{className:"ticket-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"TÃ­tulo:"}),e.jsx("span",{children:t.title})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"DescripciÃ³n:"}),e.jsx("span",{children:t.description})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"MÃ³dulo:"}),e.jsx(k,{bg:"info",children:t.module||"No especificado"})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"CategorÃ­a:"}),e.jsx(k,{bg:"secondary",children:t.category||"No especificado"})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"Tipo:"}),e.jsx(k,{bg:"light",text:"dark",children:t.type||"No especificado"})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"Prioridad:"}),e.jsx(k,{bg:C(t.priority),children:H(t.priority)})]}),t.assigned_to&&e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"Asignado a:"}),e.jsx("span",{children:t.assigned_to})]}),t.estimated_time&&e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"Tiempo estimado:"}),e.jsx("span",{children:t.estimated_time})]}),t.tags&&e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"Etiquetas:"}),e.jsx("div",{className:"tags-container",children:t.tags.split(",").map((i,u)=>e.jsx(k,{bg:"outline-secondary",className:"me-1",children:i.trim()},u))})]}),t.additional_notes&&e.jsxs("div",{className:"detail-row",children:[e.jsx("strong",{children:"Notas adicionales:"}),e.jsx("span",{children:t.additional_notes})]})]})})]})}),e.jsxs(g,{md:4,children:[e.jsxs(n,{className:"ticket-control-card",children:[e.jsx(n.Header,{className:"ticket-control-header",children:e.jsxs("h5",{className:"mb-0",children:[e.jsx(oe,{className:"me-2"}),"Control del Ticket"]})}),e.jsx(n.Body,{children:e.jsxs("div",{className:"ticket-control-section",children:[e.jsxs("div",{className:"status-section",children:[e.jsx("h6",{children:"Estado Actual"}),e.jsx(k,{bg:w(t.status),className:"status-badge",children:j(t.status)})]}),e.jsxs(A,{className:"status-update-form",children:[e.jsxs(A.Group,{className:"mb-3",children:[e.jsx(A.Label,{children:"Cambiar Estado"}),e.jsxs(A.Select,{value:y,onChange:i=>v(i.target.value),className:"status-select",children:[e.jsx("option",{value:"abierto",children:"Abierto"}),e.jsx("option",{value:"en_progreso",children:"En Progreso"}),e.jsx("option",{value:"resuelto",children:"Resuelto"}),e.jsx("option",{value:"cerrado",children:"Cerrado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})]}),e.jsxs(_,{variant:"success",className:"update-status-btn",onClick:T,disabled:y===t.status,children:[e.jsx(ie,{className:"me-1"}),"Actualizar Estado"]})]})]})})]}),e.jsxs(n,{className:"ticket-time-card mt-3",children:[e.jsx(n.Header,{className:"ticket-time-header",children:e.jsxs("h5",{className:"mb-0",children:[e.jsx(Q,{className:"me-2"}),"InformaciÃ³n de Tiempo"]})}),e.jsx(n.Body,{children:e.jsxs("div",{className:"time-info",children:[e.jsxs("div",{className:"time-item",children:[e.jsx("strong",{children:"Creado:"}),e.jsx("span",{children:new Date(t.created_at).toLocaleString("es-ES")})]}),e.jsxs("div",{className:"time-item",children:[e.jsx("strong",{children:"Ãšltima ActualizaciÃ³n:"}),e.jsx("span",{children:new Date(t.updated_at).toLocaleString("es-ES")})]})]})})]})]})]})}),e.jsx(se,{eventKey:"chat",title:"ConversaciÃ³n",children:e.jsx(Ie,{ticketId:t.id})})]})}),e.jsx(L.Footer,{children:e.jsxs(_,{variant:"secondary",onClick:m,children:[e.jsx(ye,{className:"me-1"}),"Cerrar"]})})]}):null},ze=async()=>{try{return await R("/api/ticket-filters/users")||[]}catch(o){return console.error("Error obteniendo usuarios:",o),[]}},Ue=async()=>{try{return await R("/api/ticket-filters/modules")||[]}catch(o){return console.error("Error obteniendo mÃ³dulos:",o),[]}},Oe=async()=>{try{return await R("/api/ticket-filters/categories")||[]}catch(o){return console.error("Error obteniendo categorÃ­as:",o),[]}},Ye=async()=>{try{return await R("/api/ticket-filters/types")||[]}catch(o){return console.error("Error obteniendo tipos:",o),[]}},qe=async()=>{try{return await R("/api/ticket-filters/stats")||{}}catch(o){return console.error("Error obteniendo estadÃ­sticas:",o),{}}};function ls(){const[o,m]=r.useState(!1),[t,p]=r.useState(!1),[M,N]=r.useState(null),[y,v]=r.useState(null),[b,f]=r.useState(""),[x,w]=r.useState(""),[j,C]=r.useState(""),[H,T]=r.useState(!1),[i,u]=r.useState(""),I=ve(),{data:d,isLoading:a,error:c}=B(["tickets"],()=>Le(),{keepPreviousData:!0,onSuccess:s=>{console.log("ðŸŽ« Tickets cargados:",s),console.log("ðŸŽ« Tipo de datos:",typeof s),console.log("ðŸŽ« Es array:",Array.isArray(s))},onError:s=>{console.error("âŒ Error cargando tickets:",s)}}),{data:h=[]}=B(["users"],ze),{data:F=[]}=B(["ticket-modules"],Ue),{data:G=[]}=B(["ticket-categories"],Oe),{data:Qe=[]}=B(["ticket-types"],Ye),{data:E={}}=B(["ticket-stats"],qe),W=J(He,{onSuccess:()=>{I.invalidateQueries("tickets"),m(!1),N(null),u("El ticket ha sido creado exitosamente y estÃ¡ listo para ser procesado por el equipo de soporte."),T(!0)},onError:s=>{console.error("Error creating ticket:",s),alert("âŒ Error al crear el ticket")}}),ne=J(({id:s,status:l})=>Me(s,l),{onSuccess:()=>{I.invalidateQueries("tickets"),u("El estado del ticket ha sido actualizado exitosamente."),T(!0)},onError:s=>{console.error("Error updating ticket:",s),alert("âŒ Error al actualizar el ticket")}}),K=()=>{N(null),m(!0)},ce=s=>{W.mutate(s)},le=s=>{N(s),m(!0)},de=s=>{v(s),p(!0)},me=(s,l)=>{ne.mutate({id:s,status:l})},ue=s=>({abierto:"warning",en_progreso:"info",resuelto:"success",cerrado:"secondary",cancelado:"danger"})[s]||"secondary",he=s=>({abierto:"Abierto",en_progreso:"En Progreso",resuelto:"Resuelto",cerrado:"Cerrado",cancelado:"Cancelado"})[s]||s,xe=s=>({baja:"success",media:"warning",alta:"danger",critica:"dark"})[s]||"secondary",je=s=>({baja:"Baja",media:"Media",alta:"Alta",critica:"CrÃ­tica"})[s]||s,U=r.useMemo(()=>!d||!Array.isArray(d)?[]:d.filter(s=>{var S,V;const l=((S=s.title)==null?void 0:S.toLowerCase().includes(b.toLowerCase()))||((V=s.description)==null?void 0:V.toLowerCase().includes(b.toLowerCase())),O=!x||s.status===x,Y=!j||s.priority===j;return l&&O&&Y}),[d,b,x,j]),D=r.useMemo(()=>{if(E&&Object.keys(E).length>0)return{total:E.total||0,open:E.abierto||0,inProgress:E.en_progreso||0,resolved:E.resuelto||0};if(!d||!Array.isArray(d))return{total:0,open:0,inProgress:0,resolved:0};const s=d.length,l=d.filter(S=>S.status==="abierto").length,O=d.filter(S=>S.status==="en_progreso").length,Y=d.filter(S=>S.status==="resuelto").length;return{total:s,open:l,inProgress:O,resolved:Y}},[d,E]);return c?e.jsx(ae,{fluid:!0,className:"py-4",children:e.jsxs(Pe,{variant:"danger",children:[e.jsx(Z,{className:"me-2"}),"Error al cargar los tickets: ",c.message]})}):e.jsx("div",{className:"tickets-page",children:e.jsxs(ae,{fluid:!0,className:"py-4",children:[e.jsx(Te,{title:"ðŸŽ« GestiÃ³n de Tickets",subtitle:"Administra y da seguimiento a los tickets de soporte"}),e.jsxs(q,{className:"mb-4",children:[e.jsx(g,{md:3,children:e.jsx(z,{title:"Total Tickets",value:D.total,icon:P,color:"primary"})}),e.jsx(g,{md:3,children:e.jsx(z,{title:"Abiertos",value:D.open,icon:Z,color:"warning"})}),e.jsx(g,{md:3,children:e.jsx(z,{title:"En Progreso",value:D.inProgress,icon:Q,color:"info"})}),e.jsx(g,{md:3,children:e.jsx(z,{title:"Resueltos",value:D.resolved,icon:ie,color:"success"})})]}),e.jsx(n,{className:"mb-4 tickets-filters-card",children:e.jsx(n.Body,{children:e.jsxs(q,{className:"align-items-center",children:[e.jsx(g,{md:4,children:e.jsxs(te,{children:[e.jsx(te.Text,{children:e.jsx(be,{})}),e.jsx(A.Control,{type:"text",placeholder:"Buscar tickets...",value:b,onChange:s=>f(s.target.value),className:"tickets-search-input"})]})}),e.jsx(g,{md:3,children:e.jsxs(A.Select,{value:x,onChange:s=>w(s.target.value),className:"tickets-filter-select",children:[e.jsx("option",{value:"",children:"Todos los estados"}),e.jsx("option",{value:"abierto",children:"Abierto"}),e.jsx("option",{value:"en_progreso",children:"En Progreso"}),e.jsx("option",{value:"resuelto",children:"Resuelto"}),e.jsx("option",{value:"cerrado",children:"Cerrado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})}),e.jsx(g,{md:3,children:e.jsxs(A.Select,{value:j,onChange:s=>C(s.target.value),className:"tickets-filter-select",children:[e.jsx("option",{value:"",children:"Todas las prioridades"}),e.jsx("option",{value:"baja",children:"Baja"}),e.jsx("option",{value:"media",children:"Media"}),e.jsx("option",{value:"alta",children:"Alta"}),e.jsx("option",{value:"critica",children:"CrÃ­tica"})]})}),e.jsx(g,{md:2,children:e.jsxs(_,{variant:"outline-primary",onClick:()=>{f(""),w(""),C("")},className:"w-100",children:[e.jsx(fe,{className:"me-1"}),"Limpiar"]})})]})})}),e.jsxs(n,{className:"tickets-list-card",children:[e.jsx(n.Header,{className:"tickets-list-header",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(P,{className:"me-2"}),"Tickets de Soporte (",U.length,")"]}),e.jsxs(_,{variant:"primary",onClick:K,className:"tickets-create-btn",children:[e.jsx(ee,{className:"me-2"}),"Nuevo Ticket"]})]})}),e.jsx(n.Body,{className:"tickets-list-body",children:a?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(Re,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-3 text-muted",children:"Cargando tickets..."})]}):U.length===0?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(P,{size:48,className:"text-muted mb-3"}),e.jsx("h5",{className:"text-muted",children:"No hay tickets"}),e.jsx("p",{className:"text-muted",children:"No se encontraron tickets que coincidan con los filtros."}),e.jsxs(_,{variant:"primary",onClick:K,children:[e.jsx(ee,{className:"me-2"}),"Crear Primer Ticket"]})]}):e.jsx("div",{className:"tickets-grid",children:U.map(s=>{var l;return e.jsx(n,{className:"ticket-card",children:e.jsxs(n.Body,{children:[e.jsxs("div",{className:"ticket-header",children:[e.jsxs("div",{className:"ticket-title",children:[e.jsxs("h6",{className:"mb-1",children:["#",s.id," - ",s.title]}),e.jsxs("small",{className:"text-muted",children:[(l=s.description)==null?void 0:l.substring(0,100),"..."]})]}),e.jsxs("div",{className:"ticket-badges",children:[e.jsx(k,{bg:ue(s.status),className:"me-1",children:he(s.status)}),e.jsx(k,{bg:xe(s.priority),children:je(s.priority)})]})]}),e.jsx("div",{className:"ticket-meta",children:e.jsxs("div",{className:"ticket-info",children:[e.jsxs("small",{className:"text-muted",children:[e.jsx(Ce,{className:"me-1"}),new Date(s.created_at).toLocaleDateString()]}),s.module&&e.jsxs("small",{className:"text-muted ms-3",children:[e.jsx(Se,{className:"me-1"}),s.module]}),s.category&&e.jsxs("small",{className:"text-muted ms-3",children:[e.jsx(ke,{className:"me-1"}),s.category]})]})}),e.jsxs("div",{className:"ticket-actions",children:[e.jsxs(_,{variant:"outline-primary",size:"sm",onClick:()=>de(s),className:"me-2",children:[e.jsx(we,{className:"me-1"}),"Ver"]}),e.jsxs(_,{variant:"outline-secondary",size:"sm",onClick:()=>le(s),children:[e.jsx(oe,{className:"me-1"}),"Editar"]})]})]})},s.id)})})})]}),e.jsx(Ae,{show:o,onHide:()=>m(!1),onSubmit:ce,isLoading:W.isLoading}),e.jsx(De,{show:t,onHide:()=>p(!1),ticket:y,onUpdateStatus:me}),e.jsx(Be,{show:H,onHide:()=>T(!1),title:"Â¡Ticket Procesado!",message:i,buttonText:"Continuar"})]})})}export{ls as default};
//# sourceMappingURL=Tickets-BZQtAgT3.js.map
