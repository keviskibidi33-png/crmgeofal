import{r as t,j as e,C as se,f as me,B as j,V as ae,_ as te,J as T,ah as I,m as he,F as xe,ai as ue,aj as je,u as pe}from"./index-CDayYYh0.js";import{M as ge}from"./ModuloBase-BzOcH9cf.js";import{g as fe}from"./quotes-D_hj9GKZ.js";import{S as ie}from"./Spinner-BFSKMpy4.js";import{A as L}from"./Alert-pvqi0VvY.js";import{M as o}from"./Modal-DfQWsS-G.js";import{F as v}from"./Form-CukTEVnv.js";import{C as H}from"./Card-DxGUdTXm.js";import"./ElementChildren-DjJrrPtR.js";import"./Col-Bcdl2XMD.js";const Ne=({quoteId:u})=>{const[f,a]=t.useState({primer_contacto:[],aceptacion:[],finalizacion:[]}),[M,p]=t.useState(!0),[C,$]=t.useState(!1),[F,d]=t.useState(""),[U,z]=t.useState(""),[A,O]=t.useState({total:0,primer_contacto:0,aceptacion:0,finalizacion:0}),[J,b]=t.useState(!1),[y,w]=t.useState(""),[N,S]=t.useState(null),[_,n]=t.useState(""),[g,i]=t.useState(!1),[r,Q]=t.useState(""),[ne,P]=t.useState(!1),[E,V]=t.useState(null);t.useEffect(()=>{u&&(R(),q())},[u]);const R=async()=>{try{p(!0),d("");const l="https://sublustrous-odelia-uninsured.ngrok-free.dev/api".replace(/\/api$/,""),m=localStorage.getItem("token"),x=await fetch(`${l}/api/quotes/${u}/evidences`,{headers:{Authorization:`Bearer ${m}`}});if(!x.ok)throw new Error("Error al cargar evidencias");const c=await x.json();a(c.grouped||{primer_contacto:[],aceptacion:[],finalizacion:[]})}catch(s){console.error("Error cargando evidencias:",s),d("No se pudieron cargar las evidencias: "+s.message)}finally{p(!1)}},q=async()=>{try{const l="https://sublustrous-odelia-uninsured.ngrok-free.dev/api".replace(/\/api$/,""),m=localStorage.getItem("token"),x=await fetch(`${l}/api/quotes/${u}/evidences/stats`,{headers:{Authorization:`Bearer ${m}`}});if(x.ok){const c=await x.json();O({total:parseInt(c.total)||0,primer_contacto:parseInt(c.primer_contacto)||0,aceptacion:parseInt(c.aceptacion)||0,finalizacion:parseInt(c.finalizacion)||0})}}catch(s){console.error("Error cargando estadísticas:",s)}},re=s=>{w(s),S(null),n(""),b(!0)},le=s=>{Q(s),i(!0)},ce=s=>{const l=s.target.files[0];if(l){if(!["application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/png","image/jpeg","image/jpg"].includes(l.type)){d("Tipo de archivo no permitido. Solo se aceptan PDF, Excel (.xlsx) e imágenes (PNG, JPG)"),s.target.value="";return}if(l.size>10*1024*1024){d("El archivo es demasiado grande. Tamaño máximo: 10MB"),s.target.value="";return}S(l),d("")}},oe=async()=>{if(!N){d("Por favor selecciona un archivo");return}try{$(!0),d("");const s=new FormData;s.append("file",N),s.append("evidence_type",y),_&&s.append("notes",_);const m="https://sublustrous-odelia-uninsured.ngrok-free.dev/api".replace(/\/api$/,""),x=localStorage.getItem("token"),c=await fetch(`${m}/api/quotes/${u}/evidences`,{method:"POST",headers:{Authorization:`Bearer ${x}`},body:s});if(!c.ok){const k=await c.json();throw new Error(k.message||"Error al subir evidencia")}z("Evidencia subida correctamente"),b(!1),R(),q(),setTimeout(()=>z(""),3e3)}catch(s){console.error("Error subiendo evidencia:",s),d("Error al subir evidencia: "+s.message)}finally{$(!1)}},K=async(s,l)=>{try{const x="https://sublustrous-odelia-uninsured.ngrok-free.dev/api".replace(/\/api$/,""),c=localStorage.getItem("token"),k=await fetch(`${x}/api/quotes/evidences/${s}/download`,{headers:{Authorization:`Bearer ${c}`}});if(!k.ok)throw new Error("Error al descargar archivo");const h=await k.blob(),ee=window.URL.createObjectURL(h),D=document.createElement("a");D.href=ee,D.download=l,document.body.appendChild(D),D.click(),document.body.removeChild(D),window.URL.revokeObjectURL(ee)}catch(m){console.error("Error descargando evidencia:",m),d("Error al descargar archivo: "+m.message)}},W=s=>{V(s),P(!0)},de=async()=>{if(E)try{const l="https://sublustrous-odelia-uninsured.ngrok-free.dev/api".replace(/\/api$/,""),m=localStorage.getItem("token");if(!(await fetch(`${l}/api/quotes/evidences/${E.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${m}`}})).ok)throw new Error("Error al eliminar evidencia");z("Evidencia eliminada correctamente"),P(!1),V(null),R(),q(),setTimeout(()=>z(""),3e3)}catch(s){console.error("Error eliminando evidencia:",s),d("Error al eliminar evidencia: "+s.message)}},X=()=>{P(!1),V(null)},Y=s=>s.includes("pdf")?e.jsx(xe,{className:"text-danger",size:24}):s.includes("image")?e.jsx(ue,{className:"text-success",size:24}):s.includes("excel")||s.includes("spreadsheet")?e.jsx(I,{className:"text-success",size:24}):e.jsx(I,{className:"text-secondary",size:24}),B=s=>s?s<1024?s+" B":s<1024*1024?(s/1024).toFixed(2)+" KB":(s/(1024*1024)).toFixed(2)+" MB":"Desconocido",Z=s=>new Date(s).toLocaleString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),G=(s,l,m,x,c)=>{const k=c.length;return e.jsxs(H,{className:"mb-3 shadow-sm",children:[e.jsxs(H.Header,{className:`bg-${x} text-dark d-flex justify-content-between align-items-center`,children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[m,e.jsx("strong",{children:s}),e.jsx(se,{bg:"light",text:"dark",children:k})]}),e.jsxs("div",{className:"d-flex gap-2",children:[k>0&&e.jsxs(j,{variant:"outline-secondary",size:"sm",onClick:()=>le(l),children:[e.jsx(he,{className:"me-1"}),"Ver evidencias"]}),e.jsxs(j,{variant:"light",size:"sm",onClick:()=>re(l),children:[e.jsx(ae,{className:"me-1"}),"Subir archivo"]})]})]}),e.jsx(H.Body,{children:c.length===0?e.jsxs("div",{className:"text-center text-muted py-3",children:[e.jsx(I,{size:48,className:"mb-2 opacity-25"}),e.jsx("p",{children:"No hay evidencias cargadas"})]}):e.jsx("div",{className:"evidence-list",children:c.map(h=>e.jsxs("div",{className:"evidence-item d-flex align-items-center justify-content-between p-3 border-bottom",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3 flex-grow-1",children:[Y(h.file_type),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{className:"fw-bold",children:h.file_name}),e.jsxs("div",{className:"text-muted small",children:[e.jsx("span",{children:B(h.file_size)}),e.jsx("span",{className:"mx-2",children:"•"}),e.jsx("span",{children:Z(h.uploaded_at)}),h.uploaded_by_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-2",children:"•"}),e.jsxs("span",{children:["Por: ",h.uploaded_by_name]})]})]}),h.notes&&e.jsx("div",{className:"text-muted small mt-1",children:e.jsxs("em",{children:["Nota: ",h.notes]})})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(j,{variant:"outline-primary",size:"sm",onClick:()=>K(h.id,h.file_name),title:"Descargar",children:e.jsx(te,{})}),e.jsx(j,{variant:"outline-danger",size:"sm",onClick:()=>W(h),title:"Eliminar",children:e.jsx(T,{})})]})]},h.id))})})]})};return M?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(ie,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Cargando evidencias..."})]}):e.jsxs("div",{className:"quote-evidences",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h4",{className:"mb-0",children:"📋 Evidencias de la Cotización"}),e.jsxs(se,{bg:"info",className:"fs-6",children:["Total: ",A.total," archivo",A.total!==1?"s":""]})]}),F&&e.jsx(L,{variant:"danger",dismissible:!0,onClose:()=>d(""),children:F}),U&&e.jsx(L,{variant:"success",dismissible:!0,onClose:()=>z(""),children:U}),G(" Evidencia de Primer Contacto","primer_contacto","📸","primary",f.primer_contacto),G("Evidencias de Aceptación","aceptacion","✅","success",f.aceptacion),G("Evidencias de Finalización","finalizacion","🏁","warning",f.finalizacion),e.jsxs(o,{show:J,onHide:()=>b(!1),children:[e.jsx(o.Header,{closeButton:!0,children:e.jsxs(o.Title,{children:["Subir Evidencia",y==="primer_contacto"&&" - Primer Contacto 📸",y==="aceptacion"&&" - Aceptación ✅",y==="finalizacion"&&" - Finalización 🏁"]})}),e.jsx(o.Body,{children:e.jsxs(v,{children:[e.jsxs(v.Group,{className:"mb-3",children:[e.jsx(v.Label,{children:"Archivo *"}),e.jsx(v.Control,{type:"file",onChange:ce,accept:".pdf,.xlsx,.xls,.png,.jpg,.jpeg"}),e.jsx(v.Text,{className:"text-muted",children:"Formatos permitidos: PDF, Excel (.xlsx), imágenes (PNG, JPG). Tamaño máximo: 10MB"})]}),N&&e.jsxs(L,{variant:"info",children:[e.jsx(me,{className:"me-2"}),"Archivo seleccionado: ",e.jsx("strong",{children:N.name})," (",B(N.size),")"]}),e.jsxs(v.Group,{className:"mb-3",children:[e.jsx(v.Label,{children:"Notas (opcional)"}),e.jsx(v.Control,{as:"textarea",rows:3,value:_,onChange:s=>n(s.target.value),placeholder:"Agrega notas o comentarios sobre esta evidencia..."})]})]})}),e.jsxs(o.Footer,{children:[e.jsx(j,{variant:"secondary",onClick:()=>b(!1),children:"Cancelar"}),e.jsx(j,{variant:"primary",onClick:oe,disabled:!N||C,children:C?e.jsxs(e.Fragment,{children:[e.jsx(ie,{animation:"border",size:"sm",className:"me-2"}),"Subiendo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"me-2"}),"Subir Evidencia"]})})]})]}),e.jsxs(o,{show:g,onHide:()=>i(!1),size:"lg",children:[e.jsx(o.Header,{closeButton:!0,children:e.jsxs(o.Title,{children:["Ver Evidencias",r==="primer_contacto"&&" - Primer Contacto 📸",r==="aceptacion"&&" - Aceptación ✅",r==="finalizacion"&&" - Finalización 🏁"]})}),e.jsx(o.Body,{children:f[r]&&f[r].length>0?e.jsx("div",{className:"evidences-view",children:f[r].map(s=>e.jsx("div",{className:"evidence-item-view border rounded p-3 mb-3",children:e.jsxs("div",{className:"d-flex align-items-start justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-start gap-3 flex-grow-1",children:[Y(s.file_type),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:s.file_name}),e.jsxs("div",{className:"text-muted small mb-2",children:[e.jsxs("span",{className:"me-3",children:["📏 ",B(s.file_size)]}),e.jsxs("span",{className:"me-3",children:["📅 ",Z(s.uploaded_at)]}),s.uploaded_by_name&&e.jsxs("span",{children:["👤 Por: ",s.uploaded_by_name]})]}),s.notes&&e.jsxs("div",{className:"alert alert-light p-2 mb-0",children:[e.jsx("strong",{className:"small",children:"Notas:"}),e.jsx("div",{className:"small mt-1",children:s.notes})]})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(j,{variant:"outline-primary",size:"sm",onClick:()=>K(s.id,s.file_name),title:"Descargar",children:e.jsx(te,{})}),e.jsx(j,{variant:"outline-danger",size:"sm",onClick:()=>W(s),title:"Eliminar",children:e.jsx(T,{})})]})]})},s.id))}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(I,{size:48,className:"text-muted mb-3"}),e.jsx("p",{className:"text-muted",children:"No hay evidencias de este tipo"})]})}),e.jsx(o.Footer,{children:e.jsx(j,{variant:"secondary",onClick:()=>i(!1),children:"Cerrar"})})]}),e.jsxs(o,{show:ne,onHide:X,centered:!0,children:[e.jsx(o.Header,{closeButton:!0,children:e.jsxs(o.Title,{className:"text-danger",children:[e.jsx(T,{className:"me-2"}),"Confirmar Eliminación"]})}),e.jsx(o.Body,{children:e.jsxs("div",{className:"text-center",children:[e.jsx(T,{size:48,className:"text-danger mb-3"}),e.jsx("h5",{children:"¿Estás seguro de que quieres eliminar esta evidencia?"}),E&&e.jsxs("div",{className:"mt-3 p-3 bg-light rounded",children:[e.jsx("strong",{children:"Archivo:"})," ",E.file_name,e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Tamaño: ",B(E.file_size)]}),E.notes&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:[e.jsx("strong",{children:"Notas:"})," ",E.notes]})]})]}),e.jsx("p",{className:"text-muted mt-3",children:"Esta acción no se puede deshacer."})]})}),e.jsxs(o.Footer,{children:[e.jsx(j,{variant:"secondary",onClick:X,children:"Cancelar"}),e.jsxs(j,{variant:"danger",onClick:de,children:[e.jsx(T,{className:"me-1"}),"Eliminar Evidencia"]})]})]})]})};function Fe(){const{id:u}=je(),f=pe(),[a,M]=t.useState(null),[p,C]=t.useState([]),[$,F]=t.useState(!0),[d,U]=t.useState(""),[z,A]=t.useState(!1),[O,J]=t.useState(""),[b,y]=t.useState(!1);t.useEffect(()=>{(async()=>{var n,g;try{F(!0),U(""),console.log("🔍 DetalleCotizacion - Cargando cotización ID:",u),console.log("🔍 DetalleCotizacion - Token presente:",localStorage.getItem("token")?"Sí":"No");const i=await fe(u);console.log("✅ DetalleCotizacion - Cotización cargada:",i);let r=null;if(i.meta&&typeof i.meta=="string")try{r=JSON.parse(i.meta)}catch{r=null}else i.meta&&typeof i.meta=="object"&&(r=i.meta);r?(r.customer&&(i.client_company=r.customer.company_name||i.company_name,i.client_ruc=r.customer.ruc||i.company_ruc),r.items?C(r.items):C([])):C([]),M(i)}catch(i){console.error("❌ Error cargando cotización:",i),U(i.message||"No se pudo cargar la cotización"),(i.status===404||(n=i.message)!=null&&n.includes("404")||(g=i.message)!=null&&g.includes("no encontrada"))&&(console.log("🔄 Cotización no encontrada, redirigiendo al dashboard..."),setTimeout(()=>{f("/dashboard")},2e3))}finally{F(!1)}})()},[u]);const w=t.useMemo(()=>a&&a.subtotal?Number(a.subtotal):p.reduce((n,g)=>{const i=g.partial_price||Number(g.unit_price||0)*Number(g.quantity||0);return n+Number(i)},0),[p,a]),N=t.useMemo(()=>Number((w*.18).toFixed(2)),[w]),S=t.useMemo(()=>a?typeof a.igv=="number"?Number(a.igv):N:0,[a,N]),_=t.useMemo(()=>Number((w+S).toFixed(2)),[w,S]);return e.jsxs(ge,{titulo:`📋 Evidencias - Cotización #${u}`,descripcion:"Gestión de evidencias de la cotización",children:[$&&e.jsx("div",{className:"text-center py-5",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})})}),d&&e.jsx("div",{className:"alert alert-danger",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:d}),e.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>f("/dashboard"),children:"Volver al Dashboard"})]})}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card mb-4 shadow-sm",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsx("h5",{className:"mb-0",children:"📄 Información de la Cotización"})}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Razón Social"}),e.jsx("div",{className:"fs-6 fw-bold",children:a.client_company||a.client_contact||"No especificado"}),a.client_ruc&&e.jsxs("small",{className:"text-muted",children:["RUC: ",a.client_ruc]})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Contacto"}),e.jsx("div",{className:"fs-6",children:a.client_contact||"No especificado"}),a.client_email&&e.jsx("small",{className:"text-muted d-block",children:a.client_email}),a.client_phone&&e.jsxs("small",{className:"text-muted",children:["📞 ",a.client_phone]})]}),e.jsxs("div",{className:"col-md-2",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Fecha de Emisión"}),e.jsx("div",{className:"fs-6",children:a.issue_date?new Date(a.issue_date).toLocaleDateString("es-ES"):"No especificada"})]}),e.jsxs("div",{className:"col-md-2",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Estado"}),e.jsx("div",{className:"fs-6",children:e.jsx("span",{className:`badge ${a.status==="aprobado"?"bg-success":a.status==="enviado"?"bg-primary":a.status==="rechazado"?"bg-danger":"bg-secondary"}`,children:a.status==="en_proceso"?"En proceso":a.status==="enviado"?"Enviado":a.status==="aprobado"?"Aprobado":a.status==="rechazado"?"Rechazado":a.status})})]})]}),e.jsxs("div",{className:"row g-3 mt-2",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Cantidad de Ítems"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsxs("div",{className:"fs-6",children:[p.length," ítem",p.length!==1?"s":""]}),p.length>0&&e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"showItems",checked:b,onChange:n=>y(n.target.checked)}),e.jsx("label",{className:"form-check-label small",htmlFor:"showItems",children:"Ver detalles"})]})]})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Total"}),e.jsxs("div",{className:"fs-5 fw-bold text-success",children:["S/ ",_.toFixed(2)]}),e.jsxs("small",{className:"text-muted",children:["IGV: S/ ",S.toFixed(2)]})]}),a.reference&&e.jsxs("div",{className:"col-md-7",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Referencia"}),e.jsx("div",{className:"fs-6",children:a.reference})]})]}),p.length>0&&b&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("strong",{className:"text-muted small",children:"Ítems de la Cotización"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>y(!1),children:"Ocultar"})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"10%"},children:"Código"}),e.jsx("th",{style:{width:"40%"},children:"Descripción"}),e.jsx("th",{style:{width:"15%"},children:"Norma"}),e.jsx("th",{style:{width:"12%"},children:"P. Unit."}),e.jsx("th",{style:{width:"8%"},children:"Cant."}),e.jsx("th",{style:{width:"15%"},className:"text-end",children:"Parcial"})]})}),e.jsx("tbody",{children:p.map((n,g)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("small",{children:n.code||"-"})}),e.jsx("td",{children:e.jsx("small",{children:n.description||"-"})}),e.jsx("td",{children:e.jsx("small",{children:n.norm||"-"})}),e.jsx("td",{children:e.jsxs("small",{children:["S/ ",Number(n.unit_price||0).toFixed(2)]})}),e.jsx("td",{children:e.jsx("small",{children:n.quantity||0})}),e.jsx("td",{className:"text-end",children:e.jsxs("small",{className:"fw-bold",children:["S/ ",(Number(n.unit_price||0)*Number(n.quantity||0)).toFixed(2)]})})]},g))}),e.jsxs("tfoot",{className:"table-light",children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"Subtotal:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{children:["S/ ",w.toFixed(2)]})})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"IGV 18%:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{children:["S/ ",S.toFixed(2)]})})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"Total:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["S/ ",_.toFixed(2)]})})]})]})]})})]})]})]}),e.jsx(Ne,{quoteId:u})]})]})}export{Fe as default};
//# sourceMappingURL=DetalleCotizacion-D8ujzU4z.js.map
