import{b as u,r as l,E as ie,c as q,G as p,j as a,H as ne,f as C,B as _,I as ce,J as de,m as ue,l as me,K as he,n as N,y as ge}from"./index-sJ-fqi2A.js";import{P as be,R as pe,C as S}from"./PageHeader-CKES-3QI.js";import{D as Se}from"./DataTable-BkIUefh0.js";import{M as O}from"./ModalForm-DaUBSj0Z.js";import{S as f}from"./StatsCard-BK0WfEEV.js";import{C as E}from"./Card-fwrWtkyO.js";import"./InputGroup-CuakKslC.js";import"./Form-CC49TUrP.js";import"./Spinner-ROzCSctr.js";const fe=(s={})=>{const t=new URLSearchParams;s.page&&t.set("page",s.page),s.limit&&t.set("limit",s.limit),s.search&&t.set("search",s.search),s.area&&t.set("area",s.area),s.role&&t.set("role",s.role);const r=t.toString(),c=r?`/api/users?${r}`:"/api/users";return console.log("üîç listUsers - Llamando a:",c),console.log("üîç listUsers - Token:",localStorage.getItem("token")?"Presente":"Ausente"),u(c).then(d=>(console.log("‚úÖ listUsers - Respuesta recibida:",d),d)).catch(d=>{throw console.error("‚ùå listUsers - Error:",d),d})},xe=()=>(console.log("üìä getUserStats - Llamando a: /api/users/stats"),console.log("üìä getUserStats - Token:",localStorage.getItem("token")?"Presente":"Ausente"),u("/api/users/stats").then(s=>(console.log("‚úÖ getUserStats - Respuesta recibida:",s),s)).catch(s=>{throw console.error("‚ùå getUserStats - Error:",s),s})),ve=s=>u("/api/users",{method:"POST",body:JSON.stringify(s)}),je=(s,t)=>u(`/api/users/${s}`,{method:"PATCH",body:JSON.stringify(t)}),ye=s=>u(`/api/users/${s}`,{method:"DELETE"}),we=(s,t)=>u(`/api/users/${s}/reset-password`,{method:"POST",body:JSON.stringify({password:t})}),D={name:"",apellido:"",email:"",role:"vendedor_comercial",area:"Comercial",password:""},I=[{value:"admin",label:"Administrador"},{value:"jefa_comercial",label:"Jefa Comercial"},{value:"vendedor_comercial",label:"Vendedor Comercial"},{value:"jefe_laboratorio",label:"Jefe Laboratorio"},{value:"usuario_laboratorio",label:"Usuario Laboratorio"},{value:"laboratorio",label:"Laboratorio"},{value:"soporte",label:"Soporte"},{value:"gerencia",label:"Gerencia"}],Ce=[{value:"Comercial",label:"Comercial"},{value:"Laboratorio",label:"Laboratorio"},{value:"Sistemas",label:"Sistemas"},{value:"Gerencia",label:"Gerencia"},{value:"Soporte",label:"Soporte"}];function ke(){const[s,t]=l.useState(!1),[r,c]=l.useState(null),[d,B]=l.useState(null),[h,x]=l.useState(null),[v,U]=l.useState(""),[j,y]=l.useState(1),[P,H]=l.useState(""),[R,J]=l.useState(""),[L,G]=l.useState(""),[$,F]=l.useState(!1),M=ie(),{data:i,isLoading:w,refetch:Q}=q(["users",j,P,R,L],()=>fe({page:j,limit:20,search:P,role:R,area:L}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:n,isLoading:g}=q(["userStats"],xe,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4}),b=e=>{M.invalidateQueries("users"),M.invalidateQueries("userStats"),t(!1),c(null),B(null),x(null),U("")},z=e=>{console.log("üîç handleSearch - B√∫squeda:",e),H(e),y(1),F(!0),setTimeout(()=>F(!1),1e3)},W=e=>{console.log("üîç handleFilter - Filtros:",e),J(e.role||""),G(e.area||""),y(1)},T=p(ve,{onSuccess:()=>b(),onError:e=>console.error("Error creating user:",e)}),k=p(je,{onSuccess:()=>b(),onError:e=>console.error("Error updating user:",e)}),K=p(ye,{onSuccess:()=>b(),onError:e=>console.error("Error deleting user:",e)}),A=p(we,{onSuccess:()=>b(),onError:e=>console.error("Error resetting password:",e)}),V=()=>{c(D),t(!0)},X=e=>{c(e),t(!0)},Y=e=>{window.confirm(`¬øEst√°s seguro de que quieres eliminar al usuario ${e.name}?`)&&K.mutate(e.id)},Z=e=>{x(e),U("")},ee=async e=>{r.id?await k.mutateAsync({id:r.id,...e}):await T.mutateAsync(e)},ae=async()=>{v&&h&&await A.mutateAsync({id:h.id,password:v})},se=e=>({admin:"danger",jefa_comercial:"warning",vendedor_comercial:"primary",jefe_laboratorio:"info",usuario_laboratorio:"secondary",laboratorio:"secondary",soporte:"success",gerencia:"dark"})[e]||"secondary",re=e=>{const o=I.find(le=>le.value===e);return o?o.label:e},te=[{header:"ID",accessor:"id",width:"80px"},{header:"Nombre",accessor:"name",render:(e,o)=>a.jsxs("div",{children:[a.jsxs("div",{className:"fw-medium",children:[o.name," ",o.apellido]}),a.jsx("small",{className:"text-muted",children:o.email})]})},{header:"Rol",accessor:"role",render:e=>a.jsx(N,{bg:se(e),className:"status-badge",children:re(e)})},{header:"√Årea",accessor:"area",render:e=>a.jsx(N,{bg:"light",text:"dark",className:"status-badge",children:e})},{header:"Fecha Creaci√≥n",accessor:"created_at",type:"date"}],oe=[{name:"name",label:"Nombre",type:"text",required:!0,placeholder:"Ingresa el nombre"},{name:"apellido",label:"Apellido",type:"text",required:!0,placeholder:"Ingresa el apellido"},{name:"email",label:"Email",type:"email",required:!0,placeholder:"usuario@ejemplo.com"},{name:"role",label:"Rol",type:"select",required:!0,options:I},{name:"area",label:"√Årea",type:"select",required:!0,options:Ce},{name:"password",label:"Contrase√±a",type:"password",required:!(r!=null&&r.id),placeholder:"M√≠nimo 6 caracteres",help:r!=null&&r.id?"Dejar vac√≠o para mantener la contrase√±a actual":"M√≠nimo 6 caracteres"}],m=l.useMemo(()=>{if(n)return console.log("üìä Stats - Usando estad√≠sticas reales del backend:",n),{total:n.total||0,admins:n.admins||0,vendedores:n.vendedores||0,laboratorio:n.laboratorio||0,activos:n.active||0};const e=(i==null?void 0:i.data)||[];return console.log("üìä Stats - Fallback: calculando desde p√°gina actual:",e),{total:e.length,admins:e.filter(o=>o.role==="admin").length,vendedores:e.filter(o=>o.role==="vendedor_comercial").length,laboratorio:e.filter(o=>["jefe_laboratorio","usuario_laboratorio","laboratorio"].includes(o.role)).length,activos:e.filter(o=>o.active!==!1).length}},[n,i]);return a.jsx(ne,{fluid:!0,className:"py-4",children:a.jsxs("div",{className:"fade-in",children:[a.jsx(be,{title:"Gesti√≥n de Usuarios",subtitle:"Crear, editar, eliminar y gestionar usuarios del sistema",icon:C,actions:a.jsxs(_,{variant:"primary",onClick:V,children:[a.jsx(ce,{className:"me-2"}),"Nuevo Usuario"]})}),a.jsxs(pe,{className:"g-4 mb-4",children:[a.jsx(S,{md:6,lg:3,children:a.jsx(f,{title:"Total Usuarios",value:m.total,icon:C,color:"primary",subtitle:"Usuarios registrados",loading:g})}),a.jsx(S,{md:6,lg:3,children:a.jsx(f,{title:"Administradores",value:m.admins,icon:de,color:"danger",subtitle:"Usuarios con privilegios",loading:g})}),a.jsx(S,{md:6,lg:3,children:a.jsx(f,{title:"Vendedores",value:m.vendedores,icon:ue,color:"success",subtitle:"Equipo comercial",loading:g})}),a.jsx(S,{md:6,lg:3,children:a.jsx(f,{title:"Laboratorio",value:m.laboratorio,icon:me,color:"info",subtitle:"Personal t√©cnico",loading:g})})]}),a.jsxs(E,{className:"shadow-sm border-0",children:[a.jsx(E.Header,{className:"bg-white border-bottom",children:a.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[a.jsxs("h5",{className:"mb-0",children:[a.jsx(C,{className:"me-2 text-primary"}),"Lista de Usuarios"]}),a.jsxs("div",{className:"d-flex align-items-center gap-2",children:[a.jsx(_,{variant:"outline-primary",size:"sm",onClick:()=>Q(),disabled:w,className:"refresh-btn",children:a.jsx(he,{className:w?"spinning":""})}),a.jsxs(N,{bg:"light",text:"dark",className:"px-3 py-2",children:[m.total," usuarios"]})]})]})}),a.jsx(E.Body,{className:"p-0",children:a.jsx(Se,{data:(i==null?void 0:i.data)||[],columns:te,loading:w||$,onEdit:X,onDelete:Y,emptyMessage:"No hay usuarios registrados",totalItems:(i==null?void 0:i.total)||0,itemsPerPage:20,currentPage:j,onPageChange:y,onSearch:z,onFilter:W,actions:[{label:"Restablecer Contrase√±a",icon:ge,onClick:Z,variant:"outline-warning"}]})})]}),a.jsx(O,{show:s,onHide:()=>t(!1),title:r!=null&&r.id?"Editar Usuario":"Nuevo Usuario",data:r||D,fields:oe,onSubmit:ee,loading:T.isLoading||k.isLoading,submitText:r!=null&&r.id?"Actualizar":"Crear"}),h&&a.jsx(O,{show:!!h,onHide:()=>x(null),title:"Restablecer Contrase√±a",data:{password:v},fields:[{name:"password",label:"Nueva Contrase√±a",type:"password",required:!0,placeholder:"M√≠nimo 6 caracteres"}],onSubmit:ae,loading:A.isLoading,submitText:"Restablecer"})]})})}export{ke as default};
//# sourceMappingURL=Usuarios-B8ACjZgm.js.map
