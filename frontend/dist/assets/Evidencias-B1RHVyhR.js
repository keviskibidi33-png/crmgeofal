import{R as S,r as i,j as e}from"./index-Vrmn15ab.js";import{M as F}from"./ModuloBase-BWIoHr2q.js";import{T as q,a as I}from"./Toolbar-BZWX08af.js";import{T as R}from"./Toast-Cu5rqqgV.js";import{l as D}from"./projects-b3Cl7FnY.js";import{l as O}from"./companies-CXe-FKsh.js";const B=(o={})=>{const n=new URLSearchParams(o).toString(),c=n?`/api/evidences?${n}`:"/api/evidences";return S(c)},L=async({project_id:o,invoice_id:n,type:c,file:h})=>{const l=new FormData;return o&&l.append("project_id",o),n&&l.append("invoice_id",n),c&&l.append("type",c),h&&l.append("file",h),S("/api/evidences",{method:"POST",body:l,headers:{"Content-Type":void 0}})};function J(){const[o,n]=i.useState([]),[c,h]=i.useState(0),[l,m]=i.useState(1),[y]=i.useState(10),[f,N]=i.useState(!1),[t,b]=i.useState({company_id:"",project_id:"",type:""}),[w,C]=i.useState([]),[r,T]=i.useState([]),[p,u]=i.useState({show:!1,variant:"success",message:""}),[E,j]=i.useState(!1),[d,x]=i.useState({project_id:"",invoice_id:"",type:"otro",file:null});i.useEffect(()=>{(async()=>{try{const[s,a]=await Promise.all([O({page:1,limit:200}),D({page:1,limit:500})]);C(Array.isArray(s==null?void 0:s.data)?s.data:s||[]),T(Array.isArray(a==null?void 0:a.data)?a.data:a||[])}catch{}})()},[]);const M=i.useMemo(()=>{if(!t.company_id)return r;const s=Number(t.company_id);return r.filter(a=>Number(a.company_id)===s)},[r,t.company_id]),P=i.useMemo(()=>{const s=new Map;for(const a of r)s.set(Number(a.id),a.name);return s},[r]),g=async()=>{try{N(!0);const s={page:l,limit:y};t.project_id&&(s.project_id=t.project_id),t.type&&(s.type=t.type);const a=await B(s),k=Array.isArray(a==null?void 0:a.data)?a.data:(a==null?void 0:a.rows)||a||[];n(k);const _=(a==null?void 0:a.total)??0;h(typeof _=="number"?_:0)}catch(s){u({show:!0,variant:"danger",message:s.message||"No se pudo cargar"})}finally{N(!1)}};i.useEffect(()=>{g()},[l,t.project_id,t.type]);const A=async s=>{s.preventDefault();try{await L(d),u({show:!0,variant:"success",message:"Evidencia subida"}),j(!1),x({project_id:"",invoice_id:"",type:"otro",file:null}),g()}catch(a){u({show:!0,variant:"danger",message:a.message||"Error al subir"})}},v=Math.max(1,Math.ceil((c||0)/y));return e.jsxs(F,{titulo:"Evidencias",descripcion:"Aquí podrás ver y gestionar evidencias asociadas a proyectos o tickets.",children:[e.jsx(q,{left:e.jsxs("div",{className:"row g-2 w-100",children:[e.jsxs("div",{className:"col-sm-4",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsxs("select",{className:"form-select",value:t.company_id,onChange:s=>{b({...t,company_id:s.target.value,project_id:""}),m(1)},children:[e.jsx("option",{value:"",children:"Todos"}),w.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"col-sm-4",children:[e.jsx("label",{className:"form-label",children:"Proyecto"}),e.jsxs("select",{className:"form-select",value:t.project_id,onChange:s=>{b({...t,project_id:s.target.value}),m(1)},children:[e.jsx("option",{value:"",children:"Todos"}),M.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"col-sm-3",children:[e.jsx("label",{className:"form-label",children:"Tipo"}),e.jsxs("select",{className:"form-select",value:t.type,onChange:s=>{b({...t,type:s.target.value}),m(1)},children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"informe",children:"Informe"}),e.jsx("option",{value:"foto",children:"Foto"}),e.jsx("option",{value:"certificado",children:"Certificado"}),e.jsx("option",{value:"otro",children:"Otro"})]})]})]}),right:e.jsx("button",{className:"btn btn-primary",onClick:()=>j(!0),children:"+ Subir evidencia"})}),e.jsx("div",{className:"table-responsive mt-3",children:e.jsxs("table",{className:"table table-striped align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Proyecto"}),e.jsx("th",{children:"Factura"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Archivo"}),e.jsx("th",{children:"Subido por"}),e.jsx("th",{children:"Fecha"})]})}),e.jsxs("tbody",{children:[(o||[]).map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:P.get(Number(s.project_id))||s.project_id}),e.jsx("td",{children:s.invoice_name||s.invoice_id||"—"}),e.jsx("td",{className:"text-capitalize",children:s.type}),e.jsx("td",{children:s.file_url?e.jsx("a",{href:s.file_url,target:"_blank",rel:"noreferrer",children:"Ver"}):"-"}),e.jsx("td",{children:s.uploaded_by}),e.jsx("td",{children:s.created_at?String(s.created_at).slice(0,19).replace("T"," "):""})]},s.id)),(!o||o.length===0)&&!f&&e.jsx(I,{colSpan:7,label:"Sin evidencias"})]})]})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted small",children:["Total: ",c]}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{className:"btn btn-outline-secondary",disabled:l<=1,onClick:()=>m(s=>Math.max(1,s-1)),children:"Anterior"}),e.jsxs("span",{className:"btn btn-outline-secondary disabled",children:[l,"/",v]}),e.jsx("button",{className:"btn btn-outline-secondary",disabled:l>=v,onClick:()=>m(s=>Math.min(v,s+1)),children:"Siguiente"})]})]}),E&&e.jsx("div",{className:"modal fade show",style:{display:"block"},children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Subir evidencia"}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>j(!1)})]}),e.jsxs("form",{onSubmit:A,children:[e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Proyecto"}),e.jsxs("select",{className:"form-select",value:d.project_id,onChange:s=>x({...d,project_id:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Seleccione"}),r.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Tipo"}),e.jsxs("select",{className:"form-select",value:d.type,onChange:s=>x({...d,type:s.target.value}),children:[e.jsx("option",{value:"informe",children:"Informe"}),e.jsx("option",{value:"foto",children:"Foto"}),e.jsx("option",{value:"certificado",children:"Certificado"}),e.jsx("option",{value:"otro",children:"Otro"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Archivo"}),e.jsx("input",{type:"file",className:"form-control",onChange:s=>{var a;return x({...d,file:((a=s.target.files)==null?void 0:a[0])||null})},required:!0})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>j(!1),children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:f,children:f?"Subiendo...":"Subir"})]})]})]})})}),e.jsx(R,{show:p.show,variant:p.variant,onClose:()=>u({...p,show:!1}),children:p.message})]})}export{J as default};
//# sourceMappingURL=Evidencias-B1RHVyhR.js.map
