{"version":3,"file":"Adjuntos-CmuiyezD.js","sources":["../../src/services/attachments.js","../../src/pages/Adjuntos.jsx"],"sourcesContent":["import { apiFetch } from './api';\n\nexport const listAttachments = (params = {}) => {\n  const sp = new URLSearchParams();\n  if (params.page) sp.set('page', params.page);\n  if (params.limit) sp.set('limit', params.limit);\n  if (params.q) sp.set('q', params.q);\n  const qs = sp.toString();\n  const path = qs ? `/api/project-attachments?${qs}` : '/api/project-attachments';\n  return apiFetch(path);\n};\n\nexport const createAttachment = async ({ project_id, description, file }) => {\n  const form = new FormData();\n  form.append('project_id', project_id);\n  if (description) form.append('description', description);\n  form.append('file', file);\n  return apiFetch('/api/project-attachments', {\n    method: 'POST',\n    body: form,\n  });\n};\n\nexport const deleteAttachment = (id) => apiFetch(`/api/project-attachments/${id}`, { method: 'DELETE' });\n\nexport default { listAttachments, createAttachment, deleteAttachment };","import React, { useMemo, useState, useEffect } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport { useQuery, useMutation, useQueryClient } from 'react-query';\nimport ModuloBase from '../components/ModuloBase';\nimport DataTable from '../components/DataTable';\nimport Toolbar from '../components/Toolbar';\nimport Modal from '../components/Modal';\nimport Toast from '../components/Toast';\nimport { listAttachments, createAttachment, deleteAttachment } from '../services/attachments';\nimport { listProjects } from '../services/projects';\n\nconst emptyForm = { project_id: '', description: '', file: null };\n\nexport default function Adjuntos() {\n  const [page, setPage] = useState(1);\n  const [limit] = useState(10);\n  const [filters, setFilters] = useState({ q: '' });\n  const [toast, setToast] = useState({ message: '', type: 'success', show: false });\n  const location = useLocation();\n\n  // State for modals\n  const [showUploadModal, setShowUploadModal] = useState(false);\n  const [uploadForm, setUploadForm] = useState(emptyForm);\n  const [deletingAttachment, setDeletingAttachment] = useState(null);\n\n  const queryClient = useQueryClient();\n\n  useEffect(() => {\n    if (location.state?.search) {\n      setFilters(f => ({ ...f, q: location.state.search }));\n    }\n  }, [location.state]);\n\n  const { data, isLoading } = useQuery(\n    ['attachments', { page, limit, q: filters.q }],\n    () => listAttachments({ page, limit, q: filters.q }),\n    { keepPreviousData: true }\n  );\n\n  const { data: projectsData } = useQuery('projectsList', () => listProjects({ page: 1, limit: 500 }), { staleTime: Infinity });\n  const projects = useMemo(() => projectsData?.data || [], [projectsData]);\n\n  const handleMutationSuccess = (message) => {\n    setToast({ message, type: 'success', show: true });\n    queryClient.invalidateQueries('attachments');\n    setShowUploadModal(false);\n    setUploadForm(emptyForm);\n    setDeletingAttachment(null);\n  };\n\n  const handleMutationError = (error, defaultMessage) => {\n    setToast({ message: error?.message || defaultMessage, type: 'error', show: true });\n  };\n\n  const createMutation = useMutation(createAttachment, {\n    onSuccess: () => handleMutationSuccess('Archivo subido correctamente.'),\n    onError: (err) => handleMutationError(err, 'Error al subir archivo.'),\n  });\n\n  const deleteMutation = useMutation(deleteAttachment, {\n    onSuccess: () => handleMutationSuccess('Adjunto eliminado correctamente.'),\n    onError: (err) => handleMutationError(err, 'Error al eliminar adjunto.'),\n  });\n\n  const handleUploadSubmit = (e) => {\n    e.preventDefault();\n    if (!uploadForm.file || !uploadForm.project_id) {\n      setToast({ message: 'Debe seleccionar un proyecto y un archivo.', type: 'error', show: true });\n      return;\n    }\n    createMutation.mutate(uploadForm);\n  };\n\n  const handleDeleteConfirm = () => {\n    if (deletingAttachment) {\n      deleteMutation.mutate(deletingAttachment.id);\n    }\n  };\n\n  const columns = useMemo(() => [\n    { header: 'ID', key: 'id', width: 60 },\n    { header: 'Proyecto', key: 'project_name' },\n    { header: 'Archivo', key: 'file_url', render: (att) => (\n      <a href={att.file_url} target=\"_blank\" rel=\"noreferrer noopener\">\n        {att.file_url.split('/').pop()}\n      </a>\n    )},\n    { header: 'Descripción', key: 'description' },\n    { header: 'Subido por', key: 'uploaded_by_name' },\n    { header: 'Fecha', key: 'created_at', render: (att) => new Date(att.created_at).toLocaleString(), width: 200 },\n    { header: 'Acciones', key: 'actions', width: 120, render: (att) => (\n      <button className=\"btn btn-sm btn-outline-danger\" onClick={() => setDeletingAttachment(att)}>Eliminar</button>\n    )},\n  ], []);\n\n  const rows = data?.data || [];\n  const total = data?.total || 0;\n  const totalPages = Math.max(1, Math.ceil(total / limit));\n\n  return (\n    <ModuloBase titulo=\"Gestión de Adjuntos\" descripcion=\"Archivos relacionados a proyectos y cotizaciones.\">\n      <Toolbar\n        left={\n          <input\n            className=\"form-control\"\n            style={{ maxWidth: '300px' }}\n            placeholder=\"Buscar por archivo, proyecto...\"\n            value={filters.q}\n            onChange={e => { setPage(1); setFilters({ q: e.target.value }); }}\n          />\n        }\n        right={\n          <button className=\"btn btn-primary\" onClick={() => setShowUploadModal(true)}>+ Subir Archivo</button>\n        }\n      />\n\n      <DataTable columns={columns} rows={rows} loading={isLoading} />\n\n      <div className=\"d-flex justify-content-between align-items-center mt-3\">\n        <span className=\"text-muted\">Total: {total}</span>\n        <div className=\"btn-group\">\n          <button className=\"btn btn-outline-secondary\" disabled={page <= 1} onClick={() => setPage(p => p - 1)}>Anterior</button>\n          <span className=\"btn btn-outline-secondary disabled\">{page} / {totalPages}</span>\n          <button className=\"btn btn-outline-secondary\" disabled={page >= totalPages} onClick={() => setPage(p => p + 1)}>Siguiente</button>\n        </div>\n      </div>\n\n      {/* Upload Modal */}\n      {showUploadModal && (\n        <Modal open={showUploadModal} onClose={() => setShowUploadModal(false)}>\n          <form onSubmit={handleUploadSubmit}>\n            <h4>Subir Archivo Adjunto</h4>\n            <div className=\"row g-3 mt-2\">\n              <div className=\"col-12\">\n                <label className=\"form-label\">Proyecto</label>\n                <select\n                  className=\"form-select\"\n                  value={uploadForm.project_id}\n                  onChange={(e) => setUploadForm(f => ({ ...f, project_id: e.target.value }))}\n                  required\n                >\n                  <option value=\"\">Seleccione un proyecto...</option>\n                  {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}\n                </select>\n              </div>\n              <div className=\"col-12\">\n                <label className=\"form-label\">Descripción (Opcional)</label>\n                <input\n                  className=\"form-control\"\n                  value={uploadForm.description}\n                  onChange={(e) => setUploadForm(f => ({ ...f, description: e.target.value }))}\n                />\n              </div>\n              <div className=\"col-12\">\n                <label className=\"form-label\">Archivo</label>\n                <input\n                  type=\"file\"\n                  className=\"form-control\"\n                  onChange={(e) => setUploadForm(f => ({ ...f, file: e.target.files[0] }))}\n                  required\n                />\n              </div>\n            </div>\n            <div className=\"d-flex justify-content-end gap-2 mt-4\">\n              <button type=\"button\" className=\"btn btn-outline-secondary\" onClick={() => setShowUploadModal(false)}>Cancelar</button>\n              <button type=\"submit\" className=\"btn btn-primary\" disabled={createMutation.isLoading}>\n                {createMutation.isLoading ? 'Subiendo...' : 'Subir'}\n              </button>\n            </div>\n          </form>\n        </Modal>\n      )}\n\n      {/* Delete Confirmation Modal */}\n      {deletingAttachment && (\n        <Modal open={!!deletingAttachment} onClose={() => setDeletingAttachment(null)}>\n          <h4>Confirmar Eliminación</h4>\n          <p>¿Estás seguro de que quieres eliminar el archivo <strong>{deletingAttachment.file_url.split('/').pop()}</strong>? Esta acción no se puede deshacer.</p>\n          <div className=\"d-flex justify-content-end gap-2 mt-4\">\n            <button type=\"button\" className=\"btn btn-outline-secondary\" onClick={() => setDeletingAttachment(null)}>Cancelar</button>\n            <button type=\"button\" className=\"btn btn-danger\" onClick={handleDeleteConfirm} disabled={deleteMutation.isLoading}>\n              Eliminar\n            </button>\n          </div>\n        </Modal>\n      )}\n\n      <Toast \n        message={toast.message} \n        type={toast.type} \n        onClose={() => setToast(prev => ({ ...prev, show: false }))} \n      />\n    </ModuloBase>\n  );\n}"],"names":["listAttachments","params","sp","qs","path","apiFetch","createAttachment","project_id","description","file","form","deleteAttachment","id","emptyForm","Adjuntos","page","setPage","useState","limit","filters","setFilters","toast","setToast","location","useLocation","showUploadModal","setShowUploadModal","uploadForm","setUploadForm","deletingAttachment","setDeletingAttachment","queryClient","useQueryClient","useEffect","_a","f","data","isLoading","useQuery","projectsData","listProjects","projects","useMemo","handleMutationSuccess","message","handleMutationError","error","defaultMessage","createMutation","useMutation","err","deleteMutation","handleUploadSubmit","handleDeleteConfirm","columns","att","jsx","rows","total","totalPages","jsxs","ModuloBase","Toolbar","DataTable","p","Modal","Toast","prev"],"mappings":"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"}