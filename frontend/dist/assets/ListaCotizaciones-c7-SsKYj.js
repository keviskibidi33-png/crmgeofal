import{r,u as z,j as e,L as y}from"./index-BFrTSJXc.js";import{M as I}from"./ModuloBase-BXjPI6cD.js";import{T as P,a as k}from"./Toolbar-CsECCMO9.js";import{l as F,c as L,b as M,a as T}from"./quotes-Zfd8-cRQ.js";import{l as q}from"./companies-CU1Nz5ws.js";import{l as O}from"./projects-BYu6OmzB.js";function Y(){const[_,g]=r.useState([]),[d,N]=r.useState([]),[s,c]=r.useState({company_id:"",project_id:"",status:"",date_from:"",date_to:""}),[m,v]=r.useState([]),[u,p]=r.useState(!1),[x,j]=r.useState(""),S=z();r.useEffect(()=>{(async()=>{try{const[t,a]=await Promise.all([q({page:1,limit:100}),O({page:1,limit:200})]);g(Array.isArray(t==null?void 0:t.data)?t.data:t||[]),N(Array.isArray(a==null?void 0:a.data)?a.data:a||[])}catch{}})()},[]);const b=async()=>{try{p(!0),j("");const t={};s.company_id&&(t.company_id=s.company_id),s.project_id&&(t.project_id=s.project_id),s.status&&(t.status=s.status),s.date_from&&(t.date_from=s.date_from),s.date_to&&(t.date_to=s.date_to);const a=await F(t),o=Array.isArray(a)?a:Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a==null?void 0:a.rows)?a.rows:[];v(o)}catch(t){j(t.message||"No se pudo cargar cotizaciones")}finally{p(!1)}};r.useEffect(()=>{b()},[]);const C=r.useMemo(()=>{if(!s.company_id)return d;const t=Number(s.company_id);return d.filter(a=>Number(a.company_id)===t)},[d,s.company_id]),A=async t=>{try{const a={project_id:t.project_id,variant_id:t.variant_id||null,client_contact:t.client_contact,client_email:t.client_email,client_phone:t.client_phone,issue_date:new Date().toISOString().slice(0,10),subtotal:t.subtotal,igv:t.igv,total:t.total,status:"borrador",meta:{from_quote_id:t.id,...t.meta}},o=await L(a),n=await M(t.id),l=Array.isArray(n==null?void 0:n.data)?n.data:n||[];for(const i of l)await T({quote_id:o.id,code:i.code,description:i.description,norm:i.norm,unit_price:Number(i.unit_price||0),quantity:Number(i.quantity||0),partial_price:Number(i.partial_price||0)});S(`/cotizaciones/${o.id}`)}catch{alert("No se pudo clonar")}},f=(t,a)=>{const o="http://localhost:4000/api".replace(/\/$/,"")||"",n=`/api/quotes/${t.id}/export/${a}`;return o&&/\/api$/i.test(o)?`${o}${n.replace(/^\/api/,"")}`:`${o}${n}`},h=t=>{const a=new Date;if(t==="today"){const o=a.toISOString().slice(0,10);c(n=>({...n,date_from:o,date_to:o}));return}if(t==="7d"){const o=a.toISOString().slice(0,10),n=new Date(a);n.setDate(a.getDate()-6);const l=n.toISOString().slice(0,10);c(i=>({...i,date_from:l,date_to:o}));return}if(t==="month"){const o=a.getFullYear(),n=String(a.getMonth()+1).padStart(2,"0"),l=`${o}-${n}-01`,i=new Date(o,a.getMonth()+1,1),$=new Date(i-1).toISOString().slice(0,10);c(D=>({...D,date_from:l,date_to:$}))}},E=({status:t})=>{const o={borrador:"secondary",enviado:"primary",aceptado:"success",rechazado:"danger"}[String(t||"").toLowerCase()]||"secondary";return e.jsx("span",{className:`badge text-bg-${o} text-capitalize`,children:t||"—"})};return e.jsxs(I,{titulo:"Cotizaciones",descripcion:"Lista de cotizaciones por cliente y proyecto",children:[e.jsx(P,{compact:!0,left:e.jsxs("div",{className:"row g-2 w-100",children:[e.jsxs("div",{className:"col-12 col-md-3",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsxs("select",{className:"form-select",value:s.company_id,onChange:t=>c({...s,company_id:t.target.value,project_id:""}),children:[e.jsx("option",{value:"",children:"Todos"}),_.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"col-12 col-md-3",children:[e.jsx("label",{className:"form-label",children:"Proyecto"}),e.jsxs("select",{className:"form-select",value:s.project_id,onChange:t=>c({...s,project_id:t.target.value}),children:[e.jsx("option",{value:"",children:"Todos"}),C.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"col-6 col-md-2",children:[e.jsx("label",{className:"form-label",children:"Estado"}),e.jsxs("select",{className:"form-select",value:s.status,onChange:t=>c({...s,status:t.target.value}),children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"borrador",children:"Borrador"}),e.jsx("option",{value:"enviado",children:"Enviado"}),e.jsx("option",{value:"aceptado",children:"Aceptado"}),e.jsx("option",{value:"rechazado",children:"Rechazado"})]})]}),e.jsxs("div",{className:"col-6 col-md-2",children:[e.jsx("label",{className:"form-label",children:"Desde"}),e.jsx("input",{type:"date",className:"form-control",value:s.date_from,onChange:t=>c({...s,date_from:t.target.value})})]}),e.jsxs("div",{className:"col-6 col-md-2",children:[e.jsx("label",{className:"form-label",children:"Hasta"}),e.jsx("input",{type:"date",className:"form-control",value:s.date_to,onChange:t=>c({...s,date_to:t.target.value})})]}),e.jsxs("div",{className:"col-6 col-md-3",children:[e.jsx("label",{className:"form-label",children:"Presets"}),e.jsxs("div",{className:"d-flex gap-2 flex-wrap",children:[e.jsx("button",{className:"btn btn-sm btn-outline-secondary",type:"button",onClick:()=>h("today"),children:"Hoy"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",type:"button",onClick:()=>h("7d"),children:"7 días"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",type:"button",onClick:()=>h("month"),children:"Este mes"})]})]})]}),right:e.jsxs("div",{className:"d-flex gap-2 flex-wrap",children:[e.jsx("button",{className:"btn btn-outline-primary",onClick:b,disabled:u,children:u?"Cargando...":"Filtrar"}),e.jsx(y,{to:"/cotizaciones/nueva/lem",className:"btn btn-primary",children:"Nueva LEM"})]})}),x&&e.jsx("div",{className:"alert alert-danger mt-3",children:x}),e.jsx("div",{className:"table-responsive mt-3",children:e.jsxs("table",{className:"table table-striped align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Proyecto"}),e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Subtotal"}),e.jsx("th",{children:"IGV"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Acciones"})]})}),e.jsxs("tbody",{children:[(Array.isArray(m)?m:[]).map(t=>{var a;return e.jsxs("tr",{children:[e.jsx("td",{children:t.id}),e.jsx("td",{children:t.project_name||t.project_id}),e.jsx("td",{children:(a=t.issue_date)==null?void 0:a.slice(0,10)}),e.jsxs("td",{children:["S/ ",Number(t.subtotal||0).toFixed(2)]}),e.jsxs("td",{children:["S/ ",Number(t.igv||0).toFixed(2)]}),e.jsx("td",{children:e.jsxs("strong",{children:["S/ ",Number(t.total||0).toFixed(2)]})}),e.jsx("td",{children:e.jsx(E,{status:t.status})}),e.jsxs("td",{className:"d-flex gap-2",children:[e.jsx(y,{to:`/cotizaciones/${t.id}`,className:"btn btn-sm btn-outline-secondary",children:"Ver/Editar"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>A(t),children:"Clonar"}),e.jsx("a",{className:"btn btn-sm btn-outline-success",href:f(t,"pdf"),target:"_blank",rel:"noreferrer",children:"PDF"}),e.jsx("a",{className:"btn btn-sm btn-outline-success",href:f(t,"excel"),target:"_blank",rel:"noreferrer",children:"Excel"})]})]},t.id)}),m.length===0&&!u&&e.jsx(k,{colSpan:8,label:"Sin resultados"})]})]})})]})}export{Y as default};
//# sourceMappingURL=ListaCotizaciones-c7-SsKYj.js.map
