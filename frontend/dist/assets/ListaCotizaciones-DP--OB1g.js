import{r,u as C,j as t,L as b}from"./index-DwZw-JFj.js";import{M as $}from"./ModuloBase-CvVreALB.js";import{l as E,c as z,b as F,a as P}from"./quotes-DpNrPCOS.js";import{l as L,a as k}from"./projects-CXFvgs-w.js";function Q(){const[y,_]=r.useState([]),[l,f]=r.useState([]),[s,m]=r.useState({company_id:"",project_id:""}),[o,N]=r.useState([]),[d,u]=r.useState(!1),[p,h]=r.useState(""),g=C();r.useEffect(()=>{(async()=>{try{const[e,a]=await Promise.all([L({page:1,limit:100}),k({page:1,limit:200})]);_(Array.isArray(e==null?void 0:e.data)?e.data:e||[]),f(Array.isArray(a==null?void 0:a.data)?a.data:a||[])}catch{}})()},[]);const j=async()=>{try{u(!0),h("");const e={};s.company_id&&(e.company_id=s.company_id),s.project_id&&(e.project_id=s.project_id);const a=await E(e),i=Array.isArray(a)?a:Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a==null?void 0:a.rows)?a.rows:[];N(i)}catch(e){h(e.message||"No se pudo cargar cotizaciones")}finally{u(!1)}};r.useEffect(()=>{j()},[]);const v=r.useMemo(()=>{if(!s.company_id)return l;const e=Number(s.company_id);return l.filter(a=>Number(a.company_id)===e)},[l,s.company_id]),A=async e=>{try{const a={project_id:e.project_id,variant_id:e.variant_id||null,client_contact:e.client_contact,client_email:e.client_email,client_phone:e.client_phone,issue_date:new Date().toISOString().slice(0,10),subtotal:e.subtotal,igv:e.igv,total:e.total,status:"borrador",meta:{from_quote_id:e.id,...e.meta}},i=await z(a),c=await F(e.id),S=Array.isArray(c==null?void 0:c.data)?c.data:c||[];for(const n of S)await P({quote_id:i.id,code:n.code,description:n.description,norm:n.norm,unit_price:Number(n.unit_price||0),quantity:Number(n.quantity||0),partial_price:Number(n.partial_price||0)});g(`/cotizaciones/${i.id}`)}catch{alert("No se pudo clonar")}},x=(e,a)=>{const i="http://localhost:4000/api".replace(/\/$/,"")||"",c=`/api/quotes/${e.id}/export/${a}`;return i&&/\/api$/i.test(i)?`${i}${c.replace(/^\/api/,"")}`:`${i}${c}`};return t.jsxs($,{titulo:"Cotizaciones",descripcion:"Lista de cotizaciones por cliente y proyecto",children:[t.jsxs("div",{className:"row g-2 align-items-end",children:[t.jsxs("div",{className:"col-md-4",children:[t.jsx("label",{className:"form-label",children:"Cliente"}),t.jsxs("select",{className:"form-select",value:s.company_id,onChange:e=>m({...s,company_id:e.target.value,project_id:""}),children:[t.jsx("option",{value:"",children:"Todos"}),y.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsxs("div",{className:"col-md-4",children:[t.jsx("label",{className:"form-label",children:"Proyecto"}),t.jsxs("select",{className:"form-select",value:s.project_id,onChange:e=>m({...s,project_id:e.target.value}),children:[t.jsx("option",{value:"",children:"Todos"}),v.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsx("div",{className:"col-md-2 d-grid",children:t.jsx("button",{className:"btn btn-outline-primary",onClick:j,disabled:d,children:d?"Cargando...":"Filtrar"})}),t.jsx("div",{className:"col-md-2 d-grid",children:t.jsx(b,{to:"/cotizaciones/nueva/lem",className:"btn btn-primary",children:"Nueva LEM"})})]}),p&&t.jsx("div",{className:"alert alert-danger mt-3",children:p}),t.jsx("div",{className:"table-responsive mt-3",children:t.jsxs("table",{className:"table table-striped align-middle",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"ID"}),t.jsx("th",{children:"Proyecto"}),t.jsx("th",{children:"Fecha"}),t.jsx("th",{children:"Subtotal"}),t.jsx("th",{children:"IGV"}),t.jsx("th",{children:"Total"}),t.jsx("th",{children:"Estado"}),t.jsx("th",{children:"Acciones"})]})}),t.jsxs("tbody",{children:[(Array.isArray(o)?o:[]).map(e=>{var a;return t.jsxs("tr",{children:[t.jsx("td",{children:e.id}),t.jsx("td",{children:e.project_name||e.project_id}),t.jsx("td",{children:(a=e.issue_date)==null?void 0:a.slice(0,10)}),t.jsxs("td",{children:["S/ ",Number(e.subtotal||0).toFixed(2)]}),t.jsxs("td",{children:["S/ ",Number(e.igv||0).toFixed(2)]}),t.jsx("td",{children:t.jsxs("strong",{children:["S/ ",Number(e.total||0).toFixed(2)]})}),t.jsx("td",{children:e.status}),t.jsxs("td",{className:"d-flex gap-2",children:[t.jsx(b,{to:`/cotizaciones/${e.id}`,className:"btn btn-sm btn-outline-secondary",children:"Ver/Editar"}),t.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>A(e),children:"Clonar"}),t.jsx("a",{className:"btn btn-sm btn-outline-success",href:x(e,"pdf"),target:"_blank",rel:"noreferrer",children:"PDF"}),t.jsx("a",{className:"btn btn-sm btn-outline-success",href:x(e,"excel"),target:"_blank",rel:"noreferrer",children:"Excel"})]})]},e.id)}),o.length===0&&!d&&t.jsx("tr",{children:t.jsx("td",{colSpan:"8",className:"text-center text-muted",children:"Sin resultados"})})]})]})})]})}export{Q as default};
//# sourceMappingURL=ListaCotizaciones-DP--OB1g.js.map
