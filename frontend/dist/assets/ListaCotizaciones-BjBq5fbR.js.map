{"version":3,"file":"ListaCotizaciones-BjBq5fbR.js","sources":["../../src/pages/ListaCotizaciones.jsx"],"sourcesContent":["import React, { useEffect, useMemo, useState } from 'react';\r\nimport ModuloBase from '../components/ModuloBase';\r\nimport { listQuotes, createQuote, listQuoteItems, addQuoteItem } from '../services/quotes';\r\nimport { listCompanies } from '../services/companies';\r\nimport { listProjects } from '../services/projects';\r\nimport { Link, useNavigate } from 'react-router-dom';\r\n\r\nexport default function ListaCotizaciones() {\r\n  const [companies, setCompanies] = useState([]);\r\n  const [projects, setProjects] = useState([]);\r\n  const [filters, setFilters] = useState({ company_id: '', project_id: '' });\r\n  const [rows, setRows] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState('');\r\n  const navigate = useNavigate();\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const [cRes, pRes] = await Promise.all([\r\n          listCompanies({ page: 1, limit: 100 }),\r\n          listProjects({ page: 1, limit: 200 }),\r\n        ]);\r\n        setCompanies(Array.isArray(cRes?.data) ? cRes.data : (cRes || []));\r\n        setProjects(Array.isArray(pRes?.data) ? pRes.data : (pRes || []));\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  const loadData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      setError('');\r\n      const params = {};\r\n      if (filters.company_id) params.company_id = filters.company_id;\r\n      if (filters.project_id) params.project_id = filters.project_id;\r\n      const resp = await listQuotes(params);\r\n      const arr = Array.isArray(resp)\r\n        ? resp\r\n        : Array.isArray(resp?.data)\r\n        ? resp.data\r\n        : Array.isArray(resp?.rows)\r\n        ? resp.rows\r\n        : [];\r\n      setRows(arr);\r\n    } catch (e) {\r\n      setError(e.message || 'No se pudo cargar cotizaciones');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => { loadData(); }, []); // initial\r\n\r\n  const filteredProjects = useMemo(() => {\r\n    if (!filters.company_id) return projects;\r\n    const cid = Number(filters.company_id);\r\n    return projects.filter(p => Number(p.company_id) === cid);\r\n  }, [projects, filters.company_id]);\r\n\r\n  const onClone = async (row) => {\r\n    try {\r\n      const payload = {\r\n        project_id: row.project_id,\r\n        variant_id: row.variant_id || null,\r\n        client_contact: row.client_contact,\r\n        client_email: row.client_email,\r\n        client_phone: row.client_phone,\r\n        issue_date: new Date().toISOString().slice(0,10),\r\n        subtotal: row.subtotal,\r\n        igv: row.igv,\r\n        total: row.total,\r\n        status: 'borrador',\r\n        meta: { from_quote_id: row.id, ...row.meta }\r\n      };\r\n      const created = await createQuote(payload);\r\n      // Copiar Ã­tems\r\n      const its = await listQuoteItems(row.id);\r\n      const items = Array.isArray(its?.data) ? its.data : (its || []);\r\n      for (const it of items) {\r\n        await addQuoteItem({\r\n          quote_id: created.id,\r\n          code: it.code,\r\n          description: it.description,\r\n          norm: it.norm,\r\n          unit_price: Number(it.unit_price || 0),\r\n          quantity: Number(it.quantity || 0),\r\n          partial_price: Number(it.partial_price || 0),\r\n        });\r\n      }\r\n      navigate(`/cotizaciones/${created.id}`);\r\n    } catch (e) {\r\n      alert('No se pudo clonar');\r\n    }\r\n  };\r\n\r\n  const exportUrl = (row, type) => {\r\n    const base = import.meta.env?.VITE_API_URL?.replace(/\\/$/, '') || '';\r\n    const path = `/api/quotes/${row.id}/export/${type}`;\r\n    return base && /\\/api$/i.test(base) ? `${base}${path.replace(/^\\/api/, '')}` : `${base}${path}`;\r\n  };\r\n\r\n  return (\r\n    <ModuloBase titulo=\"Cotizaciones\" descripcion=\"Lista de cotizaciones por cliente y proyecto\">\r\n      <div className=\"row g-2 align-items-end\">\r\n        <div className=\"col-md-4\">\r\n          <label className=\"form-label\">Cliente</label>\r\n          <select className=\"form-select\" value={filters.company_id} onChange={e=>setFilters({ ...filters, company_id: e.target.value, project_id: '' })}>\r\n            <option value=\"\">Todos</option>\r\n            {companies.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\r\n          </select>\r\n        </div>\r\n        <div className=\"col-md-4\">\r\n          <label className=\"form-label\">Proyecto</label>\r\n          <select className=\"form-select\" value={filters.project_id} onChange={e=>setFilters({ ...filters, project_id: e.target.value })}>\r\n            <option value=\"\">Todos</option>\r\n            {filteredProjects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}\r\n          </select>\r\n        </div>\r\n        <div className=\"col-md-2 d-grid\">\r\n          <button className=\"btn btn-outline-primary\" onClick={loadData} disabled={loading}>{loading ? 'Cargando...' : 'Filtrar'}</button>\r\n        </div>\r\n        <div className=\"col-md-2 d-grid\">\r\n          <Link to=\"/cotizaciones/nueva/lem\" className=\"btn btn-primary\">Nueva LEM</Link>\r\n        </div>\r\n      </div>\r\n\r\n      {error && <div className=\"alert alert-danger mt-3\">{error}</div>}\r\n\r\n      <div className=\"table-responsive mt-3\">\r\n        <table className=\"table table-striped align-middle\">\r\n          <thead>\r\n            <tr>\r\n              <th>ID</th>\r\n              <th>Proyecto</th>\r\n              <th>Fecha</th>\r\n              <th>Subtotal</th>\r\n              <th>IGV</th>\r\n              <th>Total</th>\r\n              <th>Estado</th>\r\n              <th>Acciones</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {(Array.isArray(rows) ? rows : []).map(row => (\r\n              <tr key={row.id}>\r\n                <td>{row.id}</td>\r\n                <td>{row.project_name || row.project_id}</td>\r\n                <td>{row.issue_date?.slice(0,10)}</td>\r\n                <td>S/ {Number(row.subtotal||0).toFixed(2)}</td>\r\n                <td>S/ {Number(row.igv||0).toFixed(2)}</td>\r\n                <td><strong>S/ {Number(row.total||0).toFixed(2)}</strong></td>\r\n                <td>{row.status}</td>\r\n                <td className=\"d-flex gap-2\">\r\n                  <Link to={`/cotizaciones/${row.id}`} className=\"btn btn-sm btn-outline-secondary\">Ver/Editar</Link>\r\n                  <button className=\"btn btn-sm btn-outline-primary\" onClick={() => onClone(row)}>Clonar</button>\r\n                  <a className=\"btn btn-sm btn-outline-success\" href={exportUrl(row, 'pdf')} target=\"_blank\" rel=\"noreferrer\">PDF</a>\r\n                  <a className=\"btn btn-sm btn-outline-success\" href={exportUrl(row, 'excel')} target=\"_blank\" rel=\"noreferrer\">Excel</a>\r\n                </td>\r\n              </tr>\r\n            ))}\r\n            {rows.length === 0 && !loading && (\r\n              <tr>\r\n                <td colSpan=\"8\" className=\"text-center text-muted\">Sin resultados</td>\r\n              </tr>\r\n            )}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </ModuloBase>\r\n  );\r\n}\r\n"],"names":["ListaCotizaciones","companies","setCompanies","useState","projects","setProjects","filters","setFilters","rows","setRows","loading","setLoading","error","setError","navigate","useNavigate","useEffect","cRes","pRes","listCompanies","listProjects","loadData","params","resp","listQuotes","arr","filteredProjects","useMemo","cid","p","onClone","row","payload","created","createQuote","its","listQuoteItems","items","it","addQuoteItem","exportUrl","type","base","path","ModuloBase","jsxs","c","jsx","Link","_a"],"mappings":"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"}