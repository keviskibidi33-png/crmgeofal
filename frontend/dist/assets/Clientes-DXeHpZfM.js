import{r as h,R as te,j as e,n as I,o as H,k as A,E as Re,p as ne,q as Fe,K as ue,w as Ke,s as we,B as P,L as We,c as xe,M as Je,f as se,g as q,N as pe,O as B,P as Ye,Q as Xe,S as Ze,T as _e,U as es,b as L,a as ss,V as as,e as K,x as ae,l as ts,W as ns,X as Z,F as le,Y as rs,C as $,u as is,Z as os,y as ls,h as ze,I as cs,_ as ds,J as Te}from"./index-Bcrgukx7.js";import{D as ms}from"./DataTable-BA50ScQ0.js";/* empty css                     */import{S as ee}from"./StatsCard-Bg6TicJV.js";import{C as us}from"./ConfirmModal-om5z7whj.js";import{M as N}from"./Modal-CPMvw6Im.js";import{u as hs,g as xs,c as ps,a as js,d as gs,l as fs,b as bs,e as Ns}from"./companies-CT3vhc5O.js";import{A as vs}from"./Alert-C1-1JEUj.js";import{S as ys}from"./Spinner-jUAz7otr.js";import{C as W}from"./Card-C96hNOBG.js";import{R as he,C as Cs}from"./Row-B5ljKXp5.js";import{C as O}from"./Col-C5Zwr_ej.js";import{T as Ss,a as ce}from"./Tabs-Bzkyjbmi.js";import{T as ke}from"./Table-CY_xt81j.js";import{g as Es,c as ws,a as zs,b as Ts,d as ks,e as Ds,l as Rs}from"./authHelper-BtdtwZok.js";/* empty css                  */import"./InputGroup-B7PnIA03.js";import"./Form-DBWuP9iW.js";import"./ElementChildren-BWXp08bt.js";const Fs=[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}],_s=[{value:"construccion",label:"Construcción"},{value:"mineria",label:"Minería"},{value:"servicios",label:"Servicios"},{value:"comercio",label:"Comercio"},{value:"industria",label:"Industria"},{value:"gobierno",label:"Gobierno"},{value:"otro",label:"Otro"}],Ps=[{value:"lima",label:"Lima"},{value:"arequipa",label:"Arequipa"},{value:"trujillo",label:"Trujillo"},{value:"chiclayo",label:"Chiclayo"},{value:"piura",label:"Piura"},{value:"cusco",label:"Cusco"},{value:"otro",label:"Otra"}],Is=({show:i,onHide:r,data:t={},onSubmit:E,loading:f=!1,isEditing:v=!1})=>{const[c,z]=h.useState({type:t.type||"empresa",name:t.name||"",ruc:t.ruc||"",dni:t.dni||"",contact_name:t.contact_name||"",email:t.email||"",phone:t.phone||"",address:t.address||"",city:t.city||"lima",sector:t.sector||"servicios"}),[m,g]=h.useState({});te.useEffect(()=>{if(i){const s=!t.id;z({type:t.type||"empresa",name:s?"":t.name||"",ruc:s?"":t.ruc||"",dni:s?"":t.dni||"",contact_name:s?"":t.contact_name||"",email:s?"":t.email||"",phone:s?"":t.phone||"",address:s?"":t.address||"",city:t.city||"lima",sector:t.sector||"servicios"}),g({})}},[i,t,v]);const u=(s,p)=>{z(n=>({...n,[s]:p})),s==="ruc"&&c.type==="empresa"&&(p&&!l(p)?g(n=>({...n,ruc:"El RUC debe empezar con 20 y tener 11 dígitos"})):g(n=>({...n,ruc:""}))),s==="dni"&&c.type==="persona"&&(p&&!y(p)?g(n=>({...n,dni:"El DNI debe tener exactamente 8 dígitos"})):g(n=>({...n,dni:""}))),s==="phone"&&(p&&!b(p)?g(n=>({...n,phone:"El teléfono debe tener 9 dígitos"})):g(n=>({...n,phone:""}))),m[s]&&s!=="ruc"&&s!=="dni"&&g(n=>({...n,[s]:""}))},l=s=>s?/^20\d{9}$/.test(s):!1,y=s=>s?/^\d{8}$/.test(s):!1,b=s=>s?/^\d{9}$/.test(s):!0,d=()=>{const s={};return c.name.trim()||(s.name="El nombre/razón social es requerido"),c.type==="empresa"&&(c.ruc.trim()?l(c.ruc)||(s.ruc="El RUC debe empezar con 20 y tener 11 dígitos"):s.ruc="El RUC es requerido para empresas"),c.type==="persona"&&(c.dni.trim()?y(c.dni)||(s.dni="El DNI debe tener exactamente 8 dígitos"):s.dni="El DNI es requerido para personas naturales"),c.email&&!/\S+@\S+\.\S+/.test(c.email)&&(s.email="El email no es válido"),c.phone&&!b(c.phone)&&(s.phone="El teléfono debe tener 9 dígitos"),g(s),Object.keys(s).length===0},T=s=>{if(s.preventDefault(),d()){const p={...c};p.type==="empresa"?delete p.dni:delete p.ruc,E(p)}};return te.useEffect(()=>{t.error&&(t.error.includes("email")||t.error.includes("Email"))&&g(s=>({...s,email:"Este email ya está registrado"}))},[t.error]),i?e.jsx("div",{className:"client-form-backdrop",onClick:r,children:e.jsxs("div",{className:"client-form-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"client-form-header",children:[e.jsxs("h4",{children:[e.jsx(I,{className:"client-form-icon"}),v?"Editar Cliente":"Nuevo Cliente"]}),e.jsx("button",{className:"close-btn",onClick:r,children:e.jsx(H,{})})]}),e.jsxs("form",{onSubmit:T,className:"client-form-body",children:[e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(I,{className:"client-form-icon"}),"Información Básica"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(A,{className:"client-form-icon"}),"Tipo de Cliente ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("select",{className:"client-form-select",value:c.type,onChange:s=>u("type",s.target.value),children:Fs.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(Re,{className:"client-form-icon"}),"Nombre/Razón Social ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${m.name?"error":""}`,value:c.name,onChange:s=>u("name",s.target.value),placeholder:"Ingresa el nombre o razón social"}),m.name&&e.jsx("div",{className:"client-form-error",children:m.name})]})]}),e.jsxs("div",{className:"client-form-row",children:[c.type==="empresa"?e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(A,{className:"client-form-icon"}),"RUC ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${m.ruc?"error":c.ruc&&l(c.ruc)?"valid":""}`,value:c.ruc,onChange:s=>u("ruc",s.target.value),placeholder:"20123456789",maxLength:"11"}),m.ruc&&e.jsx("div",{className:"client-form-error",children:m.ruc}),e.jsx("div",{className:"client-form-help",children:"Solo para empresas - Debe empezar con 20 y tener 11 dígitos"})]}):e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(I,{className:"client-form-icon"}),"DNI ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${m.dni?"error":c.dni&&y(c.dni)?"valid":""}`,value:c.dni,onChange:s=>u("dni",s.target.value),placeholder:"12345678",maxLength:"8"}),m.dni&&e.jsx("div",{className:"client-form-error",children:m.dni}),e.jsx("div",{className:"client-form-help",children:"Solo para personas naturales - Debe tener exactamente 8 dígitos"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(I,{className:"client-form-icon"}),"Nombre de Contacto"]}),e.jsx("input",{type:"text",className:"client-form-input",value:c.contact_name,onChange:s=>u("contact_name",s.target.value),placeholder:"Ingresa el nombre del contacto"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(ne,{className:"client-form-icon"}),"Información de Contacto"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(ne,{className:"client-form-icon"}),"Email"]}),e.jsx("input",{type:"email",className:`client-form-input ${m.email?"error":""}`,value:c.email,onChange:s=>u("email",s.target.value),placeholder:"contacto@empresa.com"}),m.email&&e.jsx("div",{className:"client-form-error",children:m.email})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(Fe,{className:"client-form-icon"}),"Teléfono"]}),e.jsx("input",{type:"tel",className:`client-form-input ${m.phone?"error":c.phone&&b(c.phone)?"valid":""}`,value:c.phone,onChange:s=>u("phone",s.target.value),placeholder:"930238631",maxLength:"9"}),m.phone&&e.jsx("div",{className:"client-form-error",children:m.phone}),e.jsx("div",{className:"client-form-help",children:"Debe tener 9 dígitos"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(ue,{className:"client-form-icon"}),"Información de Ubicación"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(ue,{className:"client-form-icon"}),"Dirección"]}),e.jsx("input",{type:"text",className:"client-form-input",value:c.address,onChange:s=>u("address",s.target.value),placeholder:"Ingresa la dirección"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(A,{className:"client-form-icon"}),"Ciudad"]}),e.jsx("select",{className:"client-form-select",value:c.city,onChange:s=>u("city",s.target.value),children:Ps.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsx("div",{className:"client-form-row single",children:e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(A,{className:"client-form-icon"}),"Sector"]}),e.jsx("select",{className:"client-form-select",value:c.sector,onChange:s=>u("sector",s.target.value),children:_s.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})})]})]}),e.jsxs("div",{className:"client-form-actions",children:[e.jsxs("button",{type:"button",className:"client-form-btn client-form-btn-cancel",onClick:r,disabled:f,children:[e.jsx(H,{}),"Cancelar"]}),e.jsx("button",{type:"submit",className:"client-form-btn client-form-btn-create",onClick:T,disabled:f,children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})}),v?"Actualizando...":"Creando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ke,{}),v?"Actualizar":"Crear"]})})]})]})}):null},As=({show:i,onHide:r,action:t="realizar esta acción",requiredRole:E="administrador",currentRole:f="usuario"})=>e.jsxs(N,{show:i,onHide:r,centered:!0,backdrop:"static",children:[e.jsxs(N.Header,{className:"bg-danger text-white border-0",children:[e.jsxs(N.Title,{className:"d-flex align-items-center",children:[e.jsx(we,{className:"me-2",size:20}),"Acceso Denegado"]}),e.jsx(P,{variant:"link",className:"text-white p-0 border-0",onClick:r,style:{fontSize:"1.5rem",lineHeight:1},children:e.jsx(H,{})})]}),e.jsx(N.Body,{className:"py-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-3",children:e.jsx(We,{size:48,className:"text-warning"})}),e.jsxs("h5",{className:"text-danger mb-3",children:["No tienes permisos para ",t]}),e.jsx("div",{className:"alert alert-warning border-0 mb-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(we,{className:"me-2 text-warning",size:16}),e.jsxs("div",{children:[e.jsx("strong",{children:"Rol requerido:"})," ",E,e.jsx("br",{}),e.jsx("strong",{children:"Tu rol actual:"})," ",f]})]})}),e.jsx("p",{className:"text-muted mb-0",children:"Contacta al administrador del sistema si necesitas acceso a esta funcionalidad."})]})}),e.jsx(N.Footer,{className:"border-0 justify-content-center",children:e.jsx(P,{variant:"secondary",onClick:r,className:"px-4",children:"Entendido"})})]}),de={prospeccion:{label:"Prospección",icon:Xe,color:"secondary",bgColor:"#6c757d"},interesado:{label:"Interesado",icon:Ye,color:"info",bgColor:"#17a2b8"},pendiente_cotizacion:{label:"Pendiente de Cotización",icon:B,color:"warning",bgColor:"#ffc107"},cotizacion_enviada:{label:"Cotización Enviada",icon:pe,color:"info",bgColor:"#17a2b8"},negociacion:{label:"Negociación",icon:q,color:"secondary",bgColor:"#6c757d"},ganado:{label:"Ganado",icon:se,color:"success",bgColor:"#28a745"},perdido:{label:"Perdido",icon:H,color:"danger",bgColor:"#dc3545"},otro:{label:"Otro",icon:Je,color:"light",bgColor:"#f8f9fa"}},Ms=({clientId:i,currentStatus:r,onStatusChange:t,disabled:E=!1,size:f="sm",showLabel:v=!0})=>{const[c,z]=h.useState(!1),[m,g]=h.useState(""),[u,l]=h.useState(!1),[y,b]=h.useState({top:0,left:0}),d=h.useRef(null),T=h.useRef(null),s=xe(),p=()=>{if(d.current){const C=d.current.getBoundingClientRect();b({top:C.bottom+5,left:C.left})}l(!u)},n=C=>{u&&T.current&&!T.current.contains(C.target)&&d.current&&!d.current.contains(C.target)&&l(!1)};h.useEffect(()=>{if(u)return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[u]);const w=async C=>{if(C!==r){console.log(`🔄 ClientStatusDropdown - Iniciando cambio de estado del cliente ${i} de '${r}' a '${C}'`),t==null||t(C),l(!1),z(!0),g("");try{console.log("🔄 ClientStatusDropdown - Llamando a updateClientStatus...");const F=await hs(i,C);console.log("✅ ClientStatusDropdown - Estado actualizado exitosamente:",F),s.invalidateQueries(["clients"]),s.invalidateQueries("companiesList"),s.invalidateQueries("clientStats"),s.invalidateQueries("companyStats")}catch(F){console.error("❌ ClientStatusDropdown - Error al actualizar estado:",F),g(F.message||"Error al actualizar estado"),console.log(`🔄 ClientStatusDropdown - Revirtiendo estado a '${r}'`),t==null||t(r)}finally{z(!1)}}},D=de[r]||de.prospeccion,R=D.icon,J=u&&Ze.createPortal(e.jsx("div",{ref:T,className:"dropdown-menu show",style:{position:"fixed",top:y.top,left:y.left,zIndex:99999,minWidth:"200px",maxHeight:"300px",overflowY:"auto",boxShadow:"0 0.5rem 1rem rgba(0, 0, 0, 0.15)",border:"1px solid rgba(0, 0, 0, 0.15)",borderRadius:"0.375rem",backgroundColor:"white"},children:Object.entries(de).map(([C,F])=>{const re=F.icon,_=C===r;return e.jsxs("button",{className:`dropdown-item d-flex align-items-center gap-2 ${_?"active":""}`,onClick:()=>w(C),disabled:_,style:{border:"none",background:_?F.bgColor:"transparent",color:_?"white":"#212529",width:"100%",textAlign:"left",padding:"0.5rem 1rem",cursor:"pointer"},onMouseEnter:G=>{_||(G.target.style.backgroundColor="#f8f9fa")},onMouseLeave:G=>{_||(G.target.style.backgroundColor="transparent")},children:[e.jsx(re,{size:14}),e.jsx("span",{children:F.label}),_&&e.jsx(_e,{size:14,className:"ms-auto"})]},C)})}),document.body);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-status-dropdown",children:[m&&e.jsx(vs,{variant:"danger",className:"mb-2",style:{fontSize:"0.8rem"},children:m}),e.jsxs("button",{ref:d,className:`btn btn-${D.color} btn-${f} d-flex align-items-center gap-1`,onClick:p,disabled:E||c,style:{backgroundColor:D.bgColor,borderColor:D.bgColor,minWidth:"140px"},children:[c?e.jsx(ys,{animation:"border",size:"sm"}):e.jsxs(e.Fragment,{children:[e.jsx(R,{size:14}),v&&e.jsx("span",{children:D.label})]}),e.jsx(es,{size:12})]})]}),J]})},me={async createComment(i,r){try{console.log("💬 Creando comentario para cliente:",i);const t=await L("/api/client-comments",{method:"POST",body:JSON.stringify({company_id:i,comment:r})});return console.log("✅ Comentario creado:",t),t}catch(t){throw console.error("❌ Error creando comentario:",t),t}},async getCommentsByCompany(i){try{console.log("💬 Obteniendo comentarios para cliente:",i);const r=await L(`/api/client-comments/company/${i}`,{method:"GET"});return console.log("✅ Comentarios obtenidos:",r),r}catch(r){throw console.error("❌ Error obteniendo comentarios:",r),r}},async updateComment(i,r){try{console.log("💬 Actualizando comentario:",i);const t=await L(`/api/client-comments/${i}`,{method:"PUT",body:JSON.stringify({comment:r})});return console.log("✅ Comentario actualizado:",t),t}catch(t){throw console.error("❌ Error actualizando comentario:",t),t}},async deleteComment(i){try{console.log("💬 Eliminando comentario:",i);const r=await L(`/api/client-comments/${i}`,{method:"DELETE"});return console.log("✅ Comentario eliminado:",r),r}catch(r){throw console.error("❌ Error eliminando comentario:",r),r}},async markCommentsAsRead(i){try{console.log("💬 Marcando comentarios como leídos para cliente:",i);const r=await L(`/api/client-comments/company/${i}/mark-read`,{method:"POST"});return console.log("✅ Comentarios marcados como leídos:",r),r}catch(r){throw console.error("❌ Error marcando comentarios como leídos:",r),r}},async getUnreadComments(){try{console.log("💬 Obteniendo comentarios no leídos");const i=await L("/api/client-comments/unread",{method:"GET"});return console.log("✅ Comentarios no leídos obtenidos:",i),i}catch(i){throw console.error("❌ Error obteniendo comentarios no leídos:",i),i}},async getRecentComments(i=10){try{console.log("💬 Obteniendo comentarios recientes");const r=await L(`/api/client-comments/recent?limit=${i}`,{method:"GET"});return console.log("✅ Comentarios recientes obtenidos:",r),r}catch(r){throw console.error("❌ Error obteniendo comentarios recientes:",r),r}},async getCommentsStats(){try{console.log("💬 Obteniendo estadísticas de comentarios");const i=await L("/api/client-comments/stats",{method:"GET"});return console.log("✅ Estadísticas obtenidas:",i),i}catch(i){throw console.error("❌ Error obteniendo estadísticas:",i),i}}},Ls=({companyId:i})=>{const[r,t]=h.useState(""),[E,f]=h.useState(!1),v=h.useRef(null),c=xe(),{user:z}=ss(),m=as(),{data:g,isLoading:u}=K(["client-comments",i],()=>me.getCommentsByCompany(i),{refetchInterval:1e4,onSuccess:()=>{me.markCommentsAsRead(i)}}),l=(g==null?void 0:g.comments)||[],y=ae(({companyId:n,comment:w})=>me.createComment(n,w),{onSuccess:()=>{t(""),c.invalidateQueries(["client-comments",i]),alert("✅ Comentario agregado exitosamente")},onError:n=>{console.error("Error creando comentario:",n),alert("❌ Error al enviar comentario")}}),b=()=>{var n;(n=v.current)==null||n.scrollIntoView({behavior:"smooth"})};h.useEffect(()=>{b()},[l]),h.useEffect(()=>{if(m&&m.on){const n=w=>{w.company_id===i&&c.invalidateQueries(["client-comments",i])};return m.on("new_client_comment",n),()=>{m.off("new_client_comment",n)}}},[m,i,c]);const d=n=>{n.preventDefault(),r.trim()&&!y.isLoading&&y.mutate({companyId:i,comment:r.trim()})},T=n=>{const w=new Date(n),R=(new Date-w)/(1e3*60*60);return R<1?"Hace unos minutos":R<24?`Hace ${Math.floor(R)} horas`:R<48?"Ayer":w.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})},s=(n,w)=>{const D=n?n.charAt(0).toUpperCase():"U",R=w?w.charAt(0).toUpperCase():"";return D+R},p=n=>{switch(n){case"admin":return"#dc3545";case"comercial":return"#28a745";case"vendedor":return"#007bff";case"soporte":return"#ffc107";default:return"#6c757d"}};return u?e.jsxs("div",{className:"client-chat-container",children:[e.jsxs("div",{className:"chat-header",children:[e.jsx(q,{className:"chat-icon"}),e.jsx("h3",{children:"Comentarios del Cliente"})]}),e.jsxs("div",{className:"chat-loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Cargando comentarios..."})]})]}):e.jsxs("div",{className:"client-chat-container",children:[e.jsxs("div",{className:"chat-header",children:[e.jsx(q,{className:"chat-icon"}),e.jsx("h3",{children:"Comentarios del Cliente"}),e.jsxs("span",{className:"comment-count",children:[l.length," comentarios"]})]}),e.jsxs("div",{className:"chat-messages",children:[l.length===0?e.jsxs("div",{className:"no-comments",children:[e.jsx(q,{className:"no-comments-icon"}),e.jsx("p",{children:"No hay comentarios aún"}),e.jsx("small",{children:"Sé el primero en comentar sobre este cliente"})]}):l.map(n=>e.jsxs("div",{className:`message ${n.user_id===z.id?"own-message":"other-message"}`,children:[e.jsx("div",{className:"message-avatar",children:n.user_name?e.jsx("div",{className:"avatar-circle",style:{backgroundColor:p(n.user_role)},children:s(n.user_name,n.user_apellido)}):e.jsx(I,{className:"avatar-icon"})}),e.jsxs("div",{className:"message-content",children:[e.jsxs("div",{className:"message-header",children:[e.jsx("span",{className:"user-name",children:n.user_name&&n.user_apellido?`${n.user_name} ${n.user_apellido}`:n.user_name||"Usuario"}),e.jsx("span",{className:"user-role",style:{color:p(n.user_role)},children:n.user_role}),e.jsxs("span",{className:"message-time",children:[e.jsx(B,{className:"time-icon"}),T(n.created_at)]})]}),e.jsx("div",{className:"message-text",children:n.comment}),n.is_system&&e.jsxs("div",{className:"system-message-badge",children:[e.jsx(_e,{className:"system-icon"}),"Mensaje del sistema"]})]})]},n.id)),e.jsx("div",{ref:v})]}),e.jsxs("form",{className:"chat-input-form",onSubmit:d,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("textarea",{value:r,onChange:n=>t(n.target.value),placeholder:"Escribe un comentario sobre este cliente...",className:"comment-input",rows:"2",disabled:y.isLoading}),e.jsx("button",{type:"submit",className:"send-button",disabled:!r.trim()||y.isLoading,children:e.jsx(pe,{className:"send-icon"})})]}),y.isLoading&&e.jsxs("div",{className:"sending-indicator",children:[e.jsx("div",{className:"spinner small"}),e.jsx("span",{children:"Enviando..."})]})]})]})},Os={nuevo:{label:"Nuevo",variant:"primary",icon:B},cotizacion_enviada:{label:"Cotización Enviada",variant:"info",icon:pe},pendiente_cotizacion:{label:"Pendiente de Cotización",variant:"warning",icon:B},en_negociacion:{label:"En Negociación",variant:"secondary",icon:q},seguimiento:{label:"Seguimiento",variant:"info",icon:rs},ganado:{label:"Ganado",variant:"success",icon:se},perdido:{label:"Perdido",variant:"danger",icon:H},activo:{label:"Activo",variant:"success",icon:se},completado:{label:"Completado",variant:"primary",icon:se},pausado:{label:"Pausado",variant:"warning",icon:B},cancelado:{label:"Cancelado",variant:"danger",icon:H}},$s=({show:i,onHide:r,clientId:t,clientName:E})=>{const{data:f,isLoading:v,error:c}=K(["clientHistory",t],()=>xs(t),{enabled:i&&!!t,staleTime:3e5}),z=(l,y="quote")=>{const b=Os[l]||{label:l,variant:"secondary",icon:le},d=b.icon;return e.jsxs($,{bg:b.variant,className:"d-flex align-items-center gap-1",children:[e.jsx(d,{size:12}),b.label]})},m=l=>new Date(l).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"}),g=l=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(l);if(v)return e.jsxs(N,{show:i,onHide:r,size:"xl",children:[e.jsx(N.Header,{closeButton:!0,children:e.jsxs(N.Title,{children:["Historial de ",E]})}),e.jsx(N.Body,{className:"text-center",children:e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})})})]});if(c)return e.jsxs(N,{show:i,onHide:r,size:"xl",children:[e.jsx(N.Header,{closeButton:!0,children:e.jsxs(N.Title,{children:["Historial de ",E]})}),e.jsx(N.Body,{children:e.jsxs("div",{className:"alert alert-danger",children:["Error al cargar el historial: ",c.message]})})]});const u=(f==null?void 0:f.data)||{quotes:[],projects:[],manager:null,stats:{}};return e.jsxs(N,{show:i,onHide:r,size:"xl",children:[e.jsx(N.Header,{closeButton:!0,children:e.jsxs(N.Title,{children:[e.jsx(ts,{className:"me-2"}),"Historial de ",E]})}),e.jsxs(N.Body,{children:[u.manager&&e.jsx(W,{className:"mb-4",children:e.jsx(W.Body,{children:e.jsxs(he,{children:[e.jsxs(O,{md:6,children:[e.jsxs("h6",{children:[e.jsx(I,{className:"me-2"}),"Gestor Actual"]}),e.jsx("p",{className:"mb-1",children:e.jsx("strong",{children:u.manager.name})}),e.jsx("p",{className:"mb-1 text-muted",children:u.manager.role}),e.jsx("p",{className:"mb-0 text-muted",children:u.manager.email})]}),e.jsxs(O,{md:6,children:[e.jsx("h6",{children:"Estadísticas"}),e.jsxs(he,{children:[e.jsx(O,{xs:6,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-primary mb-0",children:u.stats.totalQuotes}),e.jsx("small",{className:"text-muted",children:"Cotizaciones"})]})}),e.jsx(O,{xs:6,children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"text-success mb-0",children:u.stats.totalProjects}),e.jsx("small",{className:"text-muted",children:"Proyectos"})]})})]})]})]})})}),e.jsxs(Ss,{defaultActiveKey:"quotes",className:"mb-3",children:[e.jsx(ce,{eventKey:"quotes",title:e.jsxs("span",{children:[e.jsx(le,{className:"me-1"}),"Cotizaciones (",u.quotes.length,")"]}),children:u.quotes.length>0?e.jsxs(ke,{responsive:!0,striped:!0,hover:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Creado por"}),e.jsx("th",{children:"Fecha Creación"}),e.jsx("th",{children:"Última Actualización"})]})}),e.jsx("tbody",{children:u.quotes.map(l=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:["#",l.id]})}),e.jsxs("td",{children:[e.jsx(ns,{className:"me-1"}),g(l.total)]}),e.jsx("td",{children:z(l.status,"quote")}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{children:l.created_by_name}),e.jsx("small",{className:"text-muted",children:l.created_by_role})]})}),e.jsxs("td",{children:[e.jsx(Z,{className:"me-1"}),m(l.created_at)]}),e.jsxs("td",{children:[e.jsx(Z,{className:"me-1"}),m(l.updated_at)]})]},l.id))})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(le,{size:48,className:"text-muted mb-3"}),e.jsx("p",{className:"text-muted",children:"No hay cotizaciones registradas para este cliente"})]})}),e.jsx(ce,{eventKey:"projects",title:e.jsxs("span",{children:[e.jsx(A,{className:"me-1"}),"Proyectos (",u.projects.length,")"]}),children:u.projects.length>0?e.jsxs(ke,{responsive:!0,striped:!0,hover:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Creado por"}),e.jsx("th",{children:"Fecha Creación"}),e.jsx("th",{children:"Última Actualización"})]})}),e.jsx("tbody",{children:u.projects.map(l=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:["#",l.id]})}),e.jsxs("td",{children:[e.jsx(A,{className:"me-1"}),l.name]}),e.jsx("td",{children:z(l.status,"project")}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{children:l.created_by_name}),e.jsx("small",{className:"text-muted",children:l.created_by_role})]})}),e.jsxs("td",{children:[e.jsx(Z,{className:"me-1"}),m(l.created_at)]}),e.jsxs("td",{children:[e.jsx(Z,{className:"me-1"}),m(l.updated_at)]})]},l.id))})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(A,{size:48,className:"text-muted mb-3"}),e.jsx("p",{className:"text-muted",children:"No hay proyectos registrados para este cliente"})]})}),e.jsx(ce,{eventKey:"comments",title:e.jsxs("span",{children:[e.jsx(q,{className:"me-1"}),"Comentarios"]}),children:e.jsx(Ls,{companyId:t})})]})]}),e.jsx(N.Footer,{children:e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:r,children:"Cerrar"})})]})},De={id:null,type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:"",city:"",sector:""};function ca(){var Se,Ee;const[i,r]=h.useState(!1),[t,E]=h.useState(null),[f,v]=h.useState(null),[c,z]=h.useState(!1),[m,g]=h.useState(null),[u,l]=h.useState(!1),[y,b]=h.useState({}),d=Es(),T=ws(),s=zs(),p=Ts(),n=ks(),w=Ds();te.useEffect(()=>{Rs()},[]);const[D,R]=h.useState(1),[J,C]=h.useState(""),[F,re]=h.useState(""),[_,G]=h.useState(""),[je,Pe]=h.useState(""),[Ie,ge]=h.useState(!1),ie=xe(),fe=is(),{data:k,isLoading:Ae,refetch:qs}=K(["clients",D,J,F,_,je],()=>fs({page:D,limit:20,search:J,type:F,city:_,sector:je}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:S,isLoading:Y,error:Bs}=K(["clientStats"],bs,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4});te.useEffect(()=>{S&&S.data&&console.log("✅ Estadísticas cargadas correctamente:",{total:S.data.total,empresas:S.data.empresas,personas:S.data.personas})},[S]);const{data:Q,isLoading:Hs}=K(["clientFilterOptions"],Ns,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:6e4,cacheTime:3e5}),oe=a=>{ie.invalidateQueries("clients"),ie.invalidateQueries("clientStats"),ie.invalidateQueries("clientFilterOptions"),r(!1),E(null),v(null)},Me=a=>{console.log("🔍 handleSearch - Búsqueda:",a),C(a),R(1),ge(!0),setTimeout(()=>ge(!1),1e3)},Le=a=>{console.log("🔍 handleFilter - Filtros:",a),re(a.type||""),G(a.city||""),Pe(a.sector||""),R(1)},Oe=h.useMemo(()=>{var a,o,j;return Q?[{title:"Por Tipo de Cliente",options:((a=Q.types)==null?void 0:a.map(x=>({label:`${x.label} (${x.count})`,filter:{type:x.value}})))||[]},{title:"Por Sector",options:((o=Q.sectors)==null?void 0:o.map(x=>({label:`${x.label} (${x.count})`,filter:{sector:x.value}})))||[]},{title:"Por Ciudad",options:((j=Q.cities)==null?void 0:j.map(x=>({label:`${x.label} (${x.count})`,filter:{city:x.value}})))||[]}]:[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona"}}]}]},[Q]),be=ae(ps,{onSuccess:()=>oe(),onError:a=>{console.error("Error creating client:",a),console.error("Error details:",{message:a.message,status:a.status,body:a.body})}}),Ne=ae(js,{onSuccess:()=>oe(),onError:a=>console.error("Error updating client:",a)}),ve=ae(gs,{onSuccess:()=>oe(),onError:a=>console.error("Error deleting client:",a)}),$e=()=>{if(!T){b({action:"crear clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(d==null?void 0:d.role)||"no autenticado"}),l(!0);return}E(De),r(!0)},ye=a=>{if(!s){b({action:"editar clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(d==null?void 0:d.role)||"no autenticado"}),l(!0);return}E(a),r(!0)},Ce=a=>{if(console.log("🔍 handleDelete - Verificando permisos:",{userCanDeleteClient:p,currentUserRole:d==null?void 0:d.role,currentUser:d}),!p){console.log("🚫 handleDelete - Permisos insuficientes, mostrando modal"),b({action:"eliminar clientes",requiredRole:"administrador",currentRole:(d==null?void 0:d.role)||"no autenticado"}),l(!0);return}console.log("✅ handleDelete - Permisos OK, procediendo con eliminación"),v(a)},qe=async()=>{try{await ve.mutateAsync(f.id),v(null)}catch(a){console.error("Error eliminando cliente:",a),v(null)}},Be=a=>{if(!w){b({action:"crear cotizaciones",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(d==null?void 0:d.role)||"no autenticado"}),l(!0);return}fe("/cotizaciones/inteligente",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city,ruc:a.ruc,dni:a.dni,email:a.email,phone:a.phone,contact_name:a.contact_name,address:a.address}}})},He=a=>{if(!n){b({action:"ver historial de clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(d==null?void 0:d.role)||"no autenticado"}),l(!0);return}g(a),z(!0)},Ge=(a,o)=>{console.log(`Estado del cliente ${a} cambiado a: ${o}`)},Qe=async a=>{t.id?await Ne.mutateAsync({id:t.id,...a}):await be.mutateAsync(a)},Ue=a=>{const j={empresa:{bg:"primary",text:"Empresa",icon:A},persona:{bg:"info",text:"Persona Natural",icon:I}}[a]||{bg:"secondary",text:a,icon:I},x=j.icon;return e.jsxs($,{bg:j.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(x,{size:12,className:"me-1"}),j.text]})},Ve=[{header:"ID",accessor:"id",width:"50px"},{header:"Cliente",accessor:"name",width:"180px",render:(a,o)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:o.name}),e.jsxs("div",{className:"d-flex align-items-center gap-1 mt-1",children:[Ue(o.type),o.ruc&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["RUC: ",o.ruc]}),o.dni&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["DNI: ",o.dni]})]})]})},{header:"Contacto",accessor:"contact",width:"150px",render:(a,o)=>e.jsxs("div",{children:[o.contact_name&&e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:o.contact_name}),o.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(ne,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:o.email})]}),o.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(Fe,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:o.phone})]})]})},{header:"Ciudad",accessor:"city",width:"80px",render:a=>{const o=a||"No especificada";let j="secondary";switch(o){case"Lima":j="primary";break;case"Arequipa":j="info";break;case"Cusco":j="success";break;case"Trujillo":j="warning";break;case"Piura":j="danger";break;case"Chiclayo":j="info";break;case"Iquitos":j="success";break;case"Huancayo":j="warning";break;default:j="secondary"}return e.jsx($,{bg:j,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:o})}},{header:"Sector",accessor:"sector",width:"80px",render:a=>{const j=(M=>M&&M.replace(/\s*\[PRIORIDAD:\s*\w+\]/g,"").trim()||"General")(a);let x="secondary";switch(j){case"Construcción":x="warning";break;case"Minería":x="dark";break;case"Ingeniería":x="primary";break;case"Laboratorio":x="info";break;case"Consultoría":x="success";break;case"Tecnología":x="primary";break;case"Ambiental":x="success";break;case"Geología":x="info";break;default:x="secondary"}return e.jsx($,{bg:x,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:j})}},{header:"Estado",accessor:"status",width:"120px",render:(a,o)=>e.jsx(Ms,{clientId:o.id,currentStatus:o.status||"prospeccion",onStatusChange:j=>Ge(o.id,j),size:"sm",showLabel:!0})},{header:"Prioridad",accessor:"priority",width:"100px",render:(a,o)=>{const x=(X=>X?X.includes("[PRIORIDAD: URGENTE]")?"urgent":X.includes("[PRIORIDAD: ALTA]")?"high":X.includes("[PRIORIDAD: BAJA]")?"low":"normal":"normal")(o.sector);let M="secondary",V="Normal";switch(x){case"urgent":M="danger",V="Urgente";break;case"high":M="warning",V="Alta";break;case"normal":M="info",V="Normal";break;case"low":M="secondary",V="Baja";break}return e.jsx($,{bg:M,className:"px-2 py-1",style:{fontSize:"0.7rem"},children:V})}},{header:"Gestor",accessor:"managed_by",width:"100px",render:(a,o)=>e.jsx("div",{className:"d-flex align-items-center",children:o.managed_by_name?e.jsxs(e.Fragment,{children:[e.jsx(Re,{size:12,className:"me-1 text-success"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:o.managed_by_name}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:o.managed_by_role})]})]}):e.jsx("span",{className:"text-muted",style:{fontSize:"0.8rem"},children:"Sin asignar"})})},{header:"Dirección",accessor:"address",width:"120px",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(ue,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin dirección"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,o)=>e.jsxs("div",{className:"d-flex gap-1",children:[s&&e.jsx(P,{variant:"outline-primary",size:"sm",onClick:()=>ye(o),title:"Editar cliente",children:e.jsx(cs,{size:14})}),n&&e.jsx(P,{variant:"outline-info",size:"sm",onClick:()=>He(o),title:"Ver historial de cotizaciones y proyectos",children:e.jsx(B,{size:14})}),w&&e.jsx(P,{variant:"outline-success",size:"sm",onClick:()=>Be(o),title:"Crear cotización para este cliente",children:e.jsx(ds,{size:14})}),p&&e.jsx(P,{variant:"outline-danger",size:"sm",onClick:()=>Ce(o),title:"Eliminar cliente",children:e.jsx(Te,{size:14})}),!p&&e.jsx(P,{variant:"outline-secondary",size:"sm",onClick:()=>{console.log("🚫 Botón eliminar clickeado sin permisos"),b({action:"eliminar clientes",requiredRole:"administrador",currentRole:(d==null?void 0:d.role)||"no autenticado"}),l(!0)},title:"No tienes permisos para eliminar clientes",children:e.jsx(Te,{size:14})})]})}],U=h.useMemo(()=>{if(S&&S.data)return console.log("📊 Stats - Usando estadísticas reales del backend:",S),console.log("📊 Stats - Datos extraídos:",S.data),{total:S.data.total||0,empresas:S.data.empresas||0,personas:S.data.personas||0,conEmail:S.data.withEmail||0,conTelefono:S.data.withPhone||0};const a=(k==null?void 0:k.data)||[];return console.log("📊 Stats - Fallback: calculando desde página actual:",a),{total:a.length,empresas:a.filter(o=>o.type==="empresa").length,personas:a.filter(o=>o.type==="persona").length,conEmail:a.filter(o=>o.email).length,conTelefono:a.filter(o=>o.phone).length}},[S,k]);return e.jsx("div",{className:"clientes-page",children:e.jsxs(Cs,{fluid:!0,className:"h-100 d-flex flex-column p-0",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"mb-0 fw-bold",children:"Gestión de Clientes"}),e.jsx("small",{className:"text-muted",children:"Crear, editar y gestionar clientes del sistema"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[(d==null?void 0:d.role)==="admin"&&e.jsxs(P,{variant:"outline-success",size:"sm",onClick:()=>fe("/clientes/importar"),title:"Importar clientes desde archivo CSV",children:[e.jsx(os,{className:"me-1"}),"Importar Clientes"]}),e.jsxs(P,{variant:"primary",size:"sm",onClick:$e,disabled:!T,title:T?"Crear nuevo cliente":`No tienes permisos para crear clientes. Rol actual: ${(d==null?void 0:d.role)||"No autenticado"}`,children:[e.jsx(ls,{className:"me-1"}),"Nuevo Cliente"]})]})]}),!T&&e.jsx("div",{className:"alert alert-warning py-1 mb-1",role:"alert",children:e.jsxs("small",{children:[e.jsx("strong",{children:"⚠️ Permisos insuficientes:"})," Tu rol actual (",(d==null?void 0:d.role)||"No autenticado",") no tiene permisos para crear clientes."]})}),e.jsxs(he,{className:"g-2 mb-3",children:[e.jsx(O,{md:6,lg:3,children:e.jsx(ee,{title:"Total",value:U.total,icon:ze,color:"primary",loading:Y,size:"compact"})}),e.jsx(O,{md:6,lg:3,children:e.jsx(ee,{title:"Empresas",value:U.empresas,icon:A,color:"success",loading:Y,size:"compact"})}),e.jsx(O,{md:6,lg:3,children:e.jsx(ee,{title:"Personas",value:U.personas,icon:I,color:"info",loading:Y,size:"compact"})}),e.jsx(O,{md:6,lg:3,children:e.jsx(ee,{title:"Con Email",value:U.conEmail,icon:ne,color:"warning",loading:Y,size:"compact"})})]}),e.jsxs(W,{className:"shadow-sm border-0 flex-grow-1 d-flex flex-column",children:[e.jsx(W.Header,{className:"bg-white border-bottom flex-shrink-0 py-2",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx(ze,{className:"me-1 text-primary",size:16}),"Lista de Clientes"]}),e.jsxs($,{bg:"light",text:"dark",className:"px-2 py-1",children:[U.total," clientes"]})]})}),e.jsx(W.Body,{className:"p-0 flex-grow-1 d-flex flex-column",children:e.jsx("div",{className:"client-table flex-grow-1 d-flex flex-column",children:e.jsx(ms,{data:(k==null?void 0:k.data)||[],columns:Ve,loading:Ae||Ie,onEdit:ye,onDelete:Ce,emptyMessage:"No hay clientes registrados",totalItems:((Se=k==null?void 0:k.pagination)==null?void 0:Se.total)||0,itemsPerPage:((Ee=k==null?void 0:k.pagination)==null?void 0:Ee.limit)||20,currentPage:D,onPageChange:R,onSearch:Me,onFilter:Le,filterOptions:Oe,sortable:!1,useFlexbox:!0})})})]}),e.jsx(Is,{show:i,onHide:()=>r(!1),data:t||De,onSubmit:Qe,loading:be.isLoading||Ne.isLoading,isEditing:!!(t!=null&&t.id)}),e.jsx(us,{show:!!f,onHide:()=>v(null),onConfirm:qe,title:"Eliminar Cliente",message:`¿Estás seguro de que quieres eliminar el cliente "${f==null?void 0:f.name}"?`,confirmText:"Eliminar",variant:"danger",isLoading:ve.isLoading,alertMessage:"Esta acción eliminará permanentemente el cliente y todos sus datos asociados (proyectos, cotizaciones, etc.).",alertVariant:"danger"}),e.jsx($s,{show:c,onHide:()=>z(!1),clientId:m==null?void 0:m.id,clientName:m==null?void 0:m.name}),e.jsx(As,{show:u,onHide:()=>l(!1),action:y.action,requiredRole:y.requiredRole,currentRole:y.currentRole})]})})}export{ca as default};
//# sourceMappingURL=Clientes-DXeHpZfM.js.map
