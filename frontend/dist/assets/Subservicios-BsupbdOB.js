import{b as g,r as a,a as z,j as e}from"./index-o7c7tdkB.js";import{M as J}from"./ModuloBase-DpIJbQDg.js";import{T as U,a as Y}from"./Toolbar-Dgqueffs.js";import{T as Q}from"./Toast-BGeXl3a3.js";import{l as H}from"./services-JLHsCip8.js";import{F as P}from"./FloatingInput-DHjMLFBs.js";import{M as K}from"./Modal-M1gDWVxD.js";const V=(i,o={})=>{const r=new URLSearchParams(o).toString(),c=`/api/subservices/service/${i}`;return g(r?`${c}?${r}`:c)},W=i=>g("/api/subservices",{method:"POST",body:JSON.stringify(i)}),X=(i,o)=>g(`/api/subservices/${i}`,{method:"PUT",body:JSON.stringify(o)}),Z=i=>g(`/api/subservices/${i}`,{method:"DELETE"});function le(){var L;const[i,o]=a.useState([]),[r,c]=a.useState(""),[f,k]=a.useState([]),[M,T]=a.useState(0),[d,p]=a.useState(1),[A]=a.useState(10),[y,q]=a.useState(!1),[u,n]=a.useState({show:!1,variant:"success",message:""}),[$,b]=a.useState(!1),[N,D]=a.useState(""),[l,m]=a.useState({open:!1,id:null,name:""}),[w,I]=a.useState(""),[h,v]=a.useState({open:!1,row:null}),{user:S}=z(),x=["admin","jefe_laboratorio","jefa_comercial"].includes(S==null?void 0:S.role);a.useEffect(()=>{(async()=>{try{const s=await H({page:1,limit:200}),t=Array.isArray(s==null?void 0:s.data)?s.data:s||[];o(t),t.length&&c(String(t[0].id))}catch{}})()},[]);const j=async()=>{if(!r){k([]),T(0);return}try{q(!0);const s=await V(r,{page:d,limit:A,q:w||void 0}),t=Array.isArray(s==null?void 0:s.data)?s.data:(s==null?void 0:s.rows)||s||[];k(t),T((s==null?void 0:s.total)??t.length)}catch(s){n({show:!0,variant:"danger",message:s.message||"No se pudo cargar"})}finally{q(!1)}};a.useEffect(()=>{j()},[d,r,w]);const O=async s=>{s.preventDefault();try{if((f||[]).some(_=>String(_.name).trim().toLowerCase()===String(N).trim().toLowerCase())){n({show:!0,variant:"warning",message:"Ya existe un subservicio con ese nombre"});return}await W({service_id:r,name:N}),n({show:!0,variant:"success",message:"Subservicio creado"}),b(!1),D(""),j()}catch(t){n({show:!0,variant:"danger",message:t.message||"Error al crear"})}},C=Math.max(1,Math.ceil((M||0)/A)),R=s=>{m({open:!0,id:s.id,name:s.name||""})},B=async()=>{try{if((f||[]).some(t=>t.id!==l.id&&String(t.name).trim().toLowerCase()===String(l.name).trim().toLowerCase())){n({show:!0,variant:"warning",message:"Ya existe un subservicio con ese nombre"});return}await X(l.id,{name:l.name}),n({show:!0,variant:"success",message:"Subservicio actualizado"}),m({open:!1,id:null,name:""}),j()}catch(s){n({show:!0,variant:"danger",message:s.message||"Error al actualizar"})}},F=s=>v({open:!0,row:s}),G=async()=>{if(h.row)try{await Z(h.row.id),n({show:!0,variant:"success",message:"Subservicio eliminado"}),v({open:!1,row:null}),j()}catch(s){n({show:!0,variant:"danger",message:s.message||"Error al eliminar"})}},E=f||[];return e.jsxs(J,{titulo:"Gestión de Subservicios",descripcion:"Aquí podrás ver, crear, editar y eliminar subservicios asociados a un servicio.",children:[e.jsx(U,{left:e.jsxs("div",{className:"row g-2 w-100",children:[e.jsxs("div",{className:"col-sm-4",children:[e.jsx("label",{className:"form-label",children:"Servicio"}),e.jsx("select",{className:"form-select",value:r,onChange:s=>{c(s.target.value),p(1)},children:i.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{className:"col-sm-4",children:[e.jsx("label",{className:"form-label",children:"Buscar"}),e.jsx("input",{className:"form-control",placeholder:"Buscar por nombre",value:w,onChange:s=>I(s.target.value)})]})]}),right:e.jsx("button",{className:"btn btn-primary",onClick:()=>b(!0),disabled:!r||!x,children:"+ Agregar subservicio"})}),e.jsx("div",{className:"table-responsive mt-3",children:e.jsxs("table",{className:"table table-striped align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{style:{width:140},children:"Acciones"})]})}),e.jsxs("tbody",{children:[(E||[]).map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:s.name}),e.jsxs("td",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>R(s),disabled:!x,children:"Editar"}),e.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>F(s),disabled:!x,children:"Eliminar"})]})]},s.id)),(!E||E.length===0)&&!y&&e.jsx(Y,{colSpan:3,label:"Sin subservicios"})]})]})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted small",children:["Total: ",M]}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{className:"btn btn-outline-secondary",disabled:d<=1,onClick:()=>p(s=>Math.max(1,s-1)),children:"Anterior"}),e.jsxs("span",{className:"btn btn-outline-secondary disabled",children:[d,"/",C]}),e.jsx("button",{className:"btn btn-outline-secondary",disabled:d>=C,onClick:()=>p(s=>Math.min(C,s+1)),children:"Siguiente"})]})]}),$&&e.jsx("div",{className:"modal fade show",style:{display:"block"},children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Nuevo subservicio"}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>b(!1)})]}),e.jsxs("form",{onSubmit:O,children:[e.jsx("div",{className:"modal-body",children:e.jsx(P,{id:"subservice-name",label:"Nombre",value:N,onChange:s=>D(s.target.value),required:!0})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>b(!1),children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:y,children:y?"Guardando...":"Crear"})]})]})]})})}),l.open&&e.jsx("div",{className:"modal fade show",style:{display:"block"},children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Editar subservicio"}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>m({open:!1,id:null,name:""})})]}),e.jsx("div",{className:"modal-body",children:e.jsx(P,{id:"edit-subservice-name",label:"Nombre",value:l.name,onChange:s=>m(t=>({...t,name:s.target.value})),required:!0})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>m({open:!1,id:null,name:""}),children:"Cancelar"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:B,children:"Guardar"})]})]})})}),e.jsx(Q,{show:u.show,variant:u.variant,onClose:()=>n({...u,show:!1}),children:u.message}),e.jsxs(K,{open:h.open,onClose:()=>v({open:!1,row:null}),children:[e.jsx("h5",{children:"Confirmar eliminación"}),e.jsxs("p",{children:['¿Seguro que deseas eliminar el subservicio "',(L=h.row)==null?void 0:L.name,'"?']}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{className:"btn btn-outline-secondary",onClick:()=>v({open:!1,row:null}),children:"Cancelar"}),e.jsx("button",{className:"btn btn-danger",onClick:G,disabled:!x,children:"Eliminar"})]})]})]})}export{le as default};
//# sourceMappingURL=Subservicios-BsupbdOB.js.map
