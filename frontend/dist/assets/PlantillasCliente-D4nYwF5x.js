import{a as Q,r as t,b as C,j as e,C as F,B as l,o as P,t as W,F as z,v as X,Z as k,z as Y,A}from"./index-xQVByYRi.js";import{C as ee}from"./ConfirmModal-BQPT1yY0.js";import{S as G}from"./Spinner-C2jXaFYJ.js";import{A as se}from"./Alert-BijlR5uZ.js";import{R as u,C as o}from"./Row-mPOlevGM.js";import{C as i}from"./Col-Dz9zKzWQ.js";import{F as r}from"./Form-BAZkilfb.js";import{M as y}from"./Modal-BPoSYaBi.js";import"./ElementChildren-BP-7Da5j.js";const he=()=>{const{user:ae}=Q(),[B,M]=t.useState([]),[f,H]=t.useState([]),[w,x]=t.useState(!0),[q,d]=t.useState(null),[m,E]=t.useState({client:"",search:""}),[O,N]=t.useState(!1),[j,T]=t.useState(null),[p,b]=t.useState(null),[h,c]=t.useState({name:"",client_id:"",description:"",services:[{code:"",description:"",norm:"",unit_price:0,quantity:1}]});t.useEffect(()=>{g()},[]);const g=async()=>{try{x(!0),d(null);const s=await C("/api/templates/client");M(s||[]);const a=await C("/api/companies");H(a||[])}catch(s){console.error("Error fetching data:",s),d("Error al cargar los datos: "+(s.message||"Error desconocido"))}finally{x(!1)}},D=B.filter(s=>!(m.client&&s.client_id!==m.client||m.search&&!s.name.toLowerCase().includes(m.search.toLowerCase()))),_=(s=null)=>{s?(T(s),c({name:s.name,client_id:s.client_id,description:s.description,services:s.services||[{code:"",description:"",norm:"",unit_price:0,quantity:1}]})):(T(null),c({name:"",client_id:"",description:"",services:[{code:"",description:"",norm:"",unit_price:0,quantity:1}]})),N(!0)},R=async()=>{try{x(!0),d(null);const s=j?`/api/templates/${j.id}`:"/api/templates";await C(s,{method:j?"PUT":"POST",body:h}),N(!1),T(null),c({name:"",client_id:"",description:"",services:[{code:"",description:"",norm:"",unit_price:0,quantity:1}]}),await g()}catch(s){d("Error al guardar plantilla: "+(s.message||"Error desconocido"))}finally{x(!1)}},U=s=>{b(s)},$=async()=>{try{await C(`/api/templates/${p.id}`,{method:"DELETE"}),await g(),b(null)}catch(s){d("Error al eliminar plantilla: "+(s.message||"Error desconocido")),b(null)}},I=async s=>{try{x(!0),d(null);const a={...s,name:`${s.name} (Copia)`,id:void 0};await C("/api/templates",{method:"POST",body:a}),await g()}catch(a){d("Error al copiar plantilla: "+(a.message||"Error desconocido"))}finally{x(!1)}},J=s=>{const a=encodeURIComponent(JSON.stringify(s));window.location.href=`/cotizaciones/inteligente?template=${a}`},V=()=>{c(s=>({...s,services:[...s.services,{code:"",description:"",norm:"",unit_price:0,quantity:1}]}))},Z=s=>{h.services.length>1&&c(a=>({...a,services:a.services.filter((n,S)=>S!==s)}))},v=(s,a,n)=>{c(S=>({...S,services:S.services.map((L,K)=>K===s?{...L,[a]:n}:L)}))};return w?e.jsx(F,{className:"py-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(G,{animation:"border"}),e.jsx("p",{className:"mt-2",children:"Cargando plantillas..."})]})}):q?e.jsx(F,{className:"py-4",children:e.jsx(se,{variant:"danger",children:q})}):e.jsxs(F,{className:"py-4",children:[e.jsxs(u,{className:"mb-4",children:[e.jsxs(i,{children:[e.jsx("h2",{children:"📋 Plantillas por Cliente"}),e.jsx("p",{className:"text-muted",children:"Guarda y reutiliza cotizaciones por cliente"})]}),e.jsx(i,{md:"auto",children:e.jsxs(l,{variant:"primary",onClick:()=>_(),children:[e.jsx(P,{className:"me-2"}),"Nueva Plantilla"]})})]}),e.jsxs(u,{className:"mb-4",children:[e.jsx(i,{md:4,children:e.jsxs(r.Select,{value:m.client,onChange:s=>E(a=>({...a,client:s.target.value})),children:[e.jsx("option",{value:"",children:"Todos los clientes"}),Array.isArray(f)&&f.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx(i,{md:4,children:e.jsx(r.Control,{type:"text",placeholder:"Buscar plantilla...",value:m.search,onChange:s=>E(a=>({...a,search:s.target.value}))})}),e.jsx(i,{md:4,children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(l,{variant:"outline-secondary",onClick:g,children:[e.jsx(W,{className:"me-2"}),"Actualizar"]}),e.jsx(l,{variant:"outline-secondary",onClick:()=>E({client:"",search:""}),children:"Limpiar"})]})})]}),e.jsx(u,{children:D.length===0?e.jsx(i,{children:e.jsx(o,{children:e.jsxs(o.Body,{className:"text-center py-5",children:[e.jsx(z,{size:48,className:"text-muted mb-3"}),e.jsx("h5",{children:"No hay plantillas"}),e.jsx("p",{className:"text-muted",children:Object.values(m).some(s=>s)?"No se encontraron plantillas con los filtros aplicados":"No tienes plantillas guardadas"}),e.jsxs(l,{variant:"primary",onClick:()=>_(),children:[e.jsx(P,{className:"me-2"}),"Crear Primera Plantilla"]})]})})}):D.map(s=>{var a;return e.jsx(i,{md:6,lg:4,className:"mb-3",children:e.jsxs(o,{children:[e.jsxs(o.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:s.name}),e.jsx(X,{bg:"info",children:s.client_name})]}),e.jsxs(o.Body,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Cliente:"})," ",s.client_name||"N/A"]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Descripción:"})," ",s.description||"Sin descripción"]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Servicios:"})," ",((a=s.services)==null?void 0:a.length)||0]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Creada:"})," ",new Date(s.created_at).toLocaleDateString()]}),e.jsxs("div",{className:"d-flex gap-2 mt-3",children:[e.jsxs(l,{variant:"success",size:"sm",onClick:()=>J(s),children:[e.jsx(k,{className:"me-1"}),"Usar"]}),e.jsxs(l,{variant:"outline-primary",size:"sm",onClick:()=>_(s),children:[e.jsx(Y,{className:"me-1"}),"Editar"]}),e.jsxs(l,{variant:"outline-secondary",size:"sm",onClick:()=>I(s),children:[e.jsx(k,{className:"me-1"}),"Copiar"]}),e.jsx(l,{variant:"outline-danger",size:"sm",onClick:()=>U(s),children:e.jsx(A,{className:"me-1"})})]})]})]})},s.id)})}),e.jsxs(y,{show:O,onHide:()=>N(!1),size:"lg",children:[e.jsx(y.Header,{closeButton:!0,children:e.jsx(y.Title,{children:j?"Editar Plantilla":"Nueva Plantilla"})}),e.jsxs(y.Body,{children:[e.jsxs(u,{children:[e.jsx(i,{md:6,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Nombre de la Plantilla *"}),e.jsx(r.Control,{type:"text",value:h.name,onChange:s=>c(a=>({...a,name:s.target.value})),required:!0})]})}),e.jsx(i,{md:6,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Cliente *"}),e.jsxs(r.Select,{value:h.client_id,onChange:s=>c(a=>({...a,client_id:s.target.value})),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar cliente"}),Array.isArray(f)&&f.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})})]}),e.jsx(u,{children:e.jsx(i,{children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Descripción"}),e.jsx(r.Control,{as:"textarea",rows:3,value:h.description,onChange:s=>c(a=>({...a,description:s.target.value}))})]})})}),e.jsx("h6",{children:"Servicios de la Plantilla:"}),h.services.map((s,a)=>e.jsxs(o,{className:"mb-3",children:[e.jsxs(o.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{children:["Servicio ",a+1]}),h.services.length>1&&e.jsx(l,{variant:"outline-danger",size:"sm",onClick:()=>Z(a),children:e.jsx(A,{})})]}),e.jsxs(o.Body,{children:[e.jsxs(u,{children:[e.jsx(i,{md:3,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Código"}),e.jsx(r.Control,{type:"text",value:s.code,onChange:n=>v(a,"code",n.target.value)})]})}),e.jsx(i,{md:6,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Descripción *"}),e.jsx(r.Control,{type:"text",value:s.description,onChange:n=>v(a,"description",n.target.value),required:!0})]})}),e.jsx(i,{md:3,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Norma"}),e.jsx(r.Control,{type:"text",value:s.norm,onChange:n=>v(a,"norm",n.target.value)})]})})]}),e.jsxs(u,{children:[e.jsx(i,{md:4,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Precio Unitario (S/) *"}),e.jsx(r.Control,{type:"number",step:"0.01",value:s.unit_price,onChange:n=>v(a,"unit_price",parseFloat(n.target.value)||0),required:!0})]})}),e.jsx(i,{md:4,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Cantidad *"}),e.jsx(r.Control,{type:"number",value:s.quantity,onChange:n=>v(a,"quantity",parseInt(n.target.value)||1),required:!0})]})}),e.jsx(i,{md:4,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Subtotal (S/)"}),e.jsx(r.Control,{type:"text",value:(s.unit_price*s.quantity).toFixed(2),readOnly:!0})]})})]})]})]},a)),e.jsxs(l,{variant:"outline-primary",onClick:V,children:[e.jsx(P,{className:"me-2"}),"Agregar Servicio"]})]}),e.jsxs(y.Footer,{children:[e.jsx(l,{variant:"secondary",onClick:()=>N(!1),children:"Cancelar"}),e.jsx(l,{variant:"success",onClick:R,disabled:w,children:w?e.jsxs(e.Fragment,{children:[e.jsx(G,{size:"sm",className:"me-2"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"me-2"}),j?"Actualizar":"Crear"," Plantilla"]})})]})]}),e.jsx(ee,{show:!!p,onHide:()=>b(null),onConfirm:$,title:"Eliminar Plantilla",message:`¿Estás seguro de que quieres eliminar la plantilla "${p==null?void 0:p.name}"?`,confirmText:"Eliminar",variant:"danger",alertMessage:"Esta acción eliminará permanentemente la plantilla y no se puede deshacer.",alertVariant:"warning"})]})};export{he as default};
//# sourceMappingURL=PlantillasCliente-D4nYwF5x.js.map
