import{b as Q,c as $,d as H,e as D,u as B,a as O,r as z,F as b,f as j,g as f,h as T,j as e,i as g,k as C,B as A,l as P,m as L}from"./index-Bcrgukx7.js";import{P as V}from"./PageHeader-BXdzGOF9.js";import{S as w}from"./StatsCard-Bg6TicJV.js";import{R as E}from"./Row-B5ljKXp5.js";import{C as d}from"./Col-C5Zwr_ej.js";import{C as r}from"./Card-C96hNOBG.js";import"./Spinner-jUAz7otr.js";const G=()=>Q("/api/role-dashboard/stats"),X=(a={})=>{const t=new URLSearchParams(a).toString(),i=t?`/api/activities/recent?${t}`:"/api/activities/recent";return Q(i)},J=(a={})=>{var N,k,v,_;const t=$(),{limit:i=4,refetchInterval:n=3e5,staleTime:y=6e4,enabled:x=!0,userId:u=null,role:h=null}=a;H({onNewNotification:c=>{c.type&&(c.type.includes("quote")||c.type.includes("project")||c.type.includes("ticket")||c.type.includes("evidence")||c.type.includes("user")||c.type.includes("client"))&&t.invalidateQueries(["recentActivities"])},onUnreadCountUpdate:()=>{t.invalidateQueries(["recentActivities"])}});const l=D(["recentActivities",{limit:i,userId:u,role:h}],()=>X({limit:i,userId:u,role:h}),{enabled:x,refetchInterval:n,staleTime:y,refetchOnWindowFocus:!0,refetchOnMount:!0,retry:2,retryDelay:5e3,cacheTime:3e5,networkMode:"online",onError:c=>{console.warn("Error loading activities:",c)}});return{...l,refreshActivities:()=>{t.invalidateQueries(["recentActivities"])},getCachedActivities:()=>t.getQueryData(["recentActivities",{limit:i}]),hasActivities:((k=(N=l.data)==null?void 0:N.activities)==null?void 0:k.length)>0,activitiesCount:((_=(v=l.data)==null?void 0:v.activities)==null?void 0:_.length)||0,isOptimized:!0,lastFetch:l.dataUpdatedAt,nextFetch:l.dataUpdatedAt+n}},R=()=>{console.log("üîç DEBUG: Verificando autenticaci√≥n...");const a=localStorage.getItem("token");if(console.log("üîë Token en localStorage:",a?`${a.substring(0,50)}...`:"NO ENCONTRADO"),a)try{const i=JSON.parse(atob(a.split(".")[1]));console.log("üë§ Usuario del token:",i),console.log("‚è∞ Token expira en:",new Date(i.exp*1e3))}catch(i){console.error("‚ùå Error decodificando token:",i)}const t="http://localhost:4000/api";return console.log("üåê API URL configurada:",t),{hasToken:!!a,token:a,apiUrl:t}},W=async()=>{console.log("üß™ Probando conexi√≥n con backend...");try{const a=await fetch("/api/dashboard/stats",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(console.log("üì° Respuesta del backend:",a.status,a.statusText),a.ok){const t=await a.json();return console.log("üìä Datos del dashboard:",t),t}else{const t=await a.text();return console.error("‚ùå Error del backend:",t),null}}catch(a){return console.error("‚ùå Error de conexi√≥n:",a),null}},Y=()=>R().hasToken?(console.log("‚úÖ Token encontrado, verificando validez..."),!0):(console.log("üö® PROBLEMA: No hay token de autenticaci√≥n"),console.log("üí° SOLUCI√ìN: El usuario necesita iniciar sesi√≥n"),!1),ie=()=>{var c,M,F,q,S;const a=B(),{user:t}=O();z.useEffect(()=>{if(t!=null&&t.role)switch(t.role){case"vendedor_comercial":a("/dashboards/vendedor-comercial",{replace:!0});break;case"jefa_comercial":a("/dashboards/jefa-comercial",{replace:!0});break;case"jefe_laboratorio":case"usuario_laboratorio":a("/dashboards/laboratorio",{replace:!0});break;case"facturacion":a("/dashboards/facturacion",{replace:!0});break;case"soporte":a("/dashboards/soporte",{replace:!0});break;case"gerencia":case"admin":a("/dashboards/gerencia",{replace:!0});break}},[t,a]),z.useEffect(()=>{console.log("üîç Dashboard: Verificando autenticaci√≥n..."),R(),Y(),W().then(s=>{console.log(s?"‚úÖ Dashboard: Conexi√≥n con backend exitosa":"‚ùå Dashboard: Error en conexi√≥n con backend")})},[]);const{data:i,isLoading:n,error:y}=D(["dashboardStats"],G,{refetchInterval:3e5,staleTime:6e4,onSuccess:s=>{console.log("‚úÖ Dashboard: Datos recibidos del backend:",s)},onError:s=>{console.error("‚ùå Dashboard: Error obteniendo datos:",s)}}),{data:x,isLoading:u,activitiesCount:h,refreshActivities:l}=J({limit:4,refetchInterval:3e5,staleTime:6e4,userId:t==null?void 0:t.id,role:t==null?void 0:t.role}),o=i?{totalUsers:parseInt(i.totalUsers)||0,totalProjects:parseInt(i.totalProjects)||0,totalQuotes:parseInt(i.totalQuotes)||0,totalTickets:parseInt(i.totalTickets)||0,activeProjects:parseInt(i.activeProjects)||0,pendingQuotes:parseInt(i.pendingQuotes)||0,openTickets:parseInt(i.openTickets)||0,completedProjects:parseInt(i.completedProjects)||0,totalClients:parseInt(i.totalClients)||0,totalEvidences:parseInt(i.totalEvidences)||0,activeUsersThisMonth:parseInt(i.activeUsersThisMonth)||0,quotesThisMonth:parseInt(i.quotesThisMonth)||0,ticketsThisMonth:parseInt(i.ticketsThisMonth)||0,changePercentages:{users:0,projects:0,quotes:0,tickets:0}}:{totalUsers:0,totalProjects:0,totalQuotes:0,totalTickets:0,activeProjects:0,pendingQuotes:0,openTickets:0,completedProjects:0,totalClients:0,totalEvidences:0,activeUsersThisMonth:0,quotesThisMonth:0,ticketsThisMonth:0,changePercentages:{users:0,projects:0,quotes:0,tickets:0}};z.useEffect(()=>{console.log("üìä Dashboard: Estado de los datos:"),console.log("- isLoading:",n),console.log("- error:",y),console.log("- data:",i),console.log("- stats procesados:",o),console.log("- totalUsers:",o.totalUsers,typeof o.totalUsers),console.log("- totalProjects:",o.totalProjects,typeof o.totalProjects),console.log("- totalQuotes:",o.totalQuotes,typeof o.totalQuotes),console.log("- totalTickets:",o.totalTickets,typeof o.totalTickets)},[n,y,i,o]);const I=s=>{const m=new Date,U=new Date(s),p=Math.floor((m-U)/(1e3*60));return p<1?"Ahora":p<60?`Hace ${p} min`:p<1440?`Hace ${Math.floor(p/60)} h`:`Hace ${Math.floor(p/1440)} d√≠as`},N=s=>({quote_created:b,quote_assigned:b,quote_approved:j,quote_rejected:FiX,quote_completed:j,project_created:C,project_assigned:C,project_started:g,project_completed:j,project_delayed:FiClock,ticket_created:f,ticket_assigned:f,ticket_resolved:j,ticket_escalated:FiAlertTriangle,evidence_uploaded:FiPaperclip,evidence_approved:j,evidence_rejected:FiX,user_registered:T,user_assigned:T,user_role_changed:FiSettings,client_created:FiUser,client_updated:FiUser,system_maintenance:FiSettings,system_update:FiSettings})[s]||P,k=s=>({quote_created:"primary",quote_assigned:"primary",quote_approved:"success",quote_rejected:"danger",quote_completed:"success",project_created:"info",project_assigned:"info",project_started:"info",project_completed:"success",project_delayed:"warning",ticket_created:"warning",ticket_assigned:"warning",ticket_resolved:"success",ticket_escalated:"danger",evidence_uploaded:"secondary",evidence_approved:"success",evidence_rejected:"danger",user_registered:"info",user_assigned:"info",user_role_changed:"secondary",client_created:"primary",client_updated:"primary",system_maintenance:"secondary",system_update:"secondary"})[s]||"secondary",v=((c=x==null?void 0:x.activities)==null?void 0:c.map(s=>({id:s.id,type:s.type,title:s.title,description:s.description,time:I(s.created_at),icon:N(s.type),color:k(s.type),user:s.user_name})))||[{id:1,type:"quote_created",title:"Nueva cotizaci√≥n creada",description:"Cotizaci√≥n #2024-001 para Proyecto ABC",time:"Hace 2 horas",icon:b,color:"primary"},{id:2,type:"project_completed",title:"Proyecto completado",description:"Proyecto XYZ finalizado exitosamente",time:"Hace 4 horas",icon:j,color:"success"},{id:3,type:"ticket_created",title:"Nuevo ticket de soporte",description:"Solicitud de soporte t√©cnico",time:"Hace 6 horas",icon:f,color:"warning"},{id:4,type:"user_registered",title:"Usuario registrado",description:"Nuevo usuario agregado al sistema",time:"Hace 8 horas",icon:T,color:"info"}],_=[{title:"Nuevo Proyecto",description:"Crear un nuevo proyecto",icon:C,color:"primary",onClick:()=>a("/proyectos")},{title:"Nueva Cotizaci√≥n",description:"Generar cotizaci√≥n",icon:b,color:"success",onClick:()=>a("/cotizaciones/inteligente")},{title:"Nuevo Ticket",description:"Crear ticket de soporte",icon:f,color:"warning",onClick:()=>a("/tickets")},{title:"Ver Reportes",description:"Analizar datos del sistema",icon:g,color:"info",onClick:()=>a("/reportes")}];return e.jsxs("div",{className:"fade-in",children:[e.jsx(V,{title:"Dashboard",subtitle:"Resumen general del sistema CRM GeoFal",icon:g}),e.jsxs(E,{className:"mb-4 g-3",children:[e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Total Usuarios",value:o.totalUsers,icon:T,color:"primary",trend:((M=o.changePercentages)==null?void 0:M.users)||null,subtitle:`${o.activeUsersThisMonth||0} usuarios activos este mes`,loading:n,size:"normal"})}),e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Proyectos Activos",value:o.activeProjects,icon:C,color:"success",trend:((F=o.changePercentages)==null?void 0:F.projects)||null,subtitle:`${o.totalProjects} proyectos totales`,loading:n,size:"normal"})}),e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Cotizaciones Pendientes",value:o.pendingQuotes,icon:b,color:"warning",trend:((q=o.changePercentages)==null?void 0:q.quotes)||null,subtitle:`${o.quotesThisMonth||0} cotizaciones este mes`,loading:n,size:"normal"})}),e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Tickets Abiertos",value:o.openTickets,icon:f,color:"danger",trend:((S=o.changePercentages)==null?void 0:S.tickets)||null,subtitle:`${o.ticketsThisMonth||0} tickets este mes`,loading:n,size:"normal"})})]}),e.jsxs(E,{children:[e.jsx(d,{lg:8,className:"mb-4",children:e.jsxs(r,{className:"h-100",children:[e.jsxs(r.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"mb-0",children:"Actividades Recientes"}),h>0&&e.jsxs("small",{className:"text-muted",children:[h," actividad",h!==1?"es":""," ‚Ä¢ Actualizado autom√°ticamente"]}),(t==null?void 0:t.role)!=="admin"&&e.jsxs("small",{className:"text-info d-block",children:["Mostrando solo actividades relevantes a tu rol: ",t==null?void 0:t.role]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(A,{variant:"outline-secondary",size:"sm",onClick:l,disabled:u,title:"Actualizar actividades",className:"refresh-btn",children:e.jsx(P,{className:u?"spinning":""})}),(t==null?void 0:t.role)==="admin"&&e.jsxs(A,{variant:"outline-primary",size:"sm",onClick:()=>a("/actividades"),title:"Ver todas las actividades (Solo Admin)",children:[e.jsx(L,{className:"me-1"}),"Ver todas"]})]})]}),e.jsx(r.Body,{children:u?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando actividades..."})}),e.jsx("p",{className:"mt-2 text-muted",children:"Cargando actividades recientes..."})]}):v.length===0?e.jsxs("div",{className:"activity-empty-state text-center",children:[e.jsx("div",{className:"mb-3",children:e.jsx(P,{size:48,className:"text-muted icon"})}),e.jsx("h6",{className:"text-muted mb-2",children:"No hay actividades recientes"}),e.jsx("p",{className:"text-muted small mb-3",children:(t==null?void 0:t.role)==="admin"?"A√∫n no hay actividades registradas en el sistema.":"No hay actividades relevantes a tu rol en este momento."}),e.jsxs(A,{variant:"outline-primary",size:"sm",onClick:l,className:"mt-2",children:[e.jsx(P,{className:"me-1"}),"Actualizar"]})]}):e.jsx("div",{className:"activity-list",children:v.map(s=>{const m=s.icon;return e.jsxs("div",{className:"activity-item d-flex align-items-start mb-3",children:[e.jsx("div",{className:`activity-icon bg-${s.color} bg-opacity-10 rounded-circle p-2 me-3`,children:e.jsx(m,{size:20,className:`text-${s.color}`})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:s.title}),e.jsx("p",{className:"text-muted mb-1 small",children:s.description}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:s.time}),s.user&&e.jsxs("small",{className:"text-muted",children:["por ",s.user]})]})]})]},s.id)})})})]})}),e.jsx(d,{lg:4,className:"mb-4",children:e.jsxs(r,{className:"h-100",children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Acciones R√°pidas"})}),e.jsx(r.Body,{children:e.jsx("div",{className:"quick-actions",children:_.map((s,m)=>{const U=s.icon;return e.jsxs(A,{variant:`outline-${s.color}`,className:"w-100 mb-3 d-flex align-items-center justify-content-start",onClick:s.onClick,children:[e.jsx("div",{className:`me-3 bg-${s.color} bg-opacity-10 rounded-circle p-2`,children:e.jsx(U,{size:20,className:`text-${s.color}`})}),e.jsxs("div",{className:"text-start",children:[e.jsx("div",{className:"fw-medium",children:s.title}),e.jsx("small",{className:"text-muted",children:s.description})]})]},m)})})})]})})]}),e.jsxs(E,{children:[e.jsx(d,{lg:6,className:"mb-4",children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Resumen de Proyectos"})}),e.jsxs(r.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Completados"}),e.jsx("span",{className:"fw-bold text-success",children:o.completedProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Activos"}),e.jsx("span",{className:"fw-bold text-primary",children:o.activeProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Total Proyectos"}),e.jsx("span",{className:"fw-bold",children:o.totalProjects})]})]})]})}),e.jsx(d,{lg:6,className:"mb-4",children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Estado del Sistema"})}),e.jsxs(r.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Usuarios Online"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(g,{className:"me-1"}),Math.floor(o.totalUsers*.3)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Cotizaciones Este Mes"}),e.jsxs("span",{className:"fw-bold text-primary",children:[e.jsx(g,{className:"me-1"}),Math.floor(o.totalQuotes*.4)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Tickets Resueltos"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(g,{className:"me-1"}),Math.floor(o.totalTickets*.7)]})]})]})]})})]})]})};export{ie as default};
//# sourceMappingURL=Dashboard-CuMmom66.js.map
