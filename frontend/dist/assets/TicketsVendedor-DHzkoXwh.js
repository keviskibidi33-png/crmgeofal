import{r as c,a as P,j as e,g as k,n as z,O as U,T as q,N as ce,aq as ie,ar as O,F as Q,C as T,X as $,at as J,au as le,Z as oe,B as M,a1 as de,o as me,c as he,e as xe,x as G,y as K,f as je,Q as ue,a2 as ge,m as Ne}from"./index-Bcrgukx7.js";import{l as pe,c as ve,u as be}from"./tickets-DEzBlaRq.js";import{g as fe,c as ye,T as Ce}from"./ticketComments-ConcsPh2.js";import{M as A}from"./Modal-CPMvw6Im.js";import{T as Se,a as W}from"./Tabs-Bzkyjbmi.js";import{R as w,C as D}from"./Row-B5ljKXp5.js";import{C as i}from"./Col-C5Zwr_ej.js";import{C as n}from"./Card-C96hNOBG.js";import{F as H}from"./Form-DBWuP9iW.js";import{S as Te}from"./SuccessModal-Brilhozx.js";import{A as X}from"./Alert-C1-1JEUj.js";import{I as Z}from"./InputGroup-B7PnIA03.js";import"./ElementChildren-BWXp08bt.js";const we=({ticketId:y})=>{const[m,a]=c.useState(""),[g,E]=c.useState([]),[C,r]=c.useState(!1),[x,h]=c.useState(!0),[N,p]=c.useState("idle"),b=c.useRef(null),{user:o}=P();c.useEffect(()=>{const t=async()=>{try{const l=await fetch("http://localhost:4000/api/health",{method:"HEAD",timeout:3e3});h(l.ok)}catch{h(!1)}};t();const d=setInterval(t,1e4);return()=>clearInterval(d)},[]),c.useEffect(()=>{f();const t=setInterval(()=>{x&&f()},5e3);return()=>clearInterval(t)},[y,x]);const f=async()=>{try{const t=await fe(y);if(console.log("üîç Comentarios del backend:",t),t&&t.length>0){const d=t.map(l=>({message:l.comment,user_name:l.user_name||"Usuario",created_at:l.created_at}));E(d),console.log("‚úÖ Comentarios cargados desde backend:",d)}else E([]),console.log("üìù No hay comentarios en el backend")}catch(t){console.error("‚ùå Error cargando comentarios del backend:",t),E([])}},_=()=>{var t;(t=b.current)==null||t.scrollIntoView({behavior:"smooth"})};c.useEffect(()=>{_()},[g]);const I=async t=>{if(t.preventDefault(),m.trim()&&!C){r(!0),p("syncing");const d=m.trim();a("");try{const l=await ye({ticket_id:y,comment:d});console.log("‚úÖ Mensaje enviado al backend:",l),await f(),p("success"),console.log("‚úÖ Mensaje sincronizado correctamente")}catch(l){console.error("‚ùå Error enviando mensaje al backend:",l),p("error")}r(!1),setTimeout(()=>p("idle"),3e3)}},v=t=>new Date(t).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),B=t=>t.user_name==="Sistema",j=t=>{const d=["#3b82f6","#ef4444"],l=t.split("").reduce((u,F)=>(u=(u<<5)-u+F.charCodeAt(0),u&u),0);return d[Math.abs(l)%d.length]},L=()=>{switch(N){case"syncing":return e.jsx("div",{className:"spinner-small"});case"success":return e.jsx(q,{className:"text-success"});case"error":return e.jsx(O,{className:"text-warning"});default:return x?e.jsx(ie,{className:"text-success"}):e.jsx(O,{className:"text-danger"})}};return e.jsxs("div",{className:"ticket-chat-vendedor",children:[e.jsxs("div",{className:"ticket-chat-header",children:[e.jsx(k,{className:"chat-icon"}),e.jsx("h4",{children:"Conversaci√≥n con Soporte"}),e.jsxs("div",{className:"header-info",children:[e.jsxs("span",{className:"comment-count",children:[g.length," mensajes"]}),e.jsxs("div",{className:"connection-status",children:[L(),e.jsx("span",{className:"status-text",children:x?"Conectado":"Offline"})]})]})]}),e.jsxs("div",{className:"ticket-chat-messages",children:[g.map((t,d)=>{const l=B(t)?"#6c757d":j(t.user_name||"Usuario"),u=t.user_name===(o==null?void 0:o.name);return e.jsxs("div",{className:`message ${B(t)?"system":u?"own":"other"}`,children:[e.jsxs("div",{className:"message-header",children:[e.jsxs("div",{className:"message-user",children:[e.jsx("div",{className:"user-color-bar",style:{width:"4px",height:"20px",backgroundColor:l,borderRadius:"2px",marginRight:"8px"}}),e.jsx(z,{className:"user-icon",style:{color:l}}),e.jsx("span",{className:"user-name",style:{color:l},children:t.user_name})]}),e.jsxs("div",{className:"message-time",children:[e.jsx(U,{className:"time-icon"}),v(t.created_at)]})]}),e.jsx("div",{className:"message-content",children:t.message}),e.jsxs("div",{className:"message-status",children:[e.jsx(q,{className:"read-icon"}),"Le√≠do"]})]},d)}),e.jsx("div",{ref:b})]}),e.jsxs("form",{className:"ticket-chat-input",onSubmit:I,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("textarea",{value:m,onChange:t=>a(t.target.value),placeholder:x?"Escribe tu mensaje al equipo de soporte...":"Escribe tu mensaje (se guardar√° offline)...",className:"comment-input",rows:3,disabled:C}),e.jsx("button",{type:"submit",className:"send-button",disabled:!m.trim()||C,children:C?e.jsx("div",{className:"spinner-small"}):e.jsx(ce,{className:"send-icon"})})]}),e.jsxs("div",{className:"sync-status",children:[N==="syncing"&&e.jsx("span",{children:"Sincronizando..."}),N==="success"&&e.jsx("span",{className:"text-success",children:"‚úÖ Enviado a soporte"}),N==="error"&&e.jsx("span",{className:"text-warning",children:"‚ö†Ô∏è Guardado offline"})]})]})]})},Ee=({show:y,onHide:m,ticket:a,onUpdateStatus:g})=>{const[E,C]=c.useState(""),{user:r}=P(),x=(r==null?void 0:r.role)==="admin"||(r==null?void 0:r.role)==="soporte";if(console.log("üîç Usuario actual:",r),console.log("üîç Rol:",r==null?void 0:r.role),console.log("üîç Puede editar estado:",x),console.log("üîç Es vendedor:",(r==null?void 0:r.role)==="vendedor_comercial"),!a)return null;const h=o=>({abierto:{bg:"warning",text:"Abierto"},en_progreso:{bg:"info",text:"En Progreso"},cerrado:{bg:"success",text:"Cerrado"},cancelado:{bg:"danger",text:"Cancelado"}})[o]||{bg:"secondary",text:o},N=o=>({baja:{bg:"success",text:"Baja"},media:{bg:"warning",text:"Media"},alta:{bg:"danger",text:"Alta"},urgente:{bg:"dark",text:"Urgente"}})[o]||{bg:"secondary",text:o},p=o=>new Date(o).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),b=o=>{g&&g(a.id,o)};return e.jsxs(A,{show:y,onHide:m,size:"xl",centered:!0,children:[e.jsxs(A.Header,{closeButton:!0,className:"modal-header-vendedor",children:[e.jsxs(A.Title,{children:[e.jsx(k,{className:"me-2"}),"Historial del Ticket #",a.id]}),e.jsx("small",{className:"text-light ms-2",children:a.title})]}),e.jsx(A.Body,{className:"modal-body-vendedor",children:e.jsxs(Se,{defaultActiveKey:"details",className:"ticket-tabs",children:[e.jsx(W,{eventKey:"details",title:"Detalles",children:e.jsxs(w,{children:[e.jsxs(i,{md:8,children:[e.jsxs(n,{className:"mb-4",children:[e.jsx(n.Header,{children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(Q,{className:"me-2"}),"Informaci√≥n del Ticket"]})}),e.jsx(n.Body,{children:e.jsxs(w,{children:[e.jsxs(i,{md:6,children:[e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"T√≠tulo:"}),e.jsx("p",{className:"mb-2",children:a.title})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Descripci√≥n:"}),e.jsx("p",{className:"mb-2",children:a.description})]})]}),e.jsxs(i,{md:6,children:[e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Estado:"}),e.jsx("div",{className:"mb-2",children:e.jsx(T,{bg:h(a.status).bg,children:h(a.status).text})})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Prioridad:"}),e.jsx("div",{className:"mb-2",children:e.jsx(T,{bg:N(a.priority).bg,children:N(a.priority).text})})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"M√≥dulo:"}),e.jsx("p",{className:"mb-2",children:a.module||"No especificado"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Creado:"}),e.jsxs("p",{className:"mb-2",children:[e.jsx($,{className:"me-1"}),p(a.created_at)]})]})]})]})})]}),(a.category||a.type||a.tags||a.additional_notes)&&e.jsxs(n,{className:"mb-4",children:[e.jsx(n.Header,{children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(J,{className:"me-2"}),"Informaci√≥n Adicional"]})}),e.jsx(n.Body,{children:e.jsxs(w,{children:[a.category&&e.jsx(i,{md:6,children:e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Categor√≠a:"}),e.jsx("p",{className:"mb-2",children:a.category})]})}),a.type&&e.jsx(i,{md:6,children:e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Tipo:"}),e.jsx("p",{className:"mb-2",children:a.type})]})}),a.tags&&e.jsx(i,{md:6,children:e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Tags:"}),e.jsx("p",{className:"mb-2",children:a.tags})]})}),a.estimated_time&&e.jsx(i,{md:6,children:e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Tiempo Estimado:"}),e.jsx("p",{className:"mb-2",children:a.estimated_time})]})}),a.additional_notes&&e.jsx(i,{md:12,children:e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Notas Adicionales:"}),e.jsx("p",{className:"mb-2",children:a.additional_notes})]})})]})})]})]}),e.jsxs(i,{md:4,children:[e.jsxs(n,{className:"mb-4",children:[e.jsx(n.Header,{children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(le,{className:"me-2"}),x?"Control de Estado":"Estado del Ticket"]})}),e.jsx(n.Body,{children:e.jsxs("div",{className:"status-controls",children:[x?e.jsxs(H.Select,{value:a.status,onChange:o=>b(o.target.value),className:"mb-3",children:[e.jsx("option",{value:"abierto",children:"Abierto"}),e.jsx("option",{value:"en_progreso",children:"En Progreso"}),e.jsx("option",{value:"cerrado",children:"Cerrado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]}):e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Estado Actual:"}),e.jsx("div",{className:"d-flex align-items-center",children:e.jsx(T,{bg:h(a.status).bg,className:"me-2",children:h(a.status).text})})]}),e.jsx("div",{className:"status-info",children:e.jsxs("small",{className:"text-muted",children:[e.jsx(U,{className:"me-1"}),"√öltima actualizaci√≥n: ",p(a.updated_at||a.created_at)]})})]})})]}),e.jsxs(n,{className:"mb-4",children:[e.jsx(n.Header,{children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(z,{className:"me-2"}),"Informaci√≥n del Creador"]})}),e.jsx(n.Body,{children:e.jsxs("div",{className:"creator-info",children:[e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Vendedor:"})," ",r==null?void 0:r.name," ",r==null?void 0:r.apellido]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Email:"})," ",r==null?void 0:r.email]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Rol:"})," ",r==null?void 0:r.role]})]})})]}),a.attachment_url&&e.jsxs(n,{className:"mb-4",children:[e.jsx(n.Header,{children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(oe,{className:"me-2"}),"Archivo Adjunto"]})}),e.jsx(n.Body,{children:e.jsxs("div",{className:"attachment-info",children:[e.jsxs("p",{className:"mb-2",children:[e.jsx(Q,{className:"me-2"}),"Archivo adjunto disponible"]}),e.jsxs(M,{variant:"outline-primary",size:"sm",href:a.attachment_url,target:"_blank",children:[e.jsx(de,{className:"me-1"}),"Descargar"]})]})})]})]})]})}),e.jsx(W,{eventKey:"chat",title:"Conversaci√≥n",children:e.jsx(we,{ticketId:a.id})})]})}),e.jsx(A.Footer,{className:"modal-footer-vendedor",children:e.jsxs(M,{variant:"secondary",onClick:m,children:[e.jsx(me,{className:"me-2"}),"Cerrar"]})})]})},Re=()=>{const[y,m]=c.useState(!1),[a,g]=c.useState(!1),[E,C]=c.useState(null),[r,x]=c.useState(""),[h,N]=c.useState("todos"),[p,b]=c.useState(!1),[o,f]=c.useState(""),[_,I]=c.useState("todos"),{user:v}=P(),B=he(),{data:j=[],isLoading:L,error:t}=xe("tickets-vendedor",()=>pe({user_id:v==null?void 0:v.id}),{enabled:!!(v!=null&&v.id),refetchInterval:3e4}),d=G(ve,{onSuccess:()=>{B.invalidateQueries("tickets-vendedor"),m(!1),f("El ticket ha sido creado exitosamente y est√° listo para ser procesado por el equipo de soporte."),b(!0)},onError:()=>{alert("‚ùå Error al crear el ticket")}}),l=G(({id:s,status:S})=>be(s,S),{onSuccess:()=>{B.invalidateQueries("tickets-vendedor"),f("El estado del ticket ha sido actualizado exitosamente."),b(!0)},onError:()=>{alert("‚ùå Error al actualizar el ticket")}}),u=c.useMemo(()=>Array.isArray(j)?j.filter(s=>{var R,V;const S=((R=s.title)==null?void 0:R.toLowerCase().includes(r.toLowerCase()))||((V=s.description)==null?void 0:V.toLowerCase().includes(r.toLowerCase())),re=h==="todos"||s.status===h,ne=_==="todos"||s.priority===_;return S&&re&&ne}):[],[j,r,h,_]),F=c.useMemo(()=>Array.isArray(j)?{total:j.length,abiertos:j.filter(s=>s.status==="abierto").length,en_progreso:j.filter(s=>s.status==="en_progreso").length,cerrados:j.filter(s=>s.status==="cerrado").length}:{total:0,abiertos:0,en_progreso:0,cerrados:0},[j]),Y=s=>({abierto:"warning",en_progreso:"info",cerrado:"success",cancelado:"danger"})[s]||"secondary",ee=s=>({baja:"success",media:"warning",alta:"danger",urgente:"dark"})[s]||"secondary",se=s=>{d.mutate({...s,user_id:v.id,assigned_to:null,status:"abierto"})},ae=(s,S)=>{l.mutate({id:s,status:S})},te=s=>{C(s),g(!0)};return L?e.jsx(D,{className:"py-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})}),e.jsx("p",{className:"mt-2",children:"Cargando tickets..."})]})}):t?e.jsx(D,{className:"py-4",children:e.jsxs(X,{variant:"danger",children:[e.jsx(X.Heading,{children:"Error cargando tickets"}),e.jsx("p",{children:t.message})]})}):e.jsxs(D,{fluid:!0,className:"py-4",children:[e.jsx(w,{className:"mb-4",children:e.jsx(i,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"mb-1",children:[e.jsx(k,{className:"me-2"}),"Mis Tickets"]}),e.jsx("p",{className:"text-muted mb-0",children:"Gestiona tus tickets y solicitudes"})]}),e.jsxs(M,{variant:"primary",onClick:()=>m(!0),className:"btn-modern",children:[e.jsx(K,{className:"me-2"}),"Nuevo Ticket"]})]})})}),e.jsxs(w,{className:"mb-4",children:[e.jsx(i,{md:3,children:e.jsx(n,{className:"stat-card",children:e.jsxs(n.Body,{className:"text-center",children:[e.jsx(k,{className:"stat-icon text-primary"}),e.jsx("h3",{className:"stat-number",children:F.total}),e.jsx("p",{className:"stat-label",children:"Total Tickets"})]})})}),e.jsx(i,{md:3,children:e.jsx(n,{className:"stat-card",children:e.jsxs(n.Body,{className:"text-center",children:[e.jsx(U,{className:"stat-icon text-warning"}),e.jsx("h3",{className:"stat-number",children:F.abiertos}),e.jsx("p",{className:"stat-label",children:"Abiertos"})]})})}),e.jsx(i,{md:3,children:e.jsx(n,{className:"stat-card",children:e.jsxs(n.Body,{className:"text-center",children:[e.jsx(z,{className:"stat-icon text-info"}),e.jsx("h3",{className:"stat-number",children:F.en_progreso}),e.jsx("p",{className:"stat-label",children:"En Progreso"})]})})}),e.jsx(i,{md:3,children:e.jsx(n,{className:"stat-card",children:e.jsxs(n.Body,{className:"text-center",children:[e.jsx(je,{className:"stat-icon text-success"}),e.jsx("h3",{className:"stat-number",children:F.cerrados}),e.jsx("p",{className:"stat-label",children:"Cerrados"})]})})})]}),e.jsxs(w,{className:"mb-4",children:[e.jsx(i,{md:4,children:e.jsxs(Z,{children:[e.jsx(Z.Text,{children:e.jsx(ue,{})}),e.jsx(H.Control,{type:"text",placeholder:"Buscar tickets...",value:r,onChange:s=>x(s.target.value)})]})}),e.jsx(i,{md:3,children:e.jsxs(H.Select,{value:h,onChange:s=>N(s.target.value),children:[e.jsx("option",{value:"todos",children:"Todos los estados"}),e.jsx("option",{value:"abierto",children:"Abierto"}),e.jsx("option",{value:"en_progreso",children:"En Progreso"}),e.jsx("option",{value:"cerrado",children:"Cerrado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})}),e.jsx(i,{md:3,children:e.jsxs(H.Select,{value:_,onChange:s=>I(s.target.value),children:[e.jsx("option",{value:"todos",children:"Todas las prioridades"}),e.jsx("option",{value:"baja",children:"Baja"}),e.jsx("option",{value:"media",children:"Media"}),e.jsx("option",{value:"alta",children:"Alta"}),e.jsx("option",{value:"urgente",children:"Urgente"})]})}),e.jsx(i,{md:2,children:e.jsxs(M,{variant:"outline-secondary",className:"w-100",children:[e.jsx(ge,{className:"me-2"}),"Filtros"]})})]}),e.jsx(w,{children:e.jsx(i,{children:e.jsxs(n,{children:[e.jsx(n.Header,{children:e.jsxs("h5",{className:"mb-0",children:["Mis Tickets (",u.length,")"]})}),e.jsx(n.Body,{className:"p-0",children:u.length===0?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(k,{className:"text-muted",size:48}),e.jsx("h5",{className:"mt-3 text-muted",children:"No hay tickets"}),e.jsx("p",{className:"text-muted",children:"Crea tu primer ticket para comenzar"}),e.jsxs(M,{variant:"primary",onClick:()=>m(!0),children:[e.jsx(K,{className:"me-2"}),"Crear Ticket"]})]}):e.jsx("div",{className:"ticket-list",children:u.map(s=>e.jsxs("div",{className:"ticket-item",children:[e.jsxs("div",{className:"ticket-header",children:[e.jsxs("div",{className:"ticket-title",children:[e.jsx("h6",{className:"mb-1",children:s.title}),e.jsxs("div",{className:"ticket-meta",children:[e.jsx(T,{bg:Y(s.status),className:"me-2",children:s.status}),e.jsx(T,{bg:ee(s.priority),className:"me-2",children:s.priority}),e.jsxs("small",{className:"text-muted",children:[e.jsx($,{className:"me-1"}),new Date(s.created_at).toLocaleDateString()]})]})]}),e.jsx("div",{className:"ticket-actions",children:e.jsxs(M,{variant:"outline-primary",size:"sm",onClick:()=>te(s),children:[e.jsx(Ne,{className:"me-1"}),"Ver"]})})]}),e.jsxs("div",{className:"ticket-content",children:[e.jsx("p",{className:"text-muted mb-2",children:s.description}),s.module&&e.jsxs(T,{bg:"info",className:"me-1",children:[e.jsx(J,{className:"me-1"}),s.module]}),s.category&&e.jsx(T,{bg:"secondary",className:"me-1",children:s.category})]})]},s.id))})})]})})}),e.jsx(Ce,{show:y,onHide:()=>m(!1),onSubmit:se,isLoading:d.isLoading}),e.jsx(Ee,{show:a,onHide:()=>g(!1),ticket:E,onUpdateStatus:ae}),e.jsx(Te,{show:p,onHide:()=>b(!1),title:"¬°Ticket Procesado!",message:o,buttonText:"Continuar"})]})};export{Re as default};
//# sourceMappingURL=TicketsVendedor-DHzkoXwh.js.map
