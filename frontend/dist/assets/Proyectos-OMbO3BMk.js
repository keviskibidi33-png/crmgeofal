import{r as a,j as e}from"./index-BFrTSJXc.js";import{M as k}from"./ModuloBase-BXjPI6cD.js";import{M as z}from"./Modal-B5At1RZR.js";import{T as B,a as F}from"./Toolbar-CsECCMO9.js";import{T as L}from"./Toast-BbbM5Ntr.js";import{l as D}from"./companies-CU1Nz5ws.js";import{l as $,d as G,u as U,c as q}from"./projects-BYu6OmzB.js";function W({value:l,onChange:x,disabled:y}){const[h,f]=a.useState(""),[r,b]=a.useState([]),[c,n]=a.useState(!1),[p,d]=a.useState(!1),g=a.useMemo(()=>{if(!l)return"";const t=r.find(o=>o.id===l);return t?`${t.name} ${t.ruc?"("+t.ruc+")":""}`:String(l)},[l,r]);return a.useEffect(()=>{if(!c)return;let t=!1;return(async()=>{d(!0);try{const o=await D({page:1,limit:10,search:h});t||b((o==null?void 0:o.data)||[])}finally{t||d(!1)}})(),()=>{t=!0}},[h,c]),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{className:"form-control",placeholder:"Buscar cliente por nombre/RUC",value:c?h:g,onChange:t=>{f(t.target.value),n(!0)},onFocus:()=>n(!0),disabled:y}),c&&e.jsxs("div",{style:{position:"absolute",zIndex:5,background:"#fff",border:"1px solid #eee",boxShadow:"0 2px 12px rgba(0,0,0,0.08)",borderRadius:8,width:"100%",marginTop:4,maxHeight:240,overflowY:"auto"},children:[e.jsx("div",{style:{padding:8,fontSize:12,color:"#888"},children:p?"Buscando...":"Resultados"}),(r||[]).map(t=>e.jsxs("div",{onMouseDown:()=>{x&&x(t.id,t),n(!1)},style:{padding:"8px 10px",cursor:"pointer"},children:[e.jsx("div",{style:{fontWeight:600},children:t.name}),e.jsx("div",{style:{fontSize:12,color:"#666"},children:t.ruc?`RUC: ${t.ruc}`:t.dni?`DNI: ${t.dni}`:""})]},t.id)),(!r||r.length===0)&&e.jsx("div",{style:{padding:8,fontSize:12,color:"#888"},children:"Sin resultados"})]})]})}const E=20,P={company_id:"",name:"",location:""},X=()=>{const[l,x]=a.useState([]),[y,h]=a.useState(0),[f,r]=a.useState(!0),[b,c]=a.useState(""),[n,p]=a.useState(1),[d,g]=a.useState(""),[t,o]=a.useState(!1),[m,v]=a.useState(null),[i,u]=a.useState(P),[S,I]=a.useState(!1),[M,N]=a.useState({message:"",type:"success"}),C=async()=>{r(!0),c("");try{const s=await $({page:n,limit:E,search:d});x((s==null?void 0:s.data)||[]),h(Number((s==null?void 0:s.total)||0))}catch(s){c(s.message||"Error al cargar proyectos")}finally{r(!1)}};a.useEffect(()=>{C()},[n,d]);const R=()=>{v(null),u(P),o(!0)},T=s=>{v(s),u({company_id:s.company_id||"",name:s.name||"",location:s.location||""}),o(!0)},A=async s=>{if(window.prompt(`Para eliminar el proyecto "${s.name}", escribe ELIMINAR`)==="ELIMINAR")try{await G(s.id),await C()}catch(w){alert(w.message||"Error al eliminar proyecto")}},_=async s=>{s.preventDefault();const j={...i};try{I(!0),m?await U(m.id,{name:j.name,location:j.location}):await q(j),o(!1),v(null),u(P),await C(),N({message:m?"Proyecto actualizado":"Proyecto creado",type:"success"})}catch(w){N({message:w.message||"Error al guardar",type:"error"})}finally{I(!1)}};return e.jsxs(k,{titulo:"Gestión de Proyectos",descripcion:"Administra los proyectos por cliente, ubicación y responsables.",children:[e.jsx(B,{left:e.jsxs(e.Fragment,{children:[e.jsx("input",{placeholder:"Buscar por nombre o ubicación",value:d,onChange:s=>{g(s.target.value),p(1)},style:{padding:"0.6rem 0.8rem",border:"1px solid #ddd",borderRadius:8,minWidth:260}}),f&&e.jsx("span",{style:{color:"#888"},children:"Cargando..."}),b&&e.jsx("span",{style:{color:"red"},children:b})]}),right:e.jsx("button",{onClick:R,className:"btn btn-primary",children:"+ Agregar proyecto"})}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-striped align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Ubicación"}),e.jsx("th",{children:"Acciones"})]})}),e.jsxs("tbody",{children:[l.length===0&&e.jsx(F,{colSpan:5,message:"Sin proyectos"}),l.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:s.company_name||s.company_id}),e.jsx("td",{children:s.name}),e.jsx("td",{children:s.location}),e.jsxs("td",{children:[e.jsx("button",{className:"btn btn-sm btn-secondary me-1",onClick:()=>T(s),children:"Editar"}),e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>A(s),children:"Eliminar"})]})]},s.id))]})]})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("button",{className:"btn btn-outline-secondary",disabled:n===1,onClick:()=>p(s=>s-1),children:"Anterior"}),e.jsxs("span",{children:["Página ",n," de ",Math.ceil((y||0)/E)||1]}),e.jsx("button",{className:"btn btn-outline-secondary",disabled:n*E>=y,onClick:()=>p(s=>s+1),children:"Siguiente"})]}),t&&e.jsx(z,{open:t,onClose:()=>o(!1),children:e.jsxs("form",{onSubmit:_,children:[e.jsx("h3",{style:{marginBottom:8},children:m?"Editar proyecto":"Nuevo proyecto"}),e.jsx("div",{style:{color:"#888",marginBottom:16},children:m?"Actualiza los datos del proyecto.":"Completa los datos del nuevo proyecto."}),e.jsxs("div",{className:"row g-3",children:[!m&&e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsx(W,{value:i.company_id,onChange:s=>u({...i,company_id:s})})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Nombre del proyecto"}),e.jsx("input",{className:"form-control",value:i.name,onChange:s=>u({...i,name:s.target.value}),required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Ubicación"}),e.jsx("input",{className:"form-control",value:i.location,onChange:s=>u({...i,location:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"mt-3 d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>o(!1),disabled:S,children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn btn-success",disabled:S,children:S?"Guardando...":"Guardar"})]})]})}),e.jsx(L,{message:M.message,type:M.type,onClose:()=>N({message:"",type:"success"})})]})};export{X as default};
//# sourceMappingURL=Proyectos-OMbO3BMk.js.map
