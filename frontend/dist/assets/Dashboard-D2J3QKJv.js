import{b as S,c as R,d as $,e as Q,u as I,a as B,F as y,f as p,g as f,h as k,j as e,i as h,k as A,B as C,l as w,m as D}from"./index-D5j7Etbr.js";import{P as E}from"./PageHeader-BAMnoJ00.js";import{S as P}from"./StatsCard-CrtJfzkh.js";import{R as z,C as o,a as c}from"./Row-BbCd5WYq.js";import"./Spinner-DkvOZ9XA.js";const L=()=>S("/api/dashboard/stats"),O=(r={})=>{const t=new URLSearchParams(r).toString(),n=t?`/api/activities/recent?${t}`:"/api/activities/recent";return S(n)},V=(r={})=>{var b,v,_,N;const t=R(),{limit:n=4,refetchInterval:l=3e5,staleTime:x=6e4,enabled:j=!0,userId:m=null,role:g=null}=r;$({onNewNotification:a=>{a.type&&(a.type.includes("quote")||a.type.includes("project")||a.type.includes("ticket")||a.type.includes("evidence")||a.type.includes("user")||a.type.includes("client"))&&t.invalidateQueries(["recentActivities"])},onUnreadCountUpdate:()=>{t.invalidateQueries(["recentActivities"])}});const i=Q(["recentActivities",{limit:n,userId:m,role:g}],()=>O({limit:n,userId:m,role:g}),{enabled:j,refetchInterval:l,staleTime:x,refetchOnWindowFocus:!0,refetchOnMount:!0,retry:2,retryDelay:5e3,cacheTime:3e5,networkMode:"online",onError:a=>{console.warn("Error loading activities:",a)}});return{...i,refreshActivities:()=>{t.invalidateQueries(["recentActivities"])},getCachedActivities:()=>t.getQueryData(["recentActivities",{limit:n}]),hasActivities:((v=(b=i.data)==null?void 0:b.activities)==null?void 0:v.length)>0,activitiesCount:((N=(_=i.data)==null?void 0:_.activities)==null?void 0:N.length)||0,isOptimized:!0,lastFetch:i.dataUpdatedAt,nextFetch:i.dataUpdatedAt+l}},J=()=>{var N,a,U,H,M;const r=I(),{user:t}=B(),{data:n,isLoading:l}=Q(["dashboardStats"],L,{refetchInterval:3e5,staleTime:6e4}),{data:x,isLoading:j,activitiesCount:m,refreshActivities:g}=V({limit:4,refetchInterval:3e5,staleTime:6e4,userId:t==null?void 0:t.id,role:t==null?void 0:t.role}),i=(n==null?void 0:n.stats)||{totalUsers:0,totalProjects:0,totalQuotes:0,totalTickets:0,activeProjects:0,pendingQuotes:0,openTickets:0,completedProjects:0,changePercentages:{users:0,projects:0,quotes:0,tickets:0}},q=s=>{const d=new Date,F=new Date(s),u=Math.floor((d-F)/(1e3*60));return u<1?"Ahora":u<60?`Hace ${u} min`:u<1440?`Hace ${Math.floor(u/60)} h`:`Hace ${Math.floor(u/1440)} días`},T=s=>({quote_created:y,quote_assigned:y,quote_approved:p,quote_rejected:FiX,quote_completed:p,project_created:A,project_assigned:A,project_started:h,project_completed:p,project_delayed:FiClock,ticket_created:f,ticket_assigned:f,ticket_resolved:p,ticket_escalated:FiAlertTriangle,evidence_uploaded:FiPaperclip,evidence_approved:p,evidence_rejected:FiX,user_registered:k,user_assigned:k,user_role_changed:FiSettings,client_created:FiUser,client_updated:FiUser,system_maintenance:FiSettings,system_update:FiSettings})[s]||w,b=s=>({quote_created:"primary",quote_assigned:"primary",quote_approved:"success",quote_rejected:"danger",quote_completed:"success",project_created:"info",project_assigned:"info",project_started:"info",project_completed:"success",project_delayed:"warning",ticket_created:"warning",ticket_assigned:"warning",ticket_resolved:"success",ticket_escalated:"danger",evidence_uploaded:"secondary",evidence_approved:"success",evidence_rejected:"danger",user_registered:"info",user_assigned:"info",user_role_changed:"secondary",client_created:"primary",client_updated:"primary",system_maintenance:"secondary",system_update:"secondary"})[s]||"secondary",v=((N=x==null?void 0:x.activities)==null?void 0:N.map(s=>({id:s.id,type:s.type,title:s.title,description:s.description,time:q(s.created_at),icon:T(s.type),color:b(s.type),user:s.user_name})))||[{id:1,type:"quote_created",title:"Nueva cotización creada",description:"Cotización #2024-001 para Proyecto ABC",time:"Hace 2 horas",icon:y,color:"primary"},{id:2,type:"project_completed",title:"Proyecto completado",description:"Proyecto XYZ finalizado exitosamente",time:"Hace 4 horas",icon:p,color:"success"},{id:3,type:"ticket_created",title:"Nuevo ticket de soporte",description:"Solicitud de soporte técnico",time:"Hace 6 horas",icon:f,color:"warning"},{id:4,type:"user_registered",title:"Usuario registrado",description:"Nuevo usuario agregado al sistema",time:"Hace 8 horas",icon:k,color:"info"}],_=[{title:"Nuevo Proyecto",description:"Crear un nuevo proyecto",icon:A,color:"primary",onClick:()=>r("/proyectos")},{title:"Nueva Cotización",description:"Generar cotización",icon:y,color:"success",onClick:()=>r("/cotizaciones/nueva/lem")},{title:"Nuevo Ticket",description:"Crear ticket de soporte",icon:f,color:"warning",onClick:()=>r("/tickets")},{title:"Ver Reportes",description:"Analizar datos del sistema",icon:h,color:"info",onClick:()=>r("/reportes")}];return e.jsxs("div",{className:"fade-in",children:[e.jsx(E,{title:"Dashboard",subtitle:"Resumen general del sistema CRM GeoFal",icon:h}),e.jsxs(z,{className:"mb-4",children:[e.jsx(o,{lg:3,md:6,className:"mb-3",children:e.jsx(P,{title:"Total Usuarios",value:i.totalUsers,icon:k,color:"primary",trend:((a=i.changePercentages)==null?void 0:a.users)||0,subtitle:"Usuarios activos",loading:l})}),e.jsx(o,{lg:3,md:6,className:"mb-3",children:e.jsx(P,{title:"Proyectos Activos",value:i.activeProjects,icon:A,color:"success",trend:((U=i.changePercentages)==null?void 0:U.projects)||0,subtitle:`${i.totalProjects} proyectos totales`,loading:l})}),e.jsx(o,{lg:3,md:6,className:"mb-3",children:e.jsx(P,{title:"Cotizaciones Pendientes",value:i.pendingQuotes,icon:y,color:"warning",trend:((H=i.changePercentages)==null?void 0:H.quotes)||0,subtitle:`${i.totalQuotes} cotizaciones totales`,loading:l})}),e.jsx(o,{lg:3,md:6,className:"mb-3",children:e.jsx(P,{title:"Tickets Abiertos",value:i.openTickets,icon:f,color:"danger",trend:((M=i.changePercentages)==null?void 0:M.tickets)||0,subtitle:`${i.totalTickets} tickets totales`,loading:l})})]}),e.jsxs(z,{children:[e.jsx(o,{lg:8,className:"mb-4",children:e.jsxs(c,{className:"h-100",children:[e.jsxs(c.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"mb-0",children:"Actividades Recientes"}),m>0&&e.jsxs("small",{className:"text-muted",children:[m," actividad",m!==1?"es":""," • Actualizado automáticamente"]}),(t==null?void 0:t.role)!=="admin"&&e.jsxs("small",{className:"text-info d-block",children:["Mostrando solo actividades relevantes a tu rol: ",t==null?void 0:t.role]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(C,{variant:"outline-secondary",size:"sm",onClick:g,disabled:j,title:"Actualizar actividades",className:"refresh-btn",children:e.jsx(w,{className:j?"spinning":""})}),(t==null?void 0:t.role)==="admin"&&e.jsxs(C,{variant:"outline-primary",size:"sm",onClick:()=>r("/actividades"),title:"Ver todas las actividades (Solo Admin)",children:[e.jsx(D,{className:"me-1"}),"Ver todas"]})]})]}),e.jsx(c.Body,{children:j?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando actividades..."})}),e.jsx("p",{className:"mt-2 text-muted",children:"Cargando actividades recientes..."})]}):v.length===0?e.jsxs("div",{className:"activity-empty-state text-center",children:[e.jsx("div",{className:"mb-3",children:e.jsx(w,{size:48,className:"text-muted icon"})}),e.jsx("h6",{className:"text-muted mb-2",children:"No hay actividades recientes"}),e.jsx("p",{className:"text-muted small mb-3",children:(t==null?void 0:t.role)==="admin"?"Aún no hay actividades registradas en el sistema.":"No hay actividades relevantes a tu rol en este momento."}),e.jsxs(C,{variant:"outline-primary",size:"sm",onClick:g,className:"mt-2",children:[e.jsx(w,{className:"me-1"}),"Actualizar"]})]}):e.jsx("div",{className:"activity-list",children:v.map(s=>{const d=s.icon;return e.jsxs("div",{className:"activity-item d-flex align-items-start mb-3",children:[e.jsx("div",{className:`activity-icon bg-${s.color} bg-opacity-10 rounded-circle p-2 me-3`,children:e.jsx(d,{size:20,className:`text-${s.color}`})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:s.title}),e.jsx("p",{className:"text-muted mb-1 small",children:s.description}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:s.time}),s.user&&e.jsxs("small",{className:"text-muted",children:["por ",s.user]})]})]})]},s.id)})})})]})}),e.jsx(o,{lg:4,className:"mb-4",children:e.jsxs(c,{className:"h-100",children:[e.jsx(c.Header,{children:e.jsx("h5",{className:"mb-0",children:"Acciones Rápidas"})}),e.jsx(c.Body,{children:e.jsx("div",{className:"quick-actions",children:_.map((s,d)=>{const F=s.icon;return e.jsxs(C,{variant:`outline-${s.color}`,className:"w-100 mb-3 d-flex align-items-center justify-content-start",onClick:s.onClick,children:[e.jsx("div",{className:`me-3 bg-${s.color} bg-opacity-10 rounded-circle p-2`,children:e.jsx(F,{size:20,className:`text-${s.color}`})}),e.jsxs("div",{className:"text-start",children:[e.jsx("div",{className:"fw-medium",children:s.title}),e.jsx("small",{className:"text-muted",children:s.description})]})]},d)})})})]})})]}),e.jsxs(z,{children:[e.jsx(o,{lg:6,className:"mb-4",children:e.jsxs(c,{children:[e.jsx(c.Header,{children:e.jsx("h5",{className:"mb-0",children:"Resumen de Proyectos"})}),e.jsxs(c.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Completados"}),e.jsx("span",{className:"fw-bold text-success",children:i.completedProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Activos"}),e.jsx("span",{className:"fw-bold text-primary",children:i.activeProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Total Proyectos"}),e.jsx("span",{className:"fw-bold",children:i.totalProjects})]})]})]})}),e.jsx(o,{lg:6,className:"mb-4",children:e.jsxs(c,{children:[e.jsx(c.Header,{children:e.jsx("h5",{className:"mb-0",children:"Estado del Sistema"})}),e.jsxs(c.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Usuarios Online"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(h,{className:"me-1"}),Math.floor(i.totalUsers*.3)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Cotizaciones Este Mes"}),e.jsxs("span",{className:"fw-bold text-primary",children:[e.jsx(h,{className:"me-1"}),Math.floor(i.totalQuotes*.4)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Tickets Resueltos"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(h,{className:"me-1"}),Math.floor(i.totalTickets*.7)]})]})]})]})})]})]})};export{J as default};
//# sourceMappingURL=Dashboard-D2J3QKJv.js.map
