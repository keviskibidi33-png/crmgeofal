{"version":3,"file":"NotificacionesWhatsapp-DOg9gybA.js","sources":["../../src/services/whatsappNotices.js","../../src/pages/NotificacionesWhatsapp.jsx"],"sourcesContent":["import { apiFetch } from './api';\r\n\r\nexport const listNoticesByProject = (project_id, params = {}) => {\r\n  const sp = new URLSearchParams();\r\n  if (params.page) sp.set('page', params.page);\r\n  if (params.limit) sp.set('limit', params.limit);\r\n  const qs = sp.toString();\r\n  const path = `/api/project-whatsapp-notices/project/${project_id}` + (qs ? `?${qs}` : '');\r\n  return apiFetch(path);\r\n};\r\n\r\nexport const createNotice = ({ project_id, sent_to, message }) =>\r\n  apiFetch('/api/project-whatsapp-notices', {\r\n    method: 'POST',\r\n    body: JSON.stringify({ project_id, sent_to, message }),\r\n  });\r\n\r\nexport const listAllNotices = (params = {}) => {\r\n  const sp = new URLSearchParams();\r\n  if (params.page) sp.set('page', params.page);\r\n  if (params.limit) sp.set('limit', params.limit);\r\n  if (params.q) sp.set('q', params.q);\r\n  if (params.status) sp.set('status', params.status);\r\n  if (params.range) sp.set('range', params.range);\r\n  if (params.project_id) sp.set('project_id', params.project_id);\r\n  const qs = sp.toString();\r\n  return apiFetch('/api/project-whatsapp-notices' + (qs ? `?${qs}` : ''));\r\n};\r\n\r\nexport default { listNoticesByProject, createNotice, listAllNotices };\r\n","import React from 'react';\r\nimport ModuloBase from '../components/ModuloBase';\r\nimport DataTable from '../components/DataTable';\r\nimport Toolbar from '../components/Toolbar';\r\nimport Modal from '../components/Modal';\r\nimport { useQuery, useMutation, useQueryClient } from 'react-query';\r\nimport { listNoticesByProject, listAllNotices, createNotice } from '../services/whatsappNotices';\r\n\r\nexport default function NotificacionesWhatsapp() {\r\n  // Filters (placeholders for future global list). Currently we need project_id to list.\r\n  const [projectId, setProjectId] = React.useState('');\r\n  const [q, setQ] = React.useState('');\r\n  const [status, setStatus] = React.useState('');\r\n  const [range, setRange] = React.useState('30');\r\n  const [page, setPage] = React.useState(1);\r\n  const [limit] = React.useState(10);\r\n  const [open, setOpen] = React.useState(false);\r\n  const [form, setForm] = React.useState({ sent_to: '', message: '' });\r\n\r\n  const queryClient = useQueryClient();\r\n\r\n  const { data, isLoading } = useQuery(\r\n    ['whatsapp-notices', { projectId, page, limit, q, status, range }],\r\n    async () => {\r\n      if (projectId) {\r\n        const resp = await listNoticesByProject(projectId, { page, limit });\r\n        const rows = Array.isArray(resp?.data) ? resp.data : (resp?.rows || resp || []);\r\n        const total = Number(resp?.total || rows.length || 0);\r\n        return { rows, total };\r\n      } else {\r\n        const resp = await listAllNotices({ page, limit, q, status, range });\r\n        const rows = Array.isArray(resp?.data) ? resp.data : (resp?.rows || resp || []);\r\n        const total = Number(resp?.total || rows.length || 0);\r\n        return { rows, total };\r\n      }\r\n    },\r\n    { keepPreviousData: true }\r\n  );\r\n\r\n  const createMut = useMutation(createNotice, {\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries('whatsapp-notices');\r\n      setOpen(false);\r\n      setForm({ sent_to: '', message: '' });\r\n    }\r\n  });\r\n\r\n  return (\r\n    <ModuloBase titulo=\"Notificaciones WhatsApp\" descripcion=\"Historial y estado de notificaciones enviadas por WhatsApp.\">\r\n      <Toolbar\r\n        compact\r\n        left={(\r\n          <>\r\n            <input className=\"form-control\" style={{ minWidth: 160 }} placeholder=\"ID de proyecto (opcional)\"\r\n                   value={projectId} onChange={e=>{ setProjectId(e.target.value); setPage(1); }} />\r\n            {!projectId && (\r\n              <>\r\n                <input className=\"form-control\" style={{ minWidth: 200 }} placeholder=\"Buscar (destinatario/mensaje)\" value={q} onChange={e=>{ setQ(e.target.value); setPage(1); }} />\r\n                <select className=\"form-select\" value={status} onChange={e=>{ setStatus(e.target.value); setPage(1); }}>\r\n                  <option value=\"\">Todos los estados</option>\r\n                  <option value=\"queued\">En cola</option>\r\n                  <option value=\"sent\">Enviado</option>\r\n                  <option value=\"delivered\">Entregado</option>\r\n                  <option value=\"failed\">Fallido</option>\r\n                </select>\r\n                <select className=\"form-select\" value={range} onChange={e=>{ setRange(e.target.value); setPage(1); }}>\r\n                  <option value=\"7\">Últimos 7 días</option>\r\n                  <option value=\"30\">Últimos 30 días</option>\r\n                  <option value=\"90\">Últimos 90 días</option>\r\n                  <option value=\"all\">Todo</option>\r\n                </select>\r\n              </>\r\n            )}\r\n            <div className=\"text-muted small d-flex align-items-center\">{data?.total || 0} resultados</div>\r\n          </>\r\n        )}\r\n        right={(\r\n          <>\r\n            <button className=\"btn btn-primary\" disabled={!projectId} onClick={()=>setOpen(true)}>+ Enviar aviso</button>\r\n          </>\r\n        )}\r\n      />\r\n      <DataTable\r\n        columns={[\r\n          { header: 'ID', key: 'id', width: 80 },\r\n          { header: 'Destinatario', key: 'sent_to', render: r => r.sent_to || r.to },\r\n          { header: 'Mensaje', key: 'message' },\r\n          { header: 'Estado', key: 'status' },\r\n          { header: 'Fecha', key: 'sent_at', render: r => (r.sent_at ? String(r.sent_at).slice(0,19).replace('T',' ') : (r.created_at ? String(r.created_at).slice(0,19).replace('T',' ') : '—')), width: 160 },\r\n        ]}\r\n        rows={data?.rows || []}\r\n        loading={isLoading}\r\n      />\r\n      <div className=\"d-flex justify-content-between align-items-center mt-2\">\r\n        <div className=\"text-muted small\">Página {page}</div>\r\n        <div className=\"btn-group\">\r\n          <button className=\"btn btn-outline-secondary\" disabled={page<=1 || isLoading} onClick={()=>setPage(p=>Math.max(1,p-1))}>Anterior</button>\r\n          <button className=\"btn btn-outline-secondary\" disabled={(data?.rows?.length||0) < limit || isLoading} onClick={()=>setPage(p=>p+1)}>Siguiente</button>\r\n        </div>\r\n      </div>\r\n\r\n      <Modal open={open} onClose={()=>setOpen(false)}>\r\n        <h5 className=\"mb-2\">Enviar aviso WhatsApp</h5>\r\n        <div className=\"text-muted mb-3\">Proyecto #{projectId}</div>\r\n        <div className=\"mb-2\">\r\n          <label className=\"form-label\">Destinatario</label>\r\n          <input className=\"form-control\" value={form.sent_to} onChange={e=>setForm({ ...form, sent_to: e.target.value })} placeholder=\"Ej. +51999999999\" />\r\n        </div>\r\n        <div className=\"mb-3\">\r\n          <label className=\"form-label\">Mensaje</label>\r\n          <textarea className=\"form-control\" rows={4} value={form.message} onChange={e=>setForm({ ...form, message: e.target.value })} />\r\n        </div>\r\n        <div className=\"d-flex justify-content-end gap-2\">\r\n          <button className=\"btn btn-outline-secondary\" onClick={()=>setOpen(false)}>Cancelar</button>\r\n          <button className=\"btn btn-primary\" disabled={!projectId || !form.sent_to || !form.message || createMut.isLoading}\r\n                  onClick={()=>createMut.mutate({ project_id: Number(projectId), sent_to: form.sent_to, message: form.message })}>\r\n            {createMut.isLoading ? 'Enviando...' : 'Enviar'}\r\n          </button>\r\n        </div>\r\n      </Modal>\r\n    </ModuloBase>\r\n  );\r\n}\r\n"],"names":["listNoticesByProject","project_id","params","sp","qs","path","apiFetch","createNotice","sent_to","message","listAllNotices","NotificacionesWhatsapp","projectId","setProjectId","React","q","setQ","status","setStatus","range","setRange","page","setPage","limit","open","setOpen","form","setForm","queryClient","useQueryClient","data","isLoading","useQuery","resp","rows","total","createMut","useMutation","jsxs","ModuloBase","jsx","Toolbar","Fragment","DataTable","r","p","_a","Modal"],"mappings":"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"}