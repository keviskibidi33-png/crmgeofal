import{r as o,j as e}from"./index-HaxW7Nk-.js";import{M as P}from"./ModuloBase-BOonBI6V.js";import{l as G}from"./quoteVariants-BlLSeZZG.js";import{c as R,a as U}from"./quotes-Dd9vJWvI.js";import{l as X,c as Q}from"./projects-BIJ31CkA.js";function T({value:u,onChange:m}){const[i,g]=o.useState([]),[f,y]=o.useState(!1),[t,d]=o.useState({company_id:"",project_name:"",location:""}),[j,_]=o.useState("");o.useEffect(()=>{(async()=>{try{y(!0);const c=await X({page:1,limit:50}),h=Array.isArray(c==null?void 0:c.data)?c.data:c;g(h||[])}catch{_("No se pudo cargar empresas")}finally{y(!1)}})()},[]);const l=o.useMemo(()=>i.find(c=>String(c.id)===String(t.company_id)),[i,t.company_id]);o.useEffect(()=>{typeof m=="function"&&m({company_id:t.company_id?Number(t.company_id):null,company:l||null,project_name:t.project_name,location:t.location})},[t,l,m]);const p=async()=>{if(!(!t.company_id||!t.project_name))try{const c={company_id:Number(t.company_id),name:t.project_name,location:t.location},h=await Q(c);typeof m=="function"&&m({...u,project_id:h.id,project:h})}catch(c){_(c.message||"No se pudo crear proyecto")}};return e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("h6",{children:"Cliente y Proyecto"}),j&&e.jsx("div",{className:"alert alert-warning py-1 my-2",children:j}),e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsxs("select",{className:"form-select",value:t.company_id,disabled:f,onChange:c=>d({...t,company_id:c.target.value}),children:[e.jsx("option",{value:"",children:"Seleccione..."}),i.map(c=>e.jsxs("option",{value:c.id,children:[c.name," ",c.ruc?`(RUC ${c.ruc})`:""]},c.id))]})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Nombre del proyecto"}),e.jsx("input",{className:"form-control",value:t.project_name,onChange:c=>d({...t,project_name:c.target.value}),placeholder:"Ej. Control de calidad de mezclas"})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx("label",{className:"form-label",children:"Ubicación"}),e.jsx("input",{className:"form-control",value:t.location,onChange:c=>d({...t,location:c.target.value})})]}),e.jsx("div",{className:"col-md-1 d-grid",children:e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:p,disabled:!t.company_id||!t.project_name,children:"Crear"})})]}),l&&e.jsxs("div",{className:"small text-muted mt-2",children:["Contacto: ",l.contact_name," · Tel: ",l.phone," · Email: ",l.email]})]})}const B={company_name:"",ruc:"",contact_name:"",contact_phone:"",contact_email:"",project_location:"",project_name:"",service_name:""},H={request_date:"",issue_date:"",commercial_name:"",payment_terms:"adelantado",acceptance:!1,reference:"",igv:!0},A={code:"",description:"",norm:"",unit_price:0,quantity:1};function C(u){const m=Number(u.unit_price||0),i=Number(u.quantity||0);return Number((m*i).toFixed(2))}function V(u="xxx-XX",m=""){const i=(m||"").toUpperCase().trim()||"NOMBRE DEL CLIENTE";return`Cotización ${u} LEM-GEOFAL-${i}`}const ee=()=>{var I;const[u,m]=o.useState([]),[i,g]=o.useState(""),[f,y]=o.useState(!1),[t,d]=o.useState(B),[j,_]=o.useState({company_id:null,project_id:null,company:null,project:null}),[l,p]=o.useState(H),[c,h]=o.useState([{...A}]),[S,k]=o.useState(!1),[E,w]=o.useState("");o.useEffect(()=>{(async()=>{try{const a=await G({active:!0});m(a||[])}catch{}})()},[]);const b=o.useMemo(()=>c.reduce((a,s)=>a+C(s),0),[c]),v=o.useMemo(()=>l.igv?Number((b*.18).toFixed(2)):0,[b,l.igv]),$=o.useMemo(()=>Number((b+v).toFixed(2)),[b,v]),z=()=>h([...c,{...A}]),L=a=>h(c.filter((s,n)=>n!==a)),N=(a,s)=>h(c.map((n,r)=>r===a?{...n,...s}:n));o.useEffect(()=>{if(!i)return;const a=(u||[]).find(n=>String(n.id)===String(i));if(!a)return;const s=a.conditions||{};if(p(n=>({...n,payment_terms:s.default_payment_terms||n.payment_terms,acceptance:typeof s.default_acceptance=="boolean"?s.default_acceptance:n.acceptance,igv:typeof s.default_igv=="boolean"?s.default_igv:n.igv,reference:s.default_reference||n.reference})),Array.isArray(s.default_items)&&c.length<=1&&!c[0].code&&!c[0].description&&!c[0].norm){const n=s.default_items.map(r=>({code:r.code||"",description:r.description||"",norm:r.norm||"",unit_price:Number(r.unit_price||0),quantity:Number(r.quantity||1)}));n.length&&h(n)}s.default_service_name&&!t.service_name&&d(n=>({...n,service_name:s.default_service_name}))},[i]);const D=async a=>{var s;a.preventDefault(),k(!0),w("");try{const n={project_id:((s=j.project)==null?void 0:s.id)||j.project_id||null,variant_id:i||null,client_contact:t.contact_name,client_email:t.contact_email,client_phone:t.contact_phone,issue_date:l.issue_date||new Date().toISOString().slice(0,10),subtotal:b,igv:v,total:$,status:"borrador",meta:{customer:t,quote:l,payment_terms:l.payment_terms,acceptance:l.acceptance,reference:l.reference,subtotal:b,igv:v,file_name:V("xxx-XX",t.company_name)}},r=await R(n);for(const x of c)await U({quote_id:r.id,code:x.code,description:x.description,norm:x.norm,unit_price:Number(x.unit_price||0),quantity:Number(x.quantity||0),partial_price:C(x)});alert("Cotización creada"),M(r.id)}catch(n){w(n.message||"Error al crear cotización")}finally{k(!1)}},[q,M]=o.useState(null),F=async a=>{try{const s=q;if(!s)return alert("Guarde la cotización antes de exportar");const n="http://localhost:4000/api".replace(/\/$/,"")||"",r=`/api/quotes/${s}/export/${a}`,x=n&&/\/api$/i.test(n)?`${n}${r.replace(/^\/api/,"")}`:`${n}${r}`;window.open(x,"_blank")}catch{alert("No se pudo exportar")}},O=async()=>{try{const a=q;if(!a)return alert("Guarde la cotización antes de generar el borrador");const s="http://localhost:4000/api".replace(/\/$/,"")||"",n=`/api/quotes/${a}/export/pdf-draft`,r=s&&/\/api$/i.test(s)?`${s}${n.replace(/^\/api/,"")}`:`${s}${n}`;window.open(r,"_blank")}catch{alert("No se pudo generar el borrador")}};return e.jsxs(P,{titulo:"Nueva Cotización LEM",descripcion:"Plantilla de cotización para Laboratorio con variantes y condiciones",children:[E&&e.jsx("div",{className:"alert alert-danger",children:E}),e.jsxs("form",{onSubmit:D,children:[e.jsx(T,{value:j,onChange:_}),e.jsxs("div",{className:"row g-3 mt-3",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("h5",{children:"Datos del Cliente"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Empresa"}),e.jsx("input",{className:"form-control",value:t.company_name,onChange:a=>d({...t,company_name:a.target.value}),required:!0})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"R.U.C."}),e.jsx("input",{className:"form-control",value:t.ruc,onChange:a=>d({...t,ruc:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Contacto"}),e.jsx("input",{className:"form-control",value:t.contact_name,onChange:a=>d({...t,contact_name:a.target.value}),required:!0})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Teléfono"}),e.jsx("input",{className:"form-control",value:t.contact_phone,onChange:a=>d({...t,contact_phone:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Correo"}),e.jsx("input",{type:"email",className:"form-control",value:t.contact_email,onChange:a=>d({...t,contact_email:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Ubicación del proyecto"}),e.jsx("input",{className:"form-control",value:t.project_location,onChange:a=>d({...t,project_location:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Nombre del proyecto"}),e.jsx("input",{className:"form-control",value:t.project_name,onChange:a=>d({...t,project_name:a.target.value})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Nombre del servicio"}),e.jsx("input",{className:"form-control",value:t.service_name,onChange:a=>d({...t,service_name:a.target.value})})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("h5",{children:"Datos de la Cotización"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Fecha de Solicitud"}),e.jsx("input",{type:"date",className:"form-control",value:l.request_date,onChange:a=>p({...l,request_date:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Fecha de Emisión"}),e.jsx("input",{type:"date",className:"form-control",value:l.issue_date,onChange:a=>p({...l,issue_date:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Comercial"}),e.jsx("input",{className:"form-control",value:l.commercial_name,onChange:a=>p({...l,commercial_name:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Referencia"}),e.jsx("input",{className:"form-control",placeholder:"SEGÚN LO SOLICITADO VÍA correo / llamada",value:l.reference,onChange:a=>p({...l,reference:a.target.value})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("label",{className:"form-label mb-0",children:"Variante"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>y(!f),children:f?"Ver como lista":"Ver con imágenes"})]}),f?e.jsx("div",{className:"row row-cols-2 g-2 mt-1",children:(u||[]).map(a=>e.jsx("div",{className:"col",children:e.jsxs("button",{type:"button",className:`w-100 btn btn-outline-primary ${String(i)===String(a.id)?"active":""}`,onClick:()=>g(String(a.id)),title:a.title,children:[a.image_url?e.jsx("img",{src:a.image_url,alt:a.title,style:{maxHeight:90,objectFit:"contain",display:"block",margin:"0 auto 6px"}}):null,e.jsxs("div",{className:"small",children:[a.code," - ",a.title]})]})},a.id))}):e.jsxs("select",{className:"form-select mt-2",value:i,onChange:a=>g(a.target.value),children:[e.jsx("option",{value:"",children:"Sin variante"}),(u||[]).map(a=>e.jsxs("option",{value:a.id,children:[a.code," - ",a.title]},a.id))]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Forma de pago"}),e.jsxs("select",{className:"form-select",value:l.payment_terms,onChange:a=>p({...l,payment_terms:a.target.value}),children:[e.jsx("option",{value:"adelantado",children:"Adelantado"}),e.jsx("option",{value:"50%",children:"Adelanto 50% y saldo previo al informe"}),e.jsx("option",{value:"credito7",children:"Crédito 7 días con OS"}),e.jsx("option",{value:"credito15",children:"Crédito 15 días con OS"}),e.jsx("option",{value:"credito30",children:"Crédito 30 días con OS"})]})]}),e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"igv",checked:l.igv,onChange:a=>p({...l,igv:a.target.checked})}),e.jsx("label",{className:"form-check-label",htmlFor:"igv",children:"Aplicar IGV 18%"})]}),e.jsxs("div",{className:"form-check mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"acceptance",checked:l.acceptance,onChange:a=>p({...l,acceptance:a.target.checked})}),e.jsx("label",{className:"form-check-label",htmlFor:"acceptance",children:"Aceptación de cotización"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Nombre de archivo sugerido"}),e.jsx("input",{className:"form-control",value:V("xxx-XX",t.company_name),readOnly:!0})]})]})]}),e.jsx("h5",{className:"mt-3",children:"Ítems"}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-bordered align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código/N° ensayo"}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{children:"Norma"}),e.jsx("th",{children:"Unitario (S/)"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Parcial (S/)"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:c.map((a,s)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("input",{className:"form-control",value:a.code,onChange:n=>N(s,{code:n.target.value})})}),e.jsx("td",{children:e.jsx("textarea",{className:"form-control",rows:1,value:a.description,onChange:n=>N(s,{description:n.target.value})})}),e.jsx("td",{children:e.jsx("input",{className:"form-control",value:a.norm,onChange:n=>N(s,{norm:n.target.value})})}),e.jsx("td",{style:{width:120},children:e.jsx("input",{type:"number",step:"0.01",className:"form-control",value:a.unit_price,onChange:n=>N(s,{unit_price:n.target.value})})}),e.jsx("td",{style:{width:100},children:e.jsx("input",{type:"number",className:"form-control",value:a.quantity,onChange:n=>N(s,{quantity:n.target.value})})}),e.jsx("td",{style:{width:120},children:C(a)}),e.jsx("td",{style:{width:80},children:e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>L(s),disabled:c.length===1,children:"-"})})]},s))})]})}),e.jsx("div",{className:"mb-3",children:e.jsx("button",{type:"button",className:"btn btn-outline-primary",onClick:z,children:"Agregar ítem"})}),e.jsxs("div",{className:"d-flex justify-content-end align-items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"text-end",children:[e.jsxs("div",{children:["Subtotal: S/ ",b.toFixed(2)]}),e.jsxs("div",{children:["IGV 18%: S/ ",v.toFixed(2)]}),e.jsx("div",{children:e.jsxs("strong",{children:["Total: S/ ",$.toFixed(2)]})})]}),e.jsx("button",{type:"submit",className:"btn btn-success",disabled:S||!((I=j.project)!=null&&I.id)&&!j.project_id,children:S?"Guardando...":"Guardar borrador"}),e.jsx("button",{type:"button",className:"btn btn-outline-warning",onClick:O,children:"Guardar PDF Borrador"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>F("pdf"),children:"Exportar PDF"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>F("excel"),children:"Exportar Excel"})]})]})]})};export{ee as default};
//# sourceMappingURL=CotizacionNuevaLEM-C8v0xE6y.js.map
