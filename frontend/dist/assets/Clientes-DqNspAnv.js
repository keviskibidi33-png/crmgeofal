import{r,R as ce,E as de,u as me,c as P,G as M,j as e,H as ue,f as E,B as g,I as pe,h as R,m as T,A as B,n as C,L as he,M as ge,v as Ce,N as be,O as ye}from"./index-VjS0hY4d.js";import{P as xe}from"./PageHeader-s2EwJBI9.js";import{D as fe}from"./DataTable-DC-fV_34.js";import{M as Se}from"./ModalForm-Ccb1MyAk.js";import{S as b}from"./StatsCard-CQWt6EQk.js";import{d as je,c as Ne,u as ve,l as Pe,g as Me,a as Ee}from"./companies-CMTUE1PH.js";import{R as Te,C as y}from"./Row-Ra1wnXQ8.js";import{C as A}from"./Card-Bl_n2eis.js";import"./InputGroup-D28bQjEt.js";import"./Form-f81hzvzI.js";import"./ElementChildren-DGNtIhpN.js";import"./Table-BrpyFtCQ.js";/* empty css                     */import"./Modal-Dz5NhyjX.js";import"./Spinner-CSZmUozg.js";const F=()=>{try{const n=localStorage.getItem("token");if(!n)return null;const i=JSON.parse(atob(n.split(".")[1]));return{id:i.id,name:i.name,role:i.role,email:i.email}}catch(n){return console.error("Error decodificando token:",n),null}},k=n=>{const i=F();return i?(typeof n=="string"&&(n=[n]),n.includes(i.role)):!1},_=()=>k(["admin","jefa_comercial","vendedor_comercial"]),Ae=()=>k(["admin","jefa_comercial","vendedor_comercial"]),Fe=()=>k(["admin","jefa_comercial"]),ke=()=>{const n=F();n?(console.log("üë§ Usuario actual:",{id:n.id,name:n.name,role:n.role,email:n.email}),console.log("üîê Permisos:",{canCreateClient:_(),canEditClient:Ae(),canDeleteClient:Fe()})):console.log("‚ùå No hay usuario autenticado")},J={type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:"",city:"",sector:""};function Ve(){const[n,i]=r.useState(!1),[c,x]=r.useState(null),[Ie,Q]=r.useState(null),m=F(),f=_();ce.useEffect(()=>{ke()},[]);const[S,j]=r.useState(1),[I,$]=r.useState(""),[L,U]=r.useState(""),[D,W]=r.useState(""),[H,K]=r.useState(""),[V,z]=r.useState(!1),N=de(),Y=me(),{data:l,isLoading:Z,refetch:Le}=P(["clients",S,I,L,D,H],()=>Pe({page:S,limit:20,search:I,type:L,city:D,sector:H}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:d,isLoading:h}=P(["clientStats"],Me,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4}),{data:u,isLoading:De}=P(["clientFilterOptions"],Ee,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:6e4,cacheTime:3e5}),v=a=>{N.invalidateQueries("clients"),N.invalidateQueries("clientStats"),N.invalidateQueries("clientFilterOptions"),i(!1),x(null),Q(null)},X=a=>{console.log("üîç handleSearch - B√∫squeda:",a),$(a),j(1),z(!0),setTimeout(()=>z(!1),1e3)},ee=a=>{console.log("üîç handleFilter - Filtros:",a),U(a.type||""),W(a.city||""),K(a.sector||""),j(1)},ae=r.useMemo(()=>{var a,s,t;return u?[{title:"Por Tipo de Cliente",options:((a=u.types)==null?void 0:a.map(o=>({label:`${o.label} (${o.count})`,filter:{type:o.value}})))||[]},{title:"Por Sector",options:((s=u.sectors)==null?void 0:s.map(o=>({label:`${o.label} (${o.count})`,filter:{sector:o.value}})))||[]},{title:"Por Ciudad",options:((t=u.cities)==null?void 0:t.map(o=>({label:`${o.label} (${o.count})`,filter:{city:o.value}})))||[]}]:[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona"}}]}]},[u]),O=M(Ne,{onSuccess:()=>v(),onError:a=>{console.error("Error creating client:",a),console.error("Error details:",{message:a.message,status:a.status,body:a.body})}}),q=M(ve,{onSuccess:()=>v(),onError:a=>console.error("Error updating client:",a)}),se=M(je,{onSuccess:()=>v(),onError:a=>console.error("Error deleting client:",a)}),te=()=>{x(J),i(!0)},w=a=>{x(a),i(!0)},G=a=>{window.confirm(`¬øEst√°s seguro de que quieres eliminar el cliente "${a.name}"?`)&&se.mutate(a.id)},ne=a=>{Y("/proyectos",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city}}})},oe=async a=>{c.id?await q.mutateAsync({id:c.id,...a}):await O.mutateAsync(a)},ie=a=>{const t={empresa:{bg:"primary",text:"Empresa",icon:R},persona:{bg:"info",text:"Persona Natural",icon:T}}[a]||{bg:"secondary",text:a,icon:T},o=t.icon;return e.jsxs(C,{bg:t.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(o,{size:12,className:"me-1"}),t.text]})},re=[{header:"ID",accessor:"id",width:"80px"},{header:"Cliente",accessor:"name",render:(a,s)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.name}),e.jsxs("div",{className:"d-flex align-items-center gap-2 mt-1",children:[ie(s.type),s.ruc&&e.jsxs("small",{className:"text-muted",children:["RUC: ",s.ruc]}),s.dni&&e.jsxs("small",{className:"text-muted",children:["DNI: ",s.dni]})]})]})},{header:"Contacto",accessor:"contact",render:(a,s)=>e.jsxs("div",{children:[s.contact_name&&e.jsx("div",{className:"fw-medium",children:s.contact_name}),s.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(B,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:s.email})]}),s.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(he,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:s.phone})]})]})},{header:"Ciudad",accessor:"city",render:a=>{const s=a||"No especificada";let t="secondary";switch(s){case"Lima":t="primary";break;case"Arequipa":t="info";break;case"Cusco":t="success";break;case"Trujillo":t="warning";break;case"Piura":t="danger";break;case"Chiclayo":t="info";break;case"Iquitos":t="success";break;case"Huancayo":t="warning";break;default:t="secondary"}return e.jsx(C,{bg:t,className:"px-2 py-1",children:s})}},{header:"Sector",accessor:"sector",render:a=>{const s=a||"General";let t="secondary";switch(s){case"Construcci√≥n":t="warning";break;case"Miner√≠a":t="dark";break;case"Ingenier√≠a":t="primary";break;case"Laboratorio":t="info";break;case"Consultor√≠a":t="success";break;case"Tecnolog√≠a":t="primary";break;case"Ambiental":t="success";break;case"Geolog√≠a":t="info";break;default:t="secondary"}return e.jsx(C,{bg:t,className:"px-2 py-1",children:s})}},{header:"Direcci√≥n",accessor:"address",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(ge,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin direcci√≥n"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,s)=>e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(g,{variant:"outline-primary",size:"sm",onClick:()=>w(s),title:"Editar cliente",children:e.jsx(Ce,{size:14})}),e.jsx(g,{variant:"outline-success",size:"sm",onClick:()=>ne(s),title:"Crear proyecto para este cliente",children:e.jsx(be,{size:14})}),e.jsx(g,{variant:"outline-danger",size:"sm",onClick:()=>G(s),title:"Eliminar cliente",children:e.jsx(ye,{size:14})})]})}],le=[{name:"type",label:"Tipo de Cliente",type:"select",required:!0,options:[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}]},{name:"name",label:"Nombre/Raz√≥n Social",type:"text",required:!0,placeholder:"Ingresa el nombre o raz√≥n social"},{name:"ruc",label:"RUC",type:"text",placeholder:"Ingresa el RUC (solo para empresas)",help:"Solo para empresas"},{name:"dni",label:"DNI",type:"text",placeholder:"Ingresa el DNI (solo para personas)",help:"Solo para personas naturales"},{name:"contact_name",label:"Nombre de Contacto",type:"text",placeholder:"Ingresa el nombre del contacto"},{name:"email",label:"Email",type:"email",placeholder:"contacto@empresa.com"},{name:"phone",label:"Tel√©fono",type:"text",placeholder:"+51 999 999 999"},{name:"address",label:"Direcci√≥n",type:"textarea",placeholder:"Ingresa la direcci√≥n completa"},{name:"city",label:"Ciudad",type:"text",placeholder:"Escribe la ciudad (ej: Lima, Arequipa, Cusco...)",autocomplete:!0,suggestions:["Lima","Arequipa","Cusco","Trujillo","Piura","Chiclayo","Iquitos","Huancayo","Tacna","Cajamarca","Ayacucho","Puno","Juliaca","Chimbote","Huaraz","Abancay","Andahuaylas","Tumbes","Pucallpa","Tarapoto","Moyobamba","Cerro de Pasco","Hu√°nuco","Ica","Nazca","Chincha","Ca√±ete","Barranca","Huaral","Callao","Ventanilla","San Juan de Miraflores","Villa El Salvador","San Mart√≠n de Porres","Comas","Los Olivos","San Miguel","Pueblo Libre","Jes√∫s Mar√≠a","Magdalena","San Isidro","Miraflores","Surco","La Molina","Ate","Santa Anita","El Agustino","San Juan de Lurigancho","Lurigancho","Chosica","Chaclacayo","Cieneguilla","Pachac√°mac","Punta Hermosa","Punta Negra","San Bartolo","Santa Mar√≠a del Mar","Pucusana","Asia","Mala","San Vicente de Ca√±ete","Imperial","Nuevo Imperial","Quilman√°","San Luis","San Pedro de Lloc","Pacasmayo","Guadalupe","Jequetepeque","Chep√©n","Cascas","Contumaz√°","Cupisnique","Guzmango","San Benito","San Diego","San Jos√©","San Pablo","Tembladera","Yon√°n","Za√±a","Cajabamba","Cajamarca","Celend√≠n","Chota","Contumaz√°","Cutervo","Hualgayoc","Ja√©n","San Ignacio","San Marcos","San Miguel","San Pablo","Santa Cruz","Bagua","Bongar√°","Condorcanqui","Luya","Rodr√≠guez de Mendoza","Utcubamba","Chachapoyas","Asunci√≥n","Balsas","Cheto","Chiliqu√≠n","Chuquibamba","Granada","Huancas","La Jalca","Leimebamba","Levanto","Magdalena","Mariscal Castilla","Molinopampa","Montevideo","Olleros","Quinjalca","San Francisco de Daguas","San Isidro de Maino","Soloco","Sonche","Abancay","Andahuaylas","Antabamba","Aymaraes","Chincheros","Cotabambas","Grau","Huancarama","Huancaray","Huanipaca","Kishuara","Lambrama","Pacobamba","Pacucha","Pampachiri","Pomacocha","San Antonio de Cachi","San Jer√≥nimo","San Miguel de Chaccrampa","Santa Mar√≠a de Chicmo","Talavera","Tamburco","Andahuaylas","Antabamba","Aymaraes","Chincheros","Cotabambas","Grau","Huancarama","Huancaray","Huanipaca","Kishuara","Lambrama","Pacobamba","Pacucha","Pampachiri","Pomacocha","San Antonio de Cachi","San Jer√≥nimo","San Miguel de Chaccrampa","Santa Mar√≠a de Chicmo","Talavera","Tamburco"]},{name:"sector",label:"Sector",type:"text",placeholder:"Escribe el sector (ej: Construcci√≥n, Miner√≠a, Tecnolog√≠a...)",autocomplete:!0,suggestions:["General","Construcci√≥n","Miner√≠a","Ingenier√≠a","Laboratorio","Consultor√≠a","Tecnolog√≠a","Ambiental","Geolog√≠a","Agricultura","Ganader√≠a","Pesca","Manufactura","Textil","Alimentario","Farmac√©utico","Qu√≠mico","Petroqu√≠mico","Energ√≠a","Electricidad","Gas","Agua","Saneamiento","Transporte","Log√≠stica","Comercio","Retail","Mayorista","Distribuci√≥n","Servicios Financieros","Banca","Seguros","Inversiones","Bienes Ra√≠ces","Inmobiliaria","Turismo","Hoteler√≠a","Restaurantes","Entretenimiento","Medios","Comunicaciones","Telecomunicaciones","Software","Hardware","Sistemas","Internet","E-commerce","Marketing","Publicidad","Educaci√≥n","Capacitaci√≥n","Investigaci√≥n","Desarrollo","Salud","Medicina","Farmac√©utica","Biotecnolog√≠a","Gobierno","P√∫blico","Defensa","Seguridad","Legal","Jur√≠dico","Contable","Auditor√≠a","Recursos Humanos","Administraci√≥n","Gesti√≥n","Consultor√≠a Empresarial","Outsourcing","Servicios Profesionales","Arquitectura","Dise√±o","Arte","Cultura","Deportes","Recreaci√≥n","ONG","Fundaciones","Religioso","Espiritual","Otro"]}],p=r.useMemo(()=>{if(d)return console.log("üìä Stats - Usando estad√≠sticas reales del backend:",d),{total:d.total||0,empresas:d.empresas||0,personas:d.personas||0,conEmail:d.withEmail||0,conTelefono:d.withPhone||0};const a=(l==null?void 0:l.data)||[];return console.log("üìä Stats - Fallback: calculando desde p√°gina actual:",a),{total:a.length,empresas:a.filter(s=>s.type==="empresa").length,personas:a.filter(s=>s.type==="persona").length,conEmail:a.filter(s=>s.email).length,conTelefono:a.filter(s=>s.phone).length}},[d,l]);return e.jsx(ue,{fluid:!0,className:"py-4",children:e.jsxs("div",{className:"fade-in",children:[e.jsx(xe,{title:"Gesti√≥n de Clientes",subtitle:"Crear, editar y gestionar clientes del sistema",icon:E,actions:e.jsxs(g,{variant:"primary",onClick:te,disabled:!f,title:f?"Crear nuevo cliente":`No tienes permisos para crear clientes. Rol actual: ${(m==null?void 0:m.role)||"No autenticado"}`,children:[e.jsx(pe,{className:"me-2"}),"Nuevo Cliente"]})}),!f&&e.jsxs("div",{className:"alert alert-warning mb-4",role:"alert",children:[e.jsx("strong",{children:"‚ö†Ô∏è Permisos insuficientes:"})," Tu rol actual (",(m==null?void 0:m.role)||"No autenticado",") no tiene permisos para crear clientes. Solo los roles ",e.jsx("code",{children:"admin"}),", ",e.jsx("code",{children:"jefa_comercial"})," y ",e.jsx("code",{children:"vendedor_comercial"})," pueden crear clientes."]}),e.jsxs(Te,{className:"g-4 mb-4",children:[e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Total Clientes",value:p.total,icon:E,color:"primary",subtitle:"Clientes registrados",loading:h})}),e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Empresas",value:p.empresas,icon:R,color:"success",subtitle:"Clientes corporativos",loading:h})}),e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Personas",value:p.personas,icon:T,color:"info",subtitle:"Clientes individuales",loading:h})}),e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Con Contacto",value:p.conEmail,icon:B,color:"warning",subtitle:"Con email registrado",loading:h})})]}),e.jsxs(A,{className:"shadow-sm border-0",children:[e.jsx(A.Header,{className:"bg-white border-bottom",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(E,{className:"me-2 text-primary"}),"Lista de Clientes"]}),e.jsxs(C,{bg:"light",text:"dark",className:"px-3 py-2",children:[p.total," clientes"]})]})}),e.jsx(A.Body,{className:"p-0",children:e.jsx(fe,{data:(l==null?void 0:l.data)||[],columns:re,loading:Z||V,onEdit:w,onDelete:G,emptyMessage:"No hay clientes registrados",totalItems:(l==null?void 0:l.total)||0,itemsPerPage:20,currentPage:S,onPageChange:j,onSearch:X,onFilter:ee,filterOptions:ae})})]}),e.jsx(Se,{show:n,onHide:()=>i(!1),title:c!=null&&c.id?"Editar Cliente":"Nuevo Cliente",data:c||J,fields:le,onSubmit:oe,loading:O.isLoading||q.isLoading,submitText:c!=null&&c.id?"Actualizar":"Crear"})]})})}export{Ve as default};
//# sourceMappingURL=Clientes-DqNspAnv.js.map
