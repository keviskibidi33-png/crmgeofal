import{r as n,e as pe,j as e,y as he,$ as be,p as K,F as ce,T as Ne,w as xe}from"./index-CJuzvD_R.js";import{M as fe}from"./ModuloBase-DBccKnGV.js";import{c as ve,a as ge}from"./quotes--DNKAR1T.js";import{h as je,l as Ee}from"./projects-SlGmrIYM.js";import{C as ye}from"./CompanyProjectPicker-DlG0zH3R.js";import{s as Se}from"./subservices-H1tK5RuN.js";import{F as re}from"./Form-CKV1GU6x.js";import{S as Ae}from"./Spinner-BhrlrNe3.js";/* empty css                     */import"./companies-DZeVeHh_.js";import"./ElementChildren-GtC5s3Ff.js";import"./Col-DXGSQkwi.js";const Ce=({value:x="",onChange:b,onSelect:l,placeholder:C="Buscar por código, descripción o norma...",disabled:d=!1,size:g="lg"})=>{var w,P;const[i,R]=n.useState(x),[c,m]=n.useState(!1),[u,E]=n.useState(null),y=n.useRef(null),O=n.useRef(null),[I,F]=n.useState(i);n.useEffect(()=>{const o=setTimeout(()=>{F(i)},300);return()=>clearTimeout(o)},[i]);const{data:j,isLoading:_,error:f}=pe(["subservices-search",I],()=>Se(I),{enabled:I.length>=2,staleTime:5*60*1e3,cacheTime:10*60*1e3}),L=o=>{const N=o.target.value;R(N),m(N.length>=2),b==null||b(N),N.length<2&&(E(null),l==null||l(null))},z=o=>{var N;R(o.display_text),E(o),m(!1),l==null||l(o),(N=y.current)==null||N.blur()},$=()=>{var o;R(""),E(null),m(!1),b==null||b(""),l==null||l(null),(o=y.current)==null||o.focus()},B=o=>{var N;o.key==="Escape"&&(m(!1),(N=y.current)==null||N.blur())};n.useEffect(()=>{const o=N=>{O.current&&!O.current.contains(N.target)&&m(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[]);const V=o=>o===0?"Sujeto a evaluación":`S/ ${o.toFixed(2)}`,M=o=>({"ENSAYO ESTÁNDAR":"primary","ENSAYOS ESPECIALES":"success","ENSAYOS DE CAMPO":"info","ENSAYO AGREGADO":"warning","ENSAYO QUÍMICO SUELO Y AGUA SUBTERRÁNEO":"secondary","ENSAYO QUÍMICO AGREGADO":"dark","ENSAYO CONCRETO":"primary","ENSAYO ALBAÑILERÍA":"success","ENSAYO ROCA":"info","ENSAYO PAVIMENTO":"warning","ENSAYO ASFALTO":"secondary","ENSAYO MEZCLA ASFÁLTICO":"dark","EVALUACIONES ESTRUCTURALES":"primary","IMPLEMENTACIÓN LABORATORIO EN OBRA":"success","OTROS SERVICIOS":"info"})[o]||"light";return e.jsx("div",{className:"position-relative",ref:O,children:e.jsxs(re.Group,{children:[e.jsxs("div",{className:"position-relative",children:[e.jsx(re.Control,{ref:y,type:"text",value:i,onChange:L,onKeyDown:B,onFocus:()=>i.length>=2&&m(!0),placeholder:C,disabled:d,size:g,className:"pe-5"}),e.jsxs("div",{className:"position-absolute top-50 end-0 translate-middle-y pe-3 d-flex align-items-center gap-2",children:[_&&e.jsx(Ae,{animation:"border",size:"sm",variant:"primary"}),!_&&i&&e.jsx(he,{className:"text-muted cursor-pointer",onClick:$,style:{cursor:"pointer"}}),!_&&!i&&e.jsx(be,{className:"text-muted"})]})]}),c&&e.jsxs("div",{className:"position-absolute w-100 bg-white border rounded shadow-lg",style:{top:"100%",zIndex:1050,maxHeight:"300px",overflowY:"auto"},children:[f&&e.jsx("div",{className:"p-3 text-danger",children:e.jsx("small",{children:"Error al buscar subservicios"})}),!f&&((w=j==null?void 0:j.data)==null?void 0:w.length)===0&&e.jsx("div",{className:"p-3 text-muted",children:e.jsx("small",{children:"No se encontraron subservicios"})}),(P=j==null?void 0:j.data)==null?void 0:P.map((o,N)=>e.jsx("div",{className:"p-3 border-bottom cursor-pointer hover-bg-light",onClick:()=>z(o),style:{cursor:"pointer"},onMouseEnter:S=>S.target.style.backgroundColor="#f8f9fa",onMouseLeave:S=>S.target.style.backgroundColor="transparent",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-1",children:[e.jsx(K,{bg:M(o.service_name),className:"small",children:o.codigo}),e.jsx(K,{bg:"outline-secondary",className:"small",children:o.service_name})]}),e.jsx("div",{className:"fw-bold text-dark mb-1",children:o.descripcion}),o.norma&&o.norma!=="-"&&e.jsxs("div",{className:"text-muted small d-flex align-items-center gap-1",children:[e.jsx(ce,{size:12}),o.norma]})]}),e.jsx("div",{className:"text-end",children:e.jsxs("div",{className:"fw-bold text-success d-flex align-items-center gap-1",children:[e.jsx(Ne,{size:14}),V(o.precio)]})})]})},o.id))]}),u&&e.jsx("div",{className:"mt-2 p-2 bg-light rounded border",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx(K,{bg:M(u.service_name),className:"me-2",children:u.codigo}),e.jsx("span",{className:"fw-bold",children:u.descripcion}),u.norma&&u.norma!=="-"&&e.jsxs("div",{className:"text-muted small",children:[e.jsx(ce,{size:12,className:"me-1"}),u.norma]})]}),e.jsxs("div",{className:"text-end",children:[e.jsx("div",{className:"fw-bold text-success",children:V(u.precio)}),e.jsx(xe,{className:"text-success"})]})]})})]})})},_e={company_name:"",ruc:"",contact_name:"",contact_phone:"",contact_email:"",project_location:"",project_name:"",service_name:""},Oe={request_date:"",issue_date:"",commercial_name:"",payment_terms:"adelantado",acceptance:!1,reference:"",reference_type:["email","phone"],igv:!0},oe={code:"",description:"",norm:"",unit_price:0,quantity:1};function X(x){const b=Number(x.unit_price||0),l=Number(x.quantity||0);return Number((b*l).toFixed(2))}const v=(x="")=>(x||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().trim(),J={[v("MUESTRA DE SUELO Y AGREGADO")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá enviar al laboratorio, para los ensayo en suelo y agregados, la cantidad minima de 100 kg por cada muestra.
- El cliente deberá de entregar las muestras debidamente identificadas.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP vigente de acuerdo con el alcance del laboratorio.
- El cliente deberá entregar las muestras en las instalaciones del LEM, ubicado en la Av. Marañón N° 763, Los Olivos, Lima.`,[v("PROBETAS")]:`CONDICIONES ESPECÍFICAS:
- El cliente debe proporcionar las probetas antes del ingreso a obra.
- El cliente deberá de entregar las muestras debidamente identificadas.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP vigente de acuerdo con el alcance del laboratorio.
- El cliente deberá entregar las muestras en las instalaciones del LEM, ubicado en la Av. Marañón N° 763, Los Olivos, Lima.`,[v("DENSIDAD DE CAMPO Y MUESTREO")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá enviar al laboratorio, para los ensayo en suelo y agregados, la cantidad minima de 100 kg por cada muestra.
- Para el ensayo de Densidad de campo, la cantidad de puntos/salida minimo 4 und.
- El cliente deberá de programar el servicio, Densidad de campo, con 24 horas de anticipación.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP vigente de acuerdo con el alcance del laboratorio.
- El cliente deberá entregar las muestras en las instalaciones del LEM, ubicado en la Av. Marañón N° 763, Los Olivos, Lima.`,[v("EXTRACCIÓN DE DIAMANTINA")]:`CONDICIONES ESPECÍFICAS:
- Movilización y desmovilización de equipos y del personal técnico, estara a cargo de GEOFAL.
- Resane de estructura de concreto con sika rep 500 y Sikadur 32, estara a cargo de GEOFAL.
- El servicio no incluye trabajos de acabados como pintura, mayolica y otros.
- El area de trabajo, zona de extracción de diamantina, tiene que estar libre de interferencia.
- La extracción de diamantina se realizara en 2 dia en campo, en laboratorio se realizará el tallado y refrentado de diamantina, el ensayo de resistencia a la compresión de testigo de diamantina se realizara en 5 dias (el tiempo de ensayo obedece a la normativa vigente).
- Costo de resane insumos 250 soles, este costo se distribuira de acuerdo con el numero de perforaciones Donde se hara las extracciones de diamantina`,[v("EXTRACCION DE DIAMANTINA")]:`CONDICIONES ESPECÍFICAS:
- Movilización y desmovilización de equipos y del personal técnico, estara a cargo de GEOFAL.
- Resane de estructura de concreto con sika rep 500 y Sikadur 32, estara a cargo de GEOFAL.
- El servicio no incluye trabajos de acabados como pintura, mayolica y otros.
- El area de trabajo, zona de extracción de diamantina, tiene que estar libre de interferencia.
- La extracción de diamantina se realizara en 2 dia en campo, en laboratorio se realizará el tallado y refrentado de diamantina, el ensayo de resistencia a la compresión de testigo de diamantina se realizara en 5 dias (el tiempo de ensayo obedece a la normativa vigente).
- Costo de resane insumos 250 soles, este costo se distribuira de acuerdo con el numero de perforaciones Donde se hara las extracciones de diamantina`,[v("DIAMANTINA PARA PASES")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá de programar el servicio, Extracción diamantina, con 24 horas de anticipación.
- El area de trabajo, zona de extraccion de diamantina, debera estar libre de interferencia.
- Para extraer la diamantina, se ubicara el acero con un escaneador.
- Movilizacion y desmovilizacion de equipos y del personal tecnico, estara a cargo de Geofal.`,[v("ALBAÑILERÍA")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá enviar al laboratorio, 20 ladrillo de cada tipo, en buen estado y sin presentar fisuras.
- El cliente deberá de entregar las muestras debidamente identificadas.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP vigente de acuerdo con el alcance del laboratorio.
- El cliente deberá entregar las muestras en las instalaciones del LEM, ubicado en la Av. Marañón N° 763, Los Olivos, Lima`,[v("ALBANILERIA")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá enviar al laboratorio, 20 ladrillo de cada tipo, en buen estado y sin presentar fisuras.
- El cliente deberá de entregar las muestras debidamente identificadas.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP vigente de acuerdo con el alcance del laboratorio.
- El cliente deberá entregar las muestras en las instalaciones del LEM, ubicado en la Av. Marañón N° 763, Los Olivos, Lima`,[v("VIGA BECKELMAN")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá de programar el servicio, Ensayo de Deflexión, con 24 horas de anticipación.
- El area de trabajo tiene que estar habilitado.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP o MTC vigente de acuerdo con el alcance del laboratorio.
- Especificar las caracteristicas del camion`,[v("CONTROL DE CALIDAD DE CONCRETO FRESCO EN OBRA")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá de programar el servicio, con 24 horas de anticipación.
- Para el ensayo de control de calidad de concreto fresco en obra, se moldeara 6 probetas, ensayo slump, control de temperatura, en laboratorio las probetas se colocara en camara de curado, el ensayo de compresión de las probetas seran 3 a 7 dias y 3 a 28 dias.
- El control de calidad del concreto fresco se sacara cada 50m3 a uno de los mixer donde se hara todos los ensayos respectivos mencionados, o por dia asi no se halla llegado los 50m3.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP vigente de acuerdo con el alcance del laboratorio.`,[v("CONTROL DE CALIDAD DE CONCRETO FRESCO")]:`CONDICIONES ESPECÍFICAS:
- El cliente deberá de programar el servicio, con 24 horas de anticipación.
- Para el ensayo de control de calidad de concreto fresco en obra, se moldeara 6 probetas, ensayo slump, control de temperatura, en laboratorio las probetas se colocara en camara de curado, el ensayo de compresión de las probetas seran 3 a 7 dias y 3 a 28 dias.
- El control de calidad del concreto fresco se sacara cada 50m3 a uno de los mixer donde se hara todos los ensayos respectivos mencionados, o por dia asi no se halla llegado los 50m3.
- El cliente deberá especificar la Norma a ser utilizada para la ejecución del ensayo, caso contrario se considera Norma ASTM o NTP vigente de acuerdo con el alcance del laboratorio.`},h=x=>{const b=v((x==null?void 0:x.title)||"");if(J[b])return J[b];const l=Object.entries(J).find(([C])=>b.includes(C)||C.includes(b));return l?l[1]:""};function qe(){var ne;const[x,b]=n.useState([]),[l,C]=n.useState(""),[d,g]=n.useState(_e),[i,R]=n.useState({company_id:null,project_id:null,company:null,project:null}),[c,m]=n.useState(Oe),[u,E]=n.useState([{...oe}]),[y,O]=n.useState(!1),[I,F]=n.useState(""),[j,_]=n.useState(""),[f,L]=n.useState(1),[z,$]=n.useState(null),[B,V]=n.useState(!1),[M,w]=n.useState([]),[P,o]=n.useState([]),[N,S]=n.useState(!1),[Ie,Z]=n.useState([]),[De,H]=n.useState([]),[Te,Re]=n.useState(!1),[W,q]=n.useState(""),ee=[{value:"email",label:"📧 Correo electrónico",icon:"📧"},{value:"phone",label:"📞 Llamada telefónica",icon:"📞"},{value:"ticket",label:"🎯 Sistema de tickets",icon:"🎯"},{value:"meeting",label:"🤝 Reunión presencial",icon:"🤝"},{value:"form",label:"📋 Formulario web",icon:"📋"},{value:"referral",label:"👥 Referido",icon:"👥"},{value:"other",label:"📝 Otro",icon:"📝"}];n.useEffect(()=>{(async()=>{try{const s=[]||[];if(s.length>0)b(s);else{const t=[{id:"V1",code:"V1",title:"MUESTRA DE SUELO Y AGREGADO",description:h({title:"MUESTRA DE SUELO Y AGREGADO"})},{id:"V2",code:"V2",title:"PROBETAS",description:h({title:"PROBETAS"})},{id:"V3",code:"V3",title:"DENSIDAD DE CAMPO Y MUESTREO",description:h({title:"DENSIDAD DE CAMPO Y MUESTREO"})},{id:"V4",code:"V4",title:"EXTRACCIÓN DE DIAMANTINA",description:h({title:"EXTRACCIÓN DE DIAMANTINA"})},{id:"V5",code:"V5",title:"DIAMANTINA PARA PASES",description:h({title:"DIAMANTINA PARA PASES"})},{id:"V6",code:"V6",title:"ALBAÑILERÍA",description:h({title:"ALBAÑILERÍA"})},{id:"V7",code:"V7",title:"VIGA BECKELMAN",description:h({title:"VIGA BECKELMAN"})},{id:"V8",code:"V8",title:"CONTROL DE CALIDAD DE CONCRETO FRESCO EN OBRA",description:h({title:"CONTROL DE CALIDAD DE CONCRETO FRESCO EN OBRA"})}];b(t)}}catch{b([{id:"V1",code:"V1",title:"MUESTRA DE SUELO Y AGREGADO",description:h({title:"MUESTRA DE SUELO Y AGREGADO"})},{id:"V2",code:"V2",title:"PROBETAS",description:h({title:"PROBETAS"})},{id:"V3",code:"V3",title:"DENSIDAD DE CAMPO Y MUESTREO",description:h({title:"DENSIDAD DE CAMPO Y MUESTREO"})},{id:"V4",code:"V4",title:"EXTRACCIÓN DE DIAMANTINA",description:h({title:"EXTRACCIÓN DE DIAMANTINA"})},{id:"V5",code:"V5",title:"DIAMANTINA PARA PASES",description:h({title:"DIAMANTINA PARA PASES"})},{id:"V6",code:"V6",title:"ALBAÑILERÍA",description:h({title:"ALBAÑILERÍA"})},{id:"V7",code:"V7",title:"VIGA BECKELMAN",description:h({title:"VIGA BECKELMAN"})},{id:"V8",code:"V8",title:"CONTROL DE CALIDAD DE CONCRETO FRESCO EN OBRA",description:h({title:"CONTROL DE CALIDAD DE CONCRETO FRESCO EN OBRA"})}])}})()},[]),n.useEffect(()=>{(async()=>{try{const a=await je(),t=[...[{service_name:"Ensayos de suelo y agregado",usage_count:0},{service_name:"Extracción de diamantina",usage_count:0},{service_name:"Control de calidad de concreto fresco",usage_count:0},{service_name:"Densidad de campo y muestreo",usage_count:0},{service_name:"Probetas de concreto",usage_count:0},{service_name:"Viga Beckelman",usage_count:0},{service_name:"Albañilería",usage_count:0},{service_name:"Diamantina para pases",usage_count:0},{service_name:"Consultoría geotécnica",usage_count:0},{service_name:"Capacitación técnica",usage_count:0},{service_name:"Auditoría de calidad",usage_count:0},{service_name:"Estudios de suelos",usage_count:0},{service_name:"Análisis de materiales",usage_count:0},{service_name:"Inspección de obras",usage_count:0},{service_name:"Certificación de materiales",usage_count:0}]];a.forEach(r=>{t.find(p=>p.service_name===r.service_name)||t.push(r)}),w(t),o(t)}catch(a){console.warn("No se pudieron cargar servicios existentes:",a);const s=[{service_name:"Ensayos de suelo y agregado",usage_count:0},{service_name:"Extracción de diamantina",usage_count:0},{service_name:"Control de calidad de concreto fresco",usage_count:0},{service_name:"Densidad de campo y muestreo",usage_count:0},{service_name:"Probetas de concreto",usage_count:0}];w(s),o(s)}})()},[]),n.useEffect(()=>{(async()=>{try{const s=(await Ee({page:1,limit:100})).data||[];Z(s),H(s)}catch(a){console.warn("No se pudieron cargar proyectos existentes:",a),Z([]),H([])}})()},[]),n.useEffect(()=>{const a=()=>{const r=document.querySelector(".sidebar");r&&V(r.classList.contains("collapsed"))};a();const s=new MutationObserver(a),t=document.querySelector(".sidebar");return t&&s.observe(t,{attributes:!0,attributeFilter:["class"]}),()=>s.disconnect()},[]),n.useEffect(()=>{i.company&&g(a=>{var s,t;return{...a,company_name:i.company.name||a.company_name,ruc:i.company.ruc||a.ruc,contact_name:i.company.contact_name||a.contact_name,contact_phone:i.company.phone||a.contact_phone,contact_email:i.company.email||a.contact_email,project_location:((s=i.project)==null?void 0:s.location)||a.project_location,project_name:((t=i.project)==null?void 0:t.name)||a.project_name}})},[i.company,i.project]),n.useEffect(()=>{const a=localStorage.getItem("token");if(a)try{const s=JSON.parse(atob(a.split(".")[1]));s.name&&m(t=>({...t,commercial_name:s.name}))}catch(s){console.warn("No se pudo decodificar el token:",s)}},[]),n.useEffect(()=>{if(d.company_name){const a=Y();q(a)}},[d.company_name]),n.useEffect(()=>{if(c.reference_type&&c.reference_type.length>0){const a=Q(c.reference_type);m(s=>({...s,reference:a}))}},[c.reference_type]),n.useEffect(()=>{if(c.reference_type&&c.reference_type.length>0&&!c.reference){const a=Q(c.reference_type);m(s=>({...s,reference:a}))}},[]);const ie=a=>{const s=a.target.value;if(g(t=>({...t,service_name:s})),s.length>0){const t=M.filter(r=>r.service_name.toLowerCase().includes(s.toLowerCase()));o(t),S(!0)}else o(M),S(!1)},le=a=>{g(s=>({...s,service_name:a})),S(!1)},de=()=>{setTimeout(()=>S(!1),200)},Y=()=>{const a=new Date().getFullYear(),s=String(new Date().getMonth()+1).padStart(2,"0"),t=String(new Date().getDate()).padStart(2,"0"),r=`COT-${a}-${s}${t}-${String(Math.floor(Math.random()*1e3)).padStart(3,"0")}`,k=(d.company_name||"CLIENTE").replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s+/g,"_").toUpperCase().substring(0,30);return`${r} LEM-GEOFAL-${k}`},Q=a=>{if(!a||a.length===0)return"SEGÚN LO SOLICITADO";const s=a.map(t=>{const r=ee.find(p=>p.value===t);return r?r.label.replace(/^[^\s]+\s/,""):t});if(s.length===1)return`SEGÚN LO SOLICITADO VÍA ${s[0].toUpperCase()}`;if(s.length===2)return`SEGÚN LO SOLICITADO VÍA ${s[0].toUpperCase()} / ${s[1].toUpperCase()}`;{const t=s.pop();return`SEGÚN LO SOLICITADO VÍA ${s.join(", ").toUpperCase()} Y ${t.toUpperCase()}`}},D=n.useMemo(()=>u.reduce((a,s)=>a+X(s),0),[u]),G=n.useMemo(()=>c.igv?Number((D*.18).toFixed(2)):0,[D,c.igv]),ae=n.useMemo(()=>Number((D+G).toFixed(2)),[D,G]),me=()=>E([...u,{...oe}]),ue=a=>E(u.filter((s,t)=>t!==a)),T=(a,s)=>E(u.map((t,r)=>r===a?{...t,...s}:t));n.useEffect(()=>{if(!l)return;const a=(x||[]).find(r=>String(r.id)===String(l));if(!a)return;const s=a.conditions||{};m(r=>({...r,payment_terms:s.default_payment_terms||r.payment_terms,acceptance:typeof s.default_acceptance=="boolean"?s.default_acceptance:r.acceptance,igv:typeof s.default_igv=="boolean"?s.default_igv:r.igv,reference:s.default_reference||r.reference}));const t=h(a)||a.description||"";if(t&&_(t),Array.isArray(s.default_items)&&u.length<=1&&!u[0].code&&!u[0].description&&!u[0].norm){const r=s.default_items.map(p=>({code:p.code||"",description:p.description||"",norm:p.norm||"",unit_price:Number(p.unit_price||0),quantity:Number(p.quantity||1)}));r.length&&E(r)}s.default_service_name&&!d.service_name&&g(r=>({...r,service_name:s.default_service_name}))},[l]);const se=async a=>{var s;a.preventDefault(),O(!0),F("");try{console.log("🔍 onSubmit - Iniciando creación de cotización..."),console.log("🔍 onSubmit - Selection:",i),console.log("🔍 onSubmit - Client:",d),console.log("🔍 onSubmit - Quote:",c);const t=((s=i.project)==null?void 0:s.id)||i.project_id;if(!t)throw new Error("Debe seleccionar un proyecto para crear la cotización");console.log("🔍 onSubmit - Project ID validado:",t);const r=/^\d+$/.test(String(l))?Number(l):null,p={project_id:t,variant_id:r,client_contact:d.contact_name,client_email:d.contact_email,client_phone:d.contact_phone,issue_date:c.issue_date||new Date().toISOString().slice(0,10),subtotal:D,igv:G,total:ae,status:"borrador",reference:c.reference,reference_type:JSON.stringify(c.reference_type),meta:JSON.stringify({customer:d,quote:c,conditions_text:j,payment_terms:c.payment_terms,acceptance:c.acceptance,file_name:W||Y()})};console.log("🔍 onSubmit - Payload:",p),console.log("🔍 onSubmit - Meta type:",typeof p.meta),console.log("🔍 onSubmit - Reference Type type:",typeof p.reference_type),console.log("🔍 onSubmit - Meta content:",p.meta),console.log("🔍 onSubmit - Reference Type content:",p.reference_type);const k=await ve(p);console.log("✅ onSubmit - Cotización creada:",k);for(const A of u)A.code&&A.description&&await ge({quote_id:k.id,code:A.code,description:A.description,norm:A.norm,unit_price:Number(A.unit_price||0),quantity:Number(A.quantity||0),partial_price:X(A)});alert("Cotización creada exitosamente"),$(k.id)}catch(t){console.error("❌ onSubmit - Error:",t),F(t.message||"Error al crear cotización")}finally{O(!1)}},U=async a=>{try{const s=z;if(!s)return alert("Guarde la cotización antes de exportar");const t="http://localhost:4000/api".replace(/\/$/,"")||"",r=`/api/quotes/${s}/export/${a}`,p=t&&/\/api$/i.test(t)?`${t}${r.replace(/^\/api/,"")}`:`${t}${r}`;window.open(p,"_blank")}catch{alert("No se pudo exportar")}},te=async()=>{try{const a=z;if(!a)return alert("Guarde la cotización antes de generar el borrador");const s="http://localhost:4000/api".replace(/\/$/,"")||"",t=`/api/quotes/${a}/export/pdf-draft`,r=s&&/\/api$/i.test(s)?`${s}${t.replace(/^\/api/,"")}`:`${s}${t}`;window.open(r,"_blank")}catch{alert("No se pudo generar el borrador")}};return e.jsxs(fe,{titulo:"Nueva Cotización LEM",descripcion:"Plantilla de cotización para Laboratorio con variantes y condiciones",children:[I&&e.jsx("div",{className:"alert alert-danger",children:I}),e.jsxs("form",{onSubmit:se,className:"lem-quote-page",children:[e.jsx("div",{className:"alert alert-light border mt-3 lem-intro",children:"Completa el formulario para crear una nueva cotización del Laboratorio (LEM). Los campos están agrupados por sección para facilitar el flujo."}),e.jsx("div",{className:"lem-stepper card shadow-sm mt-3",children:e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"d-flex justify-content-between align-items-center lem-steps",children:[{id:1,label:"Cliente y Proyecto"},{id:2,label:"Condiciones"},{id:3,label:"Ítems"},{id:4,label:"Resumen"}].map(a=>e.jsxs("div",{className:`lem-step ${f===a.id?"active":""} ${f>a.id?"done":""}`,onClick:()=>L(a.id),role:"button",children:[e.jsx("div",{className:"lem-step-index",children:a.id}),e.jsx("div",{className:"lem-step-label",children:a.label})]},a.id))})})}),f===1&&e.jsxs("div",{className:"row g-4 mt-3",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card shadow-sm",children:[e.jsxs("div",{className:"card-header py-2",children:[e.jsx("strong",{children:"Proyecto"}),e.jsx("div",{className:"lem-subtitle",children:"Selecciona la empresa y el proyecto al que se asociará la cotización."})]}),e.jsx("div",{className:"card-body",children:e.jsx(ye,{value:i,onChange:R})})]})}),e.jsx("div",{className:"col-md-6",children:e.jsxs("div",{className:"card shadow-sm",children:[e.jsxs("div",{className:"card-header py-2",children:[e.jsx("strong",{children:"Datos del Cliente"}),e.jsx("div",{className:"lem-subtitle",children:"Información del cliente vinculada a esta cotización."}),i.company&&e.jsx("div",{className:"alert alert-info py-1 mt-2 mb-0",children:e.jsx("small",{children:"✅ Datos autocompletados desde la selección de cliente"})})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Empresa"}),e.jsx("input",{className:"form-control",value:d.company_name,onChange:a=>g({...d,company_name:a.target.value}),required:!0}),e.jsx("div",{className:"form-text",children:"Razón social o nombre comercial del cliente."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"R.U.C."}),e.jsx("input",{className:"form-control",value:d.ruc,onChange:a=>g({...d,ruc:a.target.value})}),e.jsx("div",{className:"form-text",children:"RUC de la empresa (si aplica). Para persona natural, deja vacío."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Contacto"}),e.jsx("input",{className:"form-control",value:d.contact_name,onChange:a=>g({...d,contact_name:a.target.value}),required:!0}),e.jsx("div",{className:"form-text",children:"Nombre de la persona que solicita la cotización."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Teléfono"}),e.jsx("input",{className:"form-control",value:d.contact_phone,onChange:a=>g({...d,contact_phone:a.target.value})}),e.jsx("div",{className:"form-text",children:"Teléfono del contacto para coordinaciones."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Correo"}),e.jsx("input",{type:"email",className:"form-control",value:d.contact_email,onChange:a=>g({...d,contact_email:a.target.value})}),e.jsx("div",{className:"form-text",children:"Correo del contacto para envío de la cotización."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Ubicación del proyecto"}),e.jsx("input",{className:"form-control",value:d.project_location,readOnly:!0,style:{backgroundColor:"#f8f9fa",cursor:"not-allowed"}}),e.jsx("div",{className:"form-text",children:"Se actualiza automáticamente desde la selección de arriba"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Nombre del proyecto"}),e.jsx("input",{className:"form-control",value:d.project_name,readOnly:!0,style:{backgroundColor:"#f8f9fa",cursor:"not-allowed"}}),e.jsx("div",{className:"form-text",children:"Se actualiza automáticamente desde la selección de arriba"})]}),e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Nombre del servicio"}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{className:"form-control",value:d.service_name,onChange:ie,onBlur:de,placeholder:"Escriba para buscar servicios existentes..."}),N&&P.length>0&&e.jsx("div",{className:"autocomplete-suggestions position-absolute w-100",style:{zIndex:1e3,top:"100%",left:0},children:P.slice(0,10).map((a,s)=>e.jsxs("div",{className:"list-group-item list-group-item-action py-2 px-3",onClick:()=>le(a.service_name),style:{cursor:"pointer"},children:[e.jsx("div",{className:"fw-medium",children:a.service_name}),e.jsx("small",{className:"text-muted",children:a.usage_count>0?`Usado ${a.usage_count} veces`:"Servicio estándar"})]},s))})]}),e.jsx("div",{className:"form-text",children:"Ej.: Ensayos de suelo y agregado, Extracción de diamantina, etc."})]})]})]})}),e.jsx("div",{className:"col-md-6",children:e.jsxs("div",{className:"card shadow-sm",children:[e.jsxs("div",{className:"card-header py-2",children:[e.jsx("strong",{children:"Datos de la Cotización"}),e.jsx("div",{className:"lem-subtitle",children:"Fechas, referencia y configuración principal."})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Fecha de Solicitud"}),e.jsx("input",{type:"date",className:"form-control",value:c.request_date,onChange:a=>m({...c,request_date:a.target.value})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Fecha de Emisión"}),e.jsx("input",{type:"date",className:"form-control",value:c.issue_date,onChange:a=>m({...c,issue_date:a.target.value})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Comercial"}),e.jsx("input",{className:"form-control",value:c.commercial_name,onChange:a=>m({...c,commercial_name:a.target.value})}),e.jsx("div",{className:"form-text",children:"Nombre del asesor comercial que atiende al cliente."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Referencia"}),e.jsx("div",{className:"mb-2",children:e.jsx("div",{className:"row g-2",children:ee.map(a=>{var s;return e.jsx("div",{className:"col-md-3 col-sm-4 col-6",children:e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:`ref-${a.value}`,checked:((s=c.reference_type)==null?void 0:s.includes(a.value))||!1,onChange:t=>{const r=c.reference_type||[];t.target.checked?m({...c,reference_type:[...r,a.value]}):m({...c,reference_type:r.filter(p=>p!==a.value)})}}),e.jsx("label",{className:"form-check-label",htmlFor:`ref-${a.value}`,children:a.label})]})},a.value)})})}),e.jsxs("div",{className:"input-group",children:[e.jsx("input",{className:"form-control",value:c.reference,onChange:a=>m({...c,reference:a.target.value}),readOnly:!0,style:{backgroundColor:"#f8f9fa",cursor:"not-allowed"}}),e.jsx("button",{className:"btn btn-outline-secondary",type:"button",onClick:()=>{const a=Q(c.reference_type);m(s=>({...s,reference:a}))},title:"Regenerar texto de referencia",children:"🔄"})]}),e.jsx("div",{className:"form-text",children:"Se genera automáticamente basado en las etiquetas seleccionadas. Puedes editarlo si necesitas."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Variante"}),e.jsxs("div",{className:"d-flex gap-2 align-items-center",children:[e.jsxs("select",{className:"form-select",value:l,onChange:a=>C(a.target.value),style:{maxWidth:"70%"},children:[e.jsx("option",{value:"",children:"Sin variante"}),(x||[]).map(a=>e.jsxs("option",{value:a.id,children:[a.code," - ",a.title]},a.id))]}),l?e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{C(""),_("")},children:"Quitar"}):null]}),l?(()=>{const a=(x||[]).find(t=>String(t.id)===String(l));if(!a)return null;const s=h(a)||a.description||"";return e.jsxs("div",{className:"alert alert-info mt-2 p-2",children:[e.jsxs("div",{className:"fw-semibold small",children:[a.code," - ",a.title]}),s?e.jsx("div",{className:"small text-muted",style:{whiteSpace:"pre-line"},children:s}):null]})})():e.jsx("div",{className:"form-text",children:"Selecciona una variante del listado."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Forma de pago"}),e.jsxs("select",{className:"form-select",value:c.payment_terms,onChange:a=>m({...c,payment_terms:a.target.value}),children:[e.jsx("option",{value:"adelantado",children:"Adelantado"}),e.jsx("option",{value:"50%",children:"Adelanto 50% y saldo previo al informe"}),e.jsx("option",{value:"credito7",children:"Crédito 7 días con OS"}),e.jsx("option",{value:"credito15",children:"Crédito 15 días con OS"}),e.jsx("option",{value:"credito30",children:"Crédito 30 días con OS"})]})]}),e.jsxs("div",{className:"form-check mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"igv",checked:c.igv,onChange:a=>m({...c,igv:a.target.checked})}),e.jsx("label",{className:"form-check-label",htmlFor:"igv",children:"Aplicar IGV 18%"})]}),e.jsxs("div",{className:"form-check mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"acceptance",checked:c.acceptance,onChange:a=>m({...c,acceptance:a.target.checked})}),e.jsx("label",{className:"form-check-label",htmlFor:"acceptance",children:"Aceptación de cotización"})]}),e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Nombre de archivo sugerido"}),e.jsxs("div",{className:"input-group",children:[e.jsx("input",{className:"form-control",value:W,onChange:a=>q(a.target.value),placeholder:"Se genera automáticamente..."}),e.jsx("button",{className:"btn btn-outline-secondary",type:"button",onClick:()=>q(Y()),title:"Regenerar nombre automáticamente",children:"🔄"})]}),e.jsx("div",{className:"form-text",children:"Se genera automáticamente basado en el cliente. Puedes editarlo si necesitas."})]})]})]})})]}),f===2&&e.jsxs("div",{className:"card shadow-sm lem-section-gap",children:[e.jsxs("div",{className:"card-header py-2",children:[e.jsx("strong",{children:"Condiciones específicas"}),e.jsx("div",{className:"lem-subtitle",children:"Se auto-completan según la variante; puedes editarlas."})]}),e.jsxs("div",{className:"card-body",children:[e.jsx("textarea",{className:"form-control lem-monospace",rows:8,placeholder:"Aquí aparecerán las condiciones de la variante seleccionada; puedes editarlas si es necesario.",value:j,onChange:a=>_(a.target.value)}),e.jsx("div",{className:"form-text mt-2",children:"Este texto se guardará en la cotización y se usará para PDF/Excel."})]})]}),f===3&&e.jsxs("div",{className:"card shadow-sm mt-4",children:[e.jsxs("div",{className:"card-header py-2",children:[e.jsx("strong",{children:"Ítems"}),e.jsx("div",{className:"lem-subtitle",children:"Detalle de ensayos/servicios cotizados."})]}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-bordered table-striped align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código/N° ensayo"}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{children:"Norma"}),e.jsx("th",{className:"text-right",children:"Unitario (S/)"}),e.jsx("th",{className:"text-right",children:"Cantidad"}),e.jsx("th",{className:"text-right",children:"Parcial (S/)"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:u.map((a,s)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("input",{className:"form-control",value:a.code,onChange:t=>T(s,{code:t.target.value})})}),e.jsx("td",{children:e.jsx(Ce,{value:a.description,onChange:t=>T(s,{description:t}),onSelect:t=>{t&&T(s,{code:t.codigo,description:t.descripcion,norm:t.norma,unit_price:t.precio})},placeholder:"Buscar por código, descripción o norma...",size:"sm"})}),e.jsx("td",{children:e.jsx("input",{className:"form-control",value:a.norm,onChange:t=>T(s,{norm:t.target.value})})}),e.jsx("td",{style:{width:120},children:e.jsx("input",{type:"number",step:"0.01",className:"form-control",value:a.unit_price,onChange:t=>T(s,{unit_price:t.target.value})})}),e.jsx("td",{style:{width:100},children:e.jsx("input",{type:"number",className:"form-control",value:a.quantity,onChange:t=>T(s,{quantity:t.target.value})})}),e.jsx("td",{style:{width:120},children:X(a)}),e.jsx("td",{style:{width:80},children:e.jsx("button",{type:"button",className:"btn btn-sm btn-link text-danger",title:"Eliminar",onClick:()=>ue(s),disabled:u.length===1,children:"🗑️"})})]},s))})]})}),e.jsx("div",{className:"mb-2",children:e.jsx("button",{type:"button",className:"btn btn-outline-primary",onClick:me,children:"Agregar ítem"})})]})]}),f===4&&e.jsxs("div",{className:"card shadow-sm mt-3 mb-2",children:[e.jsxs("div",{className:"card-header py-2",children:[e.jsx("strong",{children:"Resumen y Acciones"}),e.jsx("div",{className:"lem-subtitle",children:"Revisa montos y genera tus archivos."})]}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row align-items-center g-3",children:[e.jsx("div",{className:"col-md",children:e.jsxs("div",{className:"text-md-end",children:[e.jsxs("div",{children:["Subtotal: S/ ",D.toFixed(2)]}),e.jsxs("div",{children:["IGV 18%: S/ ",G.toFixed(2)]}),e.jsx("div",{children:e.jsxs("strong",{children:["Total: S/ ",ae.toFixed(2)]})})]})}),e.jsx("div",{className:"col-md-auto",children:e.jsxs("div",{className:"d-flex flex-wrap gap-2 lem-actions",children:[e.jsx("button",{type:"submit",className:"btn btn-success",disabled:y||!((ne=i.project)!=null&&ne.id)&&!i.project_id,children:y?"Guardando...":"Guardar borrador"}),e.jsx("button",{type:"button",className:"btn btn-outline-warning",onClick:te,children:"PDF Borrador"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>U("pdf"),children:"Exportar PDF"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>U("excel"),children:"Exportar Excel"})]})})]})})]}),e.jsx("div",{className:`lem-sticky-actions ${B?"sidebar-collapsed":""}`,children:e.jsx("div",{className:"lem-action-content",children:e.jsx("div",{className:"container-fluid px-0",children:e.jsxs("div",{className:"row align-items-center",children:[e.jsx("div",{className:"col-md-6",children:e.jsxs("div",{className:"d-flex gap-3",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>L(Math.max(1,f-1)),disabled:f===1,children:"← Anterior"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>f<4?L(f+1):se({preventDefault:()=>{}}),children:f<4?"Siguiente →":y?"Guardando...":"Guardar borrador"})]})}),e.jsx("div",{className:"col-md-6",children:e.jsxs("div",{className:"d-flex gap-2 justify-content-md-end flex-wrap",children:[e.jsx("button",{type:"button",className:"btn btn-outline-warning",onClick:te,children:"📄 PDF Borrador"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>U("pdf"),children:"📋 Exportar PDF"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>U("excel"),children:"📊 Exportar Excel"})]})})]})})})})]})]})}export{qe as default};
//# sourceMappingURL=CotizacionNuevaLEM-Cl52UpkM.js.map
