import{b as v,r,c as E,e as F,x as N,j as e}from"./index-CtKhHIj1.js";import{M as q}from"./ModuloBase-DjqvnsRM.js";import{T as I,a as O}from"./TableEmpty-DpVQ141n.js";import{l as Q}from"./projects-D8ivKETN.js";import{l as T}from"./companies-DISvptRY.js";async function L({page:n=1,limit:m=20,payment_status:i}={}){const c=new URLSearchParams;return c.set("page",n),c.set("limit",m),i&&c.set("payment_status",i),v(`/api/invoices?${c.toString()}`)}async function R(n){return v("/api/invoices",{method:"POST",body:JSON.stringify(n)})}async function B(n,m){return v(`/api/invoices/${n}/status`,{method:"PUT",body:JSON.stringify({payment_status:m})})}const b=[{value:"",label:"Todos"},{value:"pendiente",label:"Pendiente"},{value:"pagado",label:"Pagado"},{value:"vencido",label:"Vencido"}],D=n=>({pendiente:"warning",pagado:"success",vencido:"danger"})[String(n||"").toLowerCase()]||"secondary";function K(){const[n,m]=r.useState({payment_status:""}),[i,c]=r.useState(1),[u]=r.useState(20),[y,V]=r.useState(""),[$,_]=r.useState([]),[p,C]=r.useState([]),S=r.useMemo(()=>{const a=new Map;return p.forEach(t=>a.set(t.id,t)),a},[p]);r.useEffect(()=>{(async()=>{try{const[a,t]=await Promise.all([T({page:1,limit:200}),Q({page:1,limit:500})]);_(Array.isArray(a==null?void 0:a.data)?a.data:a||[]),C(Array.isArray(t==null?void 0:t.data)?t.data:t||[])}catch{}})()},[]);const g=E(),{data:s,isLoading:x}=F(["invoices",{page:i,limit:u,payment_status:n.payment_status||""}],async()=>{const a=await L({page:i,limit:u,payment_status:n.payment_status||void 0}),t=Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a)?a:[],j=Number((a==null?void 0:a.total)||t.length||0);return{rows:t,total:j}},{keepPreviousData:!0}),w=N(({id:a,payment_status:t})=>B(a,t),{onSuccess:()=>g.invalidateQueries("invoices")}),[P,h]=r.useState(!1),[l,o]=r.useState({project_id:"",quote_number:"",received_at:"",payment_due:"",payment_status:"pendiente",amount:""}),M=!l.project_id||!l.quote_number||!l.received_at||!l.payment_due||!l.amount,A=N(a=>R(a),{onSuccess:()=>{g.invalidateQueries("invoices")}}),k=async()=>{try{await A.mutateAsync({...l,amount:Number(l.amount)}),h(!1),o({project_id:"",quote_number:"",received_at:"",payment_due:"",payment_status:"pendiente",amount:""}),c(1)}catch(a){alert(a.message||"No se pudo crear factura")}};return e.jsxs(q,{titulo:"Gestión de Facturas",descripcion:"Listado y gestión de facturas (jefa comercial/admin)",children:[e.jsx(I,{left:e.jsx(e.Fragment,{children:e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Estado de pago"}),e.jsx("select",{className:"form-select",value:n.payment_status,onChange:a=>{c(1),m(t=>({...t,payment_status:a.target.value}))},children:b.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]})}),right:e.jsx(e.Fragment,{children:e.jsx("button",{className:"btn btn-primary",onClick:()=>h(!0),children:"Nueva factura"})})}),y&&e.jsx("div",{className:"alert alert-danger",children:y}),e.jsx("div",{className:"table-responsive mt-2",children:e.jsxs("table",{className:"table table-striped align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Proyecto"}),e.jsx("th",{children:"Quote #"}),e.jsx("th",{children:"Recibida"}),e.jsx("th",{children:"Vence"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Estado"})]})}),e.jsxs("tbody",{children:[((s==null?void 0:s.rows)||[]).map(a=>{var t,j,f;return e.jsxs("tr",{children:[e.jsx("td",{children:a.id}),e.jsx("td",{children:((t=S.get(a.project_id))==null?void 0:t.name)||a.project_id}),e.jsx("td",{children:a.quote_number}),e.jsx("td",{children:(j=a.received_at)==null?void 0:j.slice(0,10)}),e.jsx("td",{children:(f=a.payment_due)==null?void 0:f.slice(0,10)}),e.jsxs("td",{children:["S/ ",Number(a.amount||0).toFixed(2)]}),e.jsx("td",{children:e.jsx("select",{className:`form-select form-select-sm badge-select text-bg-${D(a.payment_status)}`,value:a.payment_status||"",onChange:d=>w.mutate({id:a.id,payment_status:d.target.value}),children:b.filter(d=>d.value!=="").map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))})})]},a.id)}),(!(s!=null&&s.rows)||s.rows.length===0)&&!x&&e.jsx(O,{colSpan:7,label:"Sin facturas"})]})]})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsx("button",{className:"btn btn-outline-secondary",disabled:i===1||x,onClick:()=>c(a=>a-1),children:"Anterior"}),e.jsxs("span",{children:["Página ",i," de ",Math.max(1,Math.ceil(((s==null?void 0:s.total)||0)/u))]}),e.jsx("button",{className:"btn btn-outline-secondary",disabled:i*u>=((s==null?void 0:s.total)||0)||x,onClick:()=>c(a=>a+1),children:"Siguiente"})]}),P&&e.jsx("div",{className:"modal d-block",tabIndex:"-1",role:"dialog",style:{background:"rgba(0,0,0,0.35)"},children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Nueva Factura"}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>h(!1)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Proyecto"}),e.jsxs("select",{className:"form-select",value:l.project_id,onChange:a=>o(t=>({...t,project_id:a.target.value})),children:[e.jsx("option",{value:"",children:"Seleccione"}),p.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{className:"row g-2",children:[e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"Quote #"}),e.jsx("input",{className:"form-control",value:l.quote_number,onChange:a=>o(t=>({...t,quote_number:a.target.value}))})]}),e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"Monto"}),e.jsx("input",{type:"number",className:"form-control",value:l.amount,onChange:a=>o(t=>({...t,amount:a.target.value}))})]})]}),e.jsxs("div",{className:"row g-2 mt-1",children:[e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"Recibida"}),e.jsx("input",{type:"date",className:"form-control",value:l.received_at,onChange:a=>o(t=>({...t,received_at:a.target.value}))})]}),e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"Vence"}),e.jsx("input",{type:"date",className:"form-control",value:l.payment_due,onChange:a=>o(t=>({...t,payment_due:a.target.value}))})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"form-label",children:"Estado"}),e.jsx("select",{className:"form-select",value:l.payment_status,onChange:a=>o(t=>({...t,payment_status:a.target.value})),children:b.filter(a=>a.value!=="").map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>h(!1),children:"Cancelar"}),e.jsx("button",{className:"btn btn-primary",disabled:M,onClick:k,children:"Crear"})]})]})})})]})}export{K as default};
//# sourceMappingURL=Facturas-DWx2KYQW.js.map
