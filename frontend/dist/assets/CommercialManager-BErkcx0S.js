import{b as ke,r as d,c as Z,R as xe,e as $,x as ue,j as e,n as M,k as je,l as U,B as O,o as pe,w as ve,y as Oe,a as Pe,Z as Me,h as ne,G as q,_ as De,V as Ie,F as Re,Y as Ue,A as ze,$ as be,a0 as Be,S as qe,a1 as ge,a2 as $e,p as Je,q as Ve,K as He,m as Qe}from"./index-ACE2z3o6.js";import{a as We,e as Ye,c as Ke,f as Xe,g as Ze}from"./companies-B_TeJKU-.js";import{C as es,a as ss}from"./ClientSuccessModal-Chrj-CQk.js";import{l as Ce}from"./users-kjRovTqt.js";import{M as N}from"./Modal-C3w-lbxe.js";import{S as J}from"./Spinner-CGz_3N-E.js";import{F as s}from"./Form-DLwAlTjb.js";import{A as H}from"./Alert-ChgNCOQW.js";import{R as Q,C as X}from"./Row-DR7Snyel.js";import{C as t}from"./Col-DolGQwSC.js";import{I as ce}from"./InputGroup-DueyeE6m.js";import{T as as}from"./Table-BW8--UG8.js";import"./Card-DrK-EhIU.js";import"./Tabs-DjFA1zi3.js";import"./ElementChildren-DF5xNtl2.js";const oe={async exportClientsCSV(x={}){try{console.log("üìä Exportando clientes a CSV...");const c=await fetch("/api/export/clients/csv",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({filters:x})});if(!c.ok)throw new Error("Error al exportar CSV");const j=await c.blob(),r=window.URL.createObjectURL(j),m=document.createElement("a");return m.href=r,m.download=`clientes_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(r),console.log("‚úÖ CSV exportado exitosamente"),{success:!0}}catch(c){throw console.error("‚ùå Error exportando CSV:",c),c}},async exportClientsJSON(x={}){try{console.log("üìä Exportando clientes a JSON...");const c=await fetch("/api/export/clients/json",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({filters:x})});if(!c.ok)throw new Error("Error al exportar JSON");const j=await c.blob(),r=window.URL.createObjectURL(j),m=document.createElement("a");return m.href=r,m.download=`clientes_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(r),console.log("‚úÖ JSON exportado exitosamente"),{success:!0}}catch(c){throw console.error("‚ùå Error exportando JSON:",c),c}},async getExportStats(x={}){try{console.log("üìä Obteniendo estad√≠sticas de exportaci√≥n...");const c=await ke("/api/export/clients/stats",{method:"POST",body:JSON.stringify({filters:x})});return console.log("‚úÖ Estad√≠sticas obtenidas:",c),c}catch(c){throw console.error("‚ùå Error obteniendo estad√≠sticas:",c),c}}},ts=({show:x,onHide:c,clientId:j,clientName:r,onSuccess:m})=>{const[l,y]=d.useState({name:"",ruc:"",contact_name:"",email:"",phone:"",address:"",city:"",sector:"",priority:"normal",status:"prospeccion",assigned_user_id:null,actividad:"",servicios:""}),[p,E]=d.useState({}),[S,w]=d.useState(!1),b=Z();xe.useEffect(()=>{x||(y({name:"",ruc:"",contact_name:"",email:"",phone:"",address:"",city:"",sector:"",priority:"normal",status:"prospeccion",assigned_user_id:null,actividad:"",servicios:""}),E({}))},[x]);const{data:V,isLoading:f}=$(["client",j],()=>Ye(j),{enabled:!!j&&x,staleTime:0,cacheTime:0,onSuccess:i=>{if(console.log("üìã ClientEditModal - Datos recibidos:",i),i){const o=i.data||i.company||i;console.log("üìã ClientEditModal - Datos procesados:",o),console.log("üìã ClientEditModal - Prioridad recibida:",o.priority),y({name:o.name||"",ruc:o.ruc||"",contact_name:o.contact_name||"",email:o.email||"",phone:o.phone||"",address:o.address||"",city:o.city||"",sector:o.sector||"",priority:o.priority||"normal",status:o.status||"prospeccion",assigned_user_id:o.assigned_user_id||null,actividad:o.actividad||"",servicios:o.servicios||""})}},onError:i=>{console.error("‚ùå ClientEditModal - Error cargando cliente:",i)}}),{data:h,isLoading:_}=$(["users"],()=>Ce(),{enabled:x}),D=(h==null?void 0:h.users)||[],L=ue(i=>We(j,i),{onSuccess:i=>{b.invalidateQueries(["client",j]),b.removeQueries(["client",j]),b.invalidateQueries(["commercial-clients"]),b.invalidateQueries(["commercial-clients-with-totals"]),b.refetchQueries(["commercial-clients-with-totals"]),b.refetchQueries(["clients"]),m&&m(i),c()},onError:i=>{console.error("Error actualizando cliente:",i),alert("‚ùå Error al actualizar cliente")}}),u=i=>{const{name:o,value:A}=i.target;y(G=>({...G,[o]:A})),p[o]&&E(G=>({...G,[o]:""}))},n=()=>{const i={};return l.name.trim()||(i.name="El nombre del cliente es requerido"),l.contact_name.trim()||(i.contact_name="El nombre de contacto es requerido"),l.email&&!/\S+@\S+\.\S+/.test(l.email)&&(i.email="El email no es v√°lido"),E(i),Object.keys(i).length===0},g=async i=>{if(i.preventDefault(),!!n()){w(!0);try{await L.mutateAsync(l)}catch(o){console.error("Error en submit:",o)}finally{w(!1)}}},P=()=>{y({name:"",ruc:"",contact_name:"",email:"",phone:"",address:"",city:"",sector:"",status:"prospeccion",assigned_user_id:null,actividad:"",servicios:""}),E({}),c()},F=[{value:"prospeccion",label:"Prospecci√≥n"},{value:"contactado",label:"Contactado"},{value:"no_contesto",label:"No contest√≥"},{value:"interesado",label:"Interesado"},{value:"pendiente_cotizacion",label:"Pendiente Cotizaci√≥n"},{value:"cotizacion_enviada",label:"Cotizaci√≥n Enviada"},{value:"negociacion",label:"Negociaci√≥n"},{value:"ganado",label:"Ganado"},{value:"perdido",label:"Perdido"}];return f?e.jsx(N,{show:x,onHide:c,size:"lg",children:e.jsxs(N.Body,{className:"text-center py-5",children:[e.jsx(J,{animation:"border"}),e.jsx("p",{className:"mt-3",children:"Cargando datos del cliente..."})]})}):e.jsxs(N,{show:x,onHide:P,size:"lg",children:[e.jsx(N.Header,{closeButton:!0,children:e.jsxs(N.Title,{children:[e.jsx(M,{className:"me-2"}),"Editar Cliente: ",r]})}),e.jsxs(s,{onSubmit:g,children:[e.jsxs(N.Body,{children:[Object.keys(p).length>0&&e.jsxs(H,{variant:"danger",children:[e.jsx("strong",{children:"Por favor corrige los siguientes errores:"}),e.jsx("ul",{className:"mb-0 mt-2",children:Object.entries(p).map(([i,o])=>e.jsx("li",{children:o},i))})]}),e.jsxs(Q,{className:"g-3",children:[e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(je,{className:"me-2"}),"Informaci√≥n B√°sica"]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Nombre del Cliente *"}),e.jsx(s.Control,{type:"text",name:"name",value:l.name,onChange:u,isInvalid:!!p.name,placeholder:"Nombre de la empresa"}),e.jsx(s.Control.Feedback,{type:"invalid",children:p.name})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"RUC"}),e.jsx(s.Control,{type:"text",name:"ruc",value:l.ruc,onChange:u,placeholder:"RUC de la empresa"})]})}),e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3 mt-4",children:[e.jsx(M,{className:"me-2"}),"Informaci√≥n de Contacto"]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Nombre de Contacto *"}),e.jsx(s.Control,{type:"text",name:"contact_name",value:l.contact_name,onChange:u,isInvalid:!!p.contact_name,placeholder:"Nombre del contacto principal"}),e.jsx(s.Control.Feedback,{type:"invalid",children:p.contact_name})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Email"}),e.jsx(s.Control,{type:"email",name:"email",value:l.email,onChange:u,isInvalid:!!p.email,placeholder:"email@empresa.com"}),e.jsx(s.Control.Feedback,{type:"invalid",children:p.email})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Tel√©fono"}),e.jsx(s.Control,{type:"tel",name:"phone",value:l.phone,onChange:u,placeholder:"+51 999 999 999"})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Ciudad"}),e.jsx(s.Control,{type:"text",name:"city",value:l.city,onChange:u,placeholder:"Ciudad"})]})}),e.jsx(t,{md:12,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Direcci√≥n"}),e.jsx(s.Control,{type:"text",name:"address",value:l.address,onChange:u,placeholder:"Direcci√≥n completa"})]})}),e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3 mt-4",children:[e.jsx(U,{className:"me-2"}),"Informaci√≥n Comercial"]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Estado"}),e.jsx(s.Select,{name:"status",value:l.status,onChange:u,children:F.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Asignado a"}),e.jsxs(s.Select,{name:"assigned_user_id",value:l.assigned_user_id||"",onChange:u,disabled:_,children:[e.jsx("option",{value:"",children:"Sin asignar"}),D.map(i=>e.jsxs("option",{value:i.id,children:[i.name," (",i.role,")"]},i.id))]})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Sector"}),e.jsx(s.Control,{type:"text",name:"sector",value:l.sector,onChange:u,placeholder:"Sector de la empresa"}),e.jsx(s.Text,{className:"text-muted",children:"Ejemplo: Laboratorio, Construcci√≥n, Miner√≠a, etc."})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Prioridad"}),e.jsxs(s.Select,{name:"priority",value:l.priority,onChange:u,children:[e.jsx("option",{value:"urgent",children:"URGENTE"}),e.jsx("option",{value:"high",children:"ALTA"}),e.jsx("option",{value:"normal",children:"NORMAL"}),e.jsx("option",{value:"low",children:"BAJA"})]}),e.jsx(s.Text,{className:"text-muted",children:"Nivel de prioridad del cliente"})]})}),e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3 mt-4",children:[e.jsx(U,{className:"me-2"}),"Actividad y Servicios"]})}),e.jsx(t,{md:12,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Actividad Principal"}),e.jsx(s.Control,{as:"textarea",rows:3,name:"actividad",value:l.actividad,onChange:u,placeholder:"Describe la actividad principal de la empresa"}),e.jsx(s.Text,{className:"text-muted",children:"Describe brevemente a qu√© se dedica la empresa"})]})}),e.jsx(t,{md:12,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Servicios"}),e.jsx(s.Control,{as:"textarea",rows:3,name:"servicios",value:l.servicios,onChange:u,placeholder:"Describe los servicios que ofrece o requiere la empresa"}),e.jsx(s.Text,{className:"text-muted",children:"Lista los servicios que ofrece o que necesita la empresa"})]})})]})]}),e.jsxs(N.Footer,{children:[e.jsxs(O,{variant:"secondary",onClick:P,disabled:S,children:[e.jsx(pe,{className:"me-1"}),"Cancelar"]}),e.jsx(O,{variant:"primary",type:"submit",disabled:S,children:S?e.jsxs(e.Fragment,{children:[e.jsx(J,{size:"sm",className:"me-1"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"me-1"}),"Guardar Cambios"]})})]})]})]})},is=({show:x,onHide:c,onSuccess:j})=>{const[r,m]=d.useState({name:"",ruc:"",contact_name:"",email:"",phone:"",address:"",city:"",sector:"",priority:"normal",status:"prospeccion",assigned_user_id:null,actividad:"",servicios:""}),[l,y]=d.useState({}),[p,E]=d.useState(!1),S=Z(),{data:w,isLoading:b}=$(["users"],()=>Ce(),{enabled:x}),V=(w==null?void 0:w.users)||[],f=ue(n=>Ke(n),{onSuccess:n=>{S.invalidateQueries(["commercial-clients"]),S.invalidateQueries(["commercial-clients-with-totals"]),j&&j(n),L()},onError:n=>{console.error("Error creando cliente:",n),alert("‚ùå Error al crear cliente")}}),h=n=>{const{name:g,value:P}=n.target;m(F=>({...F,[g]:P})),l[g]&&y(F=>({...F,[g]:""}))},_=()=>{const n={};return r.name.trim()||(n.name="El nombre del cliente es requerido"),r.contact_name.trim()||(n.contact_name="El nombre de contacto es requerido"),r.email&&!/\S+@\S+\.\S+/.test(r.email)&&(n.email="El email no es v√°lido"),y(n),Object.keys(n).length===0},D=async n=>{if(n.preventDefault(),!!_()){E(!0);try{await f.mutateAsync(r)}catch(g){console.error("Error en submit:",g)}finally{E(!1)}}},L=()=>{m({name:"",ruc:"",contact_name:"",email:"",phone:"",address:"",city:"",sector:"",status:"prospeccion",assigned_user_id:null,actividad:"",servicios:""}),y({}),c()},u=[{value:"prospeccion",label:"Prospecci√≥n"},{value:"interesado",label:"Interesado"},{value:"pendiente_cotizacion",label:"Pendiente Cotizaci√≥n"},{value:"cotizacion_enviada",label:"Cotizaci√≥n Enviada"},{value:"negociacion",label:"Negociaci√≥n"},{value:"ganado",label:"Ganado"},{value:"perdido",label:"Perdido"}];return e.jsxs(N,{show:x,onHide:L,size:"lg",children:[e.jsx(N.Header,{closeButton:!0,children:e.jsxs(N.Title,{children:[e.jsx(Oe,{className:"me-2"}),"Crear Nuevo Cliente"]})}),e.jsxs(s,{onSubmit:D,children:[e.jsxs(N.Body,{children:[Object.keys(l).length>0&&e.jsxs(H,{variant:"danger",children:[e.jsx("strong",{children:"Por favor corrige los siguientes errores:"}),e.jsx("ul",{className:"mb-0 mt-2",children:Object.entries(l).map(([n,g])=>e.jsx("li",{children:g},n))})]}),e.jsxs(Q,{className:"g-3",children:[e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(je,{className:"me-2"}),"Informaci√≥n B√°sica"]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Nombre del Cliente *"}),e.jsx(s.Control,{type:"text",name:"name",value:r.name,onChange:h,isInvalid:!!l.name,placeholder:"Nombre de la empresa"}),e.jsx(s.Control.Feedback,{type:"invalid",children:l.name})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"RUC"}),e.jsx(s.Control,{type:"text",name:"ruc",value:r.ruc,onChange:h,placeholder:"RUC de la empresa"})]})}),e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3 mt-4",children:[e.jsx(M,{className:"me-2"}),"Informaci√≥n de Contacto"]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Nombre de Contacto *"}),e.jsx(s.Control,{type:"text",name:"contact_name",value:r.contact_name,onChange:h,isInvalid:!!l.contact_name,placeholder:"Nombre del contacto principal"}),e.jsx(s.Control.Feedback,{type:"invalid",children:l.contact_name})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Email"}),e.jsx(s.Control,{type:"email",name:"email",value:r.email,onChange:h,isInvalid:!!l.email,placeholder:"email@empresa.com"}),e.jsx(s.Control.Feedback,{type:"invalid",children:l.email})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Tel√©fono"}),e.jsx(s.Control,{type:"tel",name:"phone",value:r.phone,onChange:h,placeholder:"+51 999 999 999"})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Ciudad"}),e.jsx(s.Control,{type:"text",name:"city",value:r.city,onChange:h,placeholder:"Ciudad"})]})}),e.jsx(t,{md:12,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Direcci√≥n"}),e.jsx(s.Control,{type:"text",name:"address",value:r.address,onChange:h,placeholder:"Direcci√≥n completa"})]})}),e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3 mt-4",children:[e.jsx(U,{className:"me-2"}),"Informaci√≥n Comercial"]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Estado"}),e.jsx(s.Select,{name:"status",value:r.status,onChange:h,children:u.map(n=>e.jsx("option",{value:n.value,children:n.label},n.value))})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Asignado a"}),e.jsxs(s.Select,{name:"assigned_user_id",value:r.assigned_user_id||"",onChange:h,disabled:b,children:[e.jsx("option",{value:"",children:"Sin asignar"}),V.map(n=>e.jsxs("option",{value:n.id,children:[n.name," (",n.role,")"]},n.id))]})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Sector"}),e.jsx(s.Control,{type:"text",name:"sector",value:r.sector,onChange:h,placeholder:"Sector de la empresa"}),e.jsx(s.Text,{className:"text-muted",children:"Ejemplo: Laboratorio, Construcci√≥n, Miner√≠a, etc."})]})}),e.jsx(t,{md:6,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Prioridad"}),e.jsxs(s.Select,{name:"priority",value:r.priority,onChange:h,children:[e.jsx("option",{value:"urgent",children:"URGENTE"}),e.jsx("option",{value:"high",children:"ALTA"}),e.jsx("option",{value:"normal",children:"NORMAL"}),e.jsx("option",{value:"low",children:"BAJA"})]}),e.jsx(s.Text,{className:"text-muted",children:"Nivel de prioridad del cliente"})]})}),e.jsx(t,{md:12,children:e.jsxs("h6",{className:"text-primary mb-3 mt-4",children:[e.jsx(U,{className:"me-2"}),"Actividad y Servicios"]})}),e.jsx(t,{md:12,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Actividad Principal"}),e.jsx(s.Control,{as:"textarea",rows:3,name:"actividad",value:r.actividad,onChange:h,placeholder:"Describe la actividad principal de la empresa"}),e.jsx(s.Text,{className:"text-muted",children:"Describe brevemente a qu√© se dedica la empresa"})]})}),e.jsx(t,{md:12,children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"Servicios"}),e.jsx(s.Control,{as:"textarea",rows:3,name:"servicios",value:r.servicios,onChange:h,placeholder:"Describe los servicios que ofrece o requiere la empresa"}),e.jsx(s.Text,{className:"text-muted",children:"Lista los servicios que ofrece o que necesita la empresa"})]})})]})]}),e.jsxs(N.Footer,{children:[e.jsxs(O,{variant:"secondary",onClick:L,disabled:p,children:[e.jsx(pe,{className:"me-1"}),"Cancelar"]}),e.jsx(O,{variant:"success",type:"submit",disabled:p,children:p?e.jsxs(e.Fragment,{children:[e.jsx(J,{size:"sm",className:"me-1"}),"Creando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"me-1"}),"Crear Cliente"]})})]})]})]})},de=x=>x&&x.replace(/\s*\[PRIORIDAD:\s*\w+\]/g,"").replace(/\s*\[URG\]/g,"").replace(/\s*\[ALTA\]/g,"").replace(/\s*\[BAJA\]/g,"").trim()||"General",me={urgent:{label:"URGENTE",variant:"danger",icon:U},high:{label:"ALTA",variant:"warning",icon:be},normal:{label:"NORMAL",variant:"info",icon:M},low:{label:"BAJA",variant:"secondary",icon:ge}},he={prospeccion:{label:"Prospecci√≥n",variant:"primary"},contactado:{label:"Contactado",variant:"info"},no_contesto:{label:"No contest√≥",variant:"warning"},interesado:{label:"Interesado",variant:"info"},pendiente_cotizacion:{label:"Pendiente Cotizaci√≥n",variant:"warning"},cotizacion_enviada:{label:"Cotizaci√≥n Enviada",variant:"secondary"},negociacion:{label:"Negociaci√≥n",variant:"warning"},ganado:{label:"Ganado",variant:"success"},perdido:{label:"Perdido",variant:"danger"}},Ns=()=>{const{user:x}=Pe();Z();const[c,j]=d.useState(1),[r,m]=d.useState(""),[l,y]=d.useState(""),[p,E]=d.useState(""),[S,w]=d.useState(""),[b,V]=d.useState("created_at"),[f,h]=d.useState("desc"),[_,D]=d.useState(!1),[L,u]=d.useState(""),[n,g]=d.useState(!1),[P,F]=d.useState(!1),[i,o]=d.useState(!1),[A,G]=d.useState(null),[Ne,W]=d.useState(!1),[ye,ee]=d.useState(null),[Se,se]=d.useState(!1),{data:T,isLoading:fe,error:ae,refetch:te}=$(["commercial-clients-with-totals",c,r,l,p,S,b,f],()=>Xe({page:c,limit:50,search:r,status:l,priority:p,sector:S,sortBy:b,sortOrder:f}),{keepPreviousData:!0,refetchOnWindowFocus:!0,staleTime:0}),I=(T==null?void 0:T.data)||[],Y=(T==null?void 0:T.totalPages)||1,Ee=(T==null?void 0:T.total)||0,{data:k,isLoading:ls}=$(["company-stats"],()=>Ze(),{staleTime:6e4,onError:a=>{console.error("Error cargando estad√≠sticas:",a)}}),z=xe.useMemo(()=>{if(k&&k.data)return console.log("üìä Stats - Usando estad√≠sticas reales del backend:",k),{total:k.data.total||0,byStatus:k.data.byStatus||{},byPriority:k.data.byPriority||{},bySector:k.data.bySector||{}};if(!I.length)return{total:0,byStatus:{},byPriority:{},bySector:{}};const a={},v={},B={};return I.forEach(C=>{a[C.status]=(a[C.status]||0)+1;const R=C.priority||"normal";v[R]=(v[R]||0)+1;const re=de(C.sector);B[re]=(B[re]||0)+1}),{total:I.length,byStatus:a,byPriority:v,bySector:B}},[k,I]),K=a=>{b===a?h(f==="asc"?"desc":"asc"):(V(a),h("asc"))},we=()=>{m(""),y(""),E(""),w(""),j(1)},ie=async a=>{try{D(!0),u(a);const v={search:r,status:l,sector:S,sortBy:b,sortOrder:f};a==="csv"?await oe.exportClientsCSV(v):a==="json"&&await oe.exportClientsJSON(v),alert(`‚úÖ Datos exportados exitosamente en formato ${a.toUpperCase()}`)}catch(v){console.error("Error en exportaci√≥n:",v),alert(`‚ùå Error al exportar datos: ${v.message}`)}finally{D(!1),u("")}},_e=a=>{G(a),g(!0)},Le=a=>{console.log("üîß CommercialManager - Editando cliente:",{id:a.id,name:a.name,priority:a.priority,status:a.status}),G(a),F(!0)},Fe=()=>{G(null),o(!0)},le=()=>{g(!1),F(!1),o(!1)},Te=()=>{F(!1),G(null)},Ae=a=>{ee(a),se(!1),W(!0)},Ge=a=>{ee(a),se(!0),W(!0)};return fe?e.jsx(X,{fluid:!0,className:"py-4",children:e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx(J,{animation:"border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})})})}):ae?e.jsx(X,{fluid:!0,className:"py-4",children:e.jsxs(H,{variant:"danger",children:[e.jsx(H.Heading,{children:"Error al cargar los datos"}),e.jsx("p",{children:ae.message}),e.jsx(O,{variant:"outline-danger",onClick:()=>te(),children:"Reintentar"})]})}):e.jsx(Me,{roles:["admin","jefa_comercial"],children:e.jsxs("div",{className:"commercial-manager",children:[e.jsxs(X,{fluid:!0,className:"py-4",children:[e.jsx(Q,{className:"mb-4",children:e.jsx(t,{children:e.jsx("div",{className:"excel-header",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"excel-title",children:[e.jsx(ne,{className:"me-2"}),"Panel de Gesti√≥n Comercial"]}),e.jsx("p",{className:"excel-subtitle",children:"Vista completa de todos los clientes y su informaci√≥n de seguimiento"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(O,{variant:"success",onClick:Fe,children:[e.jsx(M,{className:"me-1"}),"Crear Cliente"]}),e.jsxs(q,{children:[e.jsx(q.Toggle,{variant:"outline-primary",disabled:_,className:"d-flex align-items-center",children:_?e.jsxs(e.Fragment,{children:[e.jsx(J,{size:"sm",className:"me-1"}),"Exportando ",L==null?void 0:L.toUpperCase(),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"me-1"}),"Exportar",e.jsx(Ie,{className:"ms-1"})]})}),e.jsxs(q.Menu,{children:[e.jsxs(q.Item,{onClick:()=>ie("csv"),disabled:_,children:[e.jsx(Re,{className:"me-2"}),"Exportar CSV"]}),e.jsxs(q.Item,{onClick:()=>ie("json"),disabled:_,children:[e.jsx(Ue,{className:"me-2"}),"Exportar JSON"]})]})]}),e.jsxs(O,{variant:"primary",onClick:()=>te(),disabled:_,children:[e.jsx(ze,{className:"me-1"}),"Actualizar"]})]})]})})})}),e.jsxs(Q,{className:"mb-4",children:[e.jsx(t,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-primary",children:e.jsx(ne,{size:24})}),e.jsx("h4",{className:"stat-number text-primary",children:z.total}),e.jsx("p",{className:"stat-label",children:"Total Clientes"})]})}),e.jsx(t,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-warning",children:e.jsx(be,{size:24})}),e.jsx("h4",{className:"stat-number text-warning",children:z.byPriority.urgent||0}),e.jsx("p",{className:"stat-label",children:"Urgentes"})]})}),e.jsx(t,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-success",children:e.jsx(Be,{size:24})}),e.jsx("h4",{className:"stat-number text-success",children:z.byStatus.ganado||0}),e.jsx("p",{className:"stat-label",children:"Ganados"})]})}),e.jsx(t,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-info",children:e.jsx(U,{size:24})}),e.jsx("h4",{className:"stat-number text-info",children:z.byStatus.prospeccion||0}),e.jsx("p",{className:"stat-label",children:"En Prospecci√≥n"})]})})]}),e.jsx("div",{className:"excel-filters",children:e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Buscar"}),e.jsxs(ce,{children:[e.jsx(ce.Text,{children:e.jsx(qe,{})}),e.jsx(s.Control,{type:"text",placeholder:"Buscar cliente...",value:r,onChange:a=>m(a.target.value),className:"filter-input"})]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Estado"}),e.jsxs(s.Select,{value:l,onChange:a=>y(a.target.value),className:"filter-input",children:[e.jsx("option",{value:"",children:"Todos los estados"}),Object.entries(he).map(([a,v])=>e.jsx("option",{value:a,children:v.label},a))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Prioridad"}),e.jsxs(s.Select,{value:p,onChange:a=>E(a.target.value),className:"filter-input",children:[e.jsx("option",{value:"",children:"Todas las prioridades"}),Object.entries(me).map(([a,v])=>e.jsx("option",{value:a,children:v.label},a))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Sector"}),e.jsxs(s.Select,{value:S,onChange:a=>w(a.target.value),className:"filter-input",children:[e.jsx("option",{value:"",children:"Todos los sectores"}),Object.keys(z.bySector).map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"¬†"}),e.jsxs(O,{variant:"outline-secondary",onClick:we,className:"filter-input",children:[e.jsx($e,{className:"me-1"}),"Limpiar"]})]})]})}),e.jsxs("div",{className:"excel-table-container",children:[e.jsx("div",{className:"excel-table-header",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsx("h5",{className:"excel-table-title",children:"Lista de Clientes"}),e.jsxs("small",{className:"excel-table-count",children:["Mostrando ",I.length," de ",Ee," clientes"]})]})}),e.jsx("div",{className:"table-responsive",children:e.jsxs(as,{className:"excel-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:`sortable ${b==="name"?f==="asc"?"sort-asc":"sort-desc":""}`,onClick:()=>K("name"),children:"Cliente"}),e.jsx("th",{children:"Contacto"}),e.jsx("th",{className:`sortable ${b==="status"?f==="asc"?"sort-asc":"sort-desc":""}`,onClick:()=>K("status"),children:"Estado"}),e.jsx("th",{children:"Prioridad"}),e.jsx("th",{children:"Sector"}),e.jsx("th",{children:"Actividad"}),e.jsx("th",{children:"Servicios"}),e.jsx("th",{className:`sortable ${b==="created_at"?f==="asc"?"sort-asc":"sort-desc":""}`,onClick:()=>K("created_at"),children:"Fecha Creaci√≥n"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:I.map(a=>{const v=a.priority||"normal",B=de(a.sector),C=me[v],R=he[a.status];return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"cell-client",children:[e.jsx("div",{children:a.name}),e.jsx("small",{className:"text-muted",children:a.ruc&&`RUC: ${a.ruc}`})]})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-contact",children:[e.jsxs("div",{className:"cell-contact-item",children:[e.jsx(M,{className:"cell-contact-icon"}),a.contact_name||"Sin contacto"]}),a.email&&e.jsxs("div",{className:"cell-contact-item",children:[e.jsx(Je,{className:"cell-contact-icon"}),e.jsx("small",{className:"text-muted",style:{cursor:"pointer",color:"#007bff"},onClick:()=>window.open(`mailto:${a.email}`,"_blank"),title:"Abrir en Outlook",children:a.email})]}),a.phone&&e.jsxs("div",{className:"cell-contact-item",children:[e.jsx(Ve,{className:"cell-contact-icon"}),e.jsx("small",{className:"text-muted",style:{cursor:"pointer",color:"#25d366"},onClick:()=>window.open(`https://wa.me/51${a.phone.replace(/\D/g,"")}`,"_blank"),title:"Abrir en WhatsApp",children:a.phone})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`cell-status status-${a.status}`,children:(R==null?void 0:R.label)||a.status})}),e.jsx("td",{children:e.jsxs("span",{className:`cell-priority priority-${v}`,children:[(C==null?void 0:C.icon)&&e.jsx(C.icon,{className:"cell-priority-icon"}),(C==null?void 0:C.label)||v]})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-sector",children:[e.jsx("div",{children:B}),a.city&&e.jsxs("div",{className:"cell-sector-location",children:[e.jsx(He,{className:"cell-contact-icon"}),a.city]})]})}),e.jsx("td",{children:e.jsx("div",{className:"cell-activity",children:a.actividad?e.jsx("div",{className:"cell-activity-content",children:e.jsx("div",{className:"cell-activity-text",title:a.actividad,children:a.actividad.length>50?`${a.actividad.substring(0,50)}...`:a.actividad})}):e.jsx("span",{className:"text-muted",children:"Sin especificar"})})}),e.jsx("td",{children:e.jsx("div",{className:"cell-services",children:a.servicios?e.jsx("div",{className:"cell-services-content",children:e.jsx("div",{className:"cell-services-text",title:a.servicios,children:a.servicios.length>50?`${a.servicios.substring(0,50)}...`:a.servicios})}):e.jsx("span",{className:"text-muted",children:"Sin especificar"})})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-date",children:[e.jsx(ge,{className:"cell-date-icon"}),new Date(a.created_at).toLocaleDateString("es-ES")]})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-actions",children:[e.jsx("button",{className:"cell-action-btn",title:"Ver historial y comentarios",onClick:()=>_e(a),children:e.jsx(Qe,{className:"cell-action-icon"})}),e.jsx("button",{className:"cell-action-btn",title:"Editar cliente",onClick:()=>Le(a),children:e.jsx(M,{className:"cell-action-icon"})})]})})]},a.id)})})]})}),e.jsx("div",{className:"excel-pagination",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsxs("small",{className:"text-muted",children:["P√°gina ",c," de ",Y]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"pagination-btn",onClick:()=>j(a=>Math.max(a-1,1)),disabled:c===1,children:"Anterior"}),e.jsx("button",{className:"pagination-btn",onClick:()=>j(a=>Math.min(a+1,Y)),disabled:c===Y,children:"Siguiente"})]})]})})]})]}),n&&A&&e.jsx(es,{show:n,onHide:le,clientId:A.id,clientName:A.name}),P&&A&&e.jsx(ts,{show:P,onHide:Te,clientId:A.id,clientName:A.name,onSuccess:Ge}),i&&e.jsx(is,{show:i,onHide:le,onSuccess:Ae}),e.jsx(ss,{show:Ne,onHide:()=>W(!1),clientData:ye,isEdit:Se})]})})};export{Ns as default};
//# sourceMappingURL=CommercialManager-BErkcx0S.js.map
