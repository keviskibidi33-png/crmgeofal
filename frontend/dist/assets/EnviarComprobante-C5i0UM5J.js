import{a as De,r as n,b as P,j as e,W as w,B as h,n as ie,a0 as Ee,F as de}from"./index-BlIitoHL.js";import{C as ze,R as p}from"./Row-AGWrTK1L.js";import{C as c}from"./Col-EOfTAxlS.js";import{A as me}from"./Alert-jxPGzPb8.js";import{C as N}from"./Card-DEKILsJ8.js";import{M as F}from"./Modal-dJieHQcT.js";import{F as t}from"./Form-GUezvg6j.js";import{S as qe}from"./Spinner-mZzrAUCv.js";import"./ElementChildren-D0KhXBLv.js";const Oe=()=>{const{user:he}=De(),[Te,Ue]=n.useState(!1),[k,u]=n.useState(null),[I,H]=n.useState(null),[m,O]=n.useState([]),[W,$]=n.useState([]),[S,Y]=n.useState([]),[A,J]=n.useState([]),[g,D]=n.useState([]),[E,z]=n.useState(""),[d,G]=n.useState(null),[K,f]=n.useState(!1),[pe,q]=n.useState(!1),[V,X]=n.useState(!1),[b,M]=n.useState(""),[C,T]=n.useState(""),[y,U]=n.useState(""),[x,B]=n.useState(""),[Z,Q]=n.useState(!1),[j,ue]=n.useState([]),[xe,ee]=n.useState([]),[o,i]=n.useState({quote_id:"",client_name:"",client_email:"",client_phone:"",client_address:"",amount_paid:"",payment_date:"",payment_method:"",payment_proof:null,quote_file:null,project_id:"",description:""});n.useEffect(()=>{je(),ye(),ge(),fe()},[]),n.useEffect(()=>{be()},[S,b,C,y,x]);const je=async()=>{try{console.log("ðŸ” fetchProjects - Llamando a /api/projects"),console.log("ðŸ” fetchProjects - Usuario actual:",he);const s=await P("/api/projects?limit=500");console.log("ðŸ” fetchProjects - Respuesta recibida:",s);const a=(s==null?void 0:s.data)||s||[];console.log("ðŸ” fetchProjects - Lista de proyectos:",a.length,"proyectos"),console.log("ðŸ” fetchProjects - Primeros 3 proyectos:",a.slice(0,3).map(l=>({id:l.id,name:l.name,company_id:l.company_id}))),O(a)}catch(s){console.error("âŒ Error fetching projects:",s),u("Error al cargar los proyectos: "+(s.message||"Error desconocido")),O([])}},ge=async()=>{try{console.log("ðŸ” fetchQuotes - Llamando a /api/quotes/my-quotes");const s=await P("/api/quotes/my-quotes");console.log("ðŸ” fetchQuotes - Respuesta recibida:",s);const a=(s==null?void 0:s.data)||s||[];console.log("ðŸ” fetchQuotes - Lista de cotizaciones:",a.length,"cotizaciones"),console.log("ðŸ” fetchQuotes - Primeras 3 cotizaciones:",a.slice(0,3).map(l=>({id:l.id,quote_number:l.quote_number,client_name:l.client_name}))),Y(a)}catch(s){console.error("âŒ Error fetching quotes:",s),u("Error al cargar las cotizaciones: "+(s.message||"Error desconocido")),Y([])}},fe=async()=>{try{console.log("ðŸ” fetchUsers - Llamando a /api/users");const s=await P("/api/users?limit=100");console.log("ðŸ” fetchUsers - Respuesta recibida:",s);const a=(s==null?void 0:s.data)||s||[];console.log("ðŸ” fetchUsers - Lista de usuarios:",a.length,"usuarios"),ee(a)}catch(s){console.error("âŒ Error fetching users:",s),ee([])}},be=()=>{let s=[...S];if(b.trim()){const a=b.toLowerCase();s=s.filter(l=>{const r=(l.client_name||l.client_contact||"").toLowerCase(),_=(l.quote_number||"").toLowerCase(),L=(l.total||l.total_amount||0).toString();return r.includes(a)||_.includes(a)||L.includes(a)})}C&&(s=s.filter(a=>{const l=new Date(a.created_at),r=new Date(C);return l>=r})),y&&(s=s.filter(a=>{const l=new Date(a.created_at),r=new Date(y);return r.setHours(23,59,59,999),l<=r})),x&&(s=s.filter(a=>a.user_id==x||a.created_by==x)),console.log("ðŸ” applyQuoteFilters - Filtros aplicados:",{search:b,dateFrom:C,dateTo:y,selectedUser:x,totalQuotes:S.length,filteredQuotes:s.length}),ue(s)},Ce=()=>{M(""),T(""),U(""),B(""),Q(!1)},R=s=>{const a=new Date,l=new Date(a);l.setDate(a.getDate()-s),T(l.toISOString().split("T")[0]),U(a.toISOString().split("T")[0]),Q(!0)},ye=async()=>{try{console.log("ðŸ” fetchClients - Llamando a /api/companies");const s=await P("/api/companies?limit=500");console.log("ðŸ” fetchClients - Respuesta recibida:",s);const a=(s==null?void 0:s.data)||s||[];console.log("ðŸ” fetchClients - Lista de clientes:",a.length,"clientes");const l=a.sort((r,_)=>{const L=m.filter(v=>v.company_id===r.id).length;return m.filter(v=>v.company_id===_.id).length-L});console.log("ðŸ” fetchClients - Clientes ordenados:",l.length),console.log("ðŸ” fetchClients - Primeros 3 clientes:",l.slice(0,3).map(r=>({id:r.id,name:r.name,ruc:r.ruc}))),J(l),D(l)}catch(s){console.error("âŒ Error fetching clients:",s),u("Error al cargar los clientes: "+(s.message||"Error desconocido")),J([]),D([])}},_e=s=>{if(console.log("ðŸ” handleClientSearch - TÃ©rmino de bÃºsqueda:",s),console.log("ðŸ” handleClientSearch - Total de clientes:",A.length),z(s),s.trim()==="")D(A),f(!1);else{const a=s.toLowerCase();console.log("ðŸ” handleClientSearch - BÃºsqueda en minÃºsculas:",a);const l=A.filter(r=>{var ne,re,ce;const _=r.name.toLowerCase().includes(a),L=r.name.toLowerCase().split(" "),v=a.split(" ").every(we=>L.some(Fe=>Fe.includes(we))),ae=(ne=r.ruc)==null?void 0:ne.toLowerCase().includes(a),te=(re=r.email)==null?void 0:re.toLowerCase().includes(a),le=(ce=r.phone)==null?void 0:ce.toLowerCase().includes(a),oe=_||v||ae||te||le;return oe&&console.log("âœ… Cliente encontrado:",r.name,"- Match:",{nameMatch:_,nameWordsMatch:v,rucMatch:ae,emailMatch:te,phoneMatch:le}),oe});console.log("ðŸ” handleClientSearch - Resultados encontrados:",l.length),D(l),f(!0)}},ve=s=>{console.log("ðŸ” handleClientSelect - Cliente seleccionado:",s.name,"ID:",s.id),G(s),z(s.name),f(!1),i({...o,client_name:s.name,client_email:s.email||"",client_phone:s.phone||"",client_address:s.address||""}),console.log("ðŸ” handleClientSelect - Total de proyectos disponibles:",m.length),console.log("ðŸ” handleClientSelect - ID del cliente:",s.id),console.log("ðŸ” handleClientSelect - Todos los proyectos con company_id:",m.map(l=>({id:l.id,name:l.name,company_id:l.company_id})));const a=m.filter(l=>l.company_id===s.id);console.log("ðŸ” handleClientSelect - Proyectos encontrados:",a.length),console.log("ðŸ” handleClientSelect - Proyectos del cliente:",a.map(l=>({id:l.id,name:l.name,company_id:l.company_id}))),$(a)},Ne=()=>{console.log("ðŸ” handleClientClear - Limpiando selecciÃ³n de cliente"),G(null),z(""),f(!1),i({...o,client_name:"",client_email:"",client_phone:"",client_address:"",project_id:""}),$([])},Se=s=>{const a=s.target.files[0];a&&i({...o,payment_proof:a})},Le=s=>{const a=s.target.files[0];a&&i({...o,quote_file:a})},se=async s=>{if(s.preventDefault(),!o.payment_proof){u("Debe subir un comprobante de pago");return}try{X(!0),u(null);const a=new FormData;a.append("quote_id",o.quote_id),a.append("client_name",o.client_name),a.append("client_email",o.client_email),a.append("client_phone",o.client_phone),a.append("client_address",o.client_address),a.append("amount_paid",o.amount_paid),a.append("payment_date",o.payment_date),a.append("payment_method",o.payment_method),a.append("description",o.description),a.append("project_id",o.project_id),a.append("payment_proof",o.payment_proof),o.quote_file&&a.append("quote_file",o.quote_file);const l=await P("/api/payment-proofs/upload",{method:"POST",body:a});H("Comprobante de pago enviado exitosamente"),setTimeout(()=>{q(!1),i({quote_id:"",client_name:"",client_email:"",client_phone:"",client_address:"",amount_paid:"",payment_date:"",payment_method:"",payment_proof:null,quote_file:null,project_id:"",description:""}),G(null),z(""),f(!1),M(""),T(""),U(""),B(""),Q(!1)},100)}catch(a){console.error("Error uploading proof:",a),u("Error al enviar el comprobante: "+(a.message||"Error desconocido"))}finally{X(!1)}};return e.jsxs(ze,{fluid:!0,children:[e.jsx(p,{className:"mb-4",children:e.jsxs(c,{children:[e.jsx("h2",{children:"ðŸ“¤ Enviar Comprobante de Pago"}),e.jsx("p",{className:"text-muted",children:"Sube tu comprobante de pago y archivos relacionados para que facturaciÃ³n los revise y apruebe"})]})}),k&&e.jsx(me,{variant:"danger",dismissible:!0,onClose:()=>u(null),children:k}),I&&e.jsx(me,{variant:"success",dismissible:!0,onClose:()=>H(null),children:I}),e.jsx(p,{children:e.jsx(c,{lg:12,children:e.jsxs(N,{children:[e.jsx(N.Header,{children:e.jsxs("h5",{className:"mb-0",children:[e.jsx(w,{className:"me-2"}),"Subir Comprobante de Pago"]})}),e.jsx(N.Body,{children:e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-muted mb-4",children:"Sube tu comprobante de pago y archivos relacionados"}),e.jsxs(h,{variant:"success",size:"lg",onClick:()=>q(!0),children:[e.jsx(w,{className:"me-2"}),"Subir Comprobante de Pago"]}),e.jsx("p",{className:"text-muted mt-3",children:e.jsx("small",{children:"FacturaciÃ³n revisarÃ¡ y aprobarÃ¡ tu comprobante"})})]})})]})})}),e.jsxs(F,{show:pe,onHide:()=>q(!1),size:"lg",children:[e.jsx(F.Header,{closeButton:!0,children:e.jsxs(F.Title,{children:[e.jsx(w,{className:"me-2"}),"Subir Comprobante de Pago"]})}),e.jsx(F.Body,{children:e.jsxs(t,{onSubmit:se,children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(ie,{className:"me-2"}),"Paso 1: Seleccionar Cliente"]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Buscar Cliente"}),e.jsxs("div",{className:"position-relative",children:[e.jsx(t.Control,{type:"text",value:E,onChange:s=>_e(s.target.value),onFocus:()=>f(!0),placeholder:"Buscar por nombre, RUC, email o telÃ©fono...",className:"pe-5"}),d&&e.jsx(h,{variant:"outline-secondary",size:"sm",className:"position-absolute end-0 top-50 translate-middle-y me-2",onClick:Ne,children:"âœ•"})]}),E&&K&&g.length>0&&e.jsxs("div",{className:"border rounded mt-2",style:{maxHeight:"200px",overflowY:"auto"},children:[e.jsx("div",{className:"p-2 bg-light border-bottom",children:e.jsxs("small",{className:"text-muted",children:[g.length," cliente",g.length!==1?"s":""," encontrado",g.length!==1?"s":""]})}),g.map(s=>e.jsxs("div",{className:"p-2 border-bottom cursor-pointer hover-bg-light",onClick:()=>ve(s),style:{cursor:"pointer"},children:[e.jsx("div",{className:"fw-bold",children:s.name}),e.jsxs("small",{className:"text-muted",children:["RUC: ",s.ruc," | Email: ",s.email,s.phone&&` | Tel: ${s.phone}`]}),e.jsx("div",{className:"mt-1",children:e.jsxs("small",{className:"text-success",children:["ðŸ“Š ",m.filter(a=>a.company_id===s.id).length," proyecto",m.filter(a=>a.company_id===s.id).length!==1?"s":""]})})]},s.id))]}),E&&K&&g.length===0&&e.jsx("div",{className:"border rounded mt-2 p-3 text-center",children:e.jsxs("small",{className:"text-muted",children:['No se encontraron clientes con "',E,'"']})}),d&&e.jsxs("div",{className:"mt-2 p-2 bg-light rounded",children:[e.jsx("strong",{children:"Cliente seleccionado:"})," ",d.name,e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["RUC: ",d.ruc," | Email: ",d.email,d.phone&&` | Tel: ${d.phone}`]}),e.jsx("div",{className:"mt-1",children:e.jsxs("small",{className:"text-success",children:["ðŸ“Š ",m.filter(s=>s.company_id===d.id).length," proyecto",m.filter(s=>s.company_id===d.id).length!==1?"s":""," disponible",m.filter(s=>s.company_id===d.id).length!==1?"s":""]})})]})]})]}),d&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(ie,{className:"me-2"}),"Paso 2: InformaciÃ³n del Cliente"]}),e.jsxs(p,{children:[e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Nombre del Cliente"}),e.jsx(t.Control,{type:"text",value:o.client_name,onChange:s=>i({...o,client_name:s.target.value}),placeholder:"Nombre del cliente",required:!0})]})}),e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Email del Cliente"}),e.jsx(t.Control,{type:"email",value:o.client_email,onChange:s=>i({...o,client_email:s.target.value}),placeholder:"email@cliente.com"})]})})]}),e.jsxs(p,{children:[e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"TelÃ©fono del Cliente"}),e.jsx(t.Control,{type:"tel",value:o.client_phone,onChange:s=>i({...o,client_phone:s.target.value}),placeholder:"TelÃ©fono del cliente"})]})}),e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"DirecciÃ³n del Cliente"}),e.jsx(t.Control,{type:"text",value:o.client_address,onChange:s=>i({...o,client_address:s.target.value}),placeholder:"DirecciÃ³n del cliente"})]})})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(Ee,{className:"me-2"}),"Paso 3: InformaciÃ³n del Pago"]}),e.jsx(p,{children:e.jsx(c,{md:12,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"CotizaciÃ³n Asociada"}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"d-flex gap-2 mb-2",children:[e.jsx(t.Control,{type:"text",placeholder:"Buscar cotizaciÃ³n por nÃºmero, cliente o monto...",value:b,onChange:s=>M(s.target.value),style:{flex:1}}),e.jsx(h,{variant:"outline-secondary",onClick:()=>Q(!Z),size:"sm",children:"ðŸ” Filtros"}),(b||C||y||x)&&e.jsx(h,{variant:"outline-danger",onClick:Ce,size:"sm",children:"âœ• Limpiar"})]}),Z&&e.jsxs(N,{className:"mb-3",children:[e.jsx(N.Header,{className:"py-2",children:e.jsx("small",{className:"fw-bold",children:"Filtros Avanzados"})}),e.jsx(N.Body,{className:"py-2",children:e.jsxs(p,{children:[e.jsxs(c,{md:3,children:[e.jsx(t.Label,{className:"small",children:"Fecha Desde"}),e.jsx(t.Control,{type:"date",value:C,onChange:s=>T(s.target.value),size:"sm"})]}),e.jsxs(c,{md:3,children:[e.jsx(t.Label,{className:"small",children:"Fecha Hasta"}),e.jsx(t.Control,{type:"date",value:y,onChange:s=>U(s.target.value),size:"sm"})]}),e.jsxs(c,{md:3,children:[e.jsx(t.Label,{className:"small",children:"Usuario"}),e.jsxs(t.Select,{value:x,onChange:s=>B(s.target.value),size:"sm",children:[e.jsx("option",{value:"",children:"Todos los usuarios"}),xe.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.email,")"]},s.id))]})]}),e.jsxs(c,{md:3,children:[e.jsx(t.Label,{className:"small",children:"Ãšltimos dÃ­as"}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(h,{variant:"outline-primary",size:"sm",onClick:()=>R(7),className:"flex-fill",children:"7d"}),e.jsx(h,{variant:"outline-primary",size:"sm",onClick:()=>R(30),className:"flex-fill",children:"30d"}),e.jsx(h,{variant:"outline-primary",size:"sm",onClick:()=>R(90),className:"flex-fill",children:"90d"})]})]})]})})]}),e.jsxs(t.Select,{value:o.quote_id,onChange:s=>i({...o,quote_id:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar cotizaciÃ³n"}),Array.isArray(j)&&j.map(s=>e.jsxs("option",{value:s.id,children:[s.quote_number||`COT-${s.id}`," - ",s.client_name||s.client_contact," - $",s.total||s.total_amount||0]},s.id))]}),e.jsx("div",{className:"mt-2",children:e.jsx("small",{className:"text-muted",children:j.length>0?e.jsxs(e.Fragment,{children:["ðŸ“Š ",j.length," cotizaciÃ³n",j.length!==1?"es":""," encontrada",j.length!==1?"s":"",S.length!==j.length&&e.jsxs("span",{className:"text-warning ms-2",children:["(de ",S.length," total)"]})]}):e.jsx("span",{className:"text-danger",children:"âŒ No se encontraron cotizaciones con los filtros aplicados"})})})]}),e.jsx(t.Text,{className:"text-muted",children:"Selecciona la cotizaciÃ³n relacionada con este comprobante de pago"})]})})}),e.jsxs(p,{children:[e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Monto Pagado"}),e.jsx(t.Control,{type:"number",step:"0.01",value:o.amount_paid,onChange:s=>i({...o,amount_paid:s.target.value}),placeholder:"0.00",required:!0})]})}),e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Fecha de Pago"}),e.jsx(t.Control,{type:"date",value:o.payment_date,onChange:s=>i({...o,payment_date:s.target.value}),required:!0})]})})]}),e.jsx(p,{children:e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"MÃ©todo de Pago"}),e.jsxs(t.Select,{value:o.payment_method,onChange:s=>i({...o,payment_method:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar mÃ©todo"}),e.jsx("option",{value:"transferencia",children:"Transferencia Bancaria"}),e.jsx("option",{value:"efectivo",children:"Efectivo"}),e.jsx("option",{value:"cheque",children:"Cheque"}),e.jsx("option",{value:"tarjeta",children:"Tarjeta de CrÃ©dito/DÃ©bito"}),e.jsx("option",{value:"otros",children:"Otros"})]})]})})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(de,{className:"me-2"}),"Paso 4: Seleccionar Proyecto"]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Proyecto Asociado"}),d?e.jsxs(t.Select,{value:o.project_id,onChange:s=>i({...o,project_id:s.target.value}),required:!0,children:[e.jsxs("option",{value:"",children:["Seleccionar proyecto de ",d.name]}),Array.isArray(W)&&W.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}):e.jsx("div",{className:"alert alert-info",children:e.jsx("small",{children:"Primero selecciona un cliente para ver sus proyectos"})}),e.jsx(t.Text,{className:"text-muted",children:"Proyecto al que pertenece esta cotizaciÃ³n"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(w,{className:"me-2"}),"Paso 5: Subir Archivos"]}),e.jsxs(p,{children:[e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Archivo de CotizaciÃ³n (PDF/Excel)"}),e.jsx(t.Control,{type:"file",accept:".pdf,.xlsx,.xls",onChange:Le}),e.jsx(t.Text,{className:"text-muted",children:"Archivo de la cotizaciÃ³n enviada al cliente"})]})}),e.jsx(c,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Comprobante de Pago (PDF/Imagen) *"}),e.jsx(t.Control,{type:"file",accept:".pdf,.jpg,.jpeg,.png",onChange:Se,required:!0}),e.jsx(t.Text,{className:"text-muted",children:"Archivo del comprobante de pago (obligatorio)"})]})})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h6",{className:"text-primary mb-3",children:[e.jsx(de,{className:"me-2"}),"Paso 6: InformaciÃ³n Adicional"]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"DescripciÃ³n"}),e.jsx(t.Control,{as:"textarea",rows:3,value:o.description,onChange:s=>i({...o,description:s.target.value}),placeholder:"InformaciÃ³n adicional sobre el pago..."})]})]})]})}),e.jsxs(F.Footer,{children:[e.jsx(h,{variant:"secondary",onClick:()=>q(!1),children:"Cancelar"}),e.jsx(h,{variant:"success",onClick:se,disabled:V,children:V?e.jsxs(e.Fragment,{children:[e.jsx(qe,{animation:"border",size:"sm",className:"me-2"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"me-2"}),"Enviar Comprobante"]})})]})]})]})};export{Oe as default};
//# sourceMappingURL=EnviarComprobante-C5i0UM5J.js.map
