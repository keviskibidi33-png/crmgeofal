import{r as i,j as e,C as ee,f as me,B as u,a0 as se,a2 as ae,J as z,ab as B,m as he,F as xe,ac as ue,ad as pe}from"./index-Cuktr-pt.js";import{M as je}from"./ModuloBase-BhBuNKRm.js";import{g as ge}from"./quotes-B7ZC9qfO.js";import{S as te}from"./Spinner-B39M6lL3.js";import{A as H}from"./Alert-D03HJGca.js";import{M as r}from"./Modal-DX3fBC5J.js";import{F as f}from"./Form-luTHskiS.js";import{C as O}from"./Card-B0ZWfcwD.js";import"./ElementChildren-CA6H3NXv.js";import"./Col-nNxAn9NL.js";const fe=({quoteId:p})=>{const[a,M]=i.useState({primer_contacto:[],aceptacion:[],finalizacion:[]}),[g,y]=i.useState(!0),[F,E]=i.useState(!1),[C,o]=i.useState(""),[I,w]=i.useState(""),[A,J]=i.useState({total:0,primer_contacto:0,aceptacion:0,finalizacion:0}),[U,N]=i.useState(!1),[j,D]=i.useState(""),[x,_]=i.useState(null),[t,n]=i.useState(""),[$,P]=i.useState(!1),[S,ie]=i.useState(""),[ne,R]=i.useState(!1),[v,q]=i.useState(null);i.useEffect(()=>{p&&(G(),L())},[p]);const G=async()=>{try{y(!0),o("");const l="http://localhost:4000/api".replace(/\/api$/,""),d=localStorage.getItem("token"),h=await fetch(`${l}/api/quotes/${p}/evidences`,{headers:{Authorization:`Bearer ${d}`}});if(!h.ok)throw new Error("Error al cargar evidencias");const c=await h.json();M(c.grouped||{primer_contacto:[],aceptacion:[],finalizacion:[]})}catch(s){console.error("Error cargando evidencias:",s),o("No se pudieron cargar las evidencias: "+s.message)}finally{y(!1)}},L=async()=>{try{const l="http://localhost:4000/api".replace(/\/api$/,""),d=localStorage.getItem("token"),h=await fetch(`${l}/api/quotes/${p}/evidences/stats`,{headers:{Authorization:`Bearer ${d}`}});if(h.ok){const c=await h.json();J({total:parseInt(c.total)||0,primer_contacto:parseInt(c.primer_contacto)||0,aceptacion:parseInt(c.aceptacion)||0,finalizacion:parseInt(c.finalizacion)||0})}}catch(s){console.error("Error cargando estadísticas:",s)}},le=s=>{D(s),_(null),n(""),N(!0)},ce=s=>{ie(s),P(!0)},re=s=>{const l=s.target.files[0];if(l){if(!["application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/png","image/jpeg","image/jpg"].includes(l.type)){o("Tipo de archivo no permitido. Solo se aceptan PDF, Excel (.xlsx) e imágenes (PNG, JPG)"),s.target.value="";return}if(l.size>10*1024*1024){o("El archivo es demasiado grande. Tamaño máximo: 10MB"),s.target.value="";return}_(l),o("")}},oe=async()=>{if(!x){o("Por favor selecciona un archivo");return}try{E(!0),o("");const s=new FormData;s.append("file",x),s.append("evidence_type",j),t&&s.append("notes",t);const d="http://localhost:4000/api".replace(/\/api$/,""),h=localStorage.getItem("token"),c=await fetch(`${d}/api/quotes/${p}/evidences`,{method:"POST",headers:{Authorization:`Bearer ${h}`},body:s});if(!c.ok){const b=await c.json();throw new Error(b.message||"Error al subir evidencia")}w("Evidencia subida correctamente"),N(!1),G(),L(),setTimeout(()=>w(""),3e3)}catch(s){console.error("Error subiendo evidencia:",s),o("Error al subir evidencia: "+s.message)}finally{E(!1)}},Q=async(s,l)=>{try{const h="http://localhost:4000/api".replace(/\/api$/,""),c=localStorage.getItem("token"),b=await fetch(`${h}/api/quotes/evidences/${s}/download`,{headers:{Authorization:`Bearer ${c}`}});if(!b.ok)throw new Error("Error al descargar archivo");const m=await b.blob(),Z=window.URL.createObjectURL(m),k=document.createElement("a");k.href=Z,k.download=l,document.body.appendChild(k),k.click(),document.body.removeChild(k),window.URL.revokeObjectURL(Z)}catch(d){console.error("Error descargando evidencia:",d),o("Error al descargar archivo: "+d.message)}},K=s=>{q(s),R(!0)},de=async()=>{if(v)try{const l="http://localhost:4000/api".replace(/\/api$/,""),d=localStorage.getItem("token");if(!(await fetch(`${l}/api/quotes/evidences/${v.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${d}`}})).ok)throw new Error("Error al eliminar evidencia");w("Evidencia eliminada correctamente"),R(!1),q(null),G(),L(),setTimeout(()=>w(""),3e3)}catch(s){console.error("Error eliminando evidencia:",s),o("Error al eliminar evidencia: "+s.message)}},W=()=>{R(!1),q(null)},X=s=>s.includes("pdf")?e.jsx(xe,{className:"text-danger",size:24}):s.includes("image")?e.jsx(ue,{className:"text-success",size:24}):s.includes("excel")||s.includes("spreadsheet")?e.jsx(B,{className:"text-success",size:24}):e.jsx(B,{className:"text-secondary",size:24}),T=s=>s?s<1024?s+" B":s<1024*1024?(s/1024).toFixed(2)+" KB":(s/(1024*1024)).toFixed(2)+" MB":"Desconocido",Y=s=>new Date(s).toLocaleString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),V=(s,l,d,h,c)=>{const b=c.length;return e.jsxs(O,{className:"mb-3 shadow-sm",children:[e.jsxs(O.Header,{className:`bg-${h} text-dark d-flex justify-content-between align-items-center`,children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[d,e.jsx("strong",{children:s}),e.jsx(ee,{bg:"light",text:"dark",children:b})]}),e.jsxs("div",{className:"d-flex gap-2",children:[b>0&&e.jsxs(u,{variant:"outline-secondary",size:"sm",onClick:()=>ce(l),children:[e.jsx(he,{className:"me-1"}),"Ver evidencias"]}),e.jsxs(u,{variant:"light",size:"sm",onClick:()=>le(l),children:[e.jsx(se,{className:"me-1"}),"Subir archivo"]})]})]}),e.jsx(O.Body,{children:c.length===0?e.jsxs("div",{className:"text-center text-muted py-3",children:[e.jsx(B,{size:48,className:"mb-2 opacity-25"}),e.jsx("p",{children:"No hay evidencias cargadas"})]}):e.jsx("div",{className:"evidence-list",children:c.map(m=>e.jsxs("div",{className:"evidence-item d-flex align-items-center justify-content-between p-3 border-bottom",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3 flex-grow-1",children:[X(m.file_type),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{className:"fw-bold",children:m.file_name}),e.jsxs("div",{className:"text-muted small",children:[e.jsx("span",{children:T(m.file_size)}),e.jsx("span",{className:"mx-2",children:"•"}),e.jsx("span",{children:Y(m.uploaded_at)}),m.uploaded_by_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-2",children:"•"}),e.jsxs("span",{children:["Por: ",m.uploaded_by_name]})]})]}),m.notes&&e.jsx("div",{className:"text-muted small mt-1",children:e.jsxs("em",{children:["Nota: ",m.notes]})})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(u,{variant:"outline-primary",size:"sm",onClick:()=>Q(m.id,m.file_name),title:"Descargar",children:e.jsx(ae,{})}),e.jsx(u,{variant:"outline-danger",size:"sm",onClick:()=>K(m),title:"Eliminar",children:e.jsx(z,{})})]})]},m.id))})})]})};return g?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(te,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Cargando evidencias..."})]}):e.jsxs("div",{className:"quote-evidences",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h4",{className:"mb-0",children:"📋 Evidencias de la Cotización"}),e.jsxs(ee,{bg:"info",className:"fs-6",children:["Total: ",A.total," archivo",A.total!==1?"s":""]})]}),C&&e.jsx(H,{variant:"danger",dismissible:!0,onClose:()=>o(""),children:C}),I&&e.jsx(H,{variant:"success",dismissible:!0,onClose:()=>w(""),children:I}),V(" Evidencia de Primer Contacto","primer_contacto","📸","primary",a.primer_contacto),V("Evidencias de Aceptación","aceptacion","✅","success",a.aceptacion),V("Evidencias de Finalización","finalizacion","🏁","warning",a.finalizacion),e.jsxs(r,{show:U,onHide:()=>N(!1),children:[e.jsx(r.Header,{closeButton:!0,children:e.jsxs(r.Title,{children:["Subir Evidencia",j==="primer_contacto"&&" - Primer Contacto 📸",j==="aceptacion"&&" - Aceptación ✅",j==="finalizacion"&&" - Finalización 🏁"]})}),e.jsx(r.Body,{children:e.jsxs(f,{children:[e.jsxs(f.Group,{className:"mb-3",children:[e.jsx(f.Label,{children:"Archivo *"}),e.jsx(f.Control,{type:"file",onChange:re,accept:".pdf,.xlsx,.xls,.png,.jpg,.jpeg"}),e.jsx(f.Text,{className:"text-muted",children:"Formatos permitidos: PDF, Excel (.xlsx), imágenes (PNG, JPG). Tamaño máximo: 10MB"})]}),x&&e.jsxs(H,{variant:"info",children:[e.jsx(me,{className:"me-2"}),"Archivo seleccionado: ",e.jsx("strong",{children:x.name})," (",T(x.size),")"]}),e.jsxs(f.Group,{className:"mb-3",children:[e.jsx(f.Label,{children:"Notas (opcional)"}),e.jsx(f.Control,{as:"textarea",rows:3,value:t,onChange:s=>n(s.target.value),placeholder:"Agrega notas o comentarios sobre esta evidencia..."})]})]})}),e.jsxs(r.Footer,{children:[e.jsx(u,{variant:"secondary",onClick:()=>N(!1),children:"Cancelar"}),e.jsx(u,{variant:"primary",onClick:oe,disabled:!x||F,children:F?e.jsxs(e.Fragment,{children:[e.jsx(te,{animation:"border",size:"sm",className:"me-2"}),"Subiendo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"me-2"}),"Subir Evidencia"]})})]})]}),e.jsxs(r,{show:$,onHide:()=>P(!1),size:"lg",children:[e.jsx(r.Header,{closeButton:!0,children:e.jsxs(r.Title,{children:["Ver Evidencias",S==="primer_contacto"&&" - Primer Contacto 📸",S==="aceptacion"&&" - Aceptación ✅",S==="finalizacion"&&" - Finalización 🏁"]})}),e.jsx(r.Body,{children:a[S]&&a[S].length>0?e.jsx("div",{className:"evidences-view",children:a[S].map(s=>e.jsx("div",{className:"evidence-item-view border rounded p-3 mb-3",children:e.jsxs("div",{className:"d-flex align-items-start justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-start gap-3 flex-grow-1",children:[X(s.file_type),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:s.file_name}),e.jsxs("div",{className:"text-muted small mb-2",children:[e.jsxs("span",{className:"me-3",children:["📏 ",T(s.file_size)]}),e.jsxs("span",{className:"me-3",children:["📅 ",Y(s.uploaded_at)]}),s.uploaded_by_name&&e.jsxs("span",{children:["👤 Por: ",s.uploaded_by_name]})]}),s.notes&&e.jsxs("div",{className:"alert alert-light p-2 mb-0",children:[e.jsx("strong",{className:"small",children:"Notas:"}),e.jsx("div",{className:"small mt-1",children:s.notes})]})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(u,{variant:"outline-primary",size:"sm",onClick:()=>Q(s.id,s.file_name),title:"Descargar",children:e.jsx(ae,{})}),e.jsx(u,{variant:"outline-danger",size:"sm",onClick:()=>K(s),title:"Eliminar",children:e.jsx(z,{})})]})]})},s.id))}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(B,{size:48,className:"text-muted mb-3"}),e.jsx("p",{className:"text-muted",children:"No hay evidencias de este tipo"})]})}),e.jsx(r.Footer,{children:e.jsx(u,{variant:"secondary",onClick:()=>P(!1),children:"Cerrar"})})]}),e.jsxs(r,{show:ne,onHide:W,centered:!0,children:[e.jsx(r.Header,{closeButton:!0,children:e.jsxs(r.Title,{className:"text-danger",children:[e.jsx(z,{className:"me-2"}),"Confirmar Eliminación"]})}),e.jsx(r.Body,{children:e.jsxs("div",{className:"text-center",children:[e.jsx(z,{size:48,className:"text-danger mb-3"}),e.jsx("h5",{children:"¿Estás seguro de que quieres eliminar esta evidencia?"}),v&&e.jsxs("div",{className:"mt-3 p-3 bg-light rounded",children:[e.jsx("strong",{children:"Archivo:"})," ",v.file_name,e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Tamaño: ",T(v.file_size)]}),v.notes&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:[e.jsx("strong",{children:"Notas:"})," ",v.notes]})]})]}),e.jsx("p",{className:"text-muted mt-3",children:"Esta acción no se puede deshacer."})]})}),e.jsxs(r.Footer,{children:[e.jsx(u,{variant:"secondary",onClick:W,children:"Cancelar"}),e.jsxs(u,{variant:"danger",onClick:de,children:[e.jsx(z,{className:"me-1"}),"Eliminar Evidencia"]})]})]})]})};function ze(){const{id:p}=pe(),[a,M]=i.useState(null),[g,y]=i.useState([]),[F,E]=i.useState(!0),[C,o]=i.useState(""),[I,w]=i.useState(!1),[A,J]=i.useState(""),[U,N]=i.useState(!1);i.useEffect(()=>{(async()=>{try{E(!0),o("");const t=await ge(p);let n=null;if(t.meta&&typeof t.meta=="string")try{n=JSON.parse(t.meta)}catch{n=null}else t.meta&&typeof t.meta=="object"&&(n=t.meta);n?(n.customer&&(t.client_company=n.customer.company_name||t.company_name,t.client_ruc=n.customer.ruc||t.company_ruc),n.items?y(n.items):y([])):y([]),M(t)}catch(t){o(t.message||"No se pudo cargar la cotización")}finally{E(!1)}})()},[p]);const j=i.useMemo(()=>a&&a.subtotal?Number(a.subtotal):g.reduce((t,n)=>{const $=n.partial_price||Number(n.unit_price||0)*Number(n.quantity||0);return t+Number($)},0),[g,a]),D=i.useMemo(()=>Number((j*.18).toFixed(2)),[j]),x=i.useMemo(()=>a?typeof a.igv=="number"?Number(a.igv):D:0,[a,D]),_=i.useMemo(()=>Number((j+x).toFixed(2)),[j,x]);return e.jsxs(je,{titulo:`📋 Evidencias - Cotización #${p}`,descripcion:"Gestión de evidencias de la cotización",children:[F&&e.jsx("div",{className:"text-center py-5",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})})}),C&&e.jsx("div",{className:"alert alert-danger",children:C}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card mb-4 shadow-sm",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsx("h5",{className:"mb-0",children:"📄 Información de la Cotización"})}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Razón Social"}),e.jsx("div",{className:"fs-6 fw-bold",children:a.client_company||a.client_contact||"No especificado"}),a.client_ruc&&e.jsxs("small",{className:"text-muted",children:["RUC: ",a.client_ruc]})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Contacto"}),e.jsx("div",{className:"fs-6",children:a.client_contact||"No especificado"}),a.client_email&&e.jsx("small",{className:"text-muted d-block",children:a.client_email}),a.client_phone&&e.jsxs("small",{className:"text-muted",children:["📞 ",a.client_phone]})]}),e.jsxs("div",{className:"col-md-2",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Fecha de Emisión"}),e.jsx("div",{className:"fs-6",children:a.issue_date?new Date(a.issue_date).toLocaleDateString("es-ES"):"No especificada"})]}),e.jsxs("div",{className:"col-md-2",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Estado"}),e.jsx("div",{className:"fs-6",children:e.jsx("span",{className:`badge ${a.status==="aprobado"?"bg-success":a.status==="enviado"?"bg-primary":a.status==="rechazado"?"bg-danger":"bg-secondary"}`,children:a.status==="en_proceso"?"En proceso":a.status==="enviado"?"Enviado":a.status==="aprobado"?"Aprobado":a.status==="rechazado"?"Rechazado":a.status})})]})]}),e.jsxs("div",{className:"row g-3 mt-2",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Cantidad de Ítems"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsxs("div",{className:"fs-6",children:[g.length," ítem",g.length!==1?"s":""]}),g.length>0&&e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"showItems",checked:U,onChange:t=>N(t.target.checked)}),e.jsx("label",{className:"form-check-label small",htmlFor:"showItems",children:"Ver detalles"})]})]})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Total"}),e.jsxs("div",{className:"fs-5 fw-bold text-success",children:["S/ ",_.toFixed(2)]}),e.jsxs("small",{className:"text-muted",children:["IGV: S/ ",x.toFixed(2)]})]}),a.reference&&e.jsxs("div",{className:"col-md-7",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Referencia"}),e.jsx("div",{className:"fs-6",children:a.reference})]})]}),g.length>0&&U&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("strong",{className:"text-muted small",children:"Ítems de la Cotización"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>N(!1),children:"Ocultar"})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"10%"},children:"Código"}),e.jsx("th",{style:{width:"40%"},children:"Descripción"}),e.jsx("th",{style:{width:"15%"},children:"Norma"}),e.jsx("th",{style:{width:"12%"},children:"P. Unit."}),e.jsx("th",{style:{width:"8%"},children:"Cant."}),e.jsx("th",{style:{width:"15%"},className:"text-end",children:"Parcial"})]})}),e.jsx("tbody",{children:g.map((t,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("small",{children:t.code||"-"})}),e.jsx("td",{children:e.jsx("small",{children:t.description||"-"})}),e.jsx("td",{children:e.jsx("small",{children:t.norm||"-"})}),e.jsx("td",{children:e.jsxs("small",{children:["S/ ",Number(t.unit_price||0).toFixed(2)]})}),e.jsx("td",{children:e.jsx("small",{children:t.quantity||0})}),e.jsx("td",{className:"text-end",children:e.jsxs("small",{className:"fw-bold",children:["S/ ",(Number(t.unit_price||0)*Number(t.quantity||0)).toFixed(2)]})})]},n))}),e.jsxs("tfoot",{className:"table-light",children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"Subtotal:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{children:["S/ ",j.toFixed(2)]})})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"IGV 18%:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{children:["S/ ",x.toFixed(2)]})})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"Total:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["S/ ",_.toFixed(2)]})})]})]})]})})]})]})]}),e.jsx(fe,{quoteId:p})]})]})}export{ze as default};
//# sourceMappingURL=DetalleCotizacion-B9UkdINN.js.map
