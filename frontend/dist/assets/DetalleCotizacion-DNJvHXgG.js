import{$ as M,r as n,j as e}from"./index-xQVByYRi.js";import{M as z}from"./ModuloBase-uxYeg0t6.js";import{g as I,u as A}from"./quotes-B0lnb_TG.js";function R(){const{id:i}=M(),[t,p]=n.useState(null),[d,b]=n.useState([]),[k,v]=n.useState(!0),[m,u]=n.useState(""),[N,f]=n.useState(!1),[y,_]=n.useState("");n.useEffect(()=>{(async()=>{try{v(!0),u("");const s=await I(i);p(s),b([])}catch(s){u(s.message||"No se pudo cargar la cotización")}finally{v(!1)}})()},[i]);const l=n.useMemo(()=>d.reduce((s,a)=>s+Number(a.partial_price||0),0),[d]),j=n.useMemo(()=>Number((l*.18).toFixed(2)),[l]),c=n.useMemo(()=>t?typeof t.igv=="number"?Number(t.igv):j:0,[t,j]),C=n.useMemo(()=>Number((l+c).toFixed(2)),[l,c]),S=s=>{const a="http://localhost:4000/api".replace(/\/$/,"")||"",r=`/api/quotes/${i}/export/${s}`;return a&&/\/api$/i.test(a)?`${a}${r.replace(/^\/api/,"")}`:`${a}${r}`},o=(s,a,r)=>{b(F=>{const g=[...F],x={...g[s],[a]:a==="quantity"||a==="unit_price"?Number(r):r},$=Number(x.quantity||0),q=Number(x.unit_price||0);return x.partial_price=Number(($*q).toFixed(2)),g[s]=x,g})},h=(s,a)=>{p(r=>({...r,[s]:a}))},E=async()=>{try{f(!0),u(""),_("");const s={client_contact:(t==null?void 0:t.client_contact)||null,client_email:(t==null?void 0:t.client_email)||null,client_phone:(t==null?void 0:t.client_phone)||null,issue_date:(t==null?void 0:t.issue_date)||null,subtotal:Number(l||0),igv:Number(c||0),total:Number(C||0),status:(t==null?void 0:t.status)||"en_proceso",reference:(t==null?void 0:t.reference)||null,meta:(t==null?void 0:t.meta)||null},a=await A(i,s);p(a),_("Cambios guardados correctamente.")}catch(s){u(s.message||"No se pudo guardar los cambios")}finally{f(!1)}};return e.jsxs(z,{titulo:`Cotización #${i}`,descripcion:"Detalle y edición de la cotización.",children:[k&&e.jsx("div",{children:"Cargando..."}),m&&e.jsx("div",{className:"alert alert-danger",children:m}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{children:"Proyecto:"})," ",t.project_name||t.project_id]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label mb-0",children:e.jsx("strong",{children:"Emisión"})}),e.jsx("input",{type:"date",className:"form-control form-control-sm",value:(t.issue_date||"").slice(0,10),onChange:s=>h("issue_date",s.target.value)})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label mb-0",children:e.jsx("strong",{children:"Estado"})}),e.jsxs("select",{className:"form-select form-select-sm",value:t.status||"en_proceso",onChange:s=>h("status",s.target.value),children:[e.jsx("option",{value:"en_proceso",children:"En proceso"}),e.jsx("option",{value:"enviado",children:"Enviado"}),e.jsx("option",{value:"aprobado",children:"Aprobado"}),e.jsx("option",{value:"rechazado",children:"Rechazado"})]})]}),e.jsxs("div",{className:"col-md-8",children:[e.jsx("label",{className:"form-label mb-0",children:e.jsx("strong",{children:"Referencia"})}),e.jsx("input",{type:"text",className:"form-control form-control-sm",value:t.reference||"",onChange:s=>h("reference",s.target.value),placeholder:"Asunto / referencia"})]}),e.jsxs("div",{className:"col-md-4 d-flex align-items-end",children:[e.jsxs("div",{className:"form-check me-3",children:[e.jsx("input",{id:"igvCheck",className:"form-check-input",type:"checkbox",checked:Number(c)>0,onChange:s=>h("igv",s.target.checked?j:0)}),e.jsx("label",{className:"form-check-label",htmlFor:"igvCheck",children:"Aplicar IGV 18%"})]}),e.jsxs("div",{className:"small text-muted",children:["IGV actual: S/ ",Number(c||0).toFixed(2)]})]})]}),e.jsx("div",{className:"table-responsive mt-3",children:e.jsxs("table",{className:"table table-bordered align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código"}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{children:"Norma"}),e.jsx("th",{children:"Unitario"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Parcial"})]})}),e.jsxs("tbody",{children:[d.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{style:{width:"12rem"},children:e.jsx("input",{className:"form-control form-control-sm",value:s.code||"",onChange:r=>o(a,"code",r.target.value)})}),e.jsx("td",{children:e.jsx("textarea",{className:"form-control form-control-sm",rows:2,value:s.description||"",onChange:r=>o(a,"description",r.target.value)})}),e.jsx("td",{style:{width:"10rem"},children:e.jsx("input",{className:"form-control form-control-sm",value:s.norm||"",onChange:r=>o(a,"norm",r.target.value)})}),e.jsx("td",{style:{width:"10rem"},children:e.jsxs("div",{className:"input-group input-group-sm",children:[e.jsx("span",{className:"input-group-text",children:"S/"}),e.jsx("input",{type:"number",step:"0.01",className:"form-control",value:s.unit_price??0,onChange:r=>o(a,"unit_price",r.target.value)})]})}),e.jsx("td",{style:{width:"8rem"},children:e.jsx("input",{type:"number",step:"1",className:"form-control form-control-sm",value:s.quantity??0,onChange:r=>o(a,"quantity",r.target.value)})}),e.jsxs("td",{style:{width:"10rem"},children:["S/ ",Number(s.partial_price||0).toFixed(2)]})]},s.id)),d.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center text-muted",children:"Sin ítems"})})]})]})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-start gap-4 mt-3",children:[e.jsxs("div",{children:[y&&e.jsx("div",{className:"alert alert-success py-1 px-2 mb-2",children:y}),m&&e.jsx("div",{className:"alert alert-danger py-1 px-2 mb-2",children:m}),e.jsx("button",{className:"btn btn-primary",onClick:E,disabled:N,children:N?"Guardando...":"Guardar Cambios"})]}),e.jsxs("div",{className:"text-end",children:[e.jsxs("div",{children:["Subtotal: S/ ",l.toFixed(2)]}),e.jsxs("div",{children:["IGV: S/ ",c.toFixed(2)]}),e.jsx("div",{children:e.jsxs("strong",{children:["Total: S/ ",C.toFixed(2)]})})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("a",{className:"btn btn-outline-secondary",href:S("pdf"),target:"_blank",rel:"noreferrer",children:"Exportar PDF"}),e.jsx("a",{className:"btn btn-outline-secondary",href:S("excel"),target:"_blank",rel:"noreferrer",children:"Exportar Excel"})]})]})]})]})}export{R as default};
//# sourceMappingURL=DetalleCotizacion-DNJvHXgG.js.map
