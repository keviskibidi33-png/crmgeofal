import{b as x,r as o,a1 as Q,Q as R,c as k,R as w,j as t}from"./index-o7c7tdkB.js";import{M as B}from"./ModuloBase-DpIJbQDg.js";import{D as I}from"./DataTable-BXmKJeNO.js";import{T as O}from"./Toolbar-Dgqueffs.js";import{M as E}from"./Modal-M1gDWVxD.js";import{T as $}from"./Toast-BGeXl3a3.js";import{l as z}from"./projects-BMxbiY1g.js";const G=(s={})=>{const a=new URLSearchParams;s.page&&a.set("page",s.page),s.limit&&a.set("limit",s.limit),s.q&&a.set("q",s.q);const r=a.toString(),n=r?`/api/project-attachments?${r}`:"/api/project-attachments";return x(n)},W=async({project_id:s,description:a,file:r})=>{const n=new FormData;return n.append("project_id",s),a&&n.append("description",a),n.append("file",r),x("/api/project-attachments",{method:"POST",body:n})},H=s=>x(`/api/project-attachments/${s}`,{method:"DELETE"}),M={project_id:"",description:"",file:null};function te(){const[s,a]=o.useState(1),[r]=o.useState(10),[n,y]=o.useState({q:""}),[g,u]=o.useState({message:"",type:"success",show:!1}),b=Q(),[v,m]=o.useState(!1),[l,h]=o.useState(M),[d,p]=o.useState(null),_=R();o.useEffect(()=>{var e;(e=b.state)!=null&&e.search&&y(i=>({...i,q:b.state.search}))},[b.state]);const{data:c,isLoading:D}=k(["attachments",{page:s,limit:r,q:n.q}],()=>G({page:s,limit:r,q:n.q}),{keepPreviousData:!0}),{data:j}=k("projectsList",()=>z({page:1,limit:500}),{staleTime:1/0}),T=o.useMemo(()=>(j==null?void 0:j.data)||[],[j]),N=e=>{u({message:e,type:"success",show:!0}),_.invalidateQueries("attachments"),m(!1),h(M),p(null)},S=(e,i)=>{u({message:(e==null?void 0:e.message)||i,type:"error",show:!0})},f=w(W,{onSuccess:()=>N("Archivo subido correctamente."),onError:e=>S(e,"Error al subir archivo.")}),C=w(H,{onSuccess:()=>N("Adjunto eliminado correctamente."),onError:e=>S(e,"Error al eliminar adjunto.")}),L=e=>{if(e.preventDefault(),!l.file||!l.project_id){u({message:"Debe seleccionar un proyecto y un archivo.",type:"error",show:!0});return}f.mutate(l)},P=()=>{d&&C.mutate(d.id)},F=o.useMemo(()=>[{header:"ID",key:"id",width:60},{header:"Proyecto",key:"project_name"},{header:"Archivo",key:"file_url",render:e=>t.jsx("a",{href:e.file_url,target:"_blank",rel:"noreferrer noopener",children:e.file_url.split("/").pop()})},{header:"Descripción",key:"description"},{header:"Subido por",key:"uploaded_by_name"},{header:"Fecha",key:"created_at",render:e=>new Date(e.created_at).toLocaleString(),width:200},{header:"Acciones",key:"actions",width:120,render:e=>t.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>p(e),children:"Eliminar"})}],[]),U=(c==null?void 0:c.data)||[],q=(c==null?void 0:c.total)||0,A=Math.max(1,Math.ceil(q/r));return t.jsxs(B,{titulo:"Gestión de Adjuntos",descripcion:"Archivos relacionados a proyectos y cotizaciones.",children:[t.jsx(O,{left:t.jsx("input",{className:"form-control",style:{maxWidth:"300px"},placeholder:"Buscar por archivo, proyecto...",value:n.q,onChange:e=>{a(1),y({q:e.target.value})}}),right:t.jsx("button",{className:"btn btn-primary",onClick:()=>m(!0),children:"+ Subir Archivo"})}),t.jsx(I,{columns:F,rows:U,loading:D}),t.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[t.jsxs("span",{className:"text-muted",children:["Total: ",q]}),t.jsxs("div",{className:"btn-group",children:[t.jsx("button",{className:"btn btn-outline-secondary",disabled:s<=1,onClick:()=>a(e=>e-1),children:"Anterior"}),t.jsxs("span",{className:"btn btn-outline-secondary disabled",children:[s," / ",A]}),t.jsx("button",{className:"btn btn-outline-secondary",disabled:s>=A,onClick:()=>a(e=>e+1),children:"Siguiente"})]})]}),v&&t.jsx(E,{open:v,onClose:()=>m(!1),children:t.jsxs("form",{onSubmit:L,children:[t.jsx("h4",{children:"Subir Archivo Adjunto"}),t.jsxs("div",{className:"row g-3 mt-2",children:[t.jsxs("div",{className:"col-12",children:[t.jsx("label",{className:"form-label",children:"Proyecto"}),t.jsxs("select",{className:"form-select",value:l.project_id,onChange:e=>h(i=>({...i,project_id:e.target.value})),required:!0,children:[t.jsx("option",{value:"",children:"Seleccione un proyecto..."}),T.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsxs("div",{className:"col-12",children:[t.jsx("label",{className:"form-label",children:"Descripción (Opcional)"}),t.jsx("input",{className:"form-control",value:l.description,onChange:e=>h(i=>({...i,description:e.target.value}))})]}),t.jsxs("div",{className:"col-12",children:[t.jsx("label",{className:"form-label",children:"Archivo"}),t.jsx("input",{type:"file",className:"form-control",onChange:e=>h(i=>({...i,file:e.target.files[0]})),required:!0})]})]}),t.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-4",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>m(!1),children:"Cancelar"}),t.jsx("button",{type:"submit",className:"btn btn-primary",disabled:f.isLoading,children:f.isLoading?"Subiendo...":"Subir"})]})]})}),d&&t.jsxs(E,{open:!!d,onClose:()=>p(null),children:[t.jsx("h4",{children:"Confirmar Eliminación"}),t.jsxs("p",{children:["¿Estás seguro de que quieres eliminar el archivo ",t.jsx("strong",{children:d.file_url.split("/").pop()}),"? Esta acción no se puede deshacer."]}),t.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-4",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>p(null),children:"Cancelar"}),t.jsx("button",{type:"button",className:"btn btn-danger",onClick:P,disabled:C.isLoading,children:"Eliminar"})]})]}),t.jsx($,{message:g.message,type:g.type,onClose:()=>u(e=>({...e,show:!1}))})]})}export{te as default};
//# sourceMappingURL=Adjuntos-DCQNSNrC.js.map
