import{r as t,c as je,e as O,n as p,j as e,C as fe,h as q,B as v,o as be,p as ve,q as Se,s as ye,t as Ne,v as S,w as P,x as G,D as d,y as Ce,z as Ee,A as Fe}from"./index-CJDD9_Aw.js";import{P as Ae}from"./PageHeader-Cfye0oPO.js";import{D as Me}from"./DataTable-CI3KJtBU.js";import{M as De}from"./ModalForm-KtSltT6a.js";import{S as y}from"./StatsCard-DzydegCt.js";import{C as we}from"./ConfirmModal-C4J0KUay.js";import{c as Le,u as T,d as ke,l as qe,g as Pe}from"./users-ZY6Usyup.js";import{R as Te,C as U}from"./Row-BGooJhRW.js";import{C as N}from"./Col-DkPevymr.js";import{M as g}from"./Modal-BJZ3bxhN.js";import{A as C}from"./Alert-Cn54xJZ3.js";import{S as Ue}from"./Spinner-BVQsrHFz.js";import"./InputGroup-CY9SaoEq.js";import"./Form-FBPQ7LgU.js";import"./ElementChildren-B01Kjy_s.js";import"./Table-ME9p9tbt.js";/* empty css                     */const V={name:"",apellido:"",email:"",role:"vendedor_comercial",area:"Comercial",password:""},$=[{value:"admin",label:"Administrador"},{value:"jefa_comercial",label:"Jefa Comercial"},{value:"vendedor_comercial",label:"Vendedor Comercial"},{value:"jefe_laboratorio",label:"Jefe Laboratorio"},{value:"usuario_laboratorio",label:"Usuario Laboratorio"},{value:"facturacion",label:"Facturación"},{value:"soporte",label:"Soporte"},{value:"gerencia",label:"Gerencia"}],_e=[{value:"Comercial",label:"Comercial"},{value:"Laboratorio",label:"Laboratorio"},{value:"Facturación",label:"Facturación"},{value:"Sistemas",label:"Sistemas"},{value:"Gerencia",label:"Gerencia"},{value:"Soporte",label:"Soporte"}];function aa(){const[J,j]=t.useState(!1),[o,E]=t.useState(null),[l,h]=t.useState(null),[r,u]=t.useState(null),[_,F]=t.useState(""),[I,f]=t.useState(""),[A,M]=t.useState(1),[R,W]=t.useState(""),[X,K]=t.useState(""),[Y,Z]=t.useState(""),[ee,B]=t.useState(!1),m=je(),{data:i,isLoading:D,refetch:ae}=O(["users",A,R,X,Y],()=>qe({page:A,limit:20,search:R}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:c,isLoading:b}=O(["userStats"],Pe,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4}),w=a=>{m.invalidateQueries("users"),m.invalidateQueries("userStats"),j(!1),E(null),h(null)},se=a=>{console.log("🔍 handleSearch - Búsqueda:",a),W(a),M(1),B(!0),setTimeout(()=>B(!1),1e3)},re=a=>{console.log("🔍 handleFilter - Filtros:",a),K(a.role||""),Z(a.area||""),M(1)},Q=p(Le,{onSuccess:()=>w(),onError:a=>console.error("Error creating user:",a)}),z=p(({id:a,...s})=>T(a,s),{onSuccess:()=>w(),onError:a=>console.error("Error updating user:",a)}),H=p(ke,{onSuccess:()=>w(),onError:a=>console.error("Error deleting user:",a)}),L=p(({id:a,userData:s})=>(console.log("🔍 deactivateUserMutation - Llamando updateUser con:",{id:a,userData:s}),T(a,s)),{onSuccess:a=>{console.log("✅ deactivateUserMutation - Éxito:",a),F("Usuario desactivado exitosamente"),u(null),m.invalidateQueries("users"),m.invalidateQueries("userStats")},onError:a=>{console.error("❌ deactivateUserMutation - Error:",a),f("Error al desactivar usuario: "+(a.message||"Error desconocido"))}}),k=p(({id:a,userData:s})=>T(a,s),{onSuccess:()=>{F("Usuario activado exitosamente"),u(null),m.invalidateQueries("users"),m.invalidateQueries("userStats")},onError:a=>{f("Error al activar usuario: "+(a.message||"Error desconocido")),console.error("Error activating user:",a)}}),oe=()=>{E(V),j(!0)},te=(a,s)=>{s==null||s.stopPropagation(),E(a),j(!0)},ie=(a,s)=>{s==null||s.stopPropagation(),h(a)},le=async()=>{try{console.log("🔍 confirmDelete - Eliminando usuario:",l.id),await H.mutateAsync(l.id),console.log("✅ confirmDelete - Usuario eliminado exitosamente"),h(null)}catch(a){console.error("❌ confirmDelete - Error:",a),f("Error al eliminar usuario: "+a.message),h(null)}},ne=async a=>{o.id?await z.mutateAsync({id:o.id,...a}):await Q.mutateAsync(a)},ce=(a,s)=>{s==null||s.stopPropagation(),u(a)},de=async()=>{if(r){console.log("🔍 confirmDeactivate - Desactivando usuario:",r.id);try{const a=await L.mutateAsync({id:r.id,userData:{active:!1}});console.log("✅ confirmDeactivate - Usuario desactivado exitosamente:",a)}catch(a){console.error("❌ confirmDeactivate - Error:",a)}}},ue=(a,s)=>{s==null||s.stopPropagation(),u(a)},me=async()=>{r&&await k.mutateAsync({id:r.id,userData:{active:!0}})},he=a=>({admin:"danger",jefa_comercial:"warning",vendedor_comercial:"primary",jefe_laboratorio:"info",usuario_laboratorio:"secondary",laboratorio:"secondary",soporte:"success",gerencia:"dark"})[a]||"secondary",xe=a=>{const s=$.find(n=>n.value===a);return s?s.label:a},pe=[{header:"ID",accessor:"id",width:"80px"},{header:"Nombre",accessor:"name",render:(a,s)=>e.jsxs("div",{children:[e.jsxs("div",{className:"fw-medium",children:[s.name," ",s.apellido]}),e.jsx("small",{className:"text-muted",children:s.email})]})},{header:"Rol",accessor:"role",render:a=>e.jsx(S,{bg:he(a),className:"status-badge",children:xe(a)})},{header:"Área",accessor:"area",render:a=>e.jsx(S,{bg:"light",text:"dark",className:"status-badge",children:a})},{header:"Estado",accessor:"active",render:(a,s)=>e.jsx(S,{bg:a!==!1?"success":"danger",className:"status-badge",children:a!==!1?"Activo":"Inactivo"})},{header:"Fecha Creación",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,s)=>e.jsxs(d,{children:[e.jsx(d.Toggle,{variant:"outline-secondary",size:"sm",id:`dropdown-${s.id}`,children:e.jsx(Ce,{})}),e.jsxs(d.Menu,{children:[e.jsxs(d.Item,{onClick:n=>te(s,n),children:[e.jsx(Ee,{className:"me-2"}),"Editar Usuario"]}),e.jsx(d.Divider,{}),s.active!==!1?e.jsxs(d.Item,{onClick:n=>ce(s,n),className:"text-warning",children:[e.jsx(P,{className:"me-2"}),"Desactivar Usuario"]}):e.jsxs(d.Item,{onClick:n=>ue(s,n),className:"text-success",children:[e.jsx(G,{className:"me-2"}),"Activar Usuario"]}),e.jsxs(d.Item,{onClick:n=>ie(s,n),className:"text-danger",children:[e.jsx(Fe,{className:"me-2"}),"Eliminar Usuario"]})]})]})}],ge=[{name:"name",label:"Nombre",type:"text",required:!0,placeholder:"Ingresa el nombre"},{name:"apellido",label:"Apellido",type:"text",required:!0,placeholder:"Ingresa el apellido"},{name:"email",label:"Email",type:"email",required:!0,placeholder:"usuario@ejemplo.com"},{name:"role",label:"Rol",type:"select",required:!0,options:$},{name:"area",label:"Área",type:"select",required:!0,options:_e},{name:"password",label:"Contraseña",type:"password",required:!(o!=null&&o.id),placeholder:"Mínimo 6 caracteres",help:o!=null&&o.id?"Dejar vacío para mantener la contraseña actual":"Mínimo 6 caracteres"}],x=t.useMemo(()=>{if(c)return console.log("📊 Stats - Usando estadísticas reales del backend:",c),{total:c.total||0,admins:c.admins||0,vendedores:c.vendedores||0,laboratorio:c.laboratorio||0,activos:c.active||0};const a=(i==null?void 0:i.data)||[];return console.log("📊 Stats - Fallback: calculando desde página actual:",a),{total:a.length,admins:a.filter(s=>s.role==="admin").length,vendedores:a.filter(s=>s.role==="vendedor_comercial").length,laboratorio:a.filter(s=>["jefe_laboratorio","usuario_laboratorio"].includes(s.role)).length,activos:a.filter(s=>s.active!==!1).length}},[c,i]);return e.jsx(fe,{fluid:!0,className:"py-4",children:e.jsxs("div",{className:"fade-in",children:[e.jsx(Ae,{title:"Gestión de Usuarios",subtitle:"Crear, editar, eliminar y gestionar usuarios del sistema",icon:q,actions:e.jsxs(v,{variant:"primary",onClick:oe,children:[e.jsx(be,{className:"me-2"}),"Nuevo Usuario"]})}),e.jsxs(Te,{className:"g-4 mb-4",children:[e.jsx(N,{md:6,lg:3,children:e.jsx(y,{title:"Total Usuarios",value:x.total,icon:q,color:"primary",subtitle:"Usuarios registrados",loading:b})}),e.jsx(N,{md:6,lg:3,children:e.jsx(y,{title:"Administradores",value:x.admins,icon:ve,color:"danger",subtitle:"Usuarios con privilegios",loading:b})}),e.jsx(N,{md:6,lg:3,children:e.jsx(y,{title:"Vendedores",value:x.vendedores,icon:Se,color:"success",subtitle:"Equipo comercial",loading:b})}),e.jsx(N,{md:6,lg:3,children:e.jsx(y,{title:"Laboratorio",value:x.laboratorio,icon:ye,color:"info",subtitle:"Personal técnico",loading:b})})]}),e.jsxs(U,{className:"shadow-sm border-0",children:[e.jsx(U.Header,{className:"bg-white border-bottom",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(q,{className:"me-2 text-primary"}),"Lista de Usuarios"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(v,{variant:"outline-primary",size:"sm",onClick:()=>ae(),disabled:D,className:"refresh-btn",children:e.jsx(Ne,{className:D?"spinning":""})}),e.jsxs(S,{bg:"light",text:"dark",className:"px-3 py-2",children:[x.total," usuarios"]})]})]})}),e.jsx(U.Body,{className:"p-0",children:e.jsx(Me,{data:(i==null?void 0:i.data)||[],columns:pe,loading:D||ee,emptyMessage:"No hay usuarios registrados",totalItems:(i==null?void 0:i.total)||0,itemsPerPage:20,currentPage:A,onPageChange:M,onSearch:se,onFilter:re})})]}),e.jsx(De,{show:J,onHide:()=>j(!1),title:o!=null&&o.id?"Editar Usuario":"Nuevo Usuario",data:o||V,fields:ge,onSubmit:ne,loading:Q.isLoading||z.isLoading,submitText:o!=null&&o.id?"Actualizar":"Crear"}),e.jsxs(g,{show:!!r,onHide:()=>u(null),centered:!0,children:[e.jsx(g.Header,{closeButton:!0,children:e.jsxs(g.Title,{children:[e.jsx(P,{className:"me-2 text-warning"}),(r==null?void 0:r.active)!==!1?"Desactivar Usuario":"Activar Usuario"]})}),e.jsxs(g.Body,{children:[e.jsxs("p",{children:["¿Estás seguro de que quieres ",(r==null?void 0:r.active)!==!1?"desactivar":"activar"," al usuario"," ",e.jsxs("strong",{children:[r==null?void 0:r.name," ",r==null?void 0:r.apellido]}),"?"]}),(r==null?void 0:r.active)!==!1?e.jsxs(C,{variant:"warning",children:[e.jsx("strong",{children:"Nota:"})," Al desactivar el usuario, no podrá acceder al sistema hasta que sea reactivado."]}):e.jsxs(C,{variant:"info",children:[e.jsx("strong",{children:"Nota:"})," Al activar el usuario, podrá acceder nuevamente al sistema."]})]}),e.jsxs(g.Footer,{children:[e.jsx(v,{variant:"secondary",onClick:()=>u(null),children:"Cancelar"}),e.jsx(v,{variant:(r==null?void 0:r.active)!==!1?"warning":"success",onClick:(r==null?void 0:r.active)!==!1?de:me,disabled:(r==null?void 0:r.active)!==!1?L.isLoading:k.isLoading,children:((r==null?void 0:r.active)!==!1?L.isLoading:k.isLoading)?e.jsxs(e.Fragment,{children:[e.jsx(Ue,{animation:"border",size:"sm",className:"me-2"}),"Procesando..."]}):e.jsx(e.Fragment,{children:(r==null?void 0:r.active)!==!1?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"me-2"}),"Desactivar"]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"me-2"}),"Activar"]})})})]})]}),e.jsx(we,{show:!!l,onHide:()=>h(null),onConfirm:le,title:"Eliminar Usuario",message:`¿Estás seguro de que quieres eliminar al usuario ${l==null?void 0:l.name} ${l==null?void 0:l.apellido}?`,confirmText:"Eliminar",variant:"danger",isLoading:H.isLoading,alertMessage:"¡Advertencia! Esta acción es irreversible. Se eliminarán todos los datos asociados al usuario.",alertVariant:"danger"}),_&&e.jsx("div",{className:"position-fixed top-0 end-0 p-3",style:{zIndex:1050},children:e.jsx(C,{variant:"success",dismissible:!0,onClose:()=>F(""),children:_})}),I&&e.jsx("div",{className:"position-fixed top-0 end-0 p-3",style:{zIndex:1050},children:e.jsx(C,{variant:"danger",dismissible:!0,onClose:()=>f(""),children:I})})]})})}export{aa as default};
//# sourceMappingURL=Usuarios-GJnArsfu.js.map
