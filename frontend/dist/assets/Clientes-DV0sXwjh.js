import{r,E as te,u as le,c as L,G as f,j as e,H as re,f as C,B as m,I as ie,h as q,m as j,A as w,n as u,L as ne,M as oe,v as ce,N as de,O as me}from"./index-DEOVmouH.js";import{P as ue}from"./PageHeader-CQkDYjTq.js";import{D as pe}from"./DataTable-DczKv8iu.js";import{M as he}from"./ModalForm-Bq7S27Np.js";import{S as p}from"./StatsCard-nXHftVJq.js";import{d as ge,c as xe,u as be,l as ye,g as fe}from"./companies-CQE8_azb.js";import{R as Ce,C as h}from"./Row-BbuP-81J.js";import{C as N}from"./Card-Dh58Aev9.js";import"./InputGroup-BKumZwLE.js";import"./Form-B65jexOv.js";import"./ElementChildren-gaW6uce3.js";import"./Table-CnkmMpGQ.js";import"./Spinner-C3m4zju4.js";const D={type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:""};function De(){const[A,c]=r.useState(!1),[i,g]=r.useState(null),[je,G]=r.useState(null),[x,b]=r.useState(1),[S,H]=r.useState(""),[v,R]=r.useState(""),[E,O]=r.useState(""),[k,B]=r.useState(""),[U,T]=r.useState(!1),P=te(),_=le(),{data:l,isLoading:Q,refetch:Ne}=L(["clients",x,S,v,E,k],()=>ye({page:x,limit:20,search:S,type:v,city:E,sector:k}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:n,isLoading:d}=L(["clientStats"],fe,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4}),y=a=>{P.invalidateQueries("clients"),P.invalidateQueries("clientStats"),c(!1),g(null),G(null)},W=a=>{console.log("🔍 handleSearch - Búsqueda:",a),H(a),b(1),T(!0),setTimeout(()=>T(!1),1e3)},$=a=>{console.log("🔍 handleFilter - Filtros:",a),R(a.type||""),O(a.city||""),B(a.sector||""),b(1)},J=[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona"}}]},{title:"Por Sector",options:[{label:"General",filter:{sector:"General"}},{label:"Construcción",filter:{sector:"Construcción"}},{label:"Minería",filter:{sector:"Minería"}},{label:"Ingeniería",filter:{sector:"Ingeniería"}},{label:"Laboratorio",filter:{sector:"Laboratorio"}},{label:"Consultoría",filter:{sector:"Consultoría"}},{label:"Tecnología",filter:{sector:"Tecnología"}},{label:"Ambiental",filter:{sector:"Ambiental"}},{label:"Geología",filter:{sector:"Geología"}}]},{title:"Por Ciudad",options:[{label:"Lima",filter:{city:"Lima"}},{label:"Arequipa",filter:{city:"Arequipa"}},{label:"Cusco",filter:{city:"Cusco"}},{label:"Trujillo",filter:{city:"Trujillo"}},{label:"Piura",filter:{city:"Piura"}},{label:"Chiclayo",filter:{city:"Chiclayo"}},{label:"Iquitos",filter:{city:"Iquitos"}},{label:"Huancayo",filter:{city:"Huancayo"}}]}],F=f(xe,{onSuccess:()=>y(),onError:a=>console.error("Error creating client:",a)}),I=f(be,{onSuccess:()=>y(),onError:a=>console.error("Error updating client:",a)}),K=f(ge,{onSuccess:()=>y(),onError:a=>console.error("Error deleting client:",a)}),X=()=>{g(D),c(!0)},M=a=>{g(a),c(!0)},z=a=>{window.confirm(`¿Estás seguro de que quieres eliminar el cliente "${a.name}"?`)&&K.mutate(a.id)},Y=a=>{_("/proyectos",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city}}})},Z=async a=>{i.id?await I.mutateAsync({id:i.id,...a}):await F.mutateAsync(a)},V=a=>{const t={empresa:{bg:"primary",text:"Empresa",icon:q},persona:{bg:"info",text:"Persona Natural",icon:j}}[a]||{bg:"secondary",text:a,icon:j},se=t.icon;return e.jsxs(u,{bg:t.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(se,{size:12,className:"me-1"}),t.text]})},ee=[{header:"ID",accessor:"id",width:"80px"},{header:"Cliente",accessor:"name",render:(a,s)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.name}),e.jsxs("div",{className:"d-flex align-items-center gap-2 mt-1",children:[V(s.type),s.ruc&&e.jsxs("small",{className:"text-muted",children:["RUC: ",s.ruc]}),s.dni&&e.jsxs("small",{className:"text-muted",children:["DNI: ",s.dni]})]})]})},{header:"Contacto",accessor:"contact",render:(a,s)=>e.jsxs("div",{children:[s.contact_name&&e.jsx("div",{className:"fw-medium",children:s.contact_name}),s.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(w,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:s.email})]}),s.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(ne,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:s.phone})]})]})},{header:"Ciudad",accessor:"city",render:a=>{const s=a||"No especificada";let t="secondary";switch(s){case"Lima":t="primary";break;case"Arequipa":t="info";break;case"Cusco":t="success";break;case"Trujillo":t="warning";break;case"Piura":t="danger";break;case"Chiclayo":t="info";break;case"Iquitos":t="success";break;case"Huancayo":t="warning";break;default:t="secondary"}return e.jsx(u,{bg:t,className:"px-2 py-1",children:s})}},{header:"Sector",accessor:"sector",render:a=>{const s=a||"General";let t="secondary";switch(s){case"Construcción":t="warning";break;case"Minería":t="dark";break;case"Ingeniería":t="primary";break;case"Laboratorio":t="info";break;case"Consultoría":t="success";break;case"Tecnología":t="primary";break;case"Ambiental":t="success";break;case"Geología":t="info";break;default:t="secondary"}return e.jsx(u,{bg:t,className:"px-2 py-1",children:s})}},{header:"Dirección",accessor:"address",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(oe,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin dirección"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,s)=>e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(m,{variant:"outline-primary",size:"sm",onClick:()=>M(s),title:"Editar cliente",children:e.jsx(ce,{size:14})}),e.jsx(m,{variant:"outline-success",size:"sm",onClick:()=>Y(s),title:"Crear proyecto para este cliente",children:e.jsx(de,{size:14})}),e.jsx(m,{variant:"outline-danger",size:"sm",onClick:()=>z(s),title:"Eliminar cliente",children:e.jsx(me,{size:14})})]})}],ae=[{name:"type",label:"Tipo de Cliente",type:"select",required:!0,options:[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}]},{name:"name",label:"Nombre/Razón Social",type:"text",required:!0,placeholder:"Ingresa el nombre o razón social"},{name:"ruc",label:"RUC",type:"text",placeholder:"Ingresa el RUC (solo para empresas)",help:"Solo para empresas"},{name:"dni",label:"DNI",type:"text",placeholder:"Ingresa el DNI (solo para personas)",help:"Solo para personas naturales"},{name:"contact_name",label:"Nombre de Contacto",type:"text",placeholder:"Ingresa el nombre del contacto"},{name:"email",label:"Email",type:"email",placeholder:"contacto@empresa.com"},{name:"phone",label:"Teléfono",type:"text",placeholder:"+51 999 999 999"},{name:"address",label:"Dirección",type:"textarea",placeholder:"Ingresa la dirección completa"}],o=r.useMemo(()=>{if(n)return console.log("📊 Stats - Usando estadísticas reales del backend:",n),{total:n.total||0,empresas:n.empresas||0,personas:n.personas||0,conEmail:n.withEmail||0,conTelefono:n.withPhone||0};const a=(l==null?void 0:l.data)||[];return console.log("📊 Stats - Fallback: calculando desde página actual:",a),{total:a.length,empresas:a.filter(s=>s.type==="empresa").length,personas:a.filter(s=>s.type==="persona").length,conEmail:a.filter(s=>s.email).length,conTelefono:a.filter(s=>s.phone).length}},[n,l]);return e.jsx(re,{fluid:!0,className:"py-4",children:e.jsxs("div",{className:"fade-in",children:[e.jsx(ue,{title:"Gestión de Clientes",subtitle:"Crear, editar y gestionar clientes del sistema",icon:C,actions:e.jsxs(m,{variant:"primary",onClick:X,children:[e.jsx(ie,{className:"me-2"}),"Nuevo Cliente"]})}),e.jsxs(Ce,{className:"g-4 mb-4",children:[e.jsx(h,{md:6,lg:3,children:e.jsx(p,{title:"Total Clientes",value:o.total,icon:C,color:"primary",subtitle:"Clientes registrados",loading:d})}),e.jsx(h,{md:6,lg:3,children:e.jsx(p,{title:"Empresas",value:o.empresas,icon:q,color:"success",subtitle:"Clientes corporativos",loading:d})}),e.jsx(h,{md:6,lg:3,children:e.jsx(p,{title:"Personas",value:o.personas,icon:j,color:"info",subtitle:"Clientes individuales",loading:d})}),e.jsx(h,{md:6,lg:3,children:e.jsx(p,{title:"Con Contacto",value:o.conEmail,icon:w,color:"warning",subtitle:"Con email registrado",loading:d})})]}),e.jsxs(N,{className:"shadow-sm border-0",children:[e.jsx(N.Header,{className:"bg-white border-bottom",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(C,{className:"me-2 text-primary"}),"Lista de Clientes"]}),e.jsxs(u,{bg:"light",text:"dark",className:"px-3 py-2",children:[o.total," clientes"]})]})}),e.jsx(N.Body,{className:"p-0",children:e.jsx(pe,{data:(l==null?void 0:l.data)||[],columns:ee,loading:Q||U,onEdit:M,onDelete:z,emptyMessage:"No hay clientes registrados",totalItems:(l==null?void 0:l.total)||0,itemsPerPage:20,currentPage:x,onPageChange:b,onSearch:W,onFilter:$,filterOptions:J})})]}),e.jsx(he,{show:A,onHide:()=>c(!1),title:i!=null&&i.id?"Editar Cliente":"Nuevo Cliente",data:i||D,fields:ae,onSubmit:Z,loading:F.isLoading||I.isLoading,submitText:i!=null&&i.id?"Actualizar":"Crear"})]})})}export{De as default};
//# sourceMappingURL=Clientes-DV0sXwjh.js.map
