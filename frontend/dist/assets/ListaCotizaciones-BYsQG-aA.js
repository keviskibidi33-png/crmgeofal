import{r as y,u as I,Q as T,c as u,R as V,j as a,U as L,F as l,B as f,V as C,d as x,a7 as P,y as N,k as B,G as $,an as A,ao as M,H as z,_ as H,a4 as R,x as q,h as G}from"./index-B6K4MeZ_.js";import{P as O,R as U,C as d}from"./PageHeader-ZaYSeG4B.js";import{D as X}from"./DataTable-DtW7TOza.js";import{S as m}from"./StatsCard-BQEilZ7W.js";import{c as J,l as K,a as W,d as Y,b as Z}from"./quotes-CxJAxBZR.js";import{l as ee}from"./companies-DH28II_N.js";import{l as ae}from"./projects-UCcvN5gF.js";import{C as p}from"./Card-C3FyhA6L.js";import"./InputGroup-B3UJk0zl.js";import"./Form-DajNugM3.js";import"./Spinner-Cd5nug_F.js";function ge(){const[te,_]=y.useState(null),r=I(),h=T(),{data:se}=u("companiesList",()=>ee({page:1,limit:200}),{staleTime:1/0}),{data:ie}=u("projectsList",()=>ae({page:1,limit:500}),{staleTime:1/0}),{data:o,isLoading:E}=u(["quotes"],()=>Z(),{keepPreviousData:!0}),w=V(Y,{onSuccess:()=>{h.invalidateQueries("quotes"),_(null)},onError:e=>console.error("Error deleting quote:",e)}),F=()=>{r("/cotizaciones/nueva")},g=e=>{r(`/cotizaciones/${e.id}/editar`)},j=e=>{r(`/cotizaciones/${e.id}`)},b=e=>{window.confirm(`¿Estás seguro de que quieres eliminar la cotización "${e.code||e.id}"?`)&&w.mutate(e.id)},S=async e=>{try{const s={project_id:e.project_id,variant_id:e.variant_id||null,client_contact:e.client_contact,client_email:e.client_email,client_phone:e.client_phone,issue_date:new Date().toISOString().slice(0,10),subtotal:e.subtotal,igv:e.igv,total:e.total,status:"borrador",meta:{from_quote_id:e.id,...e.meta}},t=await J(s),i=await K(e.id),k=Array.isArray(i==null?void 0:i.data)?i.data:i||[];for(const n of k)await W({quote_id:t.id,code:n.code,description:n.description,norm:n.norm,unit_price:Number(n.unit_price||0),quantity:Number(n.quantity||0),partial_price:Number(n.partial_price||0)});h.invalidateQueries("quotes"),r(`/cotizaciones/${t.id}/editar`)}catch(s){console.error("Error cloning quote:",s)}},D=e=>{const t={borrador:{bg:"secondary",text:"Borrador",icon:H},enviada:{bg:"primary",text:"Enviada",icon:l},aprobada:{bg:"success",text:"Aprobada",icon:x},rechazada:{bg:"danger",text:"Rechazada",icon:z},cancelada:{bg:"warning",text:"Cancelada",icon:z}}[e]||{bg:"secondary",text:e,icon:l},i=t.icon;return a.jsxs(N,{bg:t.bg,className:"status-badge d-flex align-items-center",children:[a.jsx(i,{size:12,className:"me-1"}),t.text]})},v=e=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e||0),Q=[{header:"ID",accessor:"id",width:"80px"},{header:"Código",accessor:"code",render:(e,s)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:e||`COT-${s.id}`}),a.jsxs("small",{className:"text-muted",children:[a.jsx(R,{size:12,className:"me-1"}),new Date(s.issue_date).toLocaleDateString("es-ES")]})]})},{header:"Cliente",accessor:"client",render:(e,s)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:s.client_contact||"Sin contacto"}),s.client_email&&a.jsxs("small",{className:"text-muted",children:[a.jsx(q,{size:12,className:"me-1"}),s.client_email]})]})},{header:"Proyecto",accessor:"project",render:(e,s)=>{var t,i;return a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:((t=s.project)==null?void 0:t.name)||"Sin proyecto"}),((i=s.project)==null?void 0:i.company)&&a.jsxs("small",{className:"text-muted",children:[a.jsx(G,{size:12,className:"me-1"}),s.project.company.name]})]})}},{header:"Estado",accessor:"status",render:e=>D(e)},{header:"Total",accessor:"total",render:e=>a.jsxs("div",{className:"text-end",children:[a.jsx("div",{className:"fw-bold text-success",children:v(e)}),a.jsxs("small",{className:"text-muted",children:["IGV: ",v(e*.18)]})]})}],c=y.useMemo(()=>{const e=(o==null?void 0:o.quotes)||[],s=e.reduce((t,i)=>t+(i.total||0),0);return{total:e.length,borrador:e.filter(t=>t.status==="borrador").length,enviadas:e.filter(t=>t.status==="enviada").length,aprobadas:e.filter(t=>t.status==="aprobada").length,rechazadas:e.filter(t=>t.status==="rechazada").length,totalValue:s}},[o]);return a.jsx(L,{fluid:!0,className:"py-4",children:a.jsxs("div",{className:"fade-in",children:[a.jsx(O,{title:"Gestión de Cotizaciones",subtitle:"Crear, editar y gestionar cotizaciones del sistema",icon:l,actions:a.jsxs("div",{className:"d-flex gap-2",children:[a.jsxs(f,{variant:"outline-primary",onClick:()=>r("/cotizaciones/nueva/lem"),children:[a.jsx(C,{className:"me-2"}),"Nueva LEM"]}),a.jsxs(f,{variant:"primary",onClick:F,children:[a.jsx(C,{className:"me-2"}),"Nueva Cotización"]})]})}),a.jsxs(U,{className:"g-4 mb-4",children:[a.jsx(d,{md:6,lg:3,children:a.jsx(m,{title:"Total Cotizaciones",value:c.total,icon:l,color:"primary",subtitle:"Cotizaciones registradas"})}),a.jsx(d,{md:6,lg:3,children:a.jsx(m,{title:"Enviadas",value:c.enviadas,icon:x,color:"success",subtitle:"Enviadas a clientes"})}),a.jsx(d,{md:6,lg:3,children:a.jsx(m,{title:"Aprobadas",value:c.aprobadas,icon:x,color:"info",subtitle:"Aceptadas por clientes"})}),a.jsx(d,{md:6,lg:3,children:a.jsx(m,{title:"Valor Total",value:`S/ ${c.totalValue.toLocaleString()}`,icon:P,color:"warning",subtitle:"Valor acumulado"})})]}),a.jsxs(p,{className:"shadow-sm border-0",children:[a.jsx(p.Header,{className:"bg-white border-bottom",children:a.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[a.jsxs("h5",{className:"mb-0",children:[a.jsx(l,{className:"me-2 text-primary"}),"Lista de Cotizaciones"]}),a.jsxs(N,{bg:"light",text:"dark",className:"px-3 py-2",children:[c.total," cotizaciones"]})]})}),a.jsx(p.Body,{className:"p-0",children:a.jsx(X,{data:(o==null?void 0:o.quotes)||[],columns:Q,loading:E,onEdit:g,onDelete:b,onView:j,emptyMessage:"No hay cotizaciones registradas",actions:[{label:"Ver",icon:B,onClick:j,variant:"outline-info"},{label:"Editar",icon:$,onClick:g,variant:"outline-primary"},{label:"Clonar",icon:A,onClick:S,variant:"outline-secondary"},{label:"Eliminar",icon:M,onClick:b,variant:"outline-danger"}]})})]})]})})}export{ge as default};
//# sourceMappingURL=ListaCotizaciones-BYsQG-aA.js.map
