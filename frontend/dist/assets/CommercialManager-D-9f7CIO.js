import{b as te,a as re,c as le,r as o,e as ce,R as ie,j as e,B as E,a0 as ne,h as $,G as N,a1 as oe,U as de,F as me,$ as xe,A as he,Y,W as je,l as K,Q as ue,X,n as Z,a2 as pe,p as Ne,q as be,K as ve,m as ge,g as Se}from"./index-Bcrgukx7.js";import{l as fe}from"./companies-CT3vhc5O.js";import{C as O,R as z}from"./Row-B5ljKXp5.js";import{S as B}from"./Spinner-jUAz7otr.js";import{A as _}from"./Alert-C1-1JEUj.js";import{C as b}from"./Col-C5Zwr_ej.js";import{I as M}from"./InputGroup-B7PnIA03.js";import{F as S}from"./Form-DBWuP9iW.js";import{T as ye}from"./Table-CY_xt81j.js";import"./ElementChildren-BWXp08bt.js";const V={async exportClientsCSV(t={}){try{console.log("📊 Exportando clientes a CSV...");const a=await fetch("/api/export/clients/csv",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({filters:t})});if(!a.ok)throw new Error("Error al exportar CSV");const d=await a.blob(),i=window.URL.createObjectURL(d),l=document.createElement("a");return l.href=i,l.download=`clientes_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(i),console.log("✅ CSV exportado exitosamente"),{success:!0}}catch(a){throw console.error("❌ Error exportando CSV:",a),a}},async exportClientsJSON(t={}){try{console.log("📊 Exportando clientes a JSON...");const a=await fetch("/api/export/clients/json",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({filters:t})});if(!a.ok)throw new Error("Error al exportar JSON");const d=await a.blob(),i=window.URL.createObjectURL(d),l=document.createElement("a");return l.href=i,l.download=`clientes_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(i),console.log("✅ JSON exportado exitosamente"),{success:!0}}catch(a){throw console.error("❌ Error exportando JSON:",a),a}},async getExportStats(t={}){try{console.log("📊 Obteniendo estadísticas de exportación...");const a=await te("/api/export/clients/stats",{method:"POST",body:JSON.stringify({filters:t})});return console.log("✅ Estadísticas obtenidas:",a),a}catch(a){throw console.error("❌ Error obteniendo estadísticas:",a),a}}},q=t=>t?t.includes("[PRIORIDAD: URGENTE]")||t.includes("[URG]")?"urgent":t.includes("[PRIORIDAD: ALTA]")||t.includes("[ALTA]")?"high":t.includes("[PRIORIDAD: BAJA]")||t.includes("[BAJA]")?"low":"normal":"normal",Q=t=>t&&t.replace(/\s*\[PRIORIDAD:\s*\w+\]/g,"").replace(/\s*\[URG\]/g,"").replace(/\s*\[ALTA\]/g,"").replace(/\s*\[BAJA\]/g,"").trim()||"General",H={urgent:{label:"URGENTE",variant:"danger",icon:K},high:{label:"ALTA",variant:"warning",icon:Y},normal:{label:"NORMAL",variant:"info",icon:Z},low:{label:"BAJA",variant:"secondary",icon:X}},W={prospeccion:{label:"Prospección",variant:"primary"},interesado:{label:"Interesado",variant:"info"},pendiente_cotizacion:{label:"Pendiente Cotización",variant:"warning"},cotizacion_enviada:{label:"Cotización Enviada",variant:"secondary"},negociacion:{label:"Negociación",variant:"warning"},ganado:{label:"Ganado",variant:"success"},perdido:{label:"Perdido",variant:"danger"}},Ue=()=>{const{user:t}=re();le();const[a,d]=o.useState(1),[i,l]=o.useState(""),[f,F]=o.useState(""),[R,A]=o.useState(""),[v,P]=o.useState(""),[m,ee]=o.useState("created_at"),[x,T]=o.useState("desc"),[u,I]=o.useState(!1),[y,U]=o.useState(""),{data:n,isLoading:se,error:k,refetch:D}=ce(["commercial-clients",a,i,f,R,v,m,x],()=>fe({page:a,limit:50,search:i,sector:v}),{keepPreviousData:!0,refetchOnWindowFocus:!0,staleTime:3e4}),h=(n==null?void 0:n.data)||[],C=(n==null?void 0:n.totalPages)||1,L=(n==null?void 0:n.total)||0,g=ie.useMemo(()=>{if(!h.length)return{total:0,byStatus:{},byPriority:{},bySector:{}};const s={},r={},p={};return h.forEach(c=>{s[c.status]=(s[c.status]||0)+1;const j=q(c.sector);r[j]=(r[j]||0)+1;const G=Q(c.sector);p[G]=(p[G]||0)+1}),{total:h.length,byStatus:s,byPriority:r,bySector:p}},[h]),w=s=>{m===s?T(x==="asc"?"desc":"asc"):(ee(s),T("asc"))},ae=()=>{l(""),F(""),A(""),P(""),d(1)},J=async s=>{try{I(!0),U(s);const r={search:i,status:f,sector:v,sortBy:m,sortOrder:x};s==="csv"?await V.exportClientsCSV(r):s==="json"&&await V.exportClientsJSON(r),alert(`✅ Datos exportados exitosamente en formato ${s.toUpperCase()}`)}catch(r){console.error("Error en exportación:",r),alert(`❌ Error al exportar datos: ${r.message}`)}finally{I(!1),U("")}};return se?e.jsx(O,{fluid:!0,className:"py-4",children:e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx(B,{animation:"border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})})})}):k?e.jsx(O,{fluid:!0,className:"py-4",children:e.jsxs(_,{variant:"danger",children:[e.jsx(_.Heading,{children:"Error al cargar los datos"}),e.jsx("p",{children:k.message}),e.jsx(E,{variant:"outline-danger",onClick:()=>D(),children:"Reintentar"})]})}):e.jsx(ne,{roles:["admin","comercial"],children:e.jsx("div",{className:"commercial-manager",children:e.jsxs(O,{fluid:!0,className:"py-4",children:[e.jsx(z,{className:"mb-4",children:e.jsx(b,{children:e.jsx("div",{className:"excel-header",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"excel-title",children:[e.jsx($,{className:"me-2"}),"Panel de Gestión Comercial"]}),e.jsx("p",{className:"excel-subtitle",children:"Vista completa de todos los clientes y su información de seguimiento"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(N,{children:[e.jsx(N.Toggle,{variant:"outline-primary",disabled:u,className:"d-flex align-items-center",children:u?e.jsxs(e.Fragment,{children:[e.jsx(B,{size:"sm",className:"me-1"}),"Exportando ",y==null?void 0:y.toUpperCase(),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"me-1"}),"Exportar",e.jsx(de,{className:"ms-1"})]})}),e.jsxs(N.Menu,{children:[e.jsxs(N.Item,{onClick:()=>J("csv"),disabled:u,children:[e.jsx(me,{className:"me-2"}),"Exportar CSV"]}),e.jsxs(N.Item,{onClick:()=>J("json"),disabled:u,children:[e.jsx(xe,{className:"me-2"}),"Exportar JSON"]})]})]}),e.jsxs(E,{variant:"primary",onClick:()=>D(),disabled:u,children:[e.jsx(he,{className:"me-1"}),"Actualizar"]})]})]})})})}),e.jsxs(z,{className:"mb-4",children:[e.jsx(b,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-primary",children:e.jsx($,{size:24})}),e.jsx("h4",{className:"stat-number text-primary",children:L}),e.jsx("p",{className:"stat-label",children:"Total Clientes"})]})}),e.jsx(b,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-warning",children:e.jsx(Y,{size:24})}),e.jsx("h4",{className:"stat-number text-warning",children:g.byPriority.urgent||0}),e.jsx("p",{className:"stat-label",children:"Urgentes"})]})}),e.jsx(b,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-success",children:e.jsx(je,{size:24})}),e.jsx("h4",{className:"stat-number text-success",children:g.byStatus.ganado||0}),e.jsx("p",{className:"stat-label",children:"Ganados"})]})}),e.jsx(b,{md:3,children:e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon text-info",children:e.jsx(K,{size:24})}),e.jsx("h4",{className:"stat-number text-info",children:g.byStatus.prospeccion||0}),e.jsx("p",{className:"stat-label",children:"En Prospección"})]})})]}),e.jsx("div",{className:"excel-filters",children:e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Buscar"}),e.jsxs(M,{children:[e.jsx(M.Text,{children:e.jsx(ue,{})}),e.jsx(S.Control,{type:"text",placeholder:"Buscar cliente...",value:i,onChange:s=>l(s.target.value),className:"filter-input"})]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Estado"}),e.jsxs(S.Select,{value:f,onChange:s=>F(s.target.value),className:"filter-input",children:[e.jsx("option",{value:"",children:"Todos los estados"}),Object.entries(W).map(([s,r])=>e.jsx("option",{value:s,children:r.label},s))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Prioridad"}),e.jsxs(S.Select,{value:R,onChange:s=>A(s.target.value),className:"filter-input",children:[e.jsx("option",{value:"",children:"Todas las prioridades"}),Object.entries(H).map(([s,r])=>e.jsx("option",{value:s,children:r.label},s))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:"Sector"}),e.jsxs(S.Select,{value:v,onChange:s=>P(s.target.value),className:"filter-input",children:[e.jsx("option",{value:"",children:"Todos los sectores"}),Object.keys(g.bySector).map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("div",{className:"filter-label",children:" "}),e.jsxs(E,{variant:"outline-secondary",onClick:ae,className:"filter-input",children:[e.jsx(pe,{className:"me-1"}),"Limpiar"]})]})]})}),e.jsxs("div",{className:"excel-table-container",children:[e.jsx("div",{className:"excel-table-header",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsx("h5",{className:"excel-table-title",children:"Lista de Clientes"}),e.jsxs("small",{className:"excel-table-count",children:["Mostrando ",h.length," de ",L," clientes"]})]})}),e.jsx("div",{className:"table-responsive",children:e.jsxs(ye,{className:"excel-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:`sortable ${m==="name"?x==="asc"?"sort-asc":"sort-desc":""}`,onClick:()=>w("name"),children:"Cliente"}),e.jsx("th",{children:"Contacto"}),e.jsx("th",{className:`sortable ${m==="status"?x==="asc"?"sort-asc":"sort-desc":""}`,onClick:()=>w("status"),children:"Estado"}),e.jsx("th",{children:"Prioridad"}),e.jsx("th",{children:"Sector"}),e.jsx("th",{className:`sortable ${m==="created_at"?x==="asc"?"sort-asc":"sort-desc":""}`,onClick:()=>w("created_at"),children:"Fecha Creación"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:h.map(s=>{const r=q(s.sector),p=Q(s.sector),c=H[r],j=W[s.status];return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"cell-client",children:[e.jsx("div",{children:s.name}),e.jsx("small",{className:"text-muted",children:s.ruc&&`RUC: ${s.ruc}`})]})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-contact",children:[e.jsxs("div",{className:"cell-contact-item",children:[e.jsx(Z,{className:"cell-contact-icon"}),s.contact_name||"Sin contacto"]}),s.email&&e.jsxs("div",{className:"cell-contact-item",children:[e.jsx(Ne,{className:"cell-contact-icon"}),e.jsx("small",{className:"text-muted",children:s.email})]}),s.phone&&e.jsxs("div",{className:"cell-contact-item",children:[e.jsx(be,{className:"cell-contact-icon"}),e.jsx("small",{className:"text-muted",children:s.phone})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`cell-status status-${s.status}`,children:(j==null?void 0:j.label)||s.status})}),e.jsx("td",{children:e.jsxs("span",{className:`cell-priority priority-${r}`,children:[(c==null?void 0:c.icon)&&e.jsx(c.icon,{className:"cell-priority-icon"}),(c==null?void 0:c.label)||r]})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-sector",children:[e.jsx("div",{children:p}),s.city&&e.jsxs("div",{className:"cell-sector-location",children:[e.jsx(ve,{className:"cell-contact-icon"}),s.city]})]})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-date",children:[e.jsx(X,{className:"cell-date-icon"}),new Date(s.created_at).toLocaleDateString("es-ES")]})}),e.jsx("td",{children:e.jsxs("div",{className:"cell-actions",children:[e.jsx("button",{className:"cell-action-btn",title:"Ver historial",children:e.jsx(ge,{className:"cell-action-icon"})}),e.jsx("button",{className:"cell-action-btn",title:"Comentarios",children:e.jsx(Se,{className:"cell-action-icon"})})]})})]},s.id)})})]})}),e.jsx("div",{className:"excel-pagination",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsxs("small",{className:"text-muted",children:["Página ",a," de ",C]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"pagination-btn",onClick:()=>d(s=>Math.max(s-1,1)),disabled:a===1,children:"Anterior"}),e.jsx("button",{className:"pagination-btn",onClick:()=>d(s=>Math.min(s+1,C)),disabled:a===C,children:"Siguiente"})]})]})})]})]})})})};export{Ue as default};
//# sourceMappingURL=CommercialManager-D-9f7CIO.js.map
