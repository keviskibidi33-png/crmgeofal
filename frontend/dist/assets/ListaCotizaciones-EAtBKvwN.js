import{r as y,u as k,E as Q,c as p,G as I,j as a,H as T,F as c,B as P,I as V,d as g,a3 as L,n as C,k as A,v as B,aA as $,O as q,w as N,S as H,Z as M,m as G,h as O}from"./index-VjS0hY4d.js";import{P as R}from"./PageHeader-s2EwJBI9.js";import{D as U}from"./DataTable-DC-fV_34.js";import{S as d}from"./StatsCard-CQWt6EQk.js";import{c as W,l as X,a as Z,d as J,b as K}from"./quotes-DZvtMqX8.js";import{l as Y}from"./companies-CMTUE1PH.js";import{l as ee}from"./projects-x-AZJvXx.js";import{R as ae,C as m}from"./Row-Ra1wnXQ8.js";import{C as x}from"./Card-Bl_n2eis.js";import"./InputGroup-D28bQjEt.js";import"./Form-f81hzvzI.js";import"./ElementChildren-DGNtIhpN.js";import"./Table-BrpyFtCQ.js";import"./Spinner-CSZmUozg.js";function ve(){const[te,z]=y.useState(null),l=k(),h=Q(),{data:se}=p("companiesList",()=>Y({page:1,limit:200}),{staleTime:1/0}),{data:ie}=p("projectsList",()=>ee({page:1,limit:500}),{staleTime:1/0}),{data:o,isLoading:_}=p(["quotes"],()=>K(),{keepPreviousData:!0}),E=I(J,{onSuccess:()=>{h.invalidateQueries("quotes"),z(null)},onError:e=>console.error("Error deleting quote:",e)}),F=()=>{l("/cotizaciones/nueva")},j=e=>{l(`/cotizaciones/${e.id}/editar`)},b=e=>{l(`/cotizaciones/${e.id}`)},v=e=>{window.confirm(`¿Estás seguro de que quieres eliminar la cotización "${e.code||e.id}"?`)&&E.mutate(e.id)},w=async e=>{try{const t={project_id:e.project_id,variant_id:e.variant_id||null,client_contact:e.client_contact,client_email:e.client_email,client_phone:e.client_phone,issue_date:new Date().toISOString().slice(0,10),subtotal:e.subtotal,igv:e.igv,total:e.total,status:"borrador",meta:{from_quote_id:e.id,...e.meta}},s=await W(t),i=await X(e.id),u=Array.isArray(i==null?void 0:i.data)?i.data:i||[];for(const r of u)await Z({quote_id:s.id,code:r.code,description:r.description,norm:r.norm,unit_price:Number(r.unit_price||0),quantity:Number(r.quantity||0),partial_price:Number(r.partial_price||0)});h.invalidateQueries("quotes"),l(`/cotizaciones/${s.id}/editar`)}catch(t){console.error("Error cloning quote:",t)}},S=e=>{const s={borrador:{bg:"secondary",text:"Borrador",icon:H},enviada:{bg:"primary",text:"Enviada",icon:c},aprobada:{bg:"success",text:"Aprobada",icon:g},rechazada:{bg:"danger",text:"Rechazada",icon:N},cancelada:{bg:"warning",text:"Cancelada",icon:N}}[e]||{bg:"secondary",text:e,icon:c},i=s.icon;return a.jsxs(C,{bg:s.bg,className:"status-badge d-flex align-items-center",children:[a.jsx(i,{size:12,className:"me-1"}),s.text]})},f=e=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e||0),D=[{header:"ID",accessor:"id",width:"80px"},{header:"Código",accessor:"code",render:(e,t)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:e||`COT-${t.id}`}),a.jsxs("small",{className:"text-muted",children:[a.jsx(M,{size:12,className:"me-1"}),new Date(t.issue_date).toLocaleDateString("es-ES")]})]})},{header:"Cliente",accessor:"client",render:(e,t)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:t.client_contact||"Sin contacto"}),t.client_email&&a.jsxs("small",{className:"text-muted",children:[a.jsx(G,{size:12,className:"me-1"}),t.client_email]})]})},{header:"Proyecto",accessor:"project",render:(e,t)=>{var s,i;return a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:((s=t.project)==null?void 0:s.name)||"Sin proyecto"}),((i=t.project)==null?void 0:i.company)&&a.jsxs("small",{className:"text-muted",children:[a.jsx(O,{size:12,className:"me-1"}),t.project.company.name]})]})}},{header:"Estado",accessor:"status",render:e=>S(e)},{header:"Total",accessor:"total",render:(e,t)=>a.jsxs("div",{className:"text-end",children:[a.jsx("div",{className:"fw-bold text-success",children:f(e)}),a.jsxs("small",{className:"text-muted",children:["IGV: ",f(t.igv||0)]})]})}],n=y.useMemo(()=>{const e=(o==null?void 0:o.quotes)||[],t=e.reduce((s,i)=>{const u=parseFloat(i.total)||0;return s+u},0);return{total:e.length,borrador:e.filter(s=>s.status==="borrador").length,enviadas:e.filter(s=>s.status==="enviada").length,aprobadas:e.filter(s=>s.status==="aprobada").length,rechazadas:e.filter(s=>s.status==="rechazada").length,totalValue:t}},[o]);return a.jsx(T,{fluid:!0,className:"py-4",children:a.jsxs("div",{className:"fade-in",children:[a.jsx(R,{title:"Gestión de Cotizaciones",subtitle:"Crear, editar y gestionar cotizaciones del sistema",icon:c,actions:a.jsxs(P,{variant:"primary",size:"lg",onClick:F,className:"px-4 py-2 shadow-sm",style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",border:"none",fontWeight:"600",fontSize:"1.1rem"},children:[a.jsx(V,{className:"me-2",size:20}),"Nueva Cotización"]})}),a.jsxs(ae,{className:"g-4 mb-4",children:[a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Total Cotizaciones",value:n.total,icon:c,color:"primary",subtitle:"Cotizaciones registradas"})}),a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Enviadas",value:n.enviadas,icon:g,color:"success",subtitle:"Enviadas a clientes"})}),a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Aprobadas",value:n.aprobadas,icon:g,color:"info",subtitle:"Aceptadas por clientes"})}),a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Valor Total",value:`S/ ${Number(n.totalValue).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:L,color:"warning",subtitle:"Valor acumulado"})})]}),a.jsxs(x,{className:"shadow-sm border-0",children:[a.jsx(x.Header,{className:"bg-white border-bottom",children:a.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[a.jsxs("h5",{className:"mb-0",children:[a.jsx(c,{className:"me-2 text-primary"}),"Lista de Cotizaciones"]}),a.jsxs(C,{bg:"light",text:"dark",className:"px-3 py-2",children:[n.total," cotizaciones"]})]})}),a.jsx(x.Body,{className:"p-0",children:a.jsx(U,{data:(o==null?void 0:o.quotes)||[],columns:D,loading:_,onEdit:j,onDelete:v,onView:b,emptyMessage:"No hay cotizaciones registradas",actions:[{label:"Ver",icon:A,onClick:b,variant:"outline-info"},{label:"Editar",icon:B,onClick:j,variant:"outline-primary"},{label:"Clonar",icon:$,onClick:w,variant:"outline-secondary"},{label:"Eliminar",icon:q,onClick:v,variant:"outline-danger"}]})})]})]})})}export{ve as default};
//# sourceMappingURL=ListaCotizaciones-EAtBKvwN.js.map
