import{r as n,R as V,j as e,n as z,o as W,p as Ne,q as Se,s as G,t as Ce,v as X,w as ye,c as Ee,e as K,x as w,h as I,B as D,y as we,z as Fe,A as Ae,C as L,D as T,E as Y,G as v,H as De,I as Le,J as Me}from"./index-Bcrgukx7.js";import{P as qe}from"./PageHeader-BXdzGOF9.js";import{D as ke}from"./DataTable-BA50ScQ0.js";/* empty css                     */import{S as M}from"./StatsCard-Bg6TicJV.js";import{C as _e}from"./ConfirmModal-om5z7whj.js";import{c as Pe,u as B,d as Re,l as Ue,g as Ie}from"./users-B9PRke9c.js";import{C as Te,R as Be}from"./Row-B5ljKXp5.js";import{C as q}from"./Col-C5Zwr_ej.js";import{C as $}from"./Card-C96hNOBG.js";import{M as F}from"./Modal-CPMvw6Im.js";import{A as k}from"./Alert-C1-1JEUj.js";import{S as $e}from"./Spinner-jUAz7otr.js";/* empty css                  */import"./InputGroup-B7PnIA03.js";import"./Form-DBWuP9iW.js";import"./ElementChildren-BWXp08bt.js";import"./Table-CY_xt81j.js";const ze=[{value:"admin",label:"Administrador"},{value:"jefa_comercial",label:"Jefa Comercial"},{value:"vendedor_comercial",label:"Vendedor Comercial"},{value:"jefe_laboratorio",label:"Jefe Laboratorio"},{value:"usuario_laboratorio",label:"Usuario Laboratorio"},{value:"facturacion",label:"Facturaci√≥n"},{value:"soporte",label:"Soporte"},{value:"gerencia",label:"Gerencia"}],Ge=[{value:"Comercial",label:"Comercial"},{value:"Laboratorio",label:"Laboratorio"},{value:"Facturaci√≥n",label:"Facturaci√≥n"},{value:"Sistemas",label:"Sistemas"},{value:"Gerencia",label:"Gerencia"},{value:"Soporte",label:"Soporte"}],Oe=({show:S,onHide:p,data:l={},onSubmit:C,loading:c=!1,isEditing:t=!1})=>{const[s,u]=n.useState({name:l.name||"",apellido:l.apellido||"",email:l.email||"",phone:l.phone||"",role:l.role||"vendedor_comercial",area:l.area||"Comercial",password:""}),[i,x]=n.useState({});V.useEffect(()=>{if(S){const r=!l.id;u({name:r?"":l.name||"",apellido:r?"":l.apellido||"",email:r?"":l.email||"",phone:r?"":l.phone||"",role:l.role||"vendedor_comercial",area:l.area||"Comercial",password:""}),x({})}},[S,l,t]);const d=(r,f)=>{u(y=>({...y,[r]:f})),i[r]&&x(y=>({...y,[r]:""}))},b=()=>{const r={};return s.name.trim()||(r.name="El nombre es requerido"),s.apellido.trim()||(r.apellido="El apellido es requerido"),s.email.trim()?/\S+@\S+\.\S+/.test(s.email)||(r.email="El email no es v√°lido"):r.email="El email es requerido",!t&&!s.password.trim()?r.password="La contrase√±a es requerida":s.password&&s.password.length<6&&(r.password="La contrase√±a debe tener al menos 6 caracteres"),x(r),Object.keys(r).length===0},g=r=>{if(r.preventDefault(),b()){const f={...s};t&&!f.password&&delete f.password,C(f)}};return V.useEffect(()=>{l.error&&(l.error.includes("email")||l.error.includes("Email"))&&x(r=>({...r,email:"Este email ya est√° registrado"}))},[l.error]),S?e.jsx("div",{className:"user-form-backdrop",onClick:p,children:e.jsxs("div",{className:"user-form-modal",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"user-form-header",children:[e.jsxs("h4",{children:[e.jsx(z,{className:"user-form-icon"}),t?"Editar Usuario":"Nuevo Usuario"]}),e.jsx("button",{className:"close-btn",onClick:p,children:e.jsx(W,{})})]}),e.jsxs("form",{onSubmit:g,className:"user-form-body",children:[e.jsxs("div",{className:"user-form-section",children:[e.jsxs("div",{className:"user-form-section-title",children:[e.jsx(z,{className:"user-form-icon"}),"Informaci√≥n Personal"]}),e.jsxs("div",{className:"user-form-row",children:[e.jsxs("div",{className:"user-form-group",children:[e.jsxs("label",{className:"user-form-label",children:["Nombre ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`user-form-input ${i.name?"error":""}`,value:s.name,onChange:r=>d("name",r.target.value),placeholder:"Ingresa el nombre"}),i.name&&e.jsx("div",{className:"user-form-error",children:i.name})]}),e.jsxs("div",{className:"user-form-group",children:[e.jsxs("label",{className:"user-form-label",children:["Apellido ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`user-form-input ${i.apellido?"error":""}`,value:s.apellido,onChange:r=>d("apellido",r.target.value),placeholder:"Ingresa el apellido"}),i.apellido&&e.jsx("div",{className:"user-form-error",children:i.apellido})]})]}),e.jsxs("div",{className:"user-form-row",children:[e.jsxs("div",{className:"user-form-group",children:[e.jsxs("label",{className:"user-form-label",children:[e.jsx(Ne,{className:"user-form-icon"}),"Email ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"email",className:`user-form-input ${i.email?"error":""}`,value:s.email,onChange:r=>d("email",r.target.value),placeholder:"usuario@ejemplo.com"}),i.email&&e.jsx("div",{className:"user-form-error",children:i.email})]}),e.jsxs("div",{className:"user-form-group",children:[e.jsxs("label",{className:"user-form-label",children:[e.jsx(Se,{className:"user-form-icon"}),"Tel√©fono"]}),e.jsx("input",{type:"tel",className:"user-form-input",value:s.phone,onChange:r=>d("phone",r.target.value),placeholder:"N√∫mero de tel√©fono"})]})]})]}),e.jsxs("div",{className:"user-form-section",children:[e.jsxs("div",{className:"user-form-section-title",children:[e.jsx(G,{className:"user-form-icon"}),"Configuraci√≥n del Sistema"]}),e.jsxs("div",{className:"user-form-row",children:[e.jsxs("div",{className:"user-form-group",children:[e.jsxs("label",{className:"user-form-label",children:[e.jsx(G,{className:"user-form-icon"}),"Rol ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("select",{className:"user-form-select",value:s.role,onChange:r=>d("role",r.target.value),children:ze.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"user-form-group",children:[e.jsxs("label",{className:"user-form-label",children:[e.jsx(Ce,{className:"user-form-icon"}),"√Årea ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("select",{className:"user-form-select",value:s.area,onChange:r=>d("area",r.target.value),children:Ge.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]})]})]}),e.jsxs("div",{className:"user-form-section",children:[e.jsxs("div",{className:"user-form-section-title",children:[e.jsx(X,{className:"user-form-icon"}),"Seguridad"]}),e.jsx("div",{className:"user-form-row single",children:e.jsxs("div",{className:"user-form-group",children:[e.jsxs("label",{className:"user-form-label",children:[e.jsx(X,{className:"user-form-icon"}),"Contrase√±a ",!t&&e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"password",className:`user-form-input ${i.password?"error":""}`,value:s.password,onChange:r=>d("password",r.target.value),placeholder:t?"Dejar vac√≠o para mantener la contrase√±a actual":"M√≠nimo 6 caracteres"}),i.password&&e.jsx("div",{className:"user-form-error",children:i.password}),e.jsx("div",{className:"user-form-help",children:t?"Dejar vac√≠o para mantener la contrase√±a actual":"M√≠nimo 6 caracteres"})]})})]})]}),e.jsxs("div",{className:"user-form-actions",children:[e.jsxs("button",{type:"button",className:"user-form-btn user-form-btn-cancel",onClick:p,disabled:c,children:[e.jsx(W,{}),"Cancelar"]}),e.jsx("button",{type:"submit",className:"user-form-btn user-form-btn-create",onClick:g,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})}),t?"Actualizando...":"Creando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{}),t?"Actualizar":"Crear"]})})]})]})}):null},Z={id:null,name:"",apellido:"",email:"",phone:"",role:"vendedor_comercial",area:"Comercial",password:""},ee=[{value:"admin",label:"Administrador"},{value:"jefa_comercial",label:"Jefa Comercial"},{value:"vendedor_comercial",label:"Vendedor Comercial"},{value:"jefe_laboratorio",label:"Jefe Laboratorio"},{value:"usuario_laboratorio",label:"Usuario Laboratorio"},{value:"facturacion",label:"Facturaci√≥n"},{value:"soporte",label:"Soporte"},{value:"gerencia",label:"Gerencia"}],Qe=[{value:"Comercial",label:"Comercial"},{value:"Laboratorio",label:"Laboratorio"},{value:"Facturaci√≥n",label:"Facturaci√≥n"},{value:"Sistemas",label:"Sistemas"},{value:"Gerencia",label:"Gerencia"},{value:"Soporte",label:"Soporte"}];function da(){const[S,p]=n.useState(!1),[l,C]=n.useState(null),[c,t]=n.useState(null),[s,u]=n.useState(null),[i,x]=n.useState(""),[d,b]=n.useState(""),[g,r]=n.useState(1),[f,y]=n.useState(""),[ae,se]=n.useState(""),[re,oe]=n.useState(""),[le,O]=n.useState(!1),N=Ee(),{data:m,isLoading:_,refetch:ie}=K(["users",g,f,ae,re],()=>Ue({page:g,limit:20,search:f}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:j,isLoading:A}=K(["userStats"],Ie,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4}),P=a=>{N.invalidateQueries("users"),N.invalidateQueries("userStats"),p(!1),C(null),t(null)},te=a=>{console.log("üîç handleSearch - B√∫squeda:",a),y(a),r(1),O(!0),setTimeout(()=>O(!1),1e3)},ne=a=>{console.log("üîç handleFilter - Filtros:",a),se(a.role||""),oe(a.area||""),r(1)},Q=w(Pe,{onSuccess:()=>P(),onError:a=>console.error("Error creating user:",a)}),H=w(({id:a,...o})=>B(a,o),{onSuccess:()=>P(),onError:a=>console.error("Error updating user:",a)}),J=w(Re,{onSuccess:()=>P(),onError:a=>console.error("Error deleting user:",a)}),R=w(({id:a,userData:o})=>(console.log("üîç deactivateUserMutation - Llamando updateUser con:",{id:a,userData:o}),B(a,o)),{onSuccess:a=>{console.log("‚úÖ deactivateUserMutation - √âxito:",a),x("Usuario desactivado exitosamente"),u(null),N.invalidateQueries("users"),N.invalidateQueries("userStats")},onError:a=>{console.error("‚ùå deactivateUserMutation - Error:",a),b("Error al desactivar usuario: "+(a.message||"Error desconocido"))}}),U=w(({id:a,userData:o})=>B(a,o),{onSuccess:()=>{x("Usuario activado exitosamente"),u(null),N.invalidateQueries("users"),N.invalidateQueries("userStats")},onError:a=>{b("Error al activar usuario: "+(a.message||"Error desconocido")),console.error("Error activating user:",a)}}),ce=()=>{C(Z),p(!0)},de=(a,o)=>{o==null||o.stopPropagation(),C(a),p(!0)},me=(a,o)=>{o==null||o.stopPropagation(),t(a)},ue=async()=>{try{console.log("üîç confirmDelete - Eliminando usuario:",c.id),await J.mutateAsync(c.id),console.log("‚úÖ confirmDelete - Usuario eliminado exitosamente"),t(null)}catch(a){console.error("‚ùå confirmDelete - Error:",a),b("Error al eliminar usuario: "+a.message),t(null)}},he=async a=>{l.id?await H.mutateAsync({id:l.id,...a}):await Q.mutateAsync(a)},pe=(a,o)=>{o==null||o.stopPropagation(),u(a)},xe=async()=>{if(s){console.log("üîç confirmDeactivate - Desactivando usuario:",s.id);try{const a=await R.mutateAsync({id:s.id,userData:{active:!1}});console.log("‚úÖ confirmDeactivate - Usuario desactivado exitosamente:",a)}catch(a){console.error("‚ùå confirmDeactivate - Error:",a)}}},fe=(a,o)=>{o==null||o.stopPropagation(),u(a)},je=async()=>{s&&await U.mutateAsync({id:s.id,userData:{active:!0}})},ve=a=>({admin:"danger",jefa_comercial:"warning",vendedor_comercial:"primary",jefe_laboratorio:"info",usuario_laboratorio:"secondary",laboratorio:"secondary",soporte:"success",gerencia:"dark"})[a]||"secondary",be=a=>{const o=ee.find(h=>h.value===a);return o?o.label:a},ge=[{header:"ID",accessor:"id",width:"80px"},{header:"Nombre",accessor:"name",render:(a,o)=>e.jsxs("div",{children:[e.jsxs("div",{className:"fw-medium",children:[o.name," ",o.apellido]}),e.jsx("small",{className:"text-muted",children:o.email})]})},{header:"Rol",accessor:"role",render:a=>e.jsx(L,{bg:ve(a),className:"status-badge",children:be(a)})},{header:"√Årea",accessor:"area",render:a=>e.jsx(L,{bg:"light",text:"dark",className:"status-badge",children:a})},{header:"Estado",accessor:"active",render:(a,o)=>e.jsx(L,{bg:a!==!1?"success":"danger",className:"status-badge",children:a!==!1?"Activo":"Inactivo"})},{header:"Fecha Creaci√≥n",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,o)=>e.jsxs(v,{children:[e.jsx(v.Toggle,{variant:"outline-secondary",size:"sm",id:`dropdown-${o.id}`,children:e.jsx(De,{})}),e.jsxs(v.Menu,{children:[e.jsxs(v.Item,{onClick:h=>de(o,h),children:[e.jsx(Le,{className:"me-2"}),"Editar Usuario"]}),e.jsx(v.Divider,{}),o.active!==!1?e.jsxs(v.Item,{onClick:h=>pe(o,h),className:"text-warning",children:[e.jsx(T,{className:"me-2"}),"Desactivar Usuario"]}):e.jsxs(v.Item,{onClick:h=>fe(o,h),className:"text-success",children:[e.jsx(Y,{className:"me-2"}),"Activar Usuario"]}),e.jsxs(v.Item,{onClick:h=>me(o,h),className:"text-danger",children:[e.jsx(Me,{className:"me-2"}),"Eliminar Usuario"]})]})]})}];l!=null&&l.id,l!=null&&l.id;const E=n.useMemo(()=>{if(j)return console.log("üìä Stats - Usando estad√≠sticas reales del backend:",j),{total:j.total||0,admins:j.admins||0,vendedores:j.vendedores||0,laboratorio:j.laboratorio||0,activos:j.active||0};const a=(m==null?void 0:m.data)||[];return console.log("üìä Stats - Fallback: calculando desde p√°gina actual:",a),{total:a.length,admins:a.filter(o=>o.role==="admin").length,vendedores:a.filter(o=>o.role==="vendedor_comercial").length,laboratorio:a.filter(o=>["jefe_laboratorio","usuario_laboratorio"].includes(o.role)).length,activos:a.filter(o=>o.active!==!1).length}},[j,m]);return e.jsx(Te,{fluid:!0,className:"py-4",children:e.jsxs("div",{className:"fade-in",children:[e.jsx(qe,{title:"Gesti√≥n de Usuarios",subtitle:"Crear, editar, eliminar y gestionar usuarios del sistema",icon:I,actions:e.jsxs(D,{variant:"primary",onClick:ce,children:[e.jsx(we,{className:"me-2"}),"Nuevo Usuario"]})}),e.jsxs(Be,{className:"g-4 mb-4",children:[e.jsx(q,{md:6,lg:3,children:e.jsx(M,{title:"Total Usuarios",value:E.total,icon:I,color:"primary",subtitle:"Usuarios registrados",loading:A})}),e.jsx(q,{md:6,lg:3,children:e.jsx(M,{title:"Administradores",value:E.admins,icon:G,color:"danger",subtitle:"Usuarios con privilegios",loading:A})}),e.jsx(q,{md:6,lg:3,children:e.jsx(M,{title:"Vendedores",value:E.vendedores,icon:z,color:"success",subtitle:"Equipo comercial",loading:A})}),e.jsx(q,{md:6,lg:3,children:e.jsx(M,{title:"Laboratorio",value:E.laboratorio,icon:Fe,color:"info",subtitle:"Personal t√©cnico",loading:A})})]}),e.jsxs($,{className:"shadow-sm border-0",children:[e.jsx($.Header,{className:"bg-white border-bottom",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(I,{className:"me-2 text-primary"}),"Lista de Usuarios"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(D,{variant:"outline-primary",size:"sm",onClick:()=>ie(),disabled:_,className:"refresh-btn",children:e.jsx(Ae,{className:_?"spinning":""})}),e.jsxs(L,{bg:"light",text:"dark",className:"px-3 py-2",children:[E.total," usuarios"]})]})]})}),e.jsx($.Body,{className:"p-0",children:e.jsx(ke,{data:(m==null?void 0:m.data)||[],columns:ge,loading:_||le,emptyMessage:"No hay usuarios registrados",totalItems:(m==null?void 0:m.total)||0,itemsPerPage:20,currentPage:g,onPageChange:r,onSearch:te,onFilter:ne})})]}),e.jsx(Oe,{show:S,onHide:()=>p(!1),data:l||Z,onSubmit:he,loading:Q.isLoading||H.isLoading,isEditing:!!(l!=null&&l.id)}),e.jsxs(F,{show:!!s,onHide:()=>u(null),centered:!0,children:[e.jsx(F.Header,{closeButton:!0,children:e.jsxs(F.Title,{children:[e.jsx(T,{className:"me-2 text-warning"}),(s==null?void 0:s.active)!==!1?"Desactivar Usuario":"Activar Usuario"]})}),e.jsxs(F.Body,{children:[e.jsxs("p",{children:["¬øEst√°s seguro de que quieres ",(s==null?void 0:s.active)!==!1?"desactivar":"activar"," al usuario"," ",e.jsxs("strong",{children:[s==null?void 0:s.name," ",s==null?void 0:s.apellido]}),"?"]}),(s==null?void 0:s.active)!==!1?e.jsxs(k,{variant:"warning",children:[e.jsx("strong",{children:"Nota:"})," Al desactivar el usuario, no podr√° acceder al sistema hasta que sea reactivado."]}):e.jsxs(k,{variant:"info",children:[e.jsx("strong",{children:"Nota:"})," Al activar el usuario, podr√° acceder nuevamente al sistema."]})]}),e.jsxs(F.Footer,{children:[e.jsx(D,{variant:"secondary",onClick:()=>u(null),children:"Cancelar"}),e.jsx(D,{variant:(s==null?void 0:s.active)!==!1?"warning":"success",onClick:(s==null?void 0:s.active)!==!1?xe:je,disabled:(s==null?void 0:s.active)!==!1?R.isLoading:U.isLoading,children:((s==null?void 0:s.active)!==!1?R.isLoading:U.isLoading)?e.jsxs(e.Fragment,{children:[e.jsx($e,{animation:"border",size:"sm",className:"me-2"}),"Procesando..."]}):e.jsx(e.Fragment,{children:(s==null?void 0:s.active)!==!1?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"me-2"}),"Desactivar"]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"me-2"}),"Activar"]})})})]})]}),e.jsx(_e,{show:!!c,onHide:()=>t(null),onConfirm:ue,title:"Eliminar Usuario",message:`¬øEst√°s seguro de que quieres eliminar al usuario ${c==null?void 0:c.name} ${c==null?void 0:c.apellido}?`,confirmText:"Eliminar",variant:"danger",isLoading:J.isLoading,alertMessage:"¬°Advertencia! Esta acci√≥n es irreversible. Se eliminar√°n todos los datos asociados al usuario.",alertVariant:"danger"}),i&&e.jsx("div",{className:"position-fixed top-0 end-0 p-3",style:{zIndex:1050},children:e.jsx(k,{variant:"success",dismissible:!0,onClose:()=>x(""),children:i})}),d&&e.jsx("div",{className:"position-fixed top-0 end-0 p-3",style:{zIndex:1050},children:e.jsx(k,{variant:"danger",dismissible:!0,onClose:()=>b(""),children:d})})]})})}export{da as default};
//# sourceMappingURL=Usuarios-iz4irlVd.js.map
