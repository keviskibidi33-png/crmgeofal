import{b as S,c as $,d as R,e as H,u as D,a as B,r as E,F as y,f as j,g as f,h as C,j as e,i as x,k as A,B as P,l as T,m as L}from"./index-BlIitoHL.js";import{P as O}from"./PageHeader-B0QsIMkl.js";import{S as w}from"./StatsCard-WhbJamxe.js";import{R as M}from"./Row-AGWrTK1L.js";import{C as d}from"./Col-EOfTAxlS.js";import{C as r}from"./Card-DEKILsJ8.js";import"./Spinner-mZzrAUCv.js";const V=()=>S("/api/role-dashboard/stats"),X=(c={})=>{const t=new URLSearchParams(c).toString(),i=t?`/api/activities/recent?${t}`:"/api/activities/recent";return S(i)},G=(c={})=>{var N,_,v,k;const t=$(),{limit:i=4,refetchInterval:n=3e5,staleTime:b=6e4,enabled:g=!0,userId:u=null,role:p=null}=c;R({onNewNotification:o=>{o.type&&(o.type.includes("quote")||o.type.includes("project")||o.type.includes("ticket")||o.type.includes("evidence")||o.type.includes("user")||o.type.includes("client"))&&t.invalidateQueries(["recentActivities"])},onUnreadCountUpdate:()=>{t.invalidateQueries(["recentActivities"])}});const l=H(["recentActivities",{limit:i,userId:u,role:p}],()=>X({limit:i,userId:u,role:p}),{enabled:g,refetchInterval:n,staleTime:b,refetchOnWindowFocus:!0,refetchOnMount:!0,retry:2,retryDelay:5e3,cacheTime:3e5,networkMode:"online",onError:o=>{console.warn("Error loading activities:",o)}});return{...l,refreshActivities:()=>{t.invalidateQueries(["recentActivities"])},getCachedActivities:()=>t.getQueryData(["recentActivities",{limit:i}]),hasActivities:((_=(N=l.data)==null?void 0:N.activities)==null?void 0:_.length)>0,activitiesCount:((k=(v=l.data)==null?void 0:v.activities)==null?void 0:k.length)||0,isOptimized:!0,lastFetch:l.dataUpdatedAt,nextFetch:l.dataUpdatedAt+n}},te=()=>{var o,z,U,I,Q;const c=D(),{user:t}=B();E.useEffect(()=>{if(t!=null&&t.role)switch(t.role){case"vendedor_comercial":c("/dashboards/vendedor-comercial",{replace:!0});break;case"jefa_comercial":c("/dashboards/jefa-comercial",{replace:!0});break;case"jefe_laboratorio":case"usuario_laboratorio":c("/dashboards/laboratorio",{replace:!0});break;case"facturacion":c("/dashboards/facturacion",{replace:!0});break;case"soporte":c("/dashboards/soporte",{replace:!0});break;case"gerencia":case"admin":c("/dashboards/gerencia",{replace:!0});break}},[t,c]);const{data:i,isLoading:n,error:b}=H(["dashboardStats"],V,{refetchInterval:3e5,staleTime:6e4,onSuccess:s=>{console.log("✅ Dashboard: Datos recibidos del backend:",s)},onError:s=>{console.error("❌ Dashboard: Error obteniendo datos:",s)}}),{data:g,isLoading:u,activitiesCount:p,refreshActivities:l}=G({limit:4,refetchInterval:3e5,staleTime:6e4,userId:t==null?void 0:t.id,role:t==null?void 0:t.role}),a=i?{totalUsers:parseInt(i.totalUsers)||0,totalProjects:parseInt(i.totalProjects)||0,totalQuotes:parseInt(i.totalQuotes)||0,totalTickets:parseInt(i.totalTickets)||0,activeProjects:parseInt(i.activeProjects)||0,pendingQuotes:parseInt(i.pendingQuotes)||0,openTickets:parseInt(i.openTickets)||0,completedProjects:parseInt(i.completedProjects)||0,totalClients:parseInt(i.totalClients)||0,totalEvidences:parseInt(i.totalEvidences)||0,activeUsersThisMonth:parseInt(i.activeUsersThisMonth)||0,quotesThisMonth:parseInt(i.quotesThisMonth)||0,ticketsThisMonth:parseInt(i.ticketsThisMonth)||0,changePercentages:{users:0,projects:0,quotes:0,tickets:0}}:{totalUsers:0,totalProjects:0,totalQuotes:0,totalTickets:0,activeProjects:0,pendingQuotes:0,openTickets:0,completedProjects:0,totalClients:0,totalEvidences:0,activeUsersThisMonth:0,quotesThisMonth:0,ticketsThisMonth:0,changePercentages:{users:0,projects:0,quotes:0,tickets:0}};E.useEffect(()=>{console.log("📊 Dashboard: Estado de los datos:"),console.log("- isLoading:",n),console.log("- error:",b),console.log("- data:",i),console.log("- stats procesados:",a),console.log("- totalUsers:",a.totalUsers,typeof a.totalUsers),console.log("- totalProjects:",a.totalProjects,typeof a.totalProjects),console.log("- totalQuotes:",a.totalQuotes,typeof a.totalQuotes),console.log("- totalTickets:",a.totalTickets,typeof a.totalTickets)},[n,b,i,a]);const q=s=>{const m=new Date,F=new Date(s),h=Math.floor((m-F)/(1e3*60));return h<1?"Ahora":h<60?`Hace ${h} min`:h<1440?`Hace ${Math.floor(h/60)} h`:`Hace ${Math.floor(h/1440)} días`},N=s=>({quote_created:y,quote_assigned:y,quote_approved:j,quote_rejected:FiX,quote_completed:j,project_created:A,project_assigned:A,project_started:x,project_completed:j,project_delayed:FiClock,ticket_created:f,ticket_assigned:f,ticket_resolved:j,ticket_escalated:FiAlertTriangle,evidence_uploaded:FiPaperclip,evidence_approved:j,evidence_rejected:FiX,user_registered:C,user_assigned:C,user_role_changed:FiSettings,client_created:FiUser,client_updated:FiUser,system_maintenance:FiSettings,system_update:FiSettings})[s]||T,_=s=>({quote_created:"primary",quote_assigned:"primary",quote_approved:"success",quote_rejected:"danger",quote_completed:"success",project_created:"info",project_assigned:"info",project_started:"info",project_completed:"success",project_delayed:"warning",ticket_created:"warning",ticket_assigned:"warning",ticket_resolved:"success",ticket_escalated:"danger",evidence_uploaded:"secondary",evidence_approved:"success",evidence_rejected:"danger",user_registered:"info",user_assigned:"info",user_role_changed:"secondary",client_created:"primary",client_updated:"primary",system_maintenance:"secondary",system_update:"secondary"})[s]||"secondary",v=((o=g==null?void 0:g.activities)==null?void 0:o.map(s=>({id:s.id,type:s.type,title:s.title,description:s.description,time:q(s.created_at),icon:N(s.type),color:_(s.type),user:s.user_name})))||[{id:1,type:"quote_created",title:"Nueva cotización creada",description:"Cotización #2024-001 para Proyecto ABC",time:"Hace 2 horas",icon:y,color:"primary"},{id:2,type:"project_completed",title:"Proyecto completado",description:"Proyecto XYZ finalizado exitosamente",time:"Hace 4 horas",icon:j,color:"success"},{id:3,type:"ticket_created",title:"Nuevo ticket de soporte",description:"Solicitud de soporte técnico",time:"Hace 6 horas",icon:f,color:"warning"},{id:4,type:"user_registered",title:"Usuario registrado",description:"Nuevo usuario agregado al sistema",time:"Hace 8 horas",icon:C,color:"info"}],k=[{title:"Nuevo Proyecto",description:"Crear un nuevo proyecto",icon:A,color:"primary",onClick:()=>c("/proyectos")},{title:"Nueva Cotización",description:"Generar cotización",icon:y,color:"success",onClick:()=>c("/cotizaciones/inteligente")},{title:"Nuevo Ticket",description:"Crear ticket de soporte",icon:f,color:"warning",onClick:()=>c("/tickets")},{title:"Ver Reportes",description:"Analizar datos del sistema",icon:x,color:"info",onClick:()=>c("/reportes")}];return e.jsxs("div",{className:"fade-in",children:[e.jsx(O,{title:"Dashboard",subtitle:"Resumen general del sistema CRM GeoFal",icon:x}),e.jsxs(M,{className:"mb-4 g-3",children:[e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Total Usuarios",value:a.totalUsers,icon:C,color:"primary",trend:((z=a.changePercentages)==null?void 0:z.users)||null,subtitle:`${a.activeUsersThisMonth||0} usuarios activos este mes`,loading:n,size:"normal"})}),e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Proyectos Activos",value:a.activeProjects,icon:A,color:"success",trend:((U=a.changePercentages)==null?void 0:U.projects)||null,subtitle:`${a.totalProjects} proyectos totales`,loading:n,size:"normal"})}),e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Cotizaciones Pendientes",value:a.pendingQuotes,icon:y,color:"warning",trend:((I=a.changePercentages)==null?void 0:I.quotes)||null,subtitle:`${a.quotesThisMonth||0} cotizaciones este mes`,loading:n,size:"normal"})}),e.jsx(d,{lg:3,md:6,children:e.jsx(w,{title:"Tickets Abiertos",value:a.openTickets,icon:f,color:"danger",trend:((Q=a.changePercentages)==null?void 0:Q.tickets)||null,subtitle:`${a.ticketsThisMonth||0} tickets este mes`,loading:n,size:"normal"})})]}),e.jsxs(M,{children:[e.jsx(d,{lg:8,className:"mb-4",children:e.jsxs(r,{className:"h-100",children:[e.jsxs(r.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"mb-0",children:"Actividades Recientes"}),p>0&&e.jsxs("small",{className:"text-muted",children:[p," actividad",p!==1?"es":""," • Actualizado automáticamente"]}),(t==null?void 0:t.role)!=="admin"&&e.jsxs("small",{className:"text-info d-block",children:["Mostrando solo actividades relevantes a tu rol: ",t==null?void 0:t.role]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(P,{variant:"outline-secondary",size:"sm",onClick:l,disabled:u,title:"Actualizar actividades",className:"refresh-btn",children:e.jsx(T,{className:u?"spinning":""})}),(t==null?void 0:t.role)==="admin"&&e.jsxs(P,{variant:"outline-primary",size:"sm",onClick:()=>c("/actividades"),title:"Ver todas las actividades (Solo Admin)",children:[e.jsx(L,{className:"me-1"}),"Ver todas"]})]})]}),e.jsx(r.Body,{children:u?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando actividades..."})}),e.jsx("p",{className:"mt-2 text-muted",children:"Cargando actividades recientes..."})]}):v.length===0?e.jsxs("div",{className:"activity-empty-state text-center",children:[e.jsx("div",{className:"mb-3",children:e.jsx(T,{size:48,className:"text-muted icon"})}),e.jsx("h6",{className:"text-muted mb-2",children:"No hay actividades recientes"}),e.jsx("p",{className:"text-muted small mb-3",children:(t==null?void 0:t.role)==="admin"?"Aún no hay actividades registradas en el sistema.":"No hay actividades relevantes a tu rol en este momento."}),e.jsxs(P,{variant:"outline-primary",size:"sm",onClick:l,className:"mt-2",children:[e.jsx(T,{className:"me-1"}),"Actualizar"]})]}):e.jsx("div",{className:"activity-list",children:v.map(s=>{const m=s.icon;return e.jsxs("div",{className:"activity-item d-flex align-items-start mb-3",children:[e.jsx("div",{className:`activity-icon bg-${s.color} bg-opacity-10 rounded-circle p-2 me-3`,children:e.jsx(m,{size:20,className:`text-${s.color}`})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:s.title}),e.jsx("p",{className:"text-muted mb-1 small",children:s.description}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:s.time}),s.user&&e.jsxs("small",{className:"text-muted",children:["por ",s.user]})]})]})]},s.id)})})})]})}),e.jsx(d,{lg:4,className:"mb-4",children:e.jsxs(r,{className:"h-100",children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Acciones Rápidas"})}),e.jsx(r.Body,{children:e.jsx("div",{className:"quick-actions",children:k.map((s,m)=>{const F=s.icon;return e.jsxs(P,{variant:`outline-${s.color}`,className:"w-100 mb-3 d-flex align-items-center justify-content-start",onClick:s.onClick,children:[e.jsx("div",{className:`me-3 bg-${s.color} bg-opacity-10 rounded-circle p-2`,children:e.jsx(F,{size:20,className:`text-${s.color}`})}),e.jsxs("div",{className:"text-start",children:[e.jsx("div",{className:"fw-medium",children:s.title}),e.jsx("small",{className:"text-muted",children:s.description})]})]},m)})})})]})})]}),e.jsxs(M,{children:[e.jsx(d,{lg:6,className:"mb-4",children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Resumen de Proyectos"})}),e.jsxs(r.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Completados"}),e.jsx("span",{className:"fw-bold text-success",children:a.completedProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Proyectos Activos"}),e.jsx("span",{className:"fw-bold text-primary",children:a.activeProjects})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Total Proyectos"}),e.jsx("span",{className:"fw-bold",children:a.totalProjects})]})]})]})}),e.jsx(d,{lg:6,className:"mb-4",children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h5",{className:"mb-0",children:"Estado del Sistema"})}),e.jsxs(r.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Usuarios Online"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(x,{className:"me-1"}),Math.floor(a.totalUsers*.3)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("span",{children:"Cotizaciones Este Mes"}),e.jsxs("span",{className:"fw-bold text-primary",children:[e.jsx(x,{className:"me-1"}),Math.floor(a.totalQuotes*.4)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Tickets Resueltos"}),e.jsxs("span",{className:"fw-bold text-success",children:[e.jsx(x,{className:"me-1"}),Math.floor(a.totalTickets*.7)]})]})]})]})})]})]})};export{te as default};
//# sourceMappingURL=Dashboard-BbnB0ugr.js.map
