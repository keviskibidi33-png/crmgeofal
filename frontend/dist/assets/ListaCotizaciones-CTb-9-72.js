import{r as f,u as I,E as T,c as u,G as V,j as a,H as L,F as l,B as y,I as C,d as x,Y as P,n as N,k as B,v as $,au as A,O as M,w as z,Q as H,V as q,m as G,h as O}from"./index-DEOVmouH.js";import{P as R}from"./PageHeader-CQkDYjTq.js";import{D as U}from"./DataTable-DczKv8iu.js";import{S as d}from"./StatsCard-nXHftVJq.js";import{c as X,l as Y,a as J,d as K,b as W}from"./quotes-0LdIpxEP.js";import{l as Z}from"./companies-CQE8_azb.js";import{l as ee}from"./projects-CIJM5hiT.js";import{R as ae,C as m}from"./Row-BbuP-81J.js";import{C as p}from"./Card-Dh58Aev9.js";import"./InputGroup-BKumZwLE.js";import"./Form-B65jexOv.js";import"./ElementChildren-gaW6uce3.js";import"./Table-CnkmMpGQ.js";import"./Spinner-C3m4zju4.js";function ve(){const[te,_]=f.useState(null),r=I(),h=T(),{data:se}=u("companiesList",()=>Z({page:1,limit:200}),{staleTime:1/0}),{data:ie}=u("projectsList",()=>ee({page:1,limit:500}),{staleTime:1/0}),{data:o,isLoading:E}=u(["quotes"],()=>W(),{keepPreviousData:!0}),w=V(K,{onSuccess:()=>{h.invalidateQueries("quotes"),_(null)},onError:e=>console.error("Error deleting quote:",e)}),F=()=>{r("/cotizaciones/nueva")},g=e=>{r(`/cotizaciones/${e.id}/editar`)},j=e=>{r(`/cotizaciones/${e.id}`)},b=e=>{window.confirm(`¿Estás seguro de que quieres eliminar la cotización "${e.code||e.id}"?`)&&w.mutate(e.id)},S=async e=>{try{const s={project_id:e.project_id,variant_id:e.variant_id||null,client_contact:e.client_contact,client_email:e.client_email,client_phone:e.client_phone,issue_date:new Date().toISOString().slice(0,10),subtotal:e.subtotal,igv:e.igv,total:e.total,status:"borrador",meta:{from_quote_id:e.id,...e.meta}},t=await X(s),i=await Y(e.id),k=Array.isArray(i==null?void 0:i.data)?i.data:i||[];for(const n of k)await J({quote_id:t.id,code:n.code,description:n.description,norm:n.norm,unit_price:Number(n.unit_price||0),quantity:Number(n.quantity||0),partial_price:Number(n.partial_price||0)});h.invalidateQueries("quotes"),r(`/cotizaciones/${t.id}/editar`)}catch(s){console.error("Error cloning quote:",s)}},D=e=>{const t={borrador:{bg:"secondary",text:"Borrador",icon:H},enviada:{bg:"primary",text:"Enviada",icon:l},aprobada:{bg:"success",text:"Aprobada",icon:x},rechazada:{bg:"danger",text:"Rechazada",icon:z},cancelada:{bg:"warning",text:"Cancelada",icon:z}}[e]||{bg:"secondary",text:e,icon:l},i=t.icon;return a.jsxs(N,{bg:t.bg,className:"status-badge d-flex align-items-center",children:[a.jsx(i,{size:12,className:"me-1"}),t.text]})},v=e=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e||0),Q=[{header:"ID",accessor:"id",width:"80px"},{header:"Código",accessor:"code",render:(e,s)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:e||`COT-${s.id}`}),a.jsxs("small",{className:"text-muted",children:[a.jsx(q,{size:12,className:"me-1"}),new Date(s.issue_date).toLocaleDateString("es-ES")]})]})},{header:"Cliente",accessor:"client",render:(e,s)=>a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:s.client_contact||"Sin contacto"}),s.client_email&&a.jsxs("small",{className:"text-muted",children:[a.jsx(G,{size:12,className:"me-1"}),s.client_email]})]})},{header:"Proyecto",accessor:"project",render:(e,s)=>{var t,i;return a.jsxs("div",{children:[a.jsx("div",{className:"fw-medium",children:((t=s.project)==null?void 0:t.name)||"Sin proyecto"}),((i=s.project)==null?void 0:i.company)&&a.jsxs("small",{className:"text-muted",children:[a.jsx(O,{size:12,className:"me-1"}),s.project.company.name]})]})}},{header:"Estado",accessor:"status",render:e=>D(e)},{header:"Total",accessor:"total",render:e=>a.jsxs("div",{className:"text-end",children:[a.jsx("div",{className:"fw-bold text-success",children:v(e)}),a.jsxs("small",{className:"text-muted",children:["IGV: ",v(e*.18)]})]})}],c=f.useMemo(()=>{const e=(o==null?void 0:o.quotes)||[],s=e.reduce((t,i)=>t+(i.total||0),0);return{total:e.length,borrador:e.filter(t=>t.status==="borrador").length,enviadas:e.filter(t=>t.status==="enviada").length,aprobadas:e.filter(t=>t.status==="aprobada").length,rechazadas:e.filter(t=>t.status==="rechazada").length,totalValue:s}},[o]);return a.jsx(L,{fluid:!0,className:"py-4",children:a.jsxs("div",{className:"fade-in",children:[a.jsx(R,{title:"Gestión de Cotizaciones",subtitle:"Crear, editar y gestionar cotizaciones del sistema",icon:l,actions:a.jsxs("div",{className:"d-flex gap-2",children:[a.jsxs(y,{variant:"outline-primary",onClick:()=>r("/cotizaciones/nueva/lem"),children:[a.jsx(C,{className:"me-2"}),"Nueva LEM"]}),a.jsxs(y,{variant:"primary",onClick:F,children:[a.jsx(C,{className:"me-2"}),"Nueva Cotización"]})]})}),a.jsxs(ae,{className:"g-4 mb-4",children:[a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Total Cotizaciones",value:c.total,icon:l,color:"primary",subtitle:"Cotizaciones registradas"})}),a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Enviadas",value:c.enviadas,icon:x,color:"success",subtitle:"Enviadas a clientes"})}),a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Aprobadas",value:c.aprobadas,icon:x,color:"info",subtitle:"Aceptadas por clientes"})}),a.jsx(m,{md:6,lg:3,children:a.jsx(d,{title:"Valor Total",value:`S/ ${c.totalValue.toLocaleString()}`,icon:P,color:"warning",subtitle:"Valor acumulado"})})]}),a.jsxs(p,{className:"shadow-sm border-0",children:[a.jsx(p.Header,{className:"bg-white border-bottom",children:a.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[a.jsxs("h5",{className:"mb-0",children:[a.jsx(l,{className:"me-2 text-primary"}),"Lista de Cotizaciones"]}),a.jsxs(N,{bg:"light",text:"dark",className:"px-3 py-2",children:[c.total," cotizaciones"]})]})}),a.jsx(p.Body,{className:"p-0",children:a.jsx(U,{data:(o==null?void 0:o.quotes)||[],columns:Q,loading:E,onEdit:g,onDelete:b,onView:j,emptyMessage:"No hay cotizaciones registradas",actions:[{label:"Ver",icon:B,onClick:j,variant:"outline-info"},{label:"Editar",icon:$,onClick:g,variant:"outline-primary"},{label:"Clonar",icon:A,onClick:S,variant:"outline-secondary"},{label:"Eliminar",icon:M,onClick:b,variant:"outline-danger"}]})})]})]})})}export{ve as default};
//# sourceMappingURL=ListaCotizaciones-CTb-9-72.js.map
