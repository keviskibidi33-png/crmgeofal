import{r as l,c as W,o as I,f as Y,Y as Ce,g as Z,O as L,N as be,j as e,G as F,U as ye,T as M,u as ze,e as D,x as V,F as A,B as u,y as Se,J as G,ad as J,X as _e,n as Ne,C as we,m as Pe,I as Ee,ae as Me}from"./index-Bcrgukx7.js";import{P as ke}from"./PageHeader-BXdzGOF9.js";/* empty css                  */import{S as y}from"./StatsCard-Bg6TicJV.js";import{C as H}from"./ConfirmModal-om5z7whj.js";import{S as Fe}from"./SuccessModal-Brilhozx.js";import{a as Te,c as De,d as X,l as Ae}from"./quotes-BsLwC50y.js";import{l as Qe}from"./companies-CT3vhc5O.js";import{l as Ie}from"./projects-CVN8cRbd.js";import{A as q}from"./Alert-C1-1JEUj.js";import{S as Le}from"./Spinner-jUAz7otr.js";import{C as Ue,R as K}from"./Row-B5ljKXp5.js";import{C as f}from"./Col-C5Zwr_ej.js";import{C as T}from"./Card-C96hNOBG.js";import{F as Be}from"./Form-DBWuP9iW.js";import"./Modal-CPMvw6Im.js";import"./ElementChildren-BWXp08bt.js";const $e=(m=[],r=c=>c.id)=>{const[c,h]=l.useState(new Set),N=Array.from(c),g=l.useCallback(o=>{const n=r(o);return c.has(n)},[c,r]),v=c.size===m.length&&m.length>0,b=c.size>0&&c.size<m.length,j=l.useCallback(o=>{const n=r(o);h(w=>{const i=new Set(w);return i.has(n)?i.delete(n):i.add(n),i})},[r]),p=l.useCallback(()=>{const o=m.map(n=>r(n));h(new Set(o))},[m,r]),C=l.useCallback(()=>{h(new Set)},[]),k=l.useCallback(()=>{v?C():p()},[v,p,C]),x=l.useCallback(()=>{h(new Set)},[]),d=l.useCallback(()=>m.filter(o=>g(o)),[m,g]);return{selectedItems:c,selectedIds:N,isAllSelected:v,isPartiallySelected:b,isSelected:g,toggleItem:j,selectAll:p,deselectAll:C,toggleAll:k,clearSelection:x,getSelectedItems:d}},Q={nuevo:{label:"Nuevo",icon:L,color:"primary",bgColor:"#007bff"},cotizacion_enviada:{label:"Cotización Enviada",icon:be,color:"info",bgColor:"#17a2b8"},pendiente_cotizacion:{label:"Pendiente de Cotización",icon:L,color:"warning",bgColor:"#ffc107"},en_negociacion:{label:"En Negociación",icon:Z,color:"secondary",bgColor:"#6c757d"},seguimiento:{label:"Seguimiento",icon:Ce,color:"info",bgColor:"#17a2b8"},ganado:{label:"Ganado",icon:Y,color:"success",bgColor:"#28a745"},perdido:{label:"Perdido",icon:I,color:"danger",bgColor:"#dc3545"}},Re=({quoteId:m,currentStatus:r,onStatusChange:c,disabled:h=!1,size:N="sm",showLabel:g=!0})=>{const[v,b]=l.useState(!1),[j,p]=l.useState(""),C=W(),k=async o=>{if(o!==r){b(!0),p("");try{await Te(m,o),c==null||c(o),C.invalidateQueries(["quotes"]),C.invalidateQueries("quotesList")}catch(n){p(n.message||"Error al actualizar estado"),console.error("Error updating quote status:",n)}finally{b(!1)}}},x=Q[r]||Q.nuevo,d=x.icon;return e.jsxs("div",{className:"quote-status-dropdown",children:[j&&e.jsx(q,{variant:"danger",className:"mb-2",style:{fontSize:"0.8rem"},children:j}),e.jsxs(F,{children:[e.jsxs(F.Toggle,{variant:x.color,size:N,disabled:h||v,className:"d-flex align-items-center gap-1",style:{backgroundColor:x.bgColor,borderColor:x.bgColor,minWidth:"140px"},children:[v?e.jsx(Le,{animation:"border",size:"sm"}):e.jsxs(e.Fragment,{children:[e.jsx(d,{size:14}),g&&e.jsx("span",{children:x.label})]}),e.jsx(ye,{size:12})]}),e.jsx(F.Menu,{children:Object.entries(Q).map(([o,n])=>{const w=n.icon,i=o===r;return e.jsxs(F.Item,{onClick:()=>k(o),disabled:i,className:`d-flex align-items-center gap-2 ${i?"active":""}`,style:{backgroundColor:i?n.bgColor:"transparent",color:i?"white":"inherit"},children:[e.jsx(w,{size:14}),e.jsx("span",{children:n.label}),i&&e.jsx(M,{size:14,className:"ms-auto"})]},o)})})]})]})};function os(){var O;const[m,r]=l.useState(null),[c,h]=l.useState(!1),[N,g]=l.useState(!1),[v,b]=l.useState(""),j=ze(),p=W(),C=l.useRef(null),{data:k}=D("companiesList",()=>Qe({page:1,limit:200}),{staleTime:1/0}),{data:x}=D("projectsList",()=>Ie({page:1,limit:500}),{staleTime:1/0}),[d,o]=l.useState(1),[n,w]=l.useState(20),{data:i,isLoading:ee,error:se}=D(["quotes",d,n],async()=>{const s=await Ae({page:d,limit:n});return s!=null&&s.data&&(s.data=s.data.map(t=>{let a=null;if(t.meta&&typeof t.meta=="string")try{a=JSON.parse(t.meta)}catch{a=null}else t.meta&&typeof t.meta=="object"&&(a=t.meta);return a&&a.customer&&(t.client_company=a.customer.company_name||t.company_name,t.client_ruc=a.customer.ruc||t.company_ruc),t})),s},{keepPreviousData:!0});console.log("📊 Datos de cotizaciones:",{data:i,quotes:((O=i==null?void 0:i.data)==null?void 0:O.length)||0,isLoading:ee,error:se});const ae=V(X,{onSuccess:()=>{p.invalidateQueries("quotes"),r(null)},onError:s=>console.error("Error deleting quote:",s)}),te=V(async s=>{const t=s.map(a=>X(a));await Promise.all(t)},{onSuccess:()=>{p.invalidateQueries("quotes"),B(),h(!1)},onError:s=>{console.error("Error deleting quotes:",s),h(!1)}}),P=(i==null?void 0:i.data)||[],{selectedIds:E,isAllSelected:ie,isSelected:U,toggleItem:ne,toggleAll:oe,clearSelection:B}=$e(P,s=>s.id),le=E.length>0,ce=()=>{j("/cotizaciones/inteligente")},re=s=>{j(`/cotizaciones/inteligente?edit=${s.id}`)},de=s=>{j(`/cotizaciones/${s.id}`)},me=s=>{r(s)},ue=async()=>{try{await ae.mutateAsync(m.id),r(null)}catch(s){console.error("Error eliminando cotización:",s),r(null)}},xe=async s=>{try{const t={project_id:s.project_id,variant_id:s.variant_id||null,client_contact:s.client_contact,client_email:s.client_email,client_phone:s.client_phone,issue_date:new Date().toISOString().slice(0,10),subtotal:s.subtotal,igv:s.igv,total:s.total,status:"borrador",meta:{from_quote_id:s.id,...s.meta}},a=await De(t);p.invalidateQueries("quotes"),b(`Cotización clonada exitosamente. Código: ${a.quote_code||a.id}`),g(!0),j(`/cotizaciones?edit=${a.id}`)}catch(t){console.error("Error cloning quote:",t),b("Error al clonar la cotización. Por favor, inténtalo de nuevo."),g(!0)}},he=()=>{h(!0)},pe=async()=>{try{await te.mutateAsync(E)}catch(s){console.error("Error eliminando cotizaciones:",s)}},ge=(s,t)=>{p.setQueryData(["quotes"],a=>a!=null&&a.data?{...a,data:a.data.map(S=>S.id===s?{...S,status:t}:S)}:a)},$=s=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN",minimumFractionDigits:2}).format(s),R=s=>new Date(s).toLocaleDateString("es-ES"),je=s=>{if(!s||!(x!=null&&x.data))return"Sin proyecto";const t=x.data.find(a=>a.id===s);return t?t.name:"Sin proyecto"},fe=s=>s?{admin:"Admin",jefa_comercial:"Jefa Com.",vendedor_comercial:"Vend.",tecnico_laboratorio:"Téc. Lab.",jefe_laboratorio:"Jefe Lab.",supervisor_campo:"Sup. Campo",tecnico_campo:"Téc. Campo"}[s]||s.substring(0,8):"",ve=s=>s&&{admin:"danger",jefa_comercial:"primary",vendedor_comercial:"info",tecnico_laboratorio:"success",jefe_laboratorio:"success",supervisor_campo:"warning",tecnico_campo:"warning"}[s]||"secondary",z=l.useMemo(()=>P.length?P.reduce((s,t)=>(s.total++,s[t.status]=(s[t.status]||0)+1,s),{total:0,nuevo:0,cotizacion_enviada:0,pendiente_cotizacion:0,en_negociacion:0,seguimiento:0,ganado:0,perdido:0}):{total:0,nuevo:0,cotizacion_enviada:0,pendiente_cotizacion:0,en_negociacion:0,seguimiento:0,ganado:0,perdido:0},[P]);return e.jsxs(Ue,{fluid:!0,className:"p-4",children:[e.jsx(ke,{title:"Lista de Cotizaciones",subtitle:"Gestiona todas las cotizaciones del sistema",icon:A,actions:e.jsxs(u,{variant:"primary",onClick:ce,children:[e.jsx(Se,{className:"me-2"}),"Nueva Cotización"]})}),e.jsxs(K,{className:"mb-4 g-2",children:[e.jsx(f,{xs:6,sm:4,md:2,children:e.jsx(y,{title:"Total",value:z.total,icon:A,color:"primary",size:"compact"})}),e.jsx(f,{xs:6,sm:4,md:2,children:e.jsx(y,{title:"Nuevas",value:z.nuevo,icon:L,color:"primary",size:"compact"})}),e.jsx(f,{xs:6,sm:4,md:2,children:e.jsx(y,{title:"Enviadas",value:z.cotizacion_enviada,icon:A,color:"info",size:"compact"})}),e.jsx(f,{xs:6,sm:4,md:2,children:e.jsx(y,{title:"En Negociación",value:z.en_negociacion,icon:Z,color:"secondary",size:"compact"})}),e.jsx(f,{xs:6,sm:4,md:2,children:e.jsx(y,{title:"Ganadas",value:z.ganado,icon:Y,color:"success",size:"compact"})}),e.jsx(f,{xs:6,sm:4,md:2,children:e.jsx(y,{title:"Perdidas",value:z.perdido,icon:I,color:"danger",size:"compact"})}),e.jsx(f,{xs:6,sm:4,md:2,children:e.jsx(y,{title:"Seleccionadas",value:E.length,icon:M,color:"warning",size:"compact"})})]}),le&&e.jsx(q,{variant:"info",className:"mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("span",{children:[e.jsx(M,{className:"me-2"}),E.length," cotización(es) seleccionada(s)"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(u,{variant:"outline-secondary",size:"sm",onClick:B,children:[e.jsx(I,{className:"me-1"}),"Cancelar"]}),e.jsxs(u,{variant:"danger",size:"sm",onClick:he,disabled:c,children:[e.jsx(G,{className:"me-1"}),c?"Eliminando...":"Eliminar Seleccionadas"]})]})]})}),e.jsx(T,{children:e.jsx(T.Body,{className:"p-0",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover mb-0",ref:C,children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"50px"},children:e.jsx(u,{variant:"outline-secondary",size:"sm",onClick:oe,className:"p-1",children:ie?e.jsx(M,{size:16}):e.jsx(J,{size:16})})}),e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Código"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Proyecto"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Creado por"}),e.jsx("th",{style:{width:"120px"},children:"Acciones"})]})}),e.jsx("tbody",{children:P.map((s,t)=>e.jsxs("tr",{className:`quote-row ${U(s)?"selected":""}`,children:[e.jsx("td",{children:e.jsx(u,{variant:"outline-secondary",size:"sm",onClick:a=>{a.stopPropagation(),ne(s)},className:"p-1",children:U(s)?e.jsx(M,{size:16}):e.jsx(J,{size:16})})}),e.jsx("td",{children:s.id}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsxs("strong",{children:["COT-",s.id]}),e.jsxs("div",{className:"text-muted small",children:[e.jsx(_e,{size:12,className:"me-1"}),R(s.issue_date)]})]})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{className:"fw-bold",children:s.client_company||s.client_contact||"Sin razón social"}),s.client_ruc&&e.jsxs("div",{className:"text-muted small",children:["RUC: ",s.client_ruc]}),s.client_contact&&s.client_company&&e.jsxs("div",{className:"text-muted small",children:[e.jsx(Ne,{size:12,className:"me-1"}),s.client_contact]}),s.client_email&&e.jsx("div",{className:"text-muted small",children:s.client_email})]})}),e.jsx("td",{children:e.jsx("span",{className:"text-muted",children:je(s.project_id)})}),e.jsx("td",{children:e.jsx(Re,{quoteId:s.id,currentStatus:s.status,onStatusChange:a=>ge(s.id,a),size:"sm",showLabel:!0})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{className:"fw-bold text-success",children:$(s.total)}),e.jsxs("div",{className:"text-muted small",children:["IGV: ",$(s.igv)]})]})}),e.jsx("td",{children:e.jsx("span",{className:"text-muted",children:R(s.created_at)})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{className:"fw-bold small",children:s.created_by_name||"Usuario desconocido"}),e.jsx("div",{className:"mt-1",children:e.jsx(we,{bg:ve(s.created_by_role),className:"small",style:{fontSize:"0.7rem"},children:fe(s.created_by_role)})}),e.jsx("div",{className:"text-muted small mt-1",children:new Date(s.created_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})})]})}),e.jsx("td",{children:e.jsxs("div",{className:"btn-group",role:"group",children:[e.jsxs(u,{variant:"outline-primary",size:"sm",onClick:a=>{a.stopPropagation(),de(s)},onMouseDown:a=>a.stopPropagation(),onMouseUp:a=>a.stopPropagation(),title:"Ver Evidencias",children:[e.jsx(Pe,{className:"me-1"}),"Evidencias"]}),e.jsx(u,{variant:"outline-secondary",size:"sm",onClick:a=>{a.stopPropagation(),re(s)},onMouseDown:a=>a.stopPropagation(),onMouseUp:a=>a.stopPropagation(),title:"Editar",children:e.jsx(Ee,{})}),e.jsx(u,{variant:"outline-info",size:"sm",onClick:a=>{a.stopPropagation(),xe(s)},onMouseDown:a=>a.stopPropagation(),onMouseUp:a=>a.stopPropagation(),title:"Clonar",children:e.jsx(Me,{})}),e.jsx(u,{variant:"outline-danger",size:"sm",onClick:a=>{a.stopPropagation(),me(s)},onMouseDown:a=>a.stopPropagation(),onMouseUp:a=>a.stopPropagation(),title:"Eliminar",children:e.jsx(G,{})})]})})]},s.id))})]})})})}),(i==null?void 0:i.total)>n&&e.jsx(T,{className:"mt-3",children:e.jsx(T.Body,{className:"py-3",children:e.jsxs(K,{className:"align-items-center",children:[e.jsx(f,{children:e.jsxs("small",{className:"text-muted",children:["Mostrando ",(d-1)*n+1," a ",Math.min(d*n,i.total)," de ",i.total," cotizaciones"]})}),e.jsx(f,{xs:"auto",children:e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsxs(Be.Select,{size:"sm",style:{width:"80px"},value:n,onChange:s=>{w(parseInt(s.target.value)),o(1)},children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:20,children:"20"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]}),e.jsx(u,{variant:"outline-secondary",size:"sm",disabled:d===1,onClick:()=>o(1),title:"Primera página",children:"««"}),e.jsx(u,{variant:"outline-secondary",size:"sm",disabled:d===1,onClick:()=>o(d-1),title:"Página anterior",children:"«"}),(()=>{const s=Math.ceil(i.total/n),t=[],a=Math.max(1,d-1),S=Math.min(s,a+2);for(let _=a;_<=S;_++)t.push(e.jsx(u,{variant:d===_?"primary":"outline-secondary",size:"sm",onClick:()=>o(_),className:"px-3",children:_},_));return t})(),e.jsx(u,{variant:"outline-secondary",size:"sm",disabled:d>=Math.ceil(i.total/n),onClick:()=>o(d+1),title:"Página siguiente",children:"»"}),e.jsx(u,{variant:"outline-secondary",size:"sm",disabled:d>=Math.ceil(i.total/n),onClick:()=>o(Math.ceil(i.total/n)),title:"Última página",children:"»»"}),e.jsxs("div",{className:"d-flex align-items-center gap-1 ms-3",children:[e.jsx("span",{className:"text-muted small",children:"Ir a:"}),e.jsx("input",{type:"number",min:"1",max:Math.ceil(i.total/n),className:"form-control form-control-sm",style:{width:"60px"},placeholder:"...",onKeyPress:s=>{if(s.key==="Enter"){const t=parseInt(s.target.value),a=Math.ceil(i.total/n);t>=1&&t<=a?(o(t),s.target.value=""):(o(a),s.target.value="")}},title:`Ingresa un número del 1 al ${Math.ceil(i.total/n)}`})]})]})})]})})}),e.jsx(H,{show:!!m,title:"Confirmar eliminación",message:`¿Estás seguro de que quieres eliminar la cotización COT-${m==null?void 0:m.id}?`,onConfirm:ue,onCancel:()=>r(null),confirmText:"Eliminar",confirmVariant:"danger"}),e.jsx(H,{show:c,title:"Confirmar eliminación múltiple",message:`¿Estás seguro de que quieres eliminar ${E.length} cotización(es) seleccionada(s)? Esta acción no se puede deshacer.`,onConfirm:pe,onCancel:()=>h(!1),confirmText:"Eliminar Todas",confirmVariant:"danger"}),e.jsx(Fe,{show:N,onHide:()=>g(!1),title:"¡Cotización Clonada!",message:v,buttonText:"Continuar"})]})}export{os as default};
//# sourceMappingURL=ListaCotizaciones-D_6Wo5C9.js.map
