import{au as I,r as n,j as e}from"./index-B6K4MeZ_.js";import{M as A}from"./ModuloBase-C9J4epBO.js";import{g as M,l as z,u as G,e as P}from"./quotes-CxJAxBZR.js";function V(){const{id:l}=I(),[s,x]=n.useState(null),[o,b]=n.useState([]),[k,v]=n.useState(!0),[m,u]=n.useState(""),[N,f]=n.useState(!1),[y,_]=n.useState("");n.useEffect(()=>{(async()=>{try{v(!0),u("");const[t,a]=await Promise.all([M(l),z(l)]);x(t),b(Array.isArray(a==null?void 0:a.data)?a.data:a||[])}catch(t){u(t.message||"No se pudo cargar la cotización")}finally{v(!1)}})()},[l]);const c=n.useMemo(()=>o.reduce((t,a)=>t+Number(a.partial_price||0),0),[o]),j=n.useMemo(()=>Number((c*.18).toFixed(2)),[c]),i=n.useMemo(()=>s?typeof s.igv=="number"?Number(s.igv):j:0,[s,j]),C=n.useMemo(()=>Number((c+i).toFixed(2)),[c,i]),S=t=>{const a="http://localhost:4000/api".replace(/\/$/,"")||"",r=`/api/quotes/${l}/export/${t}`;return a&&/\/api$/i.test(a)?`${a}${r.replace(/^\/api/,"")}`:`${a}${r}`},d=(t,a,r)=>{b(F=>{const g=[...F],p={...g[t],[a]:a==="quantity"||a==="unit_price"?Number(r):r},q=Number(p.quantity||0),$=Number(p.unit_price||0);return p.partial_price=Number((q*$).toFixed(2)),g[t]=p,g})},h=(t,a)=>{x(r=>({...r,[t]:a}))},E=async()=>{try{f(!0),u(""),_("");for(const r of o)await G(r.id,{code:r.code,description:r.description,norm:r.norm,unit_price:Number(r.unit_price||0),quantity:Number(r.quantity||0),partial_price:Number(r.partial_price||0)});const t={client_contact:(s==null?void 0:s.client_contact)||null,client_email:(s==null?void 0:s.client_email)||null,client_phone:(s==null?void 0:s.client_phone)||null,issue_date:(s==null?void 0:s.issue_date)||null,subtotal:Number(c||0),igv:Number(i||0),total:Number(C||0),status:(s==null?void 0:s.status)||"en_proceso",reference:(s==null?void 0:s.reference)||null,meta:(s==null?void 0:s.meta)||null},a=await P(l,t);x(a),_("Cambios guardados correctamente.")}catch(t){u(t.message||"No se pudo guardar los cambios")}finally{f(!1)}};return e.jsxs(A,{titulo:`Cotización #${l}`,descripcion:"Detalle y edición de la cotización.",children:[k&&e.jsx("div",{children:"Cargando..."}),m&&e.jsx("div",{className:"alert alert-danger",children:m}),s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{children:"Proyecto:"})," ",s.project_name||s.project_id]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label mb-0",children:e.jsx("strong",{children:"Emisión"})}),e.jsx("input",{type:"date",className:"form-control form-control-sm",value:(s.issue_date||"").slice(0,10),onChange:t=>h("issue_date",t.target.value)})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label mb-0",children:e.jsx("strong",{children:"Estado"})}),e.jsxs("select",{className:"form-select form-select-sm",value:s.status||"en_proceso",onChange:t=>h("status",t.target.value),children:[e.jsx("option",{value:"en_proceso",children:"En proceso"}),e.jsx("option",{value:"enviado",children:"Enviado"}),e.jsx("option",{value:"aprobado",children:"Aprobado"}),e.jsx("option",{value:"rechazado",children:"Rechazado"})]})]}),e.jsxs("div",{className:"col-md-8",children:[e.jsx("label",{className:"form-label mb-0",children:e.jsx("strong",{children:"Referencia"})}),e.jsx("input",{type:"text",className:"form-control form-control-sm",value:s.reference||"",onChange:t=>h("reference",t.target.value),placeholder:"Asunto / referencia"})]}),e.jsxs("div",{className:"col-md-4 d-flex align-items-end",children:[e.jsxs("div",{className:"form-check me-3",children:[e.jsx("input",{id:"igvCheck",className:"form-check-input",type:"checkbox",checked:Number(i)>0,onChange:t=>h("igv",t.target.checked?j:0)}),e.jsx("label",{className:"form-check-label",htmlFor:"igvCheck",children:"Aplicar IGV 18%"})]}),e.jsxs("div",{className:"small text-muted",children:["IGV actual: S/ ",Number(i||0).toFixed(2)]})]})]}),e.jsx("div",{className:"table-responsive mt-3",children:e.jsxs("table",{className:"table table-bordered align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código"}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{children:"Norma"}),e.jsx("th",{children:"Unitario"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Parcial"})]})}),e.jsxs("tbody",{children:[o.map((t,a)=>e.jsxs("tr",{children:[e.jsx("td",{style:{width:"12rem"},children:e.jsx("input",{className:"form-control form-control-sm",value:t.code||"",onChange:r=>d(a,"code",r.target.value)})}),e.jsx("td",{children:e.jsx("textarea",{className:"form-control form-control-sm",rows:2,value:t.description||"",onChange:r=>d(a,"description",r.target.value)})}),e.jsx("td",{style:{width:"10rem"},children:e.jsx("input",{className:"form-control form-control-sm",value:t.norm||"",onChange:r=>d(a,"norm",r.target.value)})}),e.jsx("td",{style:{width:"10rem"},children:e.jsxs("div",{className:"input-group input-group-sm",children:[e.jsx("span",{className:"input-group-text",children:"S/"}),e.jsx("input",{type:"number",step:"0.01",className:"form-control",value:t.unit_price??0,onChange:r=>d(a,"unit_price",r.target.value)})]})}),e.jsx("td",{style:{width:"8rem"},children:e.jsx("input",{type:"number",step:"1",className:"form-control form-control-sm",value:t.quantity??0,onChange:r=>d(a,"quantity",r.target.value)})}),e.jsxs("td",{style:{width:"10rem"},children:["S/ ",Number(t.partial_price||0).toFixed(2)]})]},t.id)),o.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center text-muted",children:"Sin ítems"})})]})]})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-start gap-4 mt-3",children:[e.jsxs("div",{children:[y&&e.jsx("div",{className:"alert alert-success py-1 px-2 mb-2",children:y}),m&&e.jsx("div",{className:"alert alert-danger py-1 px-2 mb-2",children:m}),e.jsx("button",{className:"btn btn-primary",onClick:E,disabled:N,children:N?"Guardando...":"Guardar Cambios"})]}),e.jsxs("div",{className:"text-end",children:[e.jsxs("div",{children:["Subtotal: S/ ",c.toFixed(2)]}),e.jsxs("div",{children:["IGV: S/ ",i.toFixed(2)]}),e.jsx("div",{children:e.jsxs("strong",{children:["Total: S/ ",C.toFixed(2)]})})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("a",{className:"btn btn-outline-secondary",href:S("pdf"),target:"_blank",rel:"noreferrer",children:"Exportar PDF"}),e.jsx("a",{className:"btn btn-outline-secondary",href:S("excel"),target:"_blank",rel:"noreferrer",children:"Exportar Excel"})]})]})]})]})}export{V as default};
//# sourceMappingURL=DetalleCotizacion-C13VfLZ5.js.map
