import{r as l,R as B,c as de,u as me,e as P,H as M,j as e,I as ue,h as E,B as g,J as pe,k as G,o as T,D as J,p as C,M as he,N as ge,x as Ce,O as be,P as ye}from"./index-D5j7Etbr.js";import{P as xe}from"./PageHeader-BAMnoJ00.js";import{D as fe}from"./DataTable-BSDUXWv5.js";import{M as Se}from"./ModalForm-OWlJb50t.js";import{S as b}from"./StatsCard-CrtJfzkh.js";import{d as je,c as Ne,u as ve,l as Pe,g as Me,a as Ee}from"./companies-BQpw0ewS.js";import{R as Te,C as y,a as A}from"./Row-BbCd5WYq.js";import"./InputGroup-CuAl69_P.js";import"./ElementChildren-BZ8oKQvH.js";import"./Table-BrvfnYPw.js";/* empty css                     */import"./Modal-BtZGspVd.js";import"./Spinner-DkvOZ9XA.js";const F=()=>{try{const n=localStorage.getItem("token");if(!n)return null;const r=JSON.parse(atob(n.split(".")[1]));return{id:r.id,name:r.name,role:r.role,email:r.email}}catch(n){return console.error("Error decodificando token:",n),null}},k=n=>{const r=F();return r?(typeof n=="string"&&(n=[n]),n.includes(r.role)):!1},Q=()=>k(["admin","jefa_comercial","vendedor_comercial"]),Ae=()=>k(["admin","jefa_comercial","vendedor_comercial"]),Fe=()=>k(["admin","jefa_comercial"]),ke=()=>{const n=F();n?(console.log("üë§ Usuario actual:",{id:n.id,name:n.name,role:n.role,email:n.email}),console.log("üîê Permisos:",{canCreateClient:Q(),canEditClient:Ae(),canDeleteClient:Fe()})):console.log("‚ùå No hay usuario autenticado")},_={type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:"",city:"",sector:""};function Ke(){const[n,r]=l.useState(!1),[d,x]=l.useState(null),[Ie,$]=l.useState(null),m=F(),f=Q();B.useEffect(()=>{ke()},[]);const[S,j]=l.useState(1),[I,U]=l.useState(""),[L,W]=l.useState(""),[D,K]=l.useState(""),[H,V]=l.useState(""),[Y,z]=l.useState(!1),N=de(),Z=me(),{data:c,isLoading:X,refetch:Le}=P(["clients",S,I,L,D,H],()=>Pe({page:S,limit:20,search:I,type:L,city:D,sector:H}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:o,isLoading:h,error:De}=P(["clientStats"],Me,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4});B.useEffect(()=>{o&&o.data&&console.log("‚úÖ Estad√≠sticas cargadas correctamente:",{total:o.data.total,empresas:o.data.empresas,personas:o.data.personas})},[o]);const{data:u,isLoading:He}=P(["clientFilterOptions"],Ee,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:6e4,cacheTime:3e5}),v=a=>{N.invalidateQueries("clients"),N.invalidateQueries("clientStats"),N.invalidateQueries("clientFilterOptions"),r(!1),x(null),$(null)},ee=a=>{console.log("üîç handleSearch - B√∫squeda:",a),U(a),j(1),z(!0),setTimeout(()=>z(!1),1e3)},ae=a=>{console.log("üîç handleFilter - Filtros:",a),W(a.type||""),K(a.city||""),V(a.sector||""),j(1)},te=l.useMemo(()=>{var a,t,s;return u?[{title:"Por Tipo de Cliente",options:((a=u.types)==null?void 0:a.map(i=>({label:`${i.label} (${i.count})`,filter:{type:i.value}})))||[]},{title:"Por Sector",options:((t=u.sectors)==null?void 0:t.map(i=>({label:`${i.label} (${i.count})`,filter:{sector:i.value}})))||[]},{title:"Por Ciudad",options:((s=u.cities)==null?void 0:s.map(i=>({label:`${i.label} (${i.count})`,filter:{city:i.value}})))||[]}]:[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona"}}]}]},[u]),O=M(Ne,{onSuccess:()=>v(),onError:a=>{console.error("Error creating client:",a),console.error("Error details:",{message:a.message,status:a.status,body:a.body})}}),q=M(ve,{onSuccess:()=>v(),onError:a=>console.error("Error updating client:",a)}),se=M(je,{onSuccess:()=>v(),onError:a=>console.error("Error deleting client:",a)}),ne=()=>{x(_),r(!0)},w=a=>{x(a),r(!0)},R=a=>{window.confirm(`¬øEst√°s seguro de que quieres eliminar el cliente "${a.name}"?`)&&se.mutate(a.id)},oe=a=>{Z("/proyectos",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city}}})},ie=async a=>{d.id?await q.mutateAsync({id:d.id,...a}):await O.mutateAsync(a)},re=a=>{const s={empresa:{bg:"primary",text:"Empresa",icon:G},persona:{bg:"info",text:"Persona Natural",icon:T}}[a]||{bg:"secondary",text:a,icon:T},i=s.icon;return e.jsxs(C,{bg:s.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(i,{size:12,className:"me-1"}),s.text]})},le=[{header:"ID",accessor:"id",width:"80px"},{header:"Cliente",accessor:"name",render:(a,t)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:t.name}),e.jsxs("div",{className:"d-flex align-items-center gap-2 mt-1",children:[re(t.type),t.ruc&&e.jsxs("small",{className:"text-muted",children:["RUC: ",t.ruc]}),t.dni&&e.jsxs("small",{className:"text-muted",children:["DNI: ",t.dni]})]})]})},{header:"Contacto",accessor:"contact",render:(a,t)=>e.jsxs("div",{children:[t.contact_name&&e.jsx("div",{className:"fw-medium",children:t.contact_name}),t.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(J,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:t.email})]}),t.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(he,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:t.phone})]})]})},{header:"Ciudad",accessor:"city",render:a=>{const t=a||"No especificada";let s="secondary";switch(t){case"Lima":s="primary";break;case"Arequipa":s="info";break;case"Cusco":s="success";break;case"Trujillo":s="warning";break;case"Piura":s="danger";break;case"Chiclayo":s="info";break;case"Iquitos":s="success";break;case"Huancayo":s="warning";break;default:s="secondary"}return e.jsx(C,{bg:s,className:"px-2 py-1",children:t})}},{header:"Sector",accessor:"sector",render:a=>{const t=a||"General";let s="secondary";switch(t){case"Construcci√≥n":s="warning";break;case"Miner√≠a":s="dark";break;case"Ingenier√≠a":s="primary";break;case"Laboratorio":s="info";break;case"Consultor√≠a":s="success";break;case"Tecnolog√≠a":s="primary";break;case"Ambiental":s="success";break;case"Geolog√≠a":s="info";break;default:s="secondary"}return e.jsx(C,{bg:s,className:"px-2 py-1",children:t})}},{header:"Direcci√≥n",accessor:"address",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(ge,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin direcci√≥n"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,t)=>e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(g,{variant:"outline-primary",size:"sm",onClick:()=>w(t),title:"Editar cliente",children:e.jsx(Ce,{size:14})}),e.jsx(g,{variant:"outline-success",size:"sm",onClick:()=>oe(t),title:"Crear proyecto para este cliente",children:e.jsx(be,{size:14})}),e.jsx(g,{variant:"outline-danger",size:"sm",onClick:()=>R(t),title:"Eliminar cliente",children:e.jsx(ye,{size:14})})]})}],ce=[{name:"type",label:"Tipo de Cliente",type:"select",required:!0,options:[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}]},{name:"name",label:"Nombre/Raz√≥n Social",type:"text",required:!0,placeholder:"Ingresa el nombre o raz√≥n social"},{name:"ruc",label:"RUC",type:"text",placeholder:"Ingresa el RUC (solo para empresas)",help:"Solo para empresas"},{name:"dni",label:"DNI",type:"text",placeholder:"Ingresa el DNI (solo para personas)",help:"Solo para personas naturales"},{name:"contact_name",label:"Nombre de Contacto",type:"text",placeholder:"Ingresa el nombre del contacto"},{name:"email",label:"Email",type:"email",placeholder:"contacto@empresa.com"},{name:"phone",label:"Tel√©fono",type:"text",placeholder:"+51 999 999 999"},{name:"address",label:"Direcci√≥n",type:"textarea",placeholder:"Ingresa la direcci√≥n completa"},{name:"city",label:"Ciudad",type:"text",placeholder:"Escribe la ciudad (ej: Lima, Arequipa, Cusco...)",autocomplete:!0,suggestions:["Lima","Arequipa","Cusco","Trujillo","Piura","Chiclayo","Iquitos","Huancayo","Tacna","Cajamarca","Ayacucho","Puno","Juliaca","Chimbote","Huaraz","Abancay","Andahuaylas","Tumbes","Pucallpa","Tarapoto","Moyobamba","Cerro de Pasco","Hu√°nuco","Ica","Nazca","Chincha","Ca√±ete","Barranca","Huaral","Callao","Ventanilla","San Juan de Miraflores","Villa El Salvador","San Mart√≠n de Porres","Comas","Los Olivos","San Miguel","Pueblo Libre","Jes√∫s Mar√≠a","Magdalena","San Isidro","Miraflores","Surco","La Molina","Ate","Santa Anita","El Agustino","San Juan de Lurigancho","Lurigancho","Chosica","Chaclacayo","Cieneguilla","Pachac√°mac","Punta Hermosa","Punta Negra","San Bartolo","Santa Mar√≠a del Mar","Pucusana","Asia","Mala","San Vicente de Ca√±ete","Imperial","Nuevo Imperial","Quilman√°","San Luis","San Pedro de Lloc","Pacasmayo","Guadalupe","Jequetepeque","Chep√©n","Cascas","Contumaz√°","Cupisnique","Guzmango","San Benito","San Diego","San Jos√©","San Pablo","Tembladera","Yon√°n","Za√±a","Cajabamba","Cajamarca","Celend√≠n","Chota","Contumaz√°","Cutervo","Hualgayoc","Ja√©n","San Ignacio","San Marcos","San Miguel","San Pablo","Santa Cruz","Bagua","Bongar√°","Condorcanqui","Luya","Rodr√≠guez de Mendoza","Utcubamba","Chachapoyas","Asunci√≥n","Balsas","Cheto","Chiliqu√≠n","Chuquibamba","Granada","Huancas","La Jalca","Leimebamba","Levanto","Magdalena","Mariscal Castilla","Molinopampa","Montevideo","Olleros","Quinjalca","San Francisco de Daguas","San Isidro de Maino","Soloco","Sonche","Abancay","Andahuaylas","Antabamba","Aymaraes","Chincheros","Cotabambas","Grau","Huancarama","Huancaray","Huanipaca","Kishuara","Lambrama","Pacobamba","Pacucha","Pampachiri","Pomacocha","San Antonio de Cachi","San Jer√≥nimo","San Miguel de Chaccrampa","Santa Mar√≠a de Chicmo","Talavera","Tamburco","Andahuaylas","Antabamba","Aymaraes","Chincheros","Cotabambas","Grau","Huancarama","Huancaray","Huanipaca","Kishuara","Lambrama","Pacobamba","Pacucha","Pampachiri","Pomacocha","San Antonio de Cachi","San Jer√≥nimo","San Miguel de Chaccrampa","Santa Mar√≠a de Chicmo","Talavera","Tamburco"]},{name:"sector",label:"Sector",type:"text",placeholder:"Escribe el sector (ej: Construcci√≥n, Miner√≠a, Tecnolog√≠a...)",autocomplete:!0,suggestions:["General","Construcci√≥n","Miner√≠a","Ingenier√≠a","Laboratorio","Consultor√≠a","Tecnolog√≠a","Ambiental","Geolog√≠a","Agricultura","Ganader√≠a","Pesca","Manufactura","Textil","Alimentario","Farmac√©utico","Qu√≠mico","Petroqu√≠mico","Energ√≠a","Electricidad","Gas","Agua","Saneamiento","Transporte","Log√≠stica","Comercio","Retail","Mayorista","Distribuci√≥n","Servicios Financieros","Banca","Seguros","Inversiones","Bienes Ra√≠ces","Inmobiliaria","Turismo","Hoteler√≠a","Restaurantes","Entretenimiento","Medios","Comunicaciones","Telecomunicaciones","Software","Hardware","Sistemas","Internet","E-commerce","Marketing","Publicidad","Educaci√≥n","Capacitaci√≥n","Investigaci√≥n","Desarrollo","Salud","Medicina","Farmac√©utica","Biotecnolog√≠a","Gobierno","P√∫blico","Defensa","Seguridad","Legal","Jur√≠dico","Contable","Auditor√≠a","Recursos Humanos","Administraci√≥n","Gesti√≥n","Consultor√≠a Empresarial","Outsourcing","Servicios Profesionales","Arquitectura","Dise√±o","Arte","Cultura","Deportes","Recreaci√≥n","ONG","Fundaciones","Religioso","Espiritual","Otro"]}],p=l.useMemo(()=>{if(o&&o.data)return console.log("üìä Stats - Usando estad√≠sticas reales del backend:",o),console.log("üìä Stats - Datos extra√≠dos:",o.data),{total:o.data.total||0,empresas:o.data.empresas||0,personas:o.data.personas||0,conEmail:o.data.withEmail||0,conTelefono:o.data.withPhone||0};const a=(c==null?void 0:c.data)||[];return console.log("üìä Stats - Fallback: calculando desde p√°gina actual:",a),{total:a.length,empresas:a.filter(t=>t.type==="empresa").length,personas:a.filter(t=>t.type==="persona").length,conEmail:a.filter(t=>t.email).length,conTelefono:a.filter(t=>t.phone).length}},[o,c]);return e.jsx(ue,{fluid:!0,className:"py-4",children:e.jsxs("div",{className:"fade-in",children:[e.jsx(xe,{title:"Gesti√≥n de Clientes",subtitle:"Crear, editar y gestionar clientes del sistema",icon:E,actions:e.jsxs(g,{variant:"primary",onClick:ne,disabled:!f,title:f?"Crear nuevo cliente":`No tienes permisos para crear clientes. Rol actual: ${(m==null?void 0:m.role)||"No autenticado"}`,children:[e.jsx(pe,{className:"me-2"}),"Nuevo Cliente"]})}),!f&&e.jsxs("div",{className:"alert alert-warning mb-4",role:"alert",children:[e.jsx("strong",{children:"‚ö†Ô∏è Permisos insuficientes:"})," Tu rol actual (",(m==null?void 0:m.role)||"No autenticado",") no tiene permisos para crear clientes. Solo los roles ",e.jsx("code",{children:"admin"}),", ",e.jsx("code",{children:"jefa_comercial"})," y ",e.jsx("code",{children:"vendedor_comercial"})," pueden crear clientes."]}),e.jsxs(Te,{className:"g-4 mb-4",children:[e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Total Clientes",value:p.total,icon:E,color:"primary",subtitle:"Clientes registrados",loading:h})}),e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Empresas",value:p.empresas,icon:G,color:"success",subtitle:"Clientes corporativos",loading:h})}),e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Personas",value:p.personas,icon:T,color:"info",subtitle:"Clientes individuales",loading:h})}),e.jsx(y,{md:6,lg:3,children:e.jsx(b,{title:"Con Contacto",value:p.conEmail,icon:J,color:"warning",subtitle:"Con email registrado",loading:h})})]}),e.jsxs(A,{className:"shadow-sm border-0",children:[e.jsx(A.Header,{className:"bg-white border-bottom",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(E,{className:"me-2 text-primary"}),"Lista de Clientes"]}),e.jsxs(C,{bg:"light",text:"dark",className:"px-3 py-2",children:[p.total," clientes"]})]})}),e.jsx(A.Body,{className:"p-0",children:e.jsx(fe,{data:(c==null?void 0:c.data)||[],columns:le,loading:X||Y,onEdit:w,onDelete:R,emptyMessage:"No hay clientes registrados",totalItems:(c==null?void 0:c.total)||0,itemsPerPage:20,currentPage:S,onPageChange:j,onSearch:ee,onFilter:ae,filterOptions:te})})]}),e.jsx(Se,{show:n,onHide:()=>r(!1),title:d!=null&&d.id?"Editar Cliente":"Nuevo Cliente",data:d||_,fields:ce,onSubmit:ie,loading:O.isLoading||q.isLoading,submitText:d!=null&&d.id?"Actualizar":"Crear"})]})})}export{Ke as default};
//# sourceMappingURL=Clientes-DfvjPmQr.js.map
