import{r as n,R as $,j as e,n as q,o as re,k as D,E as V,p as J,q as ze,K as ce,w as Je,c as ke,L as Ke,f as Ye,g as Ue,M as Xe,N as Re,O as Ze,P as es,Q as ss,S as as,T as ts,U as is,u as ls,e as ie,x as le,B as O,V as os,y as ns,h as Se,C as _,I as rs,W as cs,J as we}from"./index-CtKhHIj1.js";import{D as ds}from"./DataTable-BWGtzuoJ.js";/* empty css                     */import{S as G}from"./StatsCard-DJ5F0G0T.js";import{C as ms}from"./ConfirmModal-CsXbinIh.js";import{P as us}from"./PermissionDeniedModal-D1YI6WBh.js";import{u as ps,c as hs,a as fs,d as xs,l as gs,g as bs,b as js}from"./companies-DISvptRY.js";import{A as vs}from"./Alert-DLU9YLmA.js";import{S as Ns}from"./Spinner-C5xAt4Ff.js";import{C as Cs,a as ys}from"./ClientSuccessModal-DZHDs8TV.js";import{g as Ss,c as ws,a as Es,b as zs,d as ks,e as Rs,l as Ds}from"./authHelper-YcFWq3xo.js";import{C as Fs,R as Ts}from"./Row-Bg668ZHh.js";import{C as W}from"./Col-B1bT4BUl.js";import{C as oe}from"./Card-BJy_ikLO.js";/* empty css                  */import"./InputGroup-BTxINst8.js";import"./Form-AwA8fx0S.js";import"./ElementChildren-CQMxDn8v.js";import"./Table-DD-Em4tk.js";import"./Modal-Bmxf1CSY.js";import"./Tabs-CCvyw6ub.js";const Ps=[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}],Is=[{value:"construccion",label:"Construcción"},{value:"mineria",label:"Minería"},{value:"servicios",label:"Servicios"},{value:"comercio",label:"Comercio"},{value:"industria",label:"Industria"},{value:"gobierno",label:"Gobierno"},{value:"otro",label:"Otro"}],Ms=[{value:"lima",label:"Lima"},{value:"arequipa",label:"Arequipa"},{value:"trujillo",label:"Trujillo"},{value:"chiclayo",label:"Chiclayo"},{value:"piura",label:"Piura"},{value:"cusco",label:"Cusco"},{value:"otro",label:"Otra"}],Os=[{value:"urgent",label:"URGENTE"},{value:"high",label:"ALTA"},{value:"normal",label:"NORMAL"},{value:"low",label:"BAJA"}],qs=({show:F,onHide:x,data:i={},onSubmit:I,loading:C=!1,isEditing:v=!1})=>{const[l,T]=n.useState({type:i.type||"empresa",name:i.name||"",ruc:i.ruc||"",dni:i.dni||"",contact_name:i.contact_name||"",email:i.email||"",phone:i.phone||"",address:i.address||"",city:i.city||"lima",sector:i.sector||"servicios",priority:i.priority||"normal",actividad:i.actividad||"",servicios:i.servicios||""}),[c,g]=n.useState({});$.useEffect(()=>{if(F){const s=!i.id;T({type:i.type||"empresa",name:s?"":i.name||"",ruc:s?"":i.ruc||"",dni:s?"":i.dni||"",contact_name:s?"":i.contact_name||"",email:s?"":i.email||"",phone:s?"":i.phone||"",address:s?"":i.address||"",city:i.city||"lima",sector:i.sector||"servicios",priority:i.priority||"normal",actividad:s?"":i.actividad||"",servicios:s?"":i.servicios||""}),g({})}},[F,i,v]);const m=(s,p)=>{T(u=>({...u,[s]:p})),s==="ruc"&&l.type==="empresa"&&(p&&!b(p)?g(u=>({...u,ruc:"El RUC debe empezar con 20 o 209999999 y tener 11 dígitos"})):g(u=>({...u,ruc:""}))),s==="dni"&&l.type==="persona"&&(p&&!E(p)?g(u=>({...u,dni:"El DNI debe tener exactamente 8 dígitos"})):g(u=>({...u,dni:""}))),s==="phone"&&(p&&!N(p)?g(u=>({...u,phone:"El teléfono debe tener 9 dígitos"})):g(u=>({...u,phone:""}))),c[s]&&s!=="ruc"&&s!=="dni"&&g(u=>({...u,[s]:""}))},b=s=>s?/^(20|209999999)\d{9}$/.test(s):!1,E=s=>s?/^\d{8}$/.test(s):!1,N=s=>s?/^\d{9}$/.test(s):!0,R=()=>{const s={};return l.name.trim()||(s.name="El nombre/razón social es requerido"),l.type==="empresa"&&(l.ruc.trim()?b(l.ruc)||(s.ruc="El RUC debe empezar con 20 o 209999999 y tener 11 dígitos"):s.ruc="El RUC es requerido para empresas"),l.type==="persona"&&(l.dni.trim()?E(l.dni)||(s.dni="El DNI debe tener exactamente 8 dígitos"):s.dni="El DNI es requerido para personas naturales"),l.email&&!/\S+@\S+\.\S+/.test(l.email)&&(s.email="El email no es válido"),l.phone&&!N(l.phone)&&(s.phone="El teléfono debe tener 9 dígitos"),g(s),Object.keys(s).length===0},z=s=>{if(s.preventDefault(),R()){const p={...l};p.type==="empresa"?delete p.dni:delete p.ruc,I(p)}};return $.useEffect(()=>{i.error&&(i.error.includes("email")||i.error.includes("Email"))&&g(s=>({...s,email:"Este email ya está registrado"}))},[i.error]),F?e.jsx("div",{className:"client-form-backdrop",onClick:x,children:e.jsxs("div",{className:"client-form-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"client-form-header",children:[e.jsxs("h4",{children:[e.jsx(q,{className:"client-form-icon"}),v?"Editar Cliente":"Nuevo Cliente"]}),e.jsx("button",{className:"close-btn",onClick:x,children:e.jsx(re,{})})]}),e.jsxs("form",{onSubmit:z,className:"client-form-body",children:[e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(q,{className:"client-form-icon"}),"Información Básica"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Tipo de Cliente ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("select",{className:"client-form-select",value:l.type,onChange:s=>m("type",s.target.value),children:Ps.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(V,{className:"client-form-icon"}),"Nombre/Razón Social ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${c.name?"error":""}`,value:l.name,onChange:s=>m("name",s.target.value),placeholder:"Ingresa el nombre o razón social"}),c.name&&e.jsx("div",{className:"client-form-error",children:c.name})]})]}),e.jsxs("div",{className:"client-form-row",children:[l.type==="empresa"?e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"RUC ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${c.ruc?"error":l.ruc&&b(l.ruc)?"valid":""}`,value:l.ruc,onChange:s=>m("ruc",s.target.value),placeholder:"20123456789",maxLength:"11"}),c.ruc&&e.jsx("div",{className:"client-form-error",children:c.ruc}),e.jsx("div",{className:"client-form-help",children:"Solo para empresas - Debe empezar con 20 y tener 11 dígitos"})]}):e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(q,{className:"client-form-icon"}),"DNI ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",className:`client-form-input ${c.dni?"error":l.dni&&E(l.dni)?"valid":""}`,value:l.dni,onChange:s=>m("dni",s.target.value),placeholder:"12345678",maxLength:"8"}),c.dni&&e.jsx("div",{className:"client-form-error",children:c.dni}),e.jsx("div",{className:"client-form-help",children:"Solo para personas naturales - Debe tener exactamente 8 dígitos"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(q,{className:"client-form-icon"}),"Nombre de Contacto"]}),e.jsx("input",{type:"text",className:"client-form-input",value:l.contact_name,onChange:s=>m("contact_name",s.target.value),placeholder:"Ingresa el nombre del contacto"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(J,{className:"client-form-icon"}),"Información de Contacto"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(J,{className:"client-form-icon"}),"Email"]}),e.jsx("input",{type:"email",className:`client-form-input ${c.email?"error":""}`,value:l.email,onChange:s=>m("email",s.target.value),placeholder:"contacto@empresa.com"}),c.email&&e.jsx("div",{className:"client-form-error",children:c.email})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(ze,{className:"client-form-icon"}),"Teléfono"]}),e.jsx("input",{type:"tel",className:`client-form-input ${c.phone?"error":l.phone&&N(l.phone)?"valid":""}`,value:l.phone,onChange:s=>m("phone",s.target.value),placeholder:"930238631",maxLength:"9"}),c.phone&&e.jsx("div",{className:"client-form-error",children:c.phone}),e.jsx("div",{className:"client-form-help",children:"Debe tener 9 dígitos"})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(ce,{className:"client-form-icon"}),"Información de Ubicación"]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(ce,{className:"client-form-icon"}),"Dirección"]}),e.jsx("input",{type:"text",className:"client-form-input",value:l.address,onChange:s=>m("address",s.target.value),placeholder:"Ingresa la dirección"})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Ciudad"]}),e.jsx("select",{className:"client-form-select",value:l.city,onChange:s=>m("city",s.target.value),children:Ms.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"client-form-row",children:[e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Sector"]}),e.jsx("select",{className:"client-form-select",value:l.sector,onChange:s=>m("sector",s.target.value),children:Is.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(V,{className:"client-form-icon"}),"Prioridad"]}),e.jsx("select",{className:"client-form-select",value:l.priority,onChange:s=>m("priority",s.target.value),children:Os.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]})]}),e.jsxs("div",{className:"client-form-section",children:[e.jsxs("div",{className:"client-form-section-title",children:[e.jsx(D,{className:"client-form-icon"}),"Actividad y Servicios"]}),e.jsx("div",{className:"client-form-row single",children:e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Actividad Principal"]}),e.jsx("textarea",{className:"client-form-input",value:l.actividad,onChange:s=>m("actividad",s.target.value),placeholder:"Describe la actividad principal de la empresa",rows:"3"}),e.jsx("div",{className:"client-form-help",children:"Describe brevemente a qué se dedica la empresa"})]})}),e.jsx("div",{className:"client-form-row single",children:e.jsxs("div",{className:"client-form-group",children:[e.jsxs("label",{className:"client-form-label",children:[e.jsx(D,{className:"client-form-icon"}),"Servicios"]}),e.jsx("textarea",{className:"client-form-input",value:l.servicios,onChange:s=>m("servicios",s.target.value),placeholder:"Describe los servicios que ofrece o requiere la empresa",rows:"3"}),e.jsx("div",{className:"client-form-help",children:"Lista los servicios que ofrece o que necesita la empresa"})]})})]})]}),e.jsxs("div",{className:"client-form-actions",children:[e.jsxs("button",{type:"button",className:"client-form-btn client-form-btn-cancel",onClick:x,disabled:C,children:[e.jsx(re,{}),"Cancelar"]}),e.jsx("button",{type:"submit",className:"client-form-btn client-form-btn-create",onClick:z,disabled:C,children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})}),v?"Actualizando...":"Creando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Je,{}),v?"Actualizar":"Crear"]})})]})]})}):null},ne={prospeccion:{label:"Prospección",icon:ss,color:"secondary",bgColor:"#6c757d"},contactado:{label:"Contactado",icon:V,color:"primary",bgColor:"#007bff"},no_contesto:{label:"No contestó",icon:es,color:"warning",bgColor:"#ffc107"},interesado:{label:"Interesado",icon:Ze,color:"info",bgColor:"#17a2b8"},pendiente_cotizacion:{label:"Pendiente de Cotización",icon:Re,color:"warning",bgColor:"#ffc107"},cotizacion_enviada:{label:"Cotización Enviada",icon:Xe,color:"info",bgColor:"#17a2b8"},negociacion:{label:"Negociación",icon:Ue,color:"secondary",bgColor:"#6c757d"},ganado:{label:"Ganado",icon:Ye,color:"success",bgColor:"#28a745"},perdido:{label:"Perdido",icon:re,color:"danger",bgColor:"#dc3545"},otro:{label:"Otro",icon:Ke,color:"light",bgColor:"#f8f9fa"}},Ls=({clientId:F,currentStatus:x,onStatusChange:i,disabled:I=!1,size:C="sm",showLabel:v=!0})=>{const[l,T]=n.useState(!1),[c,g]=n.useState(""),[m,b]=n.useState(!1),[E,N]=n.useState({top:0,left:0}),R=n.useRef(null),z=n.useRef(null),s=ke(),p=()=>{if(R.current){const h=R.current.getBoundingClientRect();N({top:h.bottom+5,left:h.left})}b(!m)},u=h=>{m&&z.current&&!z.current.contains(h.target)&&R.current&&!R.current.contains(h.target)&&b(!1)};n.useEffect(()=>{if(m)return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[m]);const K=async h=>{if(h!==x){console.log(`🔄 ClientStatusDropdown - Iniciando cambio de estado del cliente ${F} de '${x}' a '${h}'`),i==null||i(h),b(!1),T(!0),g("");try{console.log("🔄 ClientStatusDropdown - Llamando a updateClientStatus...");const k=await ps(F,h);console.log("✅ ClientStatusDropdown - Estado actualizado exitosamente:",k),s.invalidateQueries(["clients"]),s.invalidateQueries(["commercial-clients"]),s.invalidateQueries(["commercial-clients-with-totals"]),s.invalidateQueries("companiesList"),s.invalidateQueries("clientStats"),s.invalidateQueries("companyStats"),s.invalidateQueries("clientFilterOptions"),s.refetchQueries(["commercial-clients-with-totals"]),s.refetchQueries(["clients"])}catch(k){console.error("❌ ClientStatusDropdown - Error al actualizar estado:",k),g(k.message||"Error al actualizar estado"),console.log(`🔄 ClientStatusDropdown - Revirtiendo estado a '${x}'`),i==null||i(x)}finally{T(!1)}}},M=ne[x]||ne.prospeccion,L=M.icon,Y=m&&as.createPortal(e.jsx("div",{ref:z,className:"dropdown-menu show",style:{position:"fixed",top:E.top,left:E.left,zIndex:99999,minWidth:"200px",maxHeight:"300px",overflowY:"auto",boxShadow:"0 0.5rem 1rem rgba(0, 0, 0, 0.15)",border:"1px solid rgba(0, 0, 0, 0.15)",borderRadius:"0.375rem",backgroundColor:"white"},children:Object.entries(ne).map(([h,k])=>{const Q=k.icon,o=h===x;return e.jsxs("button",{className:`dropdown-item d-flex align-items-center gap-2 ${o?"active":""}`,onClick:()=>K(h),disabled:o,style:{border:"none",background:o?k.bgColor:"transparent",color:o?"white":"#212529",width:"100%",textAlign:"left",padding:"0.5rem 1rem",cursor:"pointer"},onMouseEnter:P=>{o||(P.target.style.backgroundColor="#f8f9fa")},onMouseLeave:P=>{o||(P.target.style.backgroundColor="transparent")},children:[e.jsx(Q,{size:14}),e.jsx("span",{children:k.label}),o&&e.jsx(ts,{size:14,className:"ms-auto"})]},h)})}),document.body);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-status-dropdown",children:[c&&e.jsx(vs,{variant:"danger",className:"mb-2",style:{fontSize:"0.8rem"},children:c}),e.jsxs("button",{ref:R,className:`btn btn-${M.color} btn-${C} d-flex align-items-center gap-1`,onClick:p,disabled:I||l,style:{backgroundColor:M.bgColor,borderColor:M.bgColor,minWidth:"140px"},children:[l?e.jsx(Ns,{animation:"border",size:"sm"}):e.jsxs(e.Fragment,{children:[e.jsx(L,{size:14}),v&&e.jsx("span",{children:M.label})]}),e.jsx(is,{size:12})]})]}),Y]})},Ee={id:null,type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:"",city:"",sector:"",priority:"normal",actividad:"",servicios:""};function ra(){var Ce,ye;const[F,x]=n.useState(!1),[i,I]=n.useState(null),[C,v]=n.useState(null),[l,T]=n.useState(!1),[c,g]=n.useState(null),[m,b]=n.useState(!1),[E,N]=n.useState({}),[R,z]=n.useState(!1),[s,p]=n.useState(""),[u,K]=n.useState("success"),[M,L]=n.useState(!1),[Y,h]=n.useState(null),[k,Q]=n.useState(!1),o=Ss(),P=ws(),de=Es(),H=zs(),me=ks(),ue=Rs();$.useEffect(()=>{Ds()},[]);const[U,X]=n.useState(1),[pe,he]=n.useState(""),[Z,De]=n.useState(""),[ee,Fe]=n.useState(""),[se,Te]=n.useState(""),[Pe,fe]=n.useState(!1),ae=ke(),xe=ls(),{data:j,isLoading:Ie,refetch:Me}=ie(["clients",U,pe,Z,ee,se],()=>gs({page:U,limit:20,search:pe,type:Z,city:ee,sector:se}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:f,isLoading:B,error:As}=ie(["clientStats"],bs,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4});$.useEffect(()=>{f&&f.data&&console.log("✅ Estadísticas cargadas correctamente:",{total:f.data.total,empresas:f.data.empresas,personas:f.data.personas})},[f]);const{data:y,isLoading:_s}=ie(["clientFilterOptions"],js,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:6e4,cacheTime:3e5});$.useEffect(()=>{y&&y.data&&console.log("✅ Opciones de filtros cargadas correctamente:",{types:y.data.types,sectors:y.data.sectors,cities:y.data.cities})},[y]);const Oe=(a,t="success")=>{p(a),K(t),z(!0),setTimeout(()=>{z(!1)},5e3)},te=a=>{ae.invalidateQueries("clients"),ae.invalidateQueries("clientStats"),ae.invalidateQueries("clientFilterOptions"),x(!1),I(null),v(null),Oe(a,"success")},qe=a=>{console.log("🔍 handleSearch - Búsqueda:",a),he(a),X(1),fe(!0),setTimeout(()=>fe(!1),1e3)},Le=a=>{console.log("🔍 handleFilter - Filtros recibidos:",a),console.log("🔍 handleFilter - Estado actual:",{selectedType:Z,selectedCity:ee,selectedSector:se});const t=a.type||"",r=a.city||"",d=a.sector||"";Object.keys(a).length===0&&(console.log("🔍 handleFilter - Limpiando todos los filtros y búsqueda"),he("")),De(t),Fe(r),Te(d),X(1),console.log("🔍 handleFilter - Nuevos valores aplicados:",{type:t,city:r,sector:d}),setTimeout(()=>{Me()},100)},Ae=n.useMemo(()=>{var r,d,S;if(console.log("🔍 clientFilterOptions - filterOptionsData:",y),!y||!y.data)return console.log("🔍 clientFilterOptions - Usando opciones por defecto"),[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona_natural"}}]}];const a=y.data,t=[{title:"Por Tipo de Cliente",options:((r=a.types)==null?void 0:r.map(w=>({label:`${w.label} (${w.count})`,filter:{type:w.value}})))||[]},{title:"Por Sector",options:((d=a.sectors)==null?void 0:d.map(w=>({label:`${w.label} (${w.count})`,filter:{sector:w.value}})))||[]},{title:"Por Ciudad",options:((S=a.cities)==null?void 0:S.map(w=>({label:`${w.label} (${w.count})`,filter:{city:w.value}})))||[]}];return console.log("🔍 clientFilterOptions - Opciones generadas:",t),t},[y]),ge=le(hs,{onSuccess:a=>{h(a),Q(!1),L(!0),te("Cliente creado exitosamente")},onError:a=>{console.error("Error creating client:",a),console.error("Error details:",{message:a.message,status:a.status,body:a.body})}}),be=le(fs,{onSuccess:a=>{h(a),Q(!0),L(!0),te("Cliente actualizado exitosamente")},onError:a=>console.error("Error updating client:",a)}),je=le(xs,{onSuccess:()=>te("Cliente eliminado exitosamente"),onError:a=>console.error("Error deleting client:",a)}),_e=()=>{if(!P){N({action:"crear clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(o==null?void 0:o.role)||"no autenticado"}),b(!0);return}I(Ee),x(!0)},ve=a=>{if(!de){N({action:"editar clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(o==null?void 0:o.role)||"no autenticado"}),b(!0);return}I(a),x(!0)},Ne=a=>{if(console.log("🔍 handleDelete - Verificando permisos:",{userCanDeleteClient:H,currentUserRole:o==null?void 0:o.role,currentUser:o}),!H){console.log("🚫 handleDelete - Permisos insuficientes, mostrando modal"),N({action:"eliminar clientes",requiredRole:"administrador",currentRole:(o==null?void 0:o.role)||"no autenticado"}),b(!0);return}console.log("✅ handleDelete - Permisos OK, procediendo con eliminación"),v(a)},$e=async()=>{try{await je.mutateAsync(C.id),v(null)}catch(a){console.error("Error eliminando cliente:",a),v(null)}},Qe=a=>{if(!ue){N({action:"crear cotizaciones",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(o==null?void 0:o.role)||"no autenticado"}),b(!0);return}xe("/cotizaciones/inteligente",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city,ruc:a.ruc,dni:a.dni,email:a.email,phone:a.phone,contact_name:a.contact_name,address:a.address}}})},He=a=>{if(!me){N({action:"ver historial de clientes",requiredRole:"administrador, jefe comercial o vendedor comercial",currentRole:(o==null?void 0:o.role)||"no autenticado"}),b(!0);return}g(a),T(!0)},Be=(a,t)=>{console.log(`Estado del cliente ${a} cambiado a: ${t}`)},Ge=async a=>{i.id?await be.mutateAsync({id:i.id,...a}):await ge.mutateAsync(a)},We=a=>{const r={empresa:{bg:"primary",text:"Empresa",icon:D},persona:{bg:"info",text:"Persona Natural",icon:q}}[a]||{bg:"secondary",text:a,icon:q},d=r.icon;return e.jsxs(_,{bg:r.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(d,{size:12,className:"me-1"}),r.text]})},Ve=[{header:"ID",accessor:"id",width:"50px"},{header:"Cliente",accessor:"name",width:"180px",render:(a,t)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:t.name}),e.jsxs("div",{className:"d-flex align-items-center gap-1 mt-1",children:[We(t.type),t.ruc&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["RUC: ",t.ruc]}),t.dni&&e.jsxs("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:["DNI: ",t.dni]})]})]})},{header:"Contacto",accessor:"contact",width:"150px",render:(a,t)=>e.jsxs("div",{children:[t.contact_name&&e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:t.contact_name}),t.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(J,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem",cursor:"pointer",color:"#007bff"},onClick:()=>window.open(`mailto:${t.email}`,"_blank"),title:"Abrir en Outlook",children:t.email})]}),t.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(ze,{size:10,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem",cursor:"pointer",color:"#25d366"},onClick:()=>window.open(`https://wa.me/51${t.phone.replace(/\D/g,"")}`,"_blank"),title:"Abrir en WhatsApp",children:t.phone})]})]})},{header:"Ciudad",accessor:"city",width:"80px",render:a=>{const t=a||"No especificada";let r="secondary";switch(t){case"Lima":r="primary";break;case"Arequipa":r="info";break;case"Cusco":r="success";break;case"Trujillo":r="warning";break;case"Piura":r="danger";break;case"Chiclayo":r="info";break;case"Iquitos":r="success";break;case"Huancayo":r="warning";break;default:r="secondary"}return e.jsx(_,{bg:r,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:t})}},{header:"Sector",accessor:"sector",width:"80px",render:a=>{const r=(S=>S&&S.replace(/\s*\[PRIORIDAD:\s*\w+\]/g,"").trim()||"General")(a);let d="secondary";switch(r){case"Construcción":d="warning";break;case"Minería":d="dark";break;case"Ingeniería":d="primary";break;case"Laboratorio":d="info";break;case"Consultoría":d="success";break;case"Tecnología":d="primary";break;case"Ambiental":d="success";break;case"Geología":d="info";break;default:d="secondary"}return e.jsx(_,{bg:d,className:"px-1 py-0",style:{fontSize:"0.65rem"},children:r})}},{header:"Estado",accessor:"status",width:"120px",render:(a,t)=>e.jsx(Ls,{clientId:t.id,currentStatus:t.status||"prospeccion",onStatusChange:r=>Be(t.id,r),size:"sm",showLabel:!0})},{header:"Prioridad",accessor:"priority",width:"100px",render:(a,t)=>{const r=t.priority||"normal";let d="secondary",S="Normal";switch(r){case"urgent":d="danger",S="URGENTE";break;case"high":d="warning",S="ALTA";break;case"normal":d="info",S="NORMAL";break;case"low":d="secondary",S="BAJA";break}return e.jsx(_,{bg:d,className:"px-2 py-1",style:{fontSize:"0.7rem"},children:S})}},{header:"Gestor",accessor:"managed_by",width:"100px",render:(a,t)=>e.jsx("div",{className:"d-flex align-items-center",children:t.managed_by_name?e.jsxs(e.Fragment,{children:[e.jsx(V,{size:12,className:"me-1 text-success"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",style:{fontSize:"0.8rem"},children:t.managed_by_name}),e.jsx("small",{className:"text-muted",style:{fontSize:"0.7rem"},children:t.managed_by_role})]})]}):e.jsx("span",{className:"text-muted",style:{fontSize:"0.8rem"},children:"Sin asignar"})})},{header:"Dirección",accessor:"address",width:"120px",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(ce,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin dirección"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,t)=>e.jsxs("div",{className:"d-flex gap-1",children:[de&&e.jsx(O,{variant:"outline-primary",size:"sm",onClick:()=>ve(t),title:"Editar cliente",children:e.jsx(rs,{size:14})}),me&&e.jsx(O,{variant:"outline-info",size:"sm",onClick:()=>He(t),title:"Ver historial de cotizaciones y proyectos",children:e.jsx(Re,{size:14})}),ue&&e.jsx(O,{variant:"outline-success",size:"sm",onClick:()=>Qe(t),title:"Crear cotización para este cliente",children:e.jsx(cs,{size:14})}),H&&e.jsx(O,{variant:"outline-danger",size:"sm",onClick:()=>Ne(t),title:"Eliminar cliente",children:e.jsx(we,{size:14})}),!H&&e.jsx(O,{variant:"outline-secondary",size:"sm",onClick:()=>{console.log("🚫 Botón eliminar clickeado sin permisos"),N({action:"eliminar clientes",requiredRole:"administrador",currentRole:(o==null?void 0:o.role)||"no autenticado"}),b(!0)},title:"No tienes permisos para eliminar clientes",children:e.jsx(we,{size:14})})]})}],A=n.useMemo(()=>{if(f&&f.data)return console.log("📊 Stats - Usando estadísticas reales del backend:",f),console.log("📊 Stats - Datos extraídos:",f.data),{total:f.data.total||0,empresas:f.data.empresas||0,personas:f.data.personas||0,conEmail:f.data.withEmail||0,conTelefono:f.data.withPhone||0};const a=(j==null?void 0:j.data)||[];return console.log("📊 Stats - Fallback: calculando desde página actual:",a),{total:a.length,empresas:a.filter(t=>t.type==="empresa").length,personas:a.filter(t=>t.type==="persona").length,conEmail:a.filter(t=>t.email).length,conTelefono:a.filter(t=>t.phone).length}},[f,j]);return e.jsx("div",{className:"clientes-page",children:e.jsxs(Fs,{fluid:!0,className:"h-100 d-flex flex-column p-0",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"mb-0 fw-bold",children:"Gestión de Clientes"}),e.jsx("small",{className:"text-muted",children:"Crear, editar y gestionar clientes del sistema"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[(o==null?void 0:o.role)==="admin"&&e.jsxs(O,{variant:"outline-success",size:"sm",onClick:()=>xe("/clientes/importar"),title:"Importar clientes desde archivo CSV",children:[e.jsx(os,{className:"me-1"}),"Importar Clientes"]}),e.jsxs(O,{variant:"primary",size:"sm",onClick:_e,disabled:!P,title:P?"Crear nuevo cliente":`No tienes permisos para crear clientes. Rol actual: ${(o==null?void 0:o.role)||"No autenticado"}`,children:[e.jsx(ns,{className:"me-1"}),"Nuevo Cliente"]})]})]}),!P&&e.jsx("div",{className:"alert alert-warning py-1 mb-1",role:"alert",children:e.jsxs("small",{children:[e.jsx("strong",{children:"⚠️ Permisos insuficientes:"})," Tu rol actual (",(o==null?void 0:o.role)||"No autenticado",") no tiene permisos para crear clientes."]})}),e.jsxs(Ts,{className:"g-2 mb-3",children:[e.jsx(W,{md:6,lg:3,children:e.jsx(G,{title:"Total",value:A.total,icon:Se,color:"primary",loading:B,size:"compact"})}),e.jsx(W,{md:6,lg:3,children:e.jsx(G,{title:"Empresas",value:A.empresas,icon:D,color:"success",loading:B,size:"compact"})}),e.jsx(W,{md:6,lg:3,children:e.jsx(G,{title:"Personas",value:A.personas,icon:q,color:"info",loading:B,size:"compact"})}),e.jsx(W,{md:6,lg:3,children:e.jsx(G,{title:"Con Email",value:A.conEmail,icon:J,color:"warning",loading:B,size:"compact"})})]}),e.jsxs(oe,{className:"shadow-sm border-0 flex-grow-1 d-flex flex-column",children:[e.jsx(oe.Header,{className:"bg-white border-bottom flex-shrink-0 py-2",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx(Se,{className:"me-1 text-primary",size:16}),"Lista de Clientes"]}),e.jsxs(_,{bg:"light",text:"dark",className:"px-2 py-1",children:[A.total," clientes"]})]})}),e.jsx(oe.Body,{className:"p-0 flex-grow-1 d-flex flex-column",children:e.jsx("div",{className:"client-table flex-grow-1 d-flex flex-column",children:e.jsx(ds,{data:(j==null?void 0:j.data)||[],columns:Ve,loading:Ie||Pe,onEdit:ve,onDelete:Ne,emptyMessage:"No hay clientes registrados",totalItems:((Ce=j==null?void 0:j.pagination)==null?void 0:Ce.total)||0,itemsPerPage:((ye=j==null?void 0:j.pagination)==null?void 0:ye.limit)||20,currentPage:U,onPageChange:X,onSearch:qe,onFilter:Le,filterOptions:Ae,sortable:!1,useFlexbox:!0})})})]}),e.jsx(qs,{show:F,onHide:()=>x(!1),data:i||Ee,onSubmit:Ge,loading:ge.isLoading||be.isLoading,isEditing:!!(i!=null&&i.id)}),e.jsx(ms,{show:!!C,onHide:()=>v(null),onConfirm:$e,title:"Eliminar Cliente",message:`¿Estás seguro de que quieres eliminar el cliente "${C==null?void 0:C.name}"?`,confirmText:"Eliminar",variant:"danger",isLoading:je.isLoading,alertMessage:"Esta acción eliminará permanentemente el cliente y todos sus datos asociados (proyectos, cotizaciones, etc.).",alertVariant:"danger"}),e.jsx(Cs,{show:l,onHide:()=>T(!1),clientId:c==null?void 0:c.id,clientName:c==null?void 0:c.name}),e.jsx(us,{show:m,onHide:()=>b(!1),action:E.action,requiredRole:E.requiredRole,currentRole:E.currentRole}),e.jsx(ys,{show:M,onHide:()=>L(!1),clientData:Y,isEdit:k}),R&&e.jsxs("div",{style:{position:"fixed",top:"20px",right:"20px",zIndex:99999,backgroundColor:u==="success"?"#28a745":"#dc3545",color:"white",padding:"15px 20px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",minWidth:"300px",border:"none"},onClick:()=>z(!1),children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:"5px"},children:u==="success"?"✅ Éxito":"❌ Error"}),e.jsx("div",{children:s})]})]})})}export{ra as default};
//# sourceMappingURL=Clientes-DlBy-Dwy.js.map
