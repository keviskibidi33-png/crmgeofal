import{r as t,j as e,C as ae,f as he,B as p,V as te,Z as ie,J as $,af as P,m as xe,F as ue,ag as je,ah as pe,u as ge}from"./index-Dcu-y_Nk.js";import{M as fe}from"./ModuloBase-BRrzUyey.js";import{g as Ne}from"./quotes-BLxht9GA.js";import{S as ne}from"./Spinner-B-FgOVHr.js";import{A as O}from"./Alert-CXOKGb3T.js";import{M as o}from"./Modal-DeSzUGFp.js";import{F as v}from"./Form-DatFUB1A.js";import{C as J}from"./Card-CTICXyCo.js";import"./ElementChildren-BevWbOM2.js";import"./Col-c57Xg6FM.js";const d={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},be=({quoteId:j})=>{const[N,a]=t.useState({primer_contacto:[],aceptacion:[],finalizacion:[]}),[M,g]=t.useState(!0),[k,A]=t.useState(!1),[D,m]=t.useState(""),[I,F]=t.useState(""),[R,Q]=t.useState({total:0,primer_contacto:0,aceptacion:0,finalizacion:0}),[K,y]=t.useState(!1),[w,E]=t.useState(""),[b,S]=t.useState(null),[U,n]=t.useState(""),[f,i]=t.useState(!1),[l,Z]=t.useState(""),[le,V]=t.useState(!1),[C,L]=t.useState(null);t.useEffect(()=>{j&&(q(),G())},[j]);const q=async()=>{try{g(!0),m("");const c=((d==null?void 0:d.VITE_API_URL)||"http://localhost:4000").replace(/\/api$/,""),h=localStorage.getItem("token"),u=await fetch(`${c}/api/quotes/${j}/evidences`,{headers:{Authorization:`Bearer ${h}`}});if(!u.ok)throw new Error("Error al cargar evidencias");const r=await u.json();a(r.grouped||{primer_contacto:[],aceptacion:[],finalizacion:[]})}catch(s){console.error("Error cargando evidencias:",s),m("No se pudieron cargar las evidencias: "+s.message)}finally{g(!1)}},G=async()=>{try{const c=((d==null?void 0:d.VITE_API_URL)||"http://localhost:4000").replace(/\/api$/,""),h=localStorage.getItem("token"),u=await fetch(`${c}/api/quotes/${j}/evidences/stats`,{headers:{Authorization:`Bearer ${h}`}});if(u.ok){const r=await u.json();Q({total:parseInt(r.total)||0,primer_contacto:parseInt(r.primer_contacto)||0,aceptacion:parseInt(r.aceptacion)||0,finalizacion:parseInt(r.finalizacion)||0})}}catch(s){console.error("Error cargando estadísticas:",s)}},ce=s=>{E(s),S(null),n(""),y(!0)},re=s=>{Z(s),i(!0)},oe=s=>{const c=s.target.files[0];if(c){if(!["application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/png","image/jpeg","image/jpg"].includes(c.type)){m("Tipo de archivo no permitido. Solo se aceptan PDF, Excel (.xlsx) e imágenes (PNG, JPG)"),s.target.value="";return}if(c.size>10*1024*1024){m("El archivo es demasiado grande. Tamaño máximo: 10MB"),s.target.value="";return}S(c),m("")}},de=async()=>{if(!b){m("Por favor selecciona un archivo");return}try{A(!0),m("");const s=new FormData;s.append("file",b),s.append("evidence_type",w),U&&s.append("notes",U);const h=((d==null?void 0:d.VITE_API_URL)||"http://localhost:4000").replace(/\/api$/,""),u=localStorage.getItem("token"),r=await fetch(`${h}/api/quotes/${j}/evidences`,{method:"POST",headers:{Authorization:`Bearer ${u}`},body:s});if(!r.ok){const z=await r.json();throw new Error(z.message||"Error al subir evidencia")}F("Evidencia subida correctamente"),y(!1),q(),G(),setTimeout(()=>F(""),3e3)}catch(s){console.error("Error subiendo evidencia:",s),m("Error al subir evidencia: "+s.message)}finally{A(!1)}},W=async(s,c)=>{try{const u=((d==null?void 0:d.VITE_API_URL)||"http://localhost:4000").replace(/\/api$/,""),r=localStorage.getItem("token"),z=await fetch(`${u}/api/quotes/evidences/${s}/download`,{headers:{Authorization:`Bearer ${r}`}});if(!z.ok)throw new Error("Error al descargar archivo");const x=await z.blob(),se=window.URL.createObjectURL(x),T=document.createElement("a");T.href=se,T.download=c,document.body.appendChild(T),T.click(),document.body.removeChild(T),window.URL.revokeObjectURL(se)}catch(h){console.error("Error descargando evidencia:",h),m("Error al descargar archivo: "+h.message)}},X=s=>{L(s),V(!0)},me=async()=>{if(C)try{const c=((d==null?void 0:d.VITE_API_URL)||"http://localhost:4000").replace(/\/api$/,""),h=localStorage.getItem("token");if(!(await fetch(`${c}/api/quotes/evidences/${C.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${h}`}})).ok)throw new Error("Error al eliminar evidencia");F("Evidencia eliminada correctamente"),V(!1),L(null),q(),G(),setTimeout(()=>F(""),3e3)}catch(s){console.error("Error eliminando evidencia:",s),m("Error al eliminar evidencia: "+s.message)}},Y=()=>{V(!1),L(null)},_=s=>s.includes("pdf")?e.jsx(ue,{className:"text-danger",size:24}):s.includes("image")?e.jsx(je,{className:"text-success",size:24}):s.includes("excel")||s.includes("spreadsheet")?e.jsx(P,{className:"text-success",size:24}):e.jsx(P,{className:"text-secondary",size:24}),B=s=>s?s<1024?s+" B":s<1024*1024?(s/1024).toFixed(2)+" KB":(s/(1024*1024)).toFixed(2)+" MB":"Desconocido",ee=s=>new Date(s).toLocaleString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),H=(s,c,h,u,r)=>{const z=r.length;return e.jsxs(J,{className:"mb-3 shadow-sm",children:[e.jsxs(J.Header,{className:`bg-${u} text-dark d-flex justify-content-between align-items-center`,children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[h,e.jsx("strong",{children:s}),e.jsx(ae,{bg:"light",text:"dark",children:z})]}),e.jsxs("div",{className:"d-flex gap-2",children:[z>0&&e.jsxs(p,{variant:"outline-secondary",size:"sm",onClick:()=>re(c),children:[e.jsx(xe,{className:"me-1"}),"Ver evidencias"]}),e.jsxs(p,{variant:"light",size:"sm",onClick:()=>ce(c),children:[e.jsx(te,{className:"me-1"}),"Subir archivo"]})]})]}),e.jsx(J.Body,{children:r.length===0?e.jsxs("div",{className:"text-center text-muted py-3",children:[e.jsx(P,{size:48,className:"mb-2 opacity-25"}),e.jsx("p",{children:"No hay evidencias cargadas"})]}):e.jsx("div",{className:"evidence-list",children:r.map(x=>e.jsxs("div",{className:"evidence-item d-flex align-items-center justify-content-between p-3 border-bottom",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3 flex-grow-1",children:[_(x.file_type),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{className:"fw-bold",children:x.file_name}),e.jsxs("div",{className:"text-muted small",children:[e.jsx("span",{children:B(x.file_size)}),e.jsx("span",{className:"mx-2",children:"•"}),e.jsx("span",{children:ee(x.uploaded_at)}),x.uploaded_by_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-2",children:"•"}),e.jsxs("span",{children:["Por: ",x.uploaded_by_name]})]})]}),x.notes&&e.jsx("div",{className:"text-muted small mt-1",children:e.jsxs("em",{children:["Nota: ",x.notes]})})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(p,{variant:"outline-primary",size:"sm",onClick:()=>W(x.id,x.file_name),title:"Descargar",children:e.jsx(ie,{})}),e.jsx(p,{variant:"outline-danger",size:"sm",onClick:()=>X(x),title:"Eliminar",children:e.jsx($,{})})]})]},x.id))})})]})};return M?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(ne,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Cargando evidencias..."})]}):e.jsxs("div",{className:"quote-evidences",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h4",{className:"mb-0",children:"📋 Evidencias de la Cotización"}),e.jsxs(ae,{bg:"info",className:"fs-6",children:["Total: ",R.total," archivo",R.total!==1?"s":""]})]}),D&&e.jsx(O,{variant:"danger",dismissible:!0,onClose:()=>m(""),children:D}),I&&e.jsx(O,{variant:"success",dismissible:!0,onClose:()=>F(""),children:I}),H(" Evidencia de Primer Contacto","primer_contacto","📸","primary",N.primer_contacto),H("Evidencias de Aceptación","aceptacion","✅","success",N.aceptacion),H("Evidencias de Finalización","finalizacion","🏁","warning",N.finalizacion),e.jsxs(o,{show:K,onHide:()=>y(!1),children:[e.jsx(o.Header,{closeButton:!0,children:e.jsxs(o.Title,{children:["Subir Evidencia",w==="primer_contacto"&&" - Primer Contacto 📸",w==="aceptacion"&&" - Aceptación ✅",w==="finalizacion"&&" - Finalización 🏁"]})}),e.jsx(o.Body,{children:e.jsxs(v,{children:[e.jsxs(v.Group,{className:"mb-3",children:[e.jsx(v.Label,{children:"Archivo *"}),e.jsx(v.Control,{type:"file",onChange:oe,accept:".pdf,.xlsx,.xls,.png,.jpg,.jpeg"}),e.jsx(v.Text,{className:"text-muted",children:"Formatos permitidos: PDF, Excel (.xlsx), imágenes (PNG, JPG). Tamaño máximo: 10MB"})]}),b&&e.jsxs(O,{variant:"info",children:[e.jsx(he,{className:"me-2"}),"Archivo seleccionado: ",e.jsx("strong",{children:b.name})," (",B(b.size),")"]}),e.jsxs(v.Group,{className:"mb-3",children:[e.jsx(v.Label,{children:"Notas (opcional)"}),e.jsx(v.Control,{as:"textarea",rows:3,value:U,onChange:s=>n(s.target.value),placeholder:"Agrega notas o comentarios sobre esta evidencia..."})]})]})}),e.jsxs(o.Footer,{children:[e.jsx(p,{variant:"secondary",onClick:()=>y(!1),children:"Cancelar"}),e.jsx(p,{variant:"primary",onClick:de,disabled:!b||k,children:k?e.jsxs(e.Fragment,{children:[e.jsx(ne,{animation:"border",size:"sm",className:"me-2"}),"Subiendo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"me-2"}),"Subir Evidencia"]})})]})]}),e.jsxs(o,{show:f,onHide:()=>i(!1),size:"lg",children:[e.jsx(o.Header,{closeButton:!0,children:e.jsxs(o.Title,{children:["Ver Evidencias",l==="primer_contacto"&&" - Primer Contacto 📸",l==="aceptacion"&&" - Aceptación ✅",l==="finalizacion"&&" - Finalización 🏁"]})}),e.jsx(o.Body,{children:N[l]&&N[l].length>0?e.jsx("div",{className:"evidences-view",children:N[l].map(s=>e.jsx("div",{className:"evidence-item-view border rounded p-3 mb-3",children:e.jsxs("div",{className:"d-flex align-items-start justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-start gap-3 flex-grow-1",children:[_(s.file_type),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h6",{className:"mb-1",children:s.file_name}),e.jsxs("div",{className:"text-muted small mb-2",children:[e.jsxs("span",{className:"me-3",children:["📏 ",B(s.file_size)]}),e.jsxs("span",{className:"me-3",children:["📅 ",ee(s.uploaded_at)]}),s.uploaded_by_name&&e.jsxs("span",{children:["👤 Por: ",s.uploaded_by_name]})]}),s.notes&&e.jsxs("div",{className:"alert alert-light p-2 mb-0",children:[e.jsx("strong",{className:"small",children:"Notas:"}),e.jsx("div",{className:"small mt-1",children:s.notes})]})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(p,{variant:"outline-primary",size:"sm",onClick:()=>W(s.id,s.file_name),title:"Descargar",children:e.jsx(ie,{})}),e.jsx(p,{variant:"outline-danger",size:"sm",onClick:()=>X(s),title:"Eliminar",children:e.jsx($,{})})]})]})},s.id))}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(P,{size:48,className:"text-muted mb-3"}),e.jsx("p",{className:"text-muted",children:"No hay evidencias de este tipo"})]})}),e.jsx(o.Footer,{children:e.jsx(p,{variant:"secondary",onClick:()=>i(!1),children:"Cerrar"})})]}),e.jsxs(o,{show:le,onHide:Y,centered:!0,children:[e.jsx(o.Header,{closeButton:!0,children:e.jsxs(o.Title,{className:"text-danger",children:[e.jsx($,{className:"me-2"}),"Confirmar Eliminación"]})}),e.jsx(o.Body,{children:e.jsxs("div",{className:"text-center",children:[e.jsx($,{size:48,className:"text-danger mb-3"}),e.jsx("h5",{children:"¿Estás seguro de que quieres eliminar esta evidencia?"}),C&&e.jsxs("div",{className:"mt-3 p-3 bg-light rounded",children:[e.jsx("strong",{children:"Archivo:"})," ",C.file_name,e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Tamaño: ",B(C.file_size)]}),C.notes&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:[e.jsx("strong",{children:"Notas:"})," ",C.notes]})]})]}),e.jsx("p",{className:"text-muted mt-3",children:"Esta acción no se puede deshacer."})]})}),e.jsxs(o.Footer,{children:[e.jsx(p,{variant:"secondary",onClick:Y,children:"Cancelar"}),e.jsxs(p,{variant:"danger",onClick:me,children:[e.jsx($,{className:"me-1"}),"Eliminar Evidencia"]})]})]})]})};function De(){const{id:j}=pe(),N=ge(),[a,M]=t.useState(null),[g,k]=t.useState([]),[A,D]=t.useState(!0),[m,I]=t.useState(""),[F,R]=t.useState(!1),[Q,K]=t.useState(""),[y,w]=t.useState(!1);t.useEffect(()=>{(async()=>{var n,f;try{D(!0),I(""),console.log("🔍 DetalleCotizacion - Cargando cotización ID:",j),console.log("🔍 DetalleCotizacion - Token presente:",localStorage.getItem("token")?"Sí":"No");const i=await Ne(j);console.log("✅ DetalleCotizacion - Cotización cargada:",i);let l=null;if(i.meta&&typeof i.meta=="string")try{l=JSON.parse(i.meta)}catch{l=null}else i.meta&&typeof i.meta=="object"&&(l=i.meta);l?(l.customer&&(i.client_company=l.customer.company_name||i.company_name,i.client_ruc=l.customer.ruc||i.company_ruc),l.items?k(l.items):k([])):k([]),M(i)}catch(i){console.error("❌ Error cargando cotización:",i),I(i.message||"No se pudo cargar la cotización"),(i.status===404||(n=i.message)!=null&&n.includes("404")||(f=i.message)!=null&&f.includes("no encontrada"))&&(console.log("🔄 Cotización no encontrada, redirigiendo al dashboard..."),setTimeout(()=>{N("/dashboard")},2e3))}finally{D(!1)}})()},[j]);const E=t.useMemo(()=>a&&a.subtotal?Number(a.subtotal):g.reduce((n,f)=>{const i=f.partial_price||Number(f.unit_price||0)*Number(f.quantity||0);return n+Number(i)},0),[g,a]),b=t.useMemo(()=>Number((E*.18).toFixed(2)),[E]),S=t.useMemo(()=>a?typeof a.igv=="number"?Number(a.igv):b:0,[a,b]),U=t.useMemo(()=>Number((E+S).toFixed(2)),[E,S]);return e.jsxs(fe,{titulo:`📋 Evidencias - Cotización #${j}`,descripcion:"Gestión de evidencias de la cotización",children:[A&&e.jsx("div",{className:"text-center py-5",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando..."})})}),m&&e.jsx("div",{className:"alert alert-danger",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:m}),e.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>N("/dashboard"),children:"Volver al Dashboard"})]})}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card mb-4 shadow-sm",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsx("h5",{className:"mb-0",children:"📄 Información de la Cotización"})}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Razón Social"}),e.jsx("div",{className:"fs-6 fw-bold",children:a.client_company||a.client_contact||"No especificado"}),a.client_ruc&&e.jsxs("small",{className:"text-muted",children:["RUC: ",a.client_ruc]})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Contacto"}),e.jsx("div",{className:"fs-6",children:a.client_contact||"No especificado"}),a.client_email&&e.jsx("small",{className:"text-muted d-block",children:a.client_email}),a.client_phone&&e.jsxs("small",{className:"text-muted",children:["📞 ",a.client_phone]})]}),e.jsxs("div",{className:"col-md-2",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Fecha de Emisión"}),e.jsx("div",{className:"fs-6",children:a.issue_date?new Date(a.issue_date).toLocaleDateString("es-ES"):"No especificada"})]}),e.jsxs("div",{className:"col-md-2",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Estado"}),e.jsx("div",{className:"fs-6",children:e.jsx("span",{className:`badge ${a.status==="aprobado"?"bg-success":a.status==="enviado"?"bg-primary":a.status==="rechazado"?"bg-danger":"bg-secondary"}`,children:a.status==="en_proceso"?"En proceso":a.status==="enviado"?"Enviado":a.status==="aprobado"?"Aprobado":a.status==="rechazado"?"Rechazado":a.status})})]})]}),e.jsxs("div",{className:"row g-3 mt-2",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Cantidad de Ítems"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsxs("div",{className:"fs-6",children:[g.length," ítem",g.length!==1?"s":""]}),g.length>0&&e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"showItems",checked:y,onChange:n=>w(n.target.checked)}),e.jsx("label",{className:"form-check-label small",htmlFor:"showItems",children:"Ver detalles"})]})]})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Total"}),e.jsxs("div",{className:"fs-5 fw-bold text-success",children:["S/ ",U.toFixed(2)]}),e.jsxs("small",{className:"text-muted",children:["IGV: S/ ",S.toFixed(2)]})]}),a.reference&&e.jsxs("div",{className:"col-md-7",children:[e.jsx("strong",{className:"text-muted d-block small",children:"Referencia"}),e.jsx("div",{className:"fs-6",children:a.reference})]})]}),g.length>0&&y&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("strong",{className:"text-muted small",children:"Ítems de la Cotización"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>w(!1),children:"Ocultar"})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"10%"},children:"Código"}),e.jsx("th",{style:{width:"40%"},children:"Descripción"}),e.jsx("th",{style:{width:"15%"},children:"Norma"}),e.jsx("th",{style:{width:"12%"},children:"P. Unit."}),e.jsx("th",{style:{width:"8%"},children:"Cant."}),e.jsx("th",{style:{width:"15%"},className:"text-end",children:"Parcial"})]})}),e.jsx("tbody",{children:g.map((n,f)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("small",{children:n.code||"-"})}),e.jsx("td",{children:e.jsx("small",{children:n.description||"-"})}),e.jsx("td",{children:e.jsx("small",{children:n.norm||"-"})}),e.jsx("td",{children:e.jsxs("small",{children:["S/ ",Number(n.unit_price||0).toFixed(2)]})}),e.jsx("td",{children:e.jsx("small",{children:n.quantity||0})}),e.jsx("td",{className:"text-end",children:e.jsxs("small",{className:"fw-bold",children:["S/ ",(Number(n.unit_price||0)*Number(n.quantity||0)).toFixed(2)]})})]},f))}),e.jsxs("tfoot",{className:"table-light",children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"Subtotal:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{children:["S/ ",E.toFixed(2)]})})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"IGV 18%:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{children:["S/ ",S.toFixed(2)]})})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-end",children:e.jsx("strong",{children:"Total:"})}),e.jsx("td",{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["S/ ",U.toFixed(2)]})})]})]})]})})]})]})]}),e.jsx(be,{quoteId:j})]})]})}export{De as default};
//# sourceMappingURL=DetalleCotizacion-Bj9zKk3R.js.map
