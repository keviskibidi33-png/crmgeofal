{"version":3,"file":"SubserviceAutocomplete-BNw3rrJ6.js","sources":["../../src/components/SubserviceAutocomplete.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { Form, Dropdown, Badge, Spinner } from 'react-bootstrap';\r\nimport { FiSearch, FiX, FiCheck, FiDollarSign, FiFileText } from 'react-icons/fi';\r\nimport { useQuery } from 'react-query';\r\nimport { searchSubservices } from '../services/subservices';\r\n\r\nconst SubserviceAutocomplete = ({ \r\n  value = '', \r\n  onChange, \r\n  onSelect, \r\n  placeholder = 'Buscar por código, descripción o norma...',\r\n  disabled = false,\r\n  size = 'lg'\r\n}) => {\r\n  const [searchTerm, setSearchTerm] = useState(value);\r\n  const [showDropdown, setShowDropdown] = useState(false);\r\n  const [selectedItem, setSelectedItem] = useState(null);\r\n  const inputRef = useRef(null);\r\n  const dropdownRef = useRef(null);\r\n\r\n  // Debounce para evitar muchas consultas\r\n  const [debouncedSearchTerm, setDebouncedSearchTerm] = useState(searchTerm);\r\n\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => {\r\n      setDebouncedSearchTerm(searchTerm);\r\n    }, 300);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, [searchTerm]);\r\n\r\n  // Query para buscar subservicios\r\n  const { data: searchResults, isLoading, error } = useQuery(\r\n    ['subservices-search', debouncedSearchTerm],\r\n    () => searchSubservices(debouncedSearchTerm),\r\n    {\r\n      enabled: debouncedSearchTerm.length >= 2,\r\n      staleTime: 5 * 60 * 1000, // 5 minutos\r\n      cacheTime: 10 * 60 * 1000, // 10 minutos\r\n    }\r\n  );\r\n\r\n  const handleInputChange = (e) => {\r\n    const newValue = e.target.value;\r\n    setSearchTerm(newValue);\r\n    setShowDropdown(newValue.length >= 2);\r\n    onChange?.(newValue);\r\n    \r\n    if (newValue.length < 2) {\r\n      setSelectedItem(null);\r\n      onSelect?.(null);\r\n    }\r\n  };\r\n\r\n  const handleItemSelect = (item) => {\r\n    setSearchTerm(item.display_text);\r\n    setSelectedItem(item);\r\n    setShowDropdown(false);\r\n    onSelect?.(item);\r\n    inputRef.current?.blur();\r\n  };\r\n\r\n  const handleClear = () => {\r\n    setSearchTerm('');\r\n    setSelectedItem(null);\r\n    setShowDropdown(false);\r\n    onChange?.('');\r\n    onSelect?.(null);\r\n    inputRef.current?.focus();\r\n  };\r\n\r\n  const handleKeyDown = (e) => {\r\n    if (e.key === 'Escape') {\r\n      setShowDropdown(false);\r\n      inputRef.current?.blur();\r\n    }\r\n  };\r\n\r\n  // Cerrar dropdown al hacer click fuera\r\n  useEffect(() => {\r\n    const handleClickOutside = (event) => {\r\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {\r\n        setShowDropdown(false);\r\n      }\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleClickOutside);\r\n    return () => document.removeEventListener('mousedown', handleClickOutside);\r\n  }, []);\r\n\r\n  const formatPrice = (precio) => {\r\n    if (precio === 0) return 'Sujeto a evaluación';\r\n    return `S/ ${precio.toFixed(2)}`;\r\n  };\r\n\r\n  const getServiceColor = (serviceName) => {\r\n    const colors = {\r\n      'ENSAYO ESTÁNDAR': 'primary',\r\n      'ENSAYOS ESPECIALES': 'success',\r\n      'ENSAYOS DE CAMPO': 'info',\r\n      'ENSAYO AGREGADO': 'warning',\r\n      'ENSAYO QUÍMICO SUELO Y AGUA SUBTERRÁNEO': 'secondary',\r\n      'ENSAYO QUÍMICO AGREGADO': 'dark',\r\n      'ENSAYO CONCRETO': 'primary',\r\n      'ENSAYO ALBAÑILERÍA': 'success',\r\n      'ENSAYO ROCA': 'info',\r\n      'ENSAYO PAVIMENTO': 'warning',\r\n      'ENSAYO ASFALTO': 'secondary',\r\n      'ENSAYO MEZCLA ASFÁLTICO': 'dark',\r\n      'EVALUACIONES ESTRUCTURALES': 'primary',\r\n      'IMPLEMENTACIÓN LABORATORIO EN OBRA': 'success',\r\n      'OTROS SERVICIOS': 'info'\r\n    };\r\n    return colors[serviceName] || 'light';\r\n  };\r\n\r\n  return (\r\n    <div className=\"position-relative\" ref={dropdownRef}>\r\n      <Form.Group>\r\n        <div className=\"position-relative\">\r\n          <Form.Control\r\n            ref={inputRef}\r\n            type=\"text\"\r\n            value={searchTerm}\r\n            onChange={handleInputChange}\r\n            onKeyDown={handleKeyDown}\r\n            onFocus={() => searchTerm.length >= 2 && setShowDropdown(true)}\r\n            placeholder={placeholder}\r\n            disabled={disabled}\r\n            size={size}\r\n            className=\"pe-5\"\r\n          />\r\n          \r\n          {/* Iconos */}\r\n          <div className=\"position-absolute top-50 end-0 translate-middle-y pe-3 d-flex align-items-center gap-2\">\r\n            {isLoading && <Spinner animation=\"border\" size=\"sm\" variant=\"primary\" />}\r\n            {!isLoading && searchTerm && (\r\n              <FiX \r\n                className=\"text-muted cursor-pointer\" \r\n                onClick={handleClear}\r\n                style={{ cursor: 'pointer' }}\r\n              />\r\n            )}\r\n            {!isLoading && !searchTerm && <FiSearch className=\"text-muted\" />}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Dropdown de resultados */}\r\n        {showDropdown && (\r\n          <div \r\n            className=\"position-absolute w-100 bg-white border rounded shadow-lg\"\r\n            style={{ \r\n              top: '100%', \r\n              zIndex: 1050,\r\n              maxHeight: '300px',\r\n              overflowY: 'auto'\r\n            }}\r\n          >\r\n            {error && (\r\n              <div className=\"p-3 text-danger\">\r\n                <small>Error al buscar subservicios</small>\r\n              </div>\r\n            )}\r\n\r\n            {!error && searchResults?.data?.length === 0 && (\r\n              <div className=\"p-3 text-muted\">\r\n                <small>No se encontraron subservicios</small>\r\n              </div>\r\n            )}\r\n\r\n            {searchResults?.data?.map((item, index) => (\r\n              <div\r\n                key={item.id}\r\n                className=\"p-3 border-bottom cursor-pointer hover-bg-light\"\r\n                onClick={() => handleItemSelect(item)}\r\n                style={{ cursor: 'pointer' }}\r\n                onMouseEnter={(e) => e.target.style.backgroundColor = '#f8f9fa'}\r\n                onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}\r\n              >\r\n                <div className=\"d-flex justify-content-between align-items-start mb-2\">\r\n                  <div className=\"flex-grow-1\">\r\n                    <div className=\"d-flex align-items-center gap-2 mb-1\">\r\n                      <Badge bg={getServiceColor(item.service_name)} className=\"small\">\r\n                        {item.codigo}\r\n                      </Badge>\r\n                      <Badge bg=\"outline-secondary\" className=\"small\">\r\n                        {item.service_name}\r\n                      </Badge>\r\n                    </div>\r\n                    <div className=\"fw-bold text-dark mb-1\">\r\n                      {item.descripcion}\r\n                    </div>\r\n                    {item.norma && item.norma !== '-' && (\r\n                      <div className=\"text-muted small d-flex align-items-center gap-1\">\r\n                        <FiFileText size={12} />\r\n                        {item.norma}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"text-end\">\r\n                    <div className=\"fw-bold text-success d-flex align-items-center gap-1\">\r\n                      <FiDollarSign size={14} />\r\n                      {formatPrice(item.precio)}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {/* Item seleccionado */}\r\n        {selectedItem && (\r\n          <div className=\"mt-2 p-2 bg-light rounded border\">\r\n            <div className=\"d-flex justify-content-between align-items-center\">\r\n              <div>\r\n                <Badge bg={getServiceColor(selectedItem.service_name)} className=\"me-2\">\r\n                  {selectedItem.codigo}\r\n                </Badge>\r\n                <span className=\"fw-bold\">{selectedItem.descripcion}</span>\r\n                {selectedItem.norma && selectedItem.norma !== '-' && (\r\n                  <div className=\"text-muted small\">\r\n                    <FiFileText size={12} className=\"me-1\" />\r\n                    {selectedItem.norma}\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <div className=\"text-end\">\r\n                <div className=\"fw-bold text-success\">\r\n                  {formatPrice(selectedItem.precio)}\r\n                </div>\r\n                <FiCheck className=\"text-success\" />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </Form.Group>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SubserviceAutocomplete;\r\n"],"names":["SubserviceAutocomplete","value","onChange","onSelect","placeholder","disabled","size","searchTerm","setSearchTerm","useState","showDropdown","setShowDropdown","selectedItem","setSelectedItem","inputRef","useRef","dropdownRef","debouncedSearchTerm","setDebouncedSearchTerm","useEffect","timer","searchResults","isLoading","error","useQuery","searchSubservices","handleInputChange","e","newValue","handleItemSelect","item","_a","handleClear","handleKeyDown","handleClickOutside","event","formatPrice","precio","getServiceColor","serviceName","jsx","jsxs","Form","Spinner","FiX","FiSearch","_b","index","Badge","FiFileText","FiDollarSign","FiCheck"],"mappings":"+NAMA,MAAMA,EAAyB,CAAC,CAC9B,MAAAC,EAAQ,GACR,SAAAC,EACA,SAAAC,EACA,YAAAC,EAAc,4CACd,SAAAC,EAAW,GACX,KAAAC,EAAO,IACT,IAAM,SACJ,KAAM,CAACC,EAAYC,CAAa,EAAIC,EAAAA,SAASR,CAAK,EAC5C,CAACS,EAAcC,CAAe,EAAIF,EAAAA,SAAS,EAAK,EAChD,CAACG,EAAcC,CAAe,EAAIJ,EAAAA,SAAS,IAAI,EAC/CK,EAAWC,EAAAA,OAAO,IAAI,EACtBC,EAAcD,EAAAA,OAAO,IAAI,EAGzB,CAACE,EAAqBC,CAAsB,EAAIT,EAAAA,SAASF,CAAU,EAEzEY,EAAAA,UAAU,IAAM,CACd,MAAMC,EAAQ,WAAW,IAAM,CAC7BF,EAAuBX,CAAU,CACnC,EAAG,GAAG,EAEN,MAAO,IAAM,aAAaa,CAAK,CACjC,EAAG,CAACb,CAAU,CAAC,EAGf,KAAM,CAAE,KAAMc,EAAe,UAAAC,EAAW,MAAAC,GAAUC,EAChD,CAAC,qBAAsBP,CAAmB,EAC1C,IAAMQ,EAAkBR,CAAmB,EAC3C,CACE,QAASA,EAAoB,QAAU,EACvC,UAAW,EAAI,GAAK,IACpB,UAAW,GAAK,GAAK,GAAA,CACvB,EAGIS,EAAqBC,GAAM,CAC/B,MAAMC,EAAWD,EAAE,OAAO,MAC1BnB,EAAcoB,CAAQ,EACtBjB,EAAgBiB,EAAS,QAAU,CAAC,EACpC1B,GAAA,MAAAA,EAAW0B,GAEPA,EAAS,OAAS,IACpBf,EAAgB,IAAI,EACpBV,GAAA,MAAAA,EAAW,MAEf,EAEM0B,EAAoBC,GAAS,OACjCtB,EAAcsB,EAAK,YAAY,EAC/BjB,EAAgBiB,CAAI,EACpBnB,EAAgB,EAAK,EACrBR,GAAA,MAAAA,EAAW2B,IACXC,EAAAjB,EAAS,UAAT,MAAAiB,EAAkB,MACpB,EAEMC,EAAc,IAAM,OACxBxB,EAAc,EAAE,EAChBK,EAAgB,IAAI,EACpBF,EAAgB,EAAK,EACrBT,GAAA,MAAAA,EAAW,IACXC,GAAA,MAAAA,EAAW,OACX4B,EAAAjB,EAAS,UAAT,MAAAiB,EAAkB,OACpB,EAEME,EAAiBN,GAAM,OACvBA,EAAE,MAAQ,WACZhB,EAAgB,EAAK,GACrBoB,EAAAjB,EAAS,UAAT,MAAAiB,EAAkB,OAEtB,EAGAZ,EAAAA,UAAU,IAAM,CACd,MAAMe,EAAsBC,GAAU,CAChCnB,EAAY,SAAW,CAACA,EAAY,QAAQ,SAASmB,EAAM,MAAM,GACnExB,EAAgB,EAAK,CAEzB,EAEA,gBAAS,iBAAiB,YAAauB,CAAkB,EAClD,IAAM,SAAS,oBAAoB,YAAaA,CAAkB,CAC3E,EAAG,CAAA,CAAE,EAEL,MAAME,EAAeC,GACfA,IAAW,EAAU,sBAClB,MAAMA,EAAO,QAAQ,CAAC,CAAC,GAG1BC,EAAmBC,IACR,CACb,kBAAmB,UACnB,qBAAsB,UACtB,mBAAoB,OACpB,kBAAmB,UACnB,0CAA2C,YAC3C,0BAA2B,OAC3B,kBAAmB,UACnB,qBAAsB,UACtB,cAAe,OACf,mBAAoB,UACpB,iBAAkB,YAClB,0BAA2B,OAC3B,6BAA8B,UAC9B,qCAAsC,UACtC,kBAAmB,MAAA,GAEPA,CAAW,GAAK,QAGhC,OACEC,EAAAA,IAAC,OAAI,UAAU,oBAAoB,IAAKxB,EACtC,SAAAyB,EAAAA,KAACC,EAAK,MAAL,CACC,SAAA,CAAAD,EAAAA,KAAC,MAAA,CAAI,UAAU,oBACb,SAAA,CAAAD,EAAAA,IAACE,EAAK,QAAL,CACC,IAAK5B,EACL,KAAK,OACL,MAAOP,EACP,SAAUmB,EACV,UAAWO,EACX,QAAS,IAAM1B,EAAW,QAAU,GAAKI,EAAgB,EAAI,EAC7D,YAAAP,EACA,SAAAC,EACA,KAAAC,EACA,UAAU,MAAA,CAAA,EAIZmC,EAAAA,KAAC,MAAA,CAAI,UAAU,yFACZ,SAAA,CAAAnB,SAAcqB,EAAA,CAAQ,UAAU,SAAS,KAAK,KAAK,QAAQ,UAAU,EACrE,CAACrB,GAAaf,GACbiC,EAAAA,IAACI,EAAA,CACC,UAAU,4BACV,QAASZ,EACT,MAAO,CAAE,OAAQ,SAAA,CAAU,CAAA,EAG9B,CAACV,GAAa,CAACf,GAAciC,EAAAA,IAACK,EAAA,CAAS,UAAU,YAAA,CAAa,CAAA,CAAA,CACjE,CAAA,EACF,EAGCnC,GACC+B,EAAAA,KAAC,MAAA,CACC,UAAU,4DACV,MAAO,CACL,IAAK,OACL,OAAQ,KACR,UAAW,QACX,UAAW,MAAA,EAGZ,SAAA,CAAAlB,SACE,MAAA,CAAI,UAAU,kBACb,SAAAiB,EAAAA,IAAC,QAAA,CAAM,wCAA4B,CAAA,CACrC,EAGD,CAACjB,KAASQ,EAAAV,GAAA,YAAAA,EAAe,OAAf,YAAAU,EAAqB,UAAW,GACzCS,EAAAA,IAAC,MAAA,CAAI,UAAU,iBACb,SAAAA,MAAC,QAAA,CAAM,0CAA8B,EACvC,GAGDM,EAAAzB,GAAA,YAAAA,EAAe,OAAf,YAAAyB,EAAqB,IAAI,CAAChB,EAAMiB,IAC/BP,EAAAA,IAAC,MAAA,CAEC,UAAU,kDACV,QAAS,IAAMX,EAAiBC,CAAI,EACpC,MAAO,CAAE,OAAQ,SAAA,EACjB,aAAeH,GAAMA,EAAE,OAAO,MAAM,gBAAkB,UACtD,aAAeA,GAAMA,EAAE,OAAO,MAAM,gBAAkB,cAEtD,SAAAc,EAAAA,KAAC,MAAA,CAAI,UAAU,wDACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,cACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,uCACb,SAAA,CAAAD,EAAAA,IAACQ,EAAA,CAAM,GAAIV,EAAgBR,EAAK,YAAY,EAAG,UAAU,QACtD,SAAAA,EAAK,MAAA,CACR,QACCkB,EAAA,CAAM,GAAG,oBAAoB,UAAU,QACrC,WAAK,YAAA,CACR,CAAA,EACF,EACAR,EAAAA,IAAC,MAAA,CAAI,UAAU,yBACZ,WAAK,YACR,EACCV,EAAK,OAASA,EAAK,QAAU,KAC5BW,OAAC,MAAA,CAAI,UAAU,mDACb,SAAA,CAAAD,EAAAA,IAACS,EAAA,CAAW,KAAM,EAAA,CAAI,EACrBnB,EAAK,KAAA,CAAA,CACR,CAAA,EAEJ,QACC,MAAA,CAAI,UAAU,WACb,SAAAW,EAAAA,KAAC,MAAA,CAAI,UAAU,uDACb,SAAA,CAAAD,EAAAA,IAACU,EAAA,CAAa,KAAM,EAAA,CAAI,EACvBd,EAAYN,EAAK,MAAM,CAAA,CAAA,CAC1B,CAAA,CACF,CAAA,CAAA,CACF,CAAA,EAjCKA,EAAK,EAAA,EAmCb,CAAA,CAAA,EAKJlB,SACE,MAAA,CAAI,UAAU,mCACb,SAAA6B,EAAAA,KAAC,MAAA,CAAI,UAAU,oDACb,SAAA,CAAAA,OAAC,MAAA,CACC,SAAA,CAAAD,EAAAA,IAACQ,EAAA,CAAM,GAAIV,EAAgB1B,EAAa,YAAY,EAAG,UAAU,OAC9D,SAAAA,EAAa,MAAA,CAChB,EACA4B,EAAAA,IAAC,OAAA,CAAK,UAAU,UAAW,WAAa,YAAY,EACnD5B,EAAa,OAASA,EAAa,QAAU,KAC5C6B,OAAC,MAAA,CAAI,UAAU,mBACb,SAAA,CAAAD,EAAAA,IAACS,EAAA,CAAW,KAAM,GAAI,UAAU,OAAO,EACtCrC,EAAa,KAAA,CAAA,CAChB,CAAA,EAEJ,EACA6B,EAAAA,KAAC,MAAA,CAAI,UAAU,WACb,SAAA,CAAAD,MAAC,OAAI,UAAU,uBACZ,SAAAJ,EAAYxB,EAAa,MAAM,EAClC,EACA4B,EAAAA,IAACW,EAAA,CAAQ,UAAU,cAAA,CAAe,CAAA,CAAA,CACpC,CAAA,CAAA,CACF,CAAA,CACF,CAAA,CAAA,CAEJ,CAAA,CACF,CAEJ"}