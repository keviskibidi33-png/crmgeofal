import{r as c,R as $,c as he,u as ge,e as E,n as T,j as e,C as Ce,h as A,B as b,o as be,k as U,q as F,E as V,v as y,G as ye,H as xe,z as fe,I as Se,A as je}from"./index-CJDD9_Aw.js";import{P as ve}from"./PageHeader-Cfye0oPO.js";import{D as Ne}from"./DataTable-CI3KJtBU.js";import{M as Pe}from"./ModalForm-KtSltT6a.js";import{S as x}from"./StatsCard-DzydegCt.js";import{C as Me}from"./ConfirmModal-C4J0KUay.js";import{c as Ee,u as Te,d as Ae,l as Fe,g as ke,a as Le}from"./companies-CfmLL5xp.js";import{R as Ie,C as k}from"./Row-BGooJhRW.js";import{C as f}from"./Col-DkPevymr.js";import"./InputGroup-CY9SaoEq.js";import"./Form-FBPQ7LgU.js";import"./ElementChildren-B01Kjy_s.js";import"./Table-ME9p9tbt.js";/* empty css                     */import"./Modal-BJZ3bxhN.js";import"./Spinner-BVQsrHFz.js";import"./Alert-Cn54xJZ3.js";const L=()=>{try{const n=localStorage.getItem("token");if(!n)return null;const l=JSON.parse(atob(n.split(".")[1]));return{id:l.id,name:l.name,role:l.role,email:l.email}}catch(n){return console.error("Error decodificando token:",n),null}},I=n=>{const l=L();return l?(typeof n=="string"&&(n=[n]),n.includes(l.role)):!1},K=()=>I(["admin","jefa_comercial","vendedor_comercial"]),De=()=>I(["admin","jefa_comercial","vendedor_comercial"]),ze=()=>I(["admin","jefa_comercial"]),He=()=>{const n=L();n?(console.log("üë§ Usuario actual:",{id:n.id,name:n.name,role:n.role,email:n.email}),console.log("üîê Permisos:",{canCreateClient:K(),canEditClient:De(),canDeleteClient:ze()})):console.log("‚ùå No hay usuario autenticado")},W={type:"empresa",ruc:"",dni:"",name:"",address:"",email:"",phone:"",contact_name:"",city:"",sector:""};function sa(){var _,Q;const[n,l]=c.useState(!1),[d,S]=c.useState(null),[u,p]=c.useState(null),m=L(),j=K();$.useEffect(()=>{He()},[]);const[v,N]=c.useState(1),[D,Y]=c.useState(""),[z,Z]=c.useState(""),[H,X]=c.useState(""),[O,ee]=c.useState(""),[ae,q]=c.useState(!1),P=he(),te=ge(),{data:i,isLoading:se,refetch:Oe}=E(["clients",v,D,z,H,O],()=>Fe({page:v,limit:20,search:D,type:z,city:H,sector:O}),{keepPreviousData:!0,refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:0,cacheTime:0}),{data:o,isLoading:C,error:qe}=E(["clientStats"],ke,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:3e4,cacheTime:6e4});$.useEffect(()=>{o&&o.data&&console.log("‚úÖ Estad√≠sticas cargadas correctamente:",{total:o.data.total,empresas:o.data.empresas,personas:o.data.personas})},[o]);const{data:h,isLoading:we}=E(["clientFilterOptions"],Le,{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:6e4,cacheTime:3e5}),M=a=>{P.invalidateQueries("clients"),P.invalidateQueries("clientStats"),P.invalidateQueries("clientFilterOptions"),l(!1),S(null),p(null)},ne=a=>{console.log("üîç handleSearch - B√∫squeda:",a),Y(a),N(1),q(!0),setTimeout(()=>q(!1),1e3)},oe=a=>{console.log("üîç handleFilter - Filtros:",a),Z(a.type||""),X(a.city||""),ee(a.sector||""),N(1)},ie=c.useMemo(()=>{var a,t,s;return h?[{title:"Por Tipo de Cliente",options:((a=h.types)==null?void 0:a.map(r=>({label:`${r.label} (${r.count})`,filter:{type:r.value}})))||[]},{title:"Por Sector",options:((t=h.sectors)==null?void 0:t.map(r=>({label:`${r.label} (${r.count})`,filter:{sector:r.value}})))||[]},{title:"Por Ciudad",options:((s=h.cities)==null?void 0:s.map(r=>({label:`${r.label} (${r.count})`,filter:{city:r.value}})))||[]}]:[{title:"Por Tipo de Cliente",options:[{label:"Empresas",filter:{type:"empresa"}},{label:"Personas Naturales",filter:{type:"persona"}}]}]},[h]),w=T(Ee,{onSuccess:()=>M(),onError:a=>{console.error("Error creating client:",a),console.error("Error details:",{message:a.message,status:a.status,body:a.body})}}),G=T(Te,{onSuccess:()=>M(),onError:a=>console.error("Error updating client:",a)}),R=T(Ae,{onSuccess:()=>M(),onError:a=>console.error("Error deleting client:",a)}),re=()=>{S(W),l(!0)},B=a=>{S(a),l(!0)},J=a=>{p(a)},le=async()=>{try{await R.mutateAsync(u.id),p(null)}catch(a){console.error("Error eliminando cliente:",a),p(null)}},ce=a=>{te("/proyectos",{state:{selectedClient:{id:a.id,name:a.name,type:a.type,sector:a.sector,city:a.city}}})},de=async a=>{d.id?await G.mutateAsync({id:d.id,...a}):await w.mutateAsync(a)},me=a=>{const s={empresa:{bg:"primary",text:"Empresa",icon:U},persona:{bg:"info",text:"Persona Natural",icon:F}}[a]||{bg:"secondary",text:a,icon:F},r=s.icon;return e.jsxs(y,{bg:s.bg,className:"status-badge d-flex align-items-center",children:[e.jsx(r,{size:12,className:"me-1"}),s.text]})},ue=[{header:"ID",accessor:"id",width:"80px"},{header:"Cliente",accessor:"name",render:(a,t)=>e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:t.name}),e.jsxs("div",{className:"d-flex align-items-center gap-2 mt-1",children:[me(t.type),t.ruc&&e.jsxs("small",{className:"text-muted",children:["RUC: ",t.ruc]}),t.dni&&e.jsxs("small",{className:"text-muted",children:["DNI: ",t.dni]})]})]})},{header:"Contacto",accessor:"contact",render:(a,t)=>e.jsxs("div",{children:[t.contact_name&&e.jsx("div",{className:"fw-medium",children:t.contact_name}),t.email&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(V,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:t.email})]}),t.phone&&e.jsxs("div",{className:"d-flex align-items-center mt-1",children:[e.jsx(ye,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:t.phone})]})]})},{header:"Ciudad",accessor:"city",render:a=>{const t=a||"No especificada";let s="secondary";switch(t){case"Lima":s="primary";break;case"Arequipa":s="info";break;case"Cusco":s="success";break;case"Trujillo":s="warning";break;case"Piura":s="danger";break;case"Chiclayo":s="info";break;case"Iquitos":s="success";break;case"Huancayo":s="warning";break;default:s="secondary"}return e.jsx(y,{bg:s,className:"px-2 py-1",children:t})}},{header:"Sector",accessor:"sector",render:a=>{const t=a||"General";let s="secondary";switch(t){case"Construcci√≥n":s="warning";break;case"Miner√≠a":s="dark";break;case"Ingenier√≠a":s="primary";break;case"Laboratorio":s="info";break;case"Consultor√≠a":s="success";break;case"Tecnolog√≠a":s="primary";break;case"Ambiental":s="success";break;case"Geolog√≠a":s="info";break;default:s="secondary"}return e.jsx(y,{bg:s,className:"px-2 py-1",children:t})}},{header:"Direcci√≥n",accessor:"address",render:a=>a?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(xe,{size:12,className:"me-1 text-muted"}),e.jsx("small",{className:"text-muted",children:a})]}):e.jsx("small",{className:"text-muted",children:"Sin direcci√≥n"})},{header:"Fecha Registro",accessor:"created_at",type:"date"},{header:"Acciones",accessor:"actions",render:(a,t)=>e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(b,{variant:"outline-primary",size:"sm",onClick:()=>B(t),title:"Editar cliente",children:e.jsx(fe,{size:14})}),e.jsx(b,{variant:"outline-success",size:"sm",onClick:()=>ce(t),title:"Crear proyecto para este cliente",children:e.jsx(Se,{size:14})}),e.jsx(b,{variant:"outline-danger",size:"sm",onClick:()=>J(t),title:"Eliminar cliente",children:e.jsx(je,{size:14})})]})}],pe=[{name:"type",label:"Tipo de Cliente",type:"select",required:!0,options:[{value:"empresa",label:"Empresa"},{value:"persona",label:"Persona Natural"}]},{name:"name",label:"Nombre/Raz√≥n Social",type:"text",required:!0,placeholder:"Ingresa el nombre o raz√≥n social"},{name:"ruc",label:"RUC",type:"text",placeholder:"Ingresa el RUC (solo para empresas)",help:"Solo para empresas"},{name:"dni",label:"DNI",type:"text",placeholder:"Ingresa el DNI (solo para personas)",help:"Solo para personas naturales"},{name:"contact_name",label:"Nombre de Contacto",type:"text",placeholder:"Ingresa el nombre del contacto"},{name:"email",label:"Email",type:"email",placeholder:"contacto@empresa.com"},{name:"phone",label:"Tel√©fono",type:"text",placeholder:"+51 999 999 999"},{name:"address",label:"Direcci√≥n",type:"textarea",placeholder:"Ingresa la direcci√≥n completa"},{name:"city",label:"Ciudad",type:"text",placeholder:"Escribe la ciudad (ej: Lima, Arequipa, Cusco...)",autocomplete:!0,suggestions:["Lima","Arequipa","Cusco","Trujillo","Piura","Chiclayo","Iquitos","Huancayo","Tacna","Cajamarca","Ayacucho","Puno","Juliaca","Chimbote","Huaraz","Abancay","Andahuaylas","Tumbes","Pucallpa","Tarapoto","Moyobamba","Cerro de Pasco","Hu√°nuco","Ica","Nazca","Chincha","Ca√±ete","Barranca","Huaral","Callao","Ventanilla","San Juan de Miraflores","Villa El Salvador","San Mart√≠n de Porres","Comas","Los Olivos","San Miguel","Pueblo Libre","Jes√∫s Mar√≠a","Magdalena","San Isidro","Miraflores","Surco","La Molina","Ate","Santa Anita","El Agustino","San Juan de Lurigancho","Lurigancho","Chosica","Chaclacayo","Cieneguilla","Pachac√°mac","Punta Hermosa","Punta Negra","San Bartolo","Santa Mar√≠a del Mar","Pucusana","Asia","Mala","San Vicente de Ca√±ete","Imperial","Nuevo Imperial","Quilman√°","San Luis","San Pedro de Lloc","Pacasmayo","Guadalupe","Jequetepeque","Chep√©n","Cascas","Contumaz√°","Cupisnique","Guzmango","San Benito","San Diego","San Jos√©","San Pablo","Tembladera","Yon√°n","Za√±a","Cajabamba","Cajamarca","Celend√≠n","Chota","Contumaz√°","Cutervo","Hualgayoc","Ja√©n","San Ignacio","San Marcos","San Miguel","San Pablo","Santa Cruz","Bagua","Bongar√°","Condorcanqui","Luya","Rodr√≠guez de Mendoza","Utcubamba","Chachapoyas","Asunci√≥n","Balsas","Cheto","Chiliqu√≠n","Chuquibamba","Granada","Huancas","La Jalca","Leimebamba","Levanto","Magdalena","Mariscal Castilla","Molinopampa","Montevideo","Olleros","Quinjalca","San Francisco de Daguas","San Isidro de Maino","Soloco","Sonche","Abancay","Andahuaylas","Antabamba","Aymaraes","Chincheros","Cotabambas","Grau","Huancarama","Huancaray","Huanipaca","Kishuara","Lambrama","Pacobamba","Pacucha","Pampachiri","Pomacocha","San Antonio de Cachi","San Jer√≥nimo","San Miguel de Chaccrampa","Santa Mar√≠a de Chicmo","Talavera","Tamburco","Andahuaylas","Antabamba","Aymaraes","Chincheros","Cotabambas","Grau","Huancarama","Huancaray","Huanipaca","Kishuara","Lambrama","Pacobamba","Pacucha","Pampachiri","Pomacocha","San Antonio de Cachi","San Jer√≥nimo","San Miguel de Chaccrampa","Santa Mar√≠a de Chicmo","Talavera","Tamburco"]},{name:"sector",label:"Sector",type:"text",placeholder:"Escribe el sector (ej: Construcci√≥n, Miner√≠a, Tecnolog√≠a...)",autocomplete:!0,suggestions:["General","Construcci√≥n","Miner√≠a","Ingenier√≠a","Laboratorio","Consultor√≠a","Tecnolog√≠a","Ambiental","Geolog√≠a","Agricultura","Ganader√≠a","Pesca","Manufactura","Textil","Alimentario","Farmac√©utico","Qu√≠mico","Petroqu√≠mico","Energ√≠a","Electricidad","Gas","Agua","Saneamiento","Transporte","Log√≠stica","Comercio","Retail","Mayorista","Distribuci√≥n","Servicios Financieros","Banca","Seguros","Inversiones","Bienes Ra√≠ces","Inmobiliaria","Turismo","Hoteler√≠a","Restaurantes","Entretenimiento","Medios","Comunicaciones","Telecomunicaciones","Software","Hardware","Sistemas","Internet","E-commerce","Marketing","Publicidad","Educaci√≥n","Capacitaci√≥n","Investigaci√≥n","Desarrollo","Salud","Medicina","Farmac√©utica","Biotecnolog√≠a","Gobierno","P√∫blico","Defensa","Seguridad","Legal","Jur√≠dico","Contable","Auditor√≠a","Recursos Humanos","Administraci√≥n","Gesti√≥n","Consultor√≠a Empresarial","Outsourcing","Servicios Profesionales","Arquitectura","Dise√±o","Arte","Cultura","Deportes","Recreaci√≥n","ONG","Fundaciones","Religioso","Espiritual","Otro"]}],g=c.useMemo(()=>{if(o&&o.data)return console.log("üìä Stats - Usando estad√≠sticas reales del backend:",o),console.log("üìä Stats - Datos extra√≠dos:",o.data),{total:o.data.total||0,empresas:o.data.empresas||0,personas:o.data.personas||0,conEmail:o.data.withEmail||0,conTelefono:o.data.withPhone||0};const a=(i==null?void 0:i.data)||[];return console.log("üìä Stats - Fallback: calculando desde p√°gina actual:",a),{total:a.length,empresas:a.filter(t=>t.type==="empresa").length,personas:a.filter(t=>t.type==="persona").length,conEmail:a.filter(t=>t.email).length,conTelefono:a.filter(t=>t.phone).length}},[o,i]);return e.jsx(Ce,{fluid:!0,className:"py-4",children:e.jsxs("div",{className:"fade-in",children:[e.jsx(ve,{title:"Gesti√≥n de Clientes",subtitle:"Crear, editar y gestionar clientes del sistema",icon:A,actions:e.jsxs(b,{variant:"primary",onClick:re,disabled:!j,title:j?"Crear nuevo cliente":`No tienes permisos para crear clientes. Rol actual: ${(m==null?void 0:m.role)||"No autenticado"}`,children:[e.jsx(be,{className:"me-2"}),"Nuevo Cliente"]})}),!j&&e.jsxs("div",{className:"alert alert-warning mb-4",role:"alert",children:[e.jsx("strong",{children:"‚ö†Ô∏è Permisos insuficientes:"})," Tu rol actual (",(m==null?void 0:m.role)||"No autenticado",") no tiene permisos para crear clientes. Solo los roles ",e.jsx("code",{children:"admin"}),", ",e.jsx("code",{children:"jefa_comercial"})," y ",e.jsx("code",{children:"vendedor_comercial"})," pueden crear clientes."]}),e.jsxs(Ie,{className:"g-4 mb-4",children:[e.jsx(f,{md:6,lg:3,children:e.jsx(x,{title:"Total Clientes",value:g.total,icon:A,color:"primary",subtitle:"Clientes registrados",loading:C})}),e.jsx(f,{md:6,lg:3,children:e.jsx(x,{title:"Empresas",value:g.empresas,icon:U,color:"success",subtitle:"Clientes corporativos",loading:C})}),e.jsx(f,{md:6,lg:3,children:e.jsx(x,{title:"Personas",value:g.personas,icon:F,color:"info",subtitle:"Clientes individuales",loading:C})}),e.jsx(f,{md:6,lg:3,children:e.jsx(x,{title:"Con Contacto",value:g.conEmail,icon:V,color:"warning",subtitle:"Con email registrado",loading:C})})]}),e.jsxs(k,{className:"shadow-sm border-0",children:[e.jsx(k.Header,{className:"bg-white border-bottom",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(A,{className:"me-2 text-primary"}),"Lista de Clientes"]}),e.jsxs(y,{bg:"light",text:"dark",className:"px-3 py-2",children:[g.total," clientes"]})]})}),e.jsx(k.Body,{className:"p-0",children:e.jsx(Ne,{data:(i==null?void 0:i.data)||[],columns:ue,loading:se||ae,onEdit:B,onDelete:J,emptyMessage:"No hay clientes registrados",totalItems:((_=i==null?void 0:i.pagination)==null?void 0:_.total)||0,itemsPerPage:((Q=i==null?void 0:i.pagination)==null?void 0:Q.limit)||20,currentPage:v,onPageChange:N,onSearch:ne,onFilter:oe,filterOptions:ie})})]}),e.jsx(Pe,{show:n,onHide:()=>l(!1),title:d!=null&&d.id?"Editar Cliente":"Nuevo Cliente",data:d||W,fields:pe,onSubmit:de,loading:w.isLoading||G.isLoading,submitText:d!=null&&d.id?"Actualizar":"Crear"}),e.jsx(Me,{show:!!u,onHide:()=>p(null),onConfirm:le,title:"Eliminar Cliente",message:`¬øEst√°s seguro de que quieres eliminar el cliente "${u==null?void 0:u.name}"?`,confirmText:"Eliminar",variant:"danger",isLoading:R.isLoading,alertMessage:"Esta acci√≥n eliminar√° permanentemente el cliente y todos sus datos asociados (proyectos, cotizaciones, etc.).",alertVariant:"danger"})]})})}export{sa as default};
//# sourceMappingURL=Clientes-CURc3xzz.js.map
